var app=function(){"use strict";function noop(){}function run(e){return e()}function blank_object(){return Object.create(null)}function run_all(e){e.forEach(run)}function is_function(e){return"function"==typeof e}function safe_not_equal(e,t){return e!=e?t==t:e!==t||e&&"object"==typeof e||"function"==typeof e}let src_url_equal_anchor,current_component;function src_url_equal(e,t){return src_url_equal_anchor||(src_url_equal_anchor=document.createElement("a")),src_url_equal_anchor.href=t,e===src_url_equal_anchor.href}function is_empty(e){return 0===Object.keys(e).length}function subscribe(e,...t){if(null==e)return noop;const n=e.subscribe(...t);return n.unsubscribe?()=>n.unsubscribe():n}function get_store_value(e){let t;return subscribe(e,(e=>t=e))(),t}function append(e,t){e.appendChild(t)}function insert(e,t,n){e.insertBefore(t,n||null)}function detach(e){e.parentNode&&e.parentNode.removeChild(e)}function destroy_each(e,t){for(let n=0;n<e.length;n+=1)e[n]&&e[n].d(t)}function element(e){return document.createElement(e)}function text(e){return document.createTextNode(e)}function space(){return text(" ")}function empty(){return text("")}function listen(e,t,n,i){return e.addEventListener(t,n,i),()=>e.removeEventListener(t,n,i)}function attr(e,t,n){null==n?e.removeAttribute(t):e.getAttribute(t)!==n&&e.setAttribute(t,n)}function set_custom_element_data(e,t,n){t in e?e[t]="boolean"==typeof e[t]&&""===n||n:attr(e,t,n)}function children(e){return Array.from(e.childNodes)}function set_data(e,t){t=""+t,e.data!==t&&(e.data=t)}function set_input_value(e,t){e.value=null==t?"":t}function set_style(e,t,n,i){null==n?e.style.removeProperty(t):e.style.setProperty(t,n,i?"important":"")}function toggle_class(e,t,n){e.classList[n?"add":"remove"](t)}function attribute_to_object(e){const t={};for(const n of e)t[n.name]=n.value;return t}function set_current_component(e){current_component=e}function get_current_component(){if(!current_component)throw new Error("Function called outside component initialization");return current_component}function onMount(e){get_current_component().$$.on_mount.push(e)}function afterUpdate(e){get_current_component().$$.after_update.push(e)}const dirty_components=[],binding_callbacks=[];let render_callbacks=[];const flush_callbacks=[],resolved_promise=Promise.resolve();let update_scheduled=!1;function schedule_update(){update_scheduled||(update_scheduled=!0,resolved_promise.then(flush))}function add_render_callback(e){render_callbacks.push(e)}const seen_callbacks=new Set;let flushidx=0;function flush(){if(0!==flushidx)return;const e=current_component;do{try{for(;flushidx<dirty_components.length;){const e=dirty_components[flushidx];flushidx++,set_current_component(e),update(e.$$)}}catch(e){throw dirty_components.length=0,flushidx=0,e}for(set_current_component(null),dirty_components.length=0,flushidx=0;binding_callbacks.length;)binding_callbacks.pop()();for(let e=0;e<render_callbacks.length;e+=1){const t=render_callbacks[e];seen_callbacks.has(t)||(seen_callbacks.add(t),t())}render_callbacks.length=0}while(dirty_components.length);for(;flush_callbacks.length;)flush_callbacks.pop()();update_scheduled=!1,seen_callbacks.clear(),set_current_component(e)}function update(e){if(null!==e.fragment){e.update(),run_all(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(add_render_callback)}}function flush_render_callbacks(e){const t=[],n=[];render_callbacks.forEach((i=>-1===e.indexOf(i)?t.push(i):n.push(i))),n.forEach((e=>e())),render_callbacks=t}const outroing=new Set;function transition_in(e,t){e&&e.i&&(outroing.delete(e),e.i(t))}function mount_component(e,t,n,i){const{fragment:s,after_update:a}=e.$$;s&&s.m(t,n),i||add_render_callback((()=>{const t=e.$$.on_mount.map(run).filter(is_function);e.$$.on_destroy?e.$$.on_destroy.push(...t):run_all(t),e.$$.on_mount=[]})),a.forEach(add_render_callback)}function destroy_component(e,t){const n=e.$$;null!==n.fragment&&(flush_render_callbacks(n.after_update),run_all(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}function make_dirty(e,t){-1===e.$$.dirty[0]&&(dirty_components.push(e),schedule_update(),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function init(e,t,n,i,s,a,o,r=[-1]){const l=current_component;set_current_component(e);const c=e.$$={fragment:null,ctx:[],props:a,update:noop,not_equal:s,bound:blank_object(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(t.context||(l?l.$$.context:[])),callbacks:blank_object(),dirty:r,skip_bound:!1,root:t.target||l.$$.root};o&&o(c.root);let p=!1;if(c.ctx=n?n(e,t.props||{},((t,n,...i)=>{const a=i.length?i[0]:n;return c.ctx&&s(c.ctx[t],c.ctx[t]=a)&&(!c.skip_bound&&c.bound[t]&&c.bound[t](a),p&&make_dirty(e,t)),n})):[],c.update(),p=!0,run_all(c.before_update),c.fragment=!!i&&i(c.ctx),t.target){if(t.hydrate){const e=children(t.target);c.fragment&&c.fragment.l(e),e.forEach(detach)}else c.fragment&&c.fragment.c();t.intro&&transition_in(e.$$.fragment),mount_component(e,t.target,t.anchor,t.customElement),flush()}set_current_component(l)}let SvelteElement;"function"==typeof HTMLElement&&(SvelteElement=class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){const{on_mount:e}=this.$$;this.$$.on_disconnect=e.map(run).filter(is_function);for(const e in this.$$.slotted)this.appendChild(this.$$.slotted[e])}attributeChangedCallback(e,t,n){this[e]=n}disconnectedCallback(){run_all(this.$$.on_disconnect)}$destroy(){destroy_component(this,1),this.$destroy=noop}$on(e,t){if(!is_function(t))return noop;const n=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return n.push(t),()=>{const e=n.indexOf(t);-1!==e&&n.splice(e,1)}}$set(e){this.$$set&&!is_empty(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}});let path=document.currentScript&&document.currentScript.src||new URL("fds-ai-image-editor.js",document.baseURI).href;class fdsHelper{static async getInfo(e,t){let n="",i="",s=!1;t&&(t=t.replace("@fds-components/",""),n=fdsHelper.get_href()+e+"-"+t+".json",i=`@fds-components/${t}/dist/${e}-${t}.json`);let a=await fetch(n).then((e=>(e.ok||(s=!0),e.json()))).then((t=>"api"!==e?t:t?t.components?t.components[0]:t:void 0));return s&&(a=await fetch(i).then((e=>(e.ok||(s=!0),e.json()))).then((t=>"api"!==e?t:t?t.components?t.components[0]:t:void 0))),a}static get_href(){return new URL("./",path).href}static get_local(){return new URL("./",path).pathname}}let tutorialsData=[{id:"tutorials",title:"Tutorials",intro:" Each tutorial opens a video.",entries:[{url:"https://youtu.be/4Ak4mERDzLs",image:"https://www.flyingdog.de/sd/appdata/tutorials/refacer_source.jpg",imageHover:"https://www.flyingdog.de/sd/appdata/tutorials/refacer_result.jpg",title:"ComfyUI Setup and Testing",play:!0,square:!0},{url:"https://youtu.be/uxfnU3KOnGQ",image:"https://www.flyingdog.de/sd/appdata/tutorials/comfyui.jpg",imageHover:"https://www.flyingdog.de/sd/appdata/tutorials/comfyui.jpg",title:"Gyre for ComfyUI (Preview)",play:!0,square:!0},{url:"https://youtu.be/W4Gaz43iq-0",image:"https://www.flyingdog.de/sd/appdata/tutorials/text_source.jpg",imageHover:"https://www.flyingdog.de/sd/appdata/tutorials/text_result.jpg",title:"V 4.2, AI-styled text (Old)",play:!0,square:!0},{url:"https://youtu.be/dWyqnJAQmyU",image:"https://www.flyingdog.de/sd/appdata/tutorials/background_source.jpg",imageHover:"https://www.flyingdog.de/sd/appdata/tutorials/background_result.jpg",title:"Background Removal and Replacement (Old)",play:!0,square:!0},{url:"https://youtu.be/MWAeZxAlGxw",image:"https://www.flyingdog.de/sd/appdata/tutorials/posenet_source.jpg",imageHover:"https://www.flyingdog.de/sd/appdata/tutorials/posenet_result.jpg",title:"Pose Layer (Old)",play:!0,square:!0},{url:"https://youtu.be/OerI9whHDSE",image:"https://www.flyingdog.de/sd/appdata/tutorials/lineart_source.jpg",imageHover:"https://www.flyingdog.de/sd/appdata/tutorials/lineart_result.jpg",title:"ControlNet (Old)",play:!0,square:!0}]},{id:"demofiles",title:"Examples",intro:"Examples",entries:[{image:"https://www.flyingdog.de/sd/appdata/examples/example_pose.jpg",type:"file",file:"https://www.flyingdog.de/sd/appdata/examples/pose.fdsai",from:"external",title:"Pose.gyre"},{image:"https://www.flyingdog.de/sd/appdata/examples/example_face.webp",type:"file",file:"https://www.flyingdog.de/sd/appdata/examples/face.fdsai",from:"external",title:"Face.gyre"},{image:"https://www.flyingdog.de/sd/appdata/examples/example_buick.jpg",type:"file",file:"https://www.flyingdog.de/sd/appdata/examples/buick.fdsai",from:"external",title:"3D Layer Buick.gyre"}]}],quickStartData=[{id:"quickStart",title:"Quick Start",intro:"Use these wizards to prepare a multi layer document for different AI tasks.",entries:[{image:"https://www.flyingdog.de/sd/appdata/quickStart/txt2img_source.jpg",imageHover:"https://www.flyingdog.de/sd/appdata/quickStart/txt2img_result.jpg",title:"Text to image",wizard:"txt2img"},{image:"https://www.flyingdog.de/sd/appdata/quickStart/text_source.jpg",imageHover:"https://www.flyingdog.de/sd/appdata/quickStart/text_result.jpg",title:"AI generated text",wizard:"text"},{image:"https://www.flyingdog.de/sd/appdata/quickStart/outpainting_source.jpg",imageHover:"https://www.flyingdog.de/sd/appdata/quickStart/outpainting_result.jpg",title:"Outpainting",wizard:"outpainting"},{image:"https://www.flyingdog.de/sd/appdata/quickStart/3d_source.jpg",imageHover:"https://www.flyingdog.de/sd/appdata/quickStart/3d_result.jpg",title:"Add object to scene",wizard:"3d"},{image:"https://www.flyingdog.de/sd/appdata/quickStart/posenet_source.jpg",imageHover:"https://www.flyingdog.de/sd/appdata/quickStart/posenet_result.jpg",title:"Add a character to scene",wizard:"pose"},{image:"https://www.flyingdog.de/sd/appdata/quickStart/background_source.jpg",imageHover:"https://www.flyingdog.de/sd/appdata/quickStart/background_result.jpg",title:"Background Replacement",wizard:"background"}]}],newDocumentData=[{id:"new",title:"",intro:"Default empty",entries:[{icon:"square",title:"1024 x 1024",selected:!0,width:1024,height:1024},{icon:"square",title:"1280 x 768",selected:!0,width:1280,height:768},{icon:"square",title:"512 x 512",selected:!0,width:512,height:512},{icon:"square",title:"2048 x 2048",selected:!0,width:2048,height:2048}]},{id:"new_social",title:"",intro:"Social Media",entries:[{icon:"Instagram",title:"Instagram post<br> 1080 x 1080",selected:!0,width:1080,height:1080},{icon:"Instagram",title:"Instagram story<br> 1080 x 1920",selected:!0,width:1080,height:1920},{icon:"Facebook",title:"Facebook post<br> 940 x 768",selected:!0,width:940,height:768},{icon:"Youtube",title:"Youtube thumbnail<br>1280 x 720",selected:!0,width:1280,height:720},{icon:"X",title:"X post<br> 1600 x 900",selected:!0,width:1600,height:900},{icon:"TikTok",title:"TikTok<br> 1080 x 1920",selected:!0,width:1080,height:1920}]}];var commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function getDefaultExportFromCjs(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function createCommonjsModule(e){var t={exports:{}};return e(t,t.exports),t.exports}var sweetalert_min=createCommonjsModule((function(e,t){e.exports=function(e){function t(i){if(n[i])return n[i].exports;var s=n[i]={i:i,l:!1,exports:{}};return e[i].call(s.exports,s,s.exports,t),s.l=!0,s.exports}var n={};return t.m=e,t.c=n,t.d=function(e,n,i){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:i})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=8)}([function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var i="swal-button";t.CLASS_NAMES={MODAL:"swal-modal",OVERLAY:"swal-overlay",SHOW_MODAL:"swal-overlay--show-modal",MODAL_TITLE:"swal-title",MODAL_TEXT:"swal-text",ICON:"swal-icon",ICON_CUSTOM:"swal-icon--custom",CONTENT:"swal-content",FOOTER:"swal-footer",BUTTON_CONTAINER:"swal-button-container",BUTTON:i,CONFIRM_BUTTON:i+"--confirm",CANCEL_BUTTON:i+"--cancel",DANGER_BUTTON:i+"--danger",BUTTON_LOADING:i+"--loading",BUTTON_LOADER:i+"__loader"},t.default=t.CLASS_NAMES},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.getNode=function(e){var t="."+e;return document.querySelector(t)},t.stringToNode=function(e){var t=document.createElement("div");return t.innerHTML=e.trim(),t.firstChild},t.insertAfter=function(e,t){var n=t.nextSibling;t.parentNode.insertBefore(e,n)},t.removeNode=function(e){e.parentElement.removeChild(e)},t.throwErr=function(e){throw"SweetAlert: "+(e=e.replace(/ +(?= )/g,"")).trim()},t.isPlainObject=function(e){if("[object Object]"!==Object.prototype.toString.call(e))return!1;var t=Object.getPrototypeOf(e);return null===t||t===Object.prototype},t.ordinalSuffixOf=function(e){var t=e%10,n=e%100;return 1===t&&11!==n?e+"st":2===t&&12!==n?e+"nd":3===t&&13!==n?e+"rd":e+"th"}},function(e,t,n){function i(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}Object.defineProperty(t,"__esModule",{value:!0}),i(n(25));var s=n(26);t.overlayMarkup=s.default,i(n(27)),i(n(28)),i(n(29));var a=n(0),o=a.default.MODAL_TITLE,r=a.default.MODAL_TEXT,l=a.default.ICON,c=a.default.FOOTER;t.iconMarkup='\n  <div class="'+l+'"></div>',t.titleMarkup='\n  <div class="'+o+'"></div>\n',t.textMarkup='\n  <div class="'+r+'"></div>',t.footerMarkup='\n  <div class="'+c+'"></div>\n'},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var i=n(1);t.CONFIRM_KEY="confirm",t.CANCEL_KEY="cancel";var s={visible:!0,text:null,value:null,className:"",closeModal:!0},a=Object.assign({},s,{visible:!1,text:"Cancel",value:null}),o=Object.assign({},s,{text:"OK",value:!0});t.defaultButtonList={cancel:a,confirm:o};var r=function(e){switch(e){case t.CONFIRM_KEY:return o;case t.CANCEL_KEY:return a;default:var n=e.charAt(0).toUpperCase()+e.slice(1);return Object.assign({},s,{text:n,value:e})}},l=function(e,t){var n=r(e);return!0===t?Object.assign({},n,{visible:!0}):"string"==typeof t?Object.assign({},n,{visible:!0,text:t}):i.isPlainObject(t)?Object.assign({visible:!0},n,t):Object.assign({},n,{visible:!1})},c=function(e){for(var t={},n=0,i=Object.keys(e);n<i.length;n++){var s=i[n],o=e[s],r=l(s,o);t[s]=r}return t.cancel||(t.cancel=a),t},p=function(e){var n={};switch(e.length){case 1:n[t.CANCEL_KEY]=Object.assign({},a,{visible:!1});break;case 2:n[t.CANCEL_KEY]=l(t.CANCEL_KEY,e[0]),n[t.CONFIRM_KEY]=l(t.CONFIRM_KEY,e[1]);break;default:i.throwErr("Invalid number of 'buttons' in array ("+e.length+").\n      If you want more than 2 buttons, you need to use an object!")}return n};t.getButtonListOpts=function(e){var n=t.defaultButtonList;return"string"==typeof e?n[t.CONFIRM_KEY]=l(t.CONFIRM_KEY,e):Array.isArray(e)?n=p(e):i.isPlainObject(e)?n=c(e):!0===e?n=p([!0,!0]):!1===e?n=p([!1,!1]):void 0===e&&(n=t.defaultButtonList),n}},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var i=n(1),s=n(2),a=n(0),o=a.default.MODAL,r=a.default.OVERLAY,l=n(30),c=n(31),p=n(32),h=n(33);t.injectElIntoModal=function(e){var t=i.getNode(o),n=i.stringToNode(e);return t.appendChild(n),n};var d=function(e){e.className=o,e.textContent=""},u=function(e,t){d(e);var n=t.className;n&&e.classList.add(n)};t.initModalContent=function(e){var t=i.getNode(o);u(t,e),l.default(e.icon),c.initTitle(e.title),c.initText(e.text),h.default(e.content),p.default(e.buttons,e.dangerMode)};var g=function(){var e=i.getNode(r),t=i.stringToNode(s.modalMarkup);e.appendChild(t)};t.default=g},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var i=n(3),s={isOpen:!1,promise:null,actions:{},timer:null},a=Object.assign({},s);t.resetState=function(){a=Object.assign({},s)},t.setActionValue=function(e){if("string"==typeof e)return o(i.CONFIRM_KEY,e);for(var t in e)o(t,e[t])};var o=function(e,t){a.actions[e]||(a.actions[e]={}),Object.assign(a.actions[e],{value:t})};t.setActionOptionsFor=function(e,t){var n=(void 0===t?{}:t).closeModal,i=void 0===n||n;Object.assign(a.actions[e],{closeModal:i})},t.default=a},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var i=n(1),s=n(3),a=n(0),o=a.default.OVERLAY,r=a.default.SHOW_MODAL,l=a.default.BUTTON,c=a.default.BUTTON_LOADING,p=n(5);t.openModal=function(){i.getNode(o).classList.add(r),p.default.isOpen=!0};var h=function(){i.getNode(o).classList.remove(r),p.default.isOpen=!1};t.onAction=function(e){void 0===e&&(e=s.CANCEL_KEY);var t=p.default.actions[e],n=t.value;if(!1===t.closeModal){var a=l+"--"+e;i.getNode(a).classList.add(c)}else h();p.default.promise.resolve(n)},t.getState=function(){var e=Object.assign({},p.default);return delete e.promise,delete e.timer,e},t.stopLoading=function(){for(var e=document.querySelectorAll("."+l),t=0;t<e.length;t++)e[t].classList.remove(c)}},function(e,t){var n;n=function(){return this}();try{n=n||Function("return this")()||(0,eval)("this")}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t,n){(function(t){e.exports=t.sweetAlert=n(9)}).call(t,n(7))},function(e,t,n){(function(t){e.exports=t.swal=n(10)}).call(t,n(7))},function(e,t,n){"undefined"!=typeof window&&n(11),n(16);var i=n(23).default;e.exports=i},function(e,t,n){var i=n(12);"string"==typeof i&&(i=[[e.i,i,""]]);var s={insertAt:"top",transform:void 0};n(14)(i,s),i.locals&&(e.exports=i.locals)},function(e,t,n){(e.exports=n(13)(void 0)).push([e.i,'.swal-icon--error{border-color:#f27474;-webkit-animation:animateErrorIcon .5s;animation:animateErrorIcon .5s}.swal-icon--error__x-mark{position:relative;display:block;-webkit-animation:animateXMark .5s;animation:animateXMark .5s}.swal-icon--error__line{position:absolute;height:5px;width:47px;background-color:#f27474;display:block;top:37px;border-radius:2px}.swal-icon--error__line--left{-webkit-transform:rotate(45deg);transform:rotate(45deg);left:17px}.swal-icon--error__line--right{-webkit-transform:rotate(-45deg);transform:rotate(-45deg);right:16px}@-webkit-keyframes animateErrorIcon{0%{-webkit-transform:rotateX(100deg);transform:rotateX(100deg);opacity:0}to{-webkit-transform:rotateX(0deg);transform:rotateX(0deg);opacity:1}}@keyframes animateErrorIcon{0%{-webkit-transform:rotateX(100deg);transform:rotateX(100deg);opacity:0}to{-webkit-transform:rotateX(0deg);transform:rotateX(0deg);opacity:1}}@-webkit-keyframes animateXMark{0%{-webkit-transform:scale(.4);transform:scale(.4);margin-top:26px;opacity:0}50%{-webkit-transform:scale(.4);transform:scale(.4);margin-top:26px;opacity:0}80%{-webkit-transform:scale(1.15);transform:scale(1.15);margin-top:-6px}to{-webkit-transform:scale(1);transform:scale(1);margin-top:0;opacity:1}}@keyframes animateXMark{0%{-webkit-transform:scale(.4);transform:scale(.4);margin-top:26px;opacity:0}50%{-webkit-transform:scale(.4);transform:scale(.4);margin-top:26px;opacity:0}80%{-webkit-transform:scale(1.15);transform:scale(1.15);margin-top:-6px}to{-webkit-transform:scale(1);transform:scale(1);margin-top:0;opacity:1}}.swal-icon--warning{border-color:#f8bb86;-webkit-animation:pulseWarning .75s infinite alternate;animation:pulseWarning .75s infinite alternate}.swal-icon--warning__body{width:5px;height:47px;top:10px;border-radius:2px;margin-left:-2px}.swal-icon--warning__body,.swal-icon--warning__dot{position:absolute;left:50%;background-color:#f8bb86}.swal-icon--warning__dot{width:7px;height:7px;border-radius:50%;margin-left:-4px;bottom:-11px}@-webkit-keyframes pulseWarning{0%{border-color:#f8d486}to{border-color:#f8bb86}}@keyframes pulseWarning{0%{border-color:#f8d486}to{border-color:#f8bb86}}.swal-icon--success{border-color:#a5dc86}.swal-icon--success:after,.swal-icon--success:before{content:"";border-radius:50%;position:absolute;width:60px;height:120px;background:#fff;-webkit-transform:rotate(45deg);transform:rotate(45deg)}.swal-icon--success:before{border-radius:120px 0 0 120px;top:-7px;left:-33px;-webkit-transform:rotate(-45deg);transform:rotate(-45deg);-webkit-transform-origin:60px 60px;transform-origin:60px 60px}.swal-icon--success:after{border-radius:0 120px 120px 0;top:-11px;left:30px;-webkit-transform:rotate(-45deg);transform:rotate(-45deg);-webkit-transform-origin:0 60px;transform-origin:0 60px;-webkit-animation:rotatePlaceholder 4.25s ease-in;animation:rotatePlaceholder 4.25s ease-in}.swal-icon--success__ring{width:80px;height:80px;border:4px solid hsla(98,55%,69%,.2);border-radius:50%;box-sizing:content-box;position:absolute;left:-4px;top:-4px;z-index:2}.swal-icon--success__hide-corners{width:5px;height:90px;background-color:#fff;padding:1px;position:absolute;left:28px;top:8px;z-index:1;-webkit-transform:rotate(-45deg);transform:rotate(-45deg)}.swal-icon--success__line{height:5px;background-color:#a5dc86;display:block;border-radius:2px;position:absolute;z-index:2}.swal-icon--success__line--tip{width:25px;left:14px;top:46px;-webkit-transform:rotate(45deg);transform:rotate(45deg);-webkit-animation:animateSuccessTip .75s;animation:animateSuccessTip .75s}.swal-icon--success__line--long{width:47px;right:8px;top:38px;-webkit-transform:rotate(-45deg);transform:rotate(-45deg);-webkit-animation:animateSuccessLong .75s;animation:animateSuccessLong .75s}@-webkit-keyframes rotatePlaceholder{0%{-webkit-transform:rotate(-45deg);transform:rotate(-45deg)}5%{-webkit-transform:rotate(-45deg);transform:rotate(-45deg)}12%{-webkit-transform:rotate(-405deg);transform:rotate(-405deg)}to{-webkit-transform:rotate(-405deg);transform:rotate(-405deg)}}@keyframes rotatePlaceholder{0%{-webkit-transform:rotate(-45deg);transform:rotate(-45deg)}5%{-webkit-transform:rotate(-45deg);transform:rotate(-45deg)}12%{-webkit-transform:rotate(-405deg);transform:rotate(-405deg)}to{-webkit-transform:rotate(-405deg);transform:rotate(-405deg)}}@-webkit-keyframes animateSuccessTip{0%{width:0;left:1px;top:19px}54%{width:0;left:1px;top:19px}70%{width:50px;left:-8px;top:37px}84%{width:17px;left:21px;top:48px}to{width:25px;left:14px;top:45px}}@keyframes animateSuccessTip{0%{width:0;left:1px;top:19px}54%{width:0;left:1px;top:19px}70%{width:50px;left:-8px;top:37px}84%{width:17px;left:21px;top:48px}to{width:25px;left:14px;top:45px}}@-webkit-keyframes animateSuccessLong{0%{width:0;right:46px;top:54px}65%{width:0;right:46px;top:54px}84%{width:55px;right:0;top:35px}to{width:47px;right:8px;top:38px}}@keyframes animateSuccessLong{0%{width:0;right:46px;top:54px}65%{width:0;right:46px;top:54px}84%{width:55px;right:0;top:35px}to{width:47px;right:8px;top:38px}}.swal-icon--info{border-color:#c9dae1}.swal-icon--info:before{width:5px;height:29px;bottom:17px;border-radius:2px;margin-left:-2px}.swal-icon--info:after,.swal-icon--info:before{content:"";position:absolute;left:50%;background-color:#c9dae1}.swal-icon--info:after{width:7px;height:7px;border-radius:50%;margin-left:-3px;top:19px}.swal-icon{width:80px;height:80px;border-width:4px;border-style:solid;border-radius:50%;padding:0;position:relative;box-sizing:content-box;margin:20px auto}.swal-icon:first-child{margin-top:32px}.swal-icon--custom{width:auto;height:auto;max-width:100%;border:none;border-radius:0}.swal-icon img{max-width:100%;max-height:100%}.swal-title{color:rgba(0,0,0,.65);font-weight:600;text-transform:none;position:relative;display:block;padding:13px 16px;font-size:27px;line-height:normal;text-align:center;margin-bottom:0}.swal-title:first-child{margin-top:26px}.swal-title:not(:first-child){padding-bottom:0}.swal-title:not(:last-child){margin-bottom:13px}.swal-text{font-size:16px;position:relative;float:none;line-height:normal;vertical-align:top;text-align:left;display:inline-block;margin:0;padding:0 10px;font-weight:400;color:rgba(0,0,0,.64);max-width:calc(100% - 20px);overflow-wrap:break-word;box-sizing:border-box}.swal-text:first-child{margin-top:45px}.swal-text:last-child{margin-bottom:45px}.swal-footer{text-align:right;padding-top:13px;margin-top:13px;padding:13px 16px;border-radius:inherit;border-top-left-radius:0;border-top-right-radius:0}.swal-button-container{margin:5px;display:inline-block;position:relative}.swal-button{background-color:#7cd1f9;color:#fff;border:none;box-shadow:none;border-radius:5px;font-weight:600;font-size:14px;padding:10px 24px;margin:0;cursor:pointer}.swal-button:not([disabled]):hover{background-color:#78cbf2}.swal-button:active{background-color:#70bce0}.swal-button:focus{outline:none;box-shadow:0 0 0 1px #fff,0 0 0 3px rgba(43,114,165,.29)}.swal-button[disabled]{opacity:.5;cursor:default}.swal-button::-moz-focus-inner{border:0}.swal-button--cancel{color:#555;background-color:#efefef}.swal-button--cancel:not([disabled]):hover{background-color:#e8e8e8}.swal-button--cancel:active{background-color:#d7d7d7}.swal-button--cancel:focus{box-shadow:0 0 0 1px #fff,0 0 0 3px rgba(116,136,150,.29)}.swal-button--danger{background-color:#e64942}.swal-button--danger:not([disabled]):hover{background-color:#df4740}.swal-button--danger:active{background-color:#cf423b}.swal-button--danger:focus{box-shadow:0 0 0 1px #fff,0 0 0 3px rgba(165,43,43,.29)}.swal-content{padding:0 20px;margin-top:20px;font-size:medium}.swal-content:last-child{margin-bottom:20px}.swal-content__input,.swal-content__textarea{-webkit-appearance:none;background-color:#fff;border:none;font-size:14px;display:block;box-sizing:border-box;width:100%;border:1px solid rgba(0,0,0,.14);padding:10px 13px;border-radius:2px;transition:border-color .2s}.swal-content__input:focus,.swal-content__textarea:focus{outline:none;border-color:#6db8ff}.swal-content__textarea{resize:vertical}.swal-button--loading{color:transparent}.swal-button--loading~.swal-button__loader{opacity:1}.swal-button__loader{position:absolute;height:auto;width:43px;z-index:2;left:50%;top:50%;-webkit-transform:translateX(-50%) translateY(-50%);transform:translateX(-50%) translateY(-50%);text-align:center;pointer-events:none;opacity:0}.swal-button__loader div{display:inline-block;float:none;vertical-align:baseline;width:9px;height:9px;padding:0;border:none;margin:2px;opacity:.4;border-radius:7px;background-color:hsla(0,0%,100%,.9);transition:background .2s;-webkit-animation:swal-loading-anim 1s infinite;animation:swal-loading-anim 1s infinite}.swal-button__loader div:nth-child(3n+2){-webkit-animation-delay:.15s;animation-delay:.15s}.swal-button__loader div:nth-child(3n+3){-webkit-animation-delay:.3s;animation-delay:.3s}@-webkit-keyframes swal-loading-anim{0%{opacity:.4}20%{opacity:.4}50%{opacity:1}to{opacity:.4}}@keyframes swal-loading-anim{0%{opacity:.4}20%{opacity:.4}50%{opacity:1}to{opacity:.4}}.swal-overlay{position:fixed;top:0;bottom:0;left:0;right:0;text-align:center;font-size:0;overflow-y:auto;background-color:rgba(0,0,0,.4);z-index:10000;pointer-events:none;opacity:0;transition:opacity .3s}.swal-overlay:before{content:" ";display:inline-block;vertical-align:middle;height:100%}.swal-overlay--show-modal{opacity:1;pointer-events:auto}.swal-overlay--show-modal .swal-modal{opacity:1;pointer-events:auto;box-sizing:border-box;-webkit-animation:showSweetAlert .3s;animation:showSweetAlert .3s;will-change:transform}.swal-modal{width:478px;opacity:0;pointer-events:none;background-color:#fff;text-align:center;border-radius:5px;position:static;margin:20px auto;display:inline-block;vertical-align:middle;-webkit-transform:scale(1);transform:scale(1);-webkit-transform-origin:50% 50%;transform-origin:50% 50%;z-index:10001;transition:opacity .2s,-webkit-transform .3s;transition:transform .3s,opacity .2s;transition:transform .3s,opacity .2s,-webkit-transform .3s}@media (max-width:500px){.swal-modal{width:calc(100% - 20px)}}@-webkit-keyframes showSweetAlert{0%{-webkit-transform:scale(1);transform:scale(1)}1%{-webkit-transform:scale(.5);transform:scale(.5)}45%{-webkit-transform:scale(1.05);transform:scale(1.05)}80%{-webkit-transform:scale(.95);transform:scale(.95)}to{-webkit-transform:scale(1);transform:scale(1)}}@keyframes showSweetAlert{0%{-webkit-transform:scale(1);transform:scale(1)}1%{-webkit-transform:scale(.5);transform:scale(.5)}45%{-webkit-transform:scale(1.05);transform:scale(1.05)}80%{-webkit-transform:scale(.95);transform:scale(.95)}to{-webkit-transform:scale(1);transform:scale(1)}}',""])},function(e,t){function n(e,t){var n=e[1]||"",s=e[3];if(!s)return n;if(t&&"function"==typeof btoa){var a=i(s);return[n].concat(s.sources.map((function(e){return"/*# sourceURL="+s.sourceRoot+e+" */"}))).concat([a]).join("\n")}return[n].join("\n")}function i(e){return"/*# sourceMappingURL=data:application/json;charset=utf-8;base64,"+btoa(unescape(encodeURIComponent(JSON.stringify(e))))+" */"}e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var i=n(t,e);return t[2]?"@media "+t[2]+"{"+i+"}":i})).join("")},t.i=function(e,n){"string"==typeof e&&(e=[[null,e,""]]);for(var i={},s=0;s<this.length;s++){var a=this[s][0];"number"==typeof a&&(i[a]=!0)}for(s=0;s<e.length;s++){var o=e[s];"number"==typeof o[0]&&i[o[0]]||(n&&!o[2]?o[2]=n:n&&(o[2]="("+o[2]+") and ("+n+")"),t.push(o))}},t}},function(e,t,n){function i(e,t){for(var n=0;n<e.length;n++){var i=e[n],s=g[i.id];if(s){s.refs++;for(var a=0;a<s.parts.length;a++)s.parts[a](i.parts[a]);for(;a<i.parts.length;a++)s.parts.push(p(i.parts[a],t))}else{var o=[];for(a=0;a<i.parts.length;a++)o.push(p(i.parts[a],t));g[i.id]={id:i.id,refs:1,parts:o}}}}function s(e,t){for(var n=[],i={},s=0;s<e.length;s++){var a=e[s],o=t.base?a[0]+t.base:a[0],r={css:a[1],media:a[2],sourceMap:a[3]};i[o]?i[o].parts.push(r):n.push(i[o]={id:o,parts:[r]})}return n}function a(e,t){var n=_(e.insertInto);if(!n)throw new Error("Couldn't find a style target. This probably means that the value for the 'insertInto' parameter is invalid.");var i=y[y.length-1];if("top"===e.insertAt)i?i.nextSibling?n.insertBefore(t,i.nextSibling):n.appendChild(t):n.insertBefore(t,n.firstChild),y.push(t);else{if("bottom"!==e.insertAt)throw new Error("Invalid value for parameter 'insertAt'. Must be 'top' or 'bottom'.");n.appendChild(t)}}function o(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e);var t=y.indexOf(e);t>=0&&y.splice(t,1)}function r(e){var t=document.createElement("style");return e.attrs.type="text/css",c(t,e.attrs),a(e,t),t}function l(e){var t=document.createElement("link");return e.attrs.type="text/css",e.attrs.rel="stylesheet",c(t,e.attrs),a(e,t),t}function c(e,t){Object.keys(t).forEach((function(n){e.setAttribute(n,t[n])}))}function p(e,t){var n,i,s,a;if(t.transform&&e.css){if(!(a=t.transform(e.css)))return function(){};e.css=a}if(t.singleton){var c=v++;n=m||(m=r(t)),i=h.bind(null,n,c,!1),s=h.bind(null,n,c,!0)}else e.sourceMap&&"function"==typeof URL&&"function"==typeof URL.createObjectURL&&"function"==typeof URL.revokeObjectURL&&"function"==typeof Blob&&"function"==typeof btoa?(n=l(t),i=u.bind(null,n,t),s=function(){o(n),n.href&&URL.revokeObjectURL(n.href)}):(n=r(t),i=d.bind(null,n),s=function(){o(n)});return i(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap)return;i(e=t)}else s()}}function h(e,t,n,i){var s=n?"":i.css;if(e.styleSheet)e.styleSheet.cssText=w(t,s);else{var a=document.createTextNode(s),o=e.childNodes;o[t]&&e.removeChild(o[t]),o.length?e.insertBefore(a,o[t]):e.appendChild(a)}}function d(e,t){var n=t.css,i=t.media;if(i&&e.setAttribute("media",i),e.styleSheet)e.styleSheet.cssText=n;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(n))}}function u(e,t,n){var i=n.css,s=n.sourceMap,a=void 0===t.convertToAbsoluteUrls&&s;(t.convertToAbsoluteUrls||a)&&(i=b(i)),s&&(i+="\n/*# sourceMappingURL=data:application/json;base64,"+btoa(unescape(encodeURIComponent(JSON.stringify(s))))+" */");var o=new Blob([i],{type:"text/css"}),r=e.href;e.href=URL.createObjectURL(o),r&&URL.revokeObjectURL(r)}var g={},f=function(e){var t;return function(){return void 0===t&&(t=e.apply(this,arguments)),t}}((function(){return window&&document&&document.all&&!window.atob})),_=function(e){var t={};return function(n){return void 0===t[n]&&(t[n]=e.call(this,n)),t[n]}}((function(e){return document.querySelector(e)})),m=null,v=0,y=[],b=n(15);e.exports=function(e,t){if("undefined"!=typeof DEBUG&&DEBUG&&"object"!=typeof document)throw new Error("The style-loader cannot be used in a non-browser environment");(t=t||{}).attrs="object"==typeof t.attrs?t.attrs:{},t.singleton||(t.singleton=f()),t.insertInto||(t.insertInto="head"),t.insertAt||(t.insertAt="bottom");var n=s(e,t);return i(n,t),function(e){for(var a=[],o=0;o<n.length;o++){var r=n[o];(l=g[r.id]).refs--,a.push(l)}for(e&&i(s(e,t),t),o=0;o<a.length;o++){var l;if(0===(l=a[o]).refs){for(var c=0;c<l.parts.length;c++)l.parts[c]();delete g[l.id]}}}};var w=function(){var e=[];return function(t,n){return e[t]=n,e.filter(Boolean).join("\n")}}()},function(e,t){e.exports=function(e){var t="undefined"!=typeof window&&window.location;if(!t)throw new Error("fixUrls requires window.location");if(!e||"string"!=typeof e)return e;var n=t.protocol+"//"+t.host,i=n+t.pathname.replace(/\/[^\/]*$/,"/");return e.replace(/url\s*\(((?:[^)(]|\((?:[^)(]+|\([^)(]*\))*\))*)\)/gi,(function(e,t){var s,a=t.trim().replace(/^"(.*)"$/,(function(e,t){return t})).replace(/^'(.*)'$/,(function(e,t){return t}));return/^(#|data:|http:\/\/|https:\/\/|file:\/\/\/)/i.test(a)?e:(s=0===a.indexOf("//")?a:0===a.indexOf("/")?n+a:i+a.replace(/^\.\//,""),"url("+JSON.stringify(s)+")")}))}},function(e,t,n){var i=n(17);"undefined"==typeof window||window.Promise||(window.Promise=i),n(21),String.prototype.includes||(String.prototype.includes=function(e,t){return"number"!=typeof t&&(t=0),!(t+e.length>this.length)&&-1!==this.indexOf(e,t)}),Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{value:function(e,t){if(null==this)throw new TypeError('"this" is null or not defined');var n=Object(this),i=n.length>>>0;if(0===i)return!1;for(var s=0|t,a=Math.max(s>=0?s:i-Math.abs(s),0);a<i;){if(function(e,t){return e===t||"number"==typeof e&&"number"==typeof t&&isNaN(e)&&isNaN(t)}(n[a],e))return!0;a++}return!1}}),"undefined"!=typeof window&&[Element.prototype,CharacterData.prototype,DocumentType.prototype].forEach((function(e){e.hasOwnProperty("remove")||Object.defineProperty(e,"remove",{configurable:!0,enumerable:!0,writable:!0,value:function(){this.parentNode.removeChild(this)}})}))},function(e,t,n){(function(t){!function(n){function i(){}function s(e,t){return function(){e.apply(t,arguments)}}function a(e){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof e)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],h(e,this)}function o(e,t){for(;3===e._state;)e=e._value;0!==e._state?(e._handled=!0,a._immediateFn((function(){var n=1===e._state?t.onFulfilled:t.onRejected;if(null!==n){var i;try{i=n(e._value)}catch(e){return void l(t.promise,e)}r(t.promise,i)}else(1===e._state?r:l)(t.promise,e._value)}))):e._deferreds.push(t)}function r(e,t){try{if(t===e)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var n=t.then;if(t instanceof a)return e._state=3,e._value=t,void c(e);if("function"==typeof n)return void h(s(n,t),e)}e._state=1,e._value=t,c(e)}catch(t){l(e,t)}}function l(e,t){e._state=2,e._value=t,c(e)}function c(e){2===e._state&&0===e._deferreds.length&&a._immediateFn((function(){e._handled||a._unhandledRejectionFn(e._value)}));for(var t=0,n=e._deferreds.length;t<n;t++)o(e,e._deferreds[t]);e._deferreds=null}function p(e,t,n){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof t?t:null,this.promise=n}function h(e,t){var n=!1;try{e((function(e){n||(n=!0,r(t,e))}),(function(e){n||(n=!0,l(t,e))}))}catch(e){if(n)return;n=!0,l(t,e)}}var d=setTimeout;a.prototype.catch=function(e){return this.then(null,e)},a.prototype.then=function(e,t){var n=new this.constructor(i);return o(this,new p(e,t,n)),n},a.all=function(e){var t=Array.prototype.slice.call(e);return new a((function(e,n){function i(a,o){try{if(o&&("object"==typeof o||"function"==typeof o)){var r=o.then;if("function"==typeof r)return void r.call(o,(function(e){i(a,e)}),n)}t[a]=o,0==--s&&e(t)}catch(e){n(e)}}if(0===t.length)return e([]);for(var s=t.length,a=0;a<t.length;a++)i(a,t[a])}))},a.resolve=function(e){return e&&"object"==typeof e&&e.constructor===a?e:new a((function(t){t(e)}))},a.reject=function(e){return new a((function(t,n){n(e)}))},a.race=function(e){return new a((function(t,n){for(var i=0,s=e.length;i<s;i++)e[i].then(t,n)}))},a._immediateFn="function"==typeof t&&function(e){t(e)}||function(e){d(e,0)},a._unhandledRejectionFn=function(e){"undefined"!=typeof console&&console},a._setImmediateFn=function(e){a._immediateFn=e},a._setUnhandledRejectionFn=function(e){a._unhandledRejectionFn=e},void 0!==e&&e.exports?e.exports=a:n.Promise||(n.Promise=a)}(this)}).call(t,n(18).setImmediate)},function(e,t,n){function i(e,t){this._id=e,this._clearFn=t}var s=Function.prototype.apply;t.setTimeout=function(){return new i(s.call(setTimeout,window,arguments),clearTimeout)},t.setInterval=function(){return new i(s.call(setInterval,window,arguments),clearInterval)},t.clearTimeout=t.clearInterval=function(e){e&&e.close()},i.prototype.unref=i.prototype.ref=function(){},i.prototype.close=function(){this._clearFn.call(window,this._id)},t.enroll=function(e,t){clearTimeout(e._idleTimeoutId),e._idleTimeout=t},t.unenroll=function(e){clearTimeout(e._idleTimeoutId),e._idleTimeout=-1},t._unrefActive=t.active=function(e){clearTimeout(e._idleTimeoutId);var t=e._idleTimeout;t>=0&&(e._idleTimeoutId=setTimeout((function(){e._onTimeout&&e._onTimeout()}),t))},n(19),t.setImmediate=setImmediate,t.clearImmediate=clearImmediate},function(e,t,n){(function(e,t){!function(e,n){function i(e){"function"!=typeof e&&(e=new Function(""+e));for(var t=new Array(arguments.length-1),n=0;n<t.length;n++)t[n]=arguments[n+1];var i={callback:e,args:t};return c[l]=i,r(l),l++}function s(e){delete c[e]}function a(e){var t=e.callback,i=e.args;switch(i.length){case 0:t();break;case 1:t(i[0]);break;case 2:t(i[0],i[1]);break;case 3:t(i[0],i[1],i[2]);break;default:t.apply(n,i)}}function o(e){if(p)setTimeout(o,0,e);else{var t=c[e];if(t){p=!0;try{a(t)}finally{s(e),p=!1}}}}if(!e.setImmediate){var r,l=1,c={},p=!1,h=e.document,d=Object.getPrototypeOf&&Object.getPrototypeOf(e);d=d&&d.setTimeout?d:e,"[object process]"==={}.toString.call(e.process)?r=function(e){t.nextTick((function(){o(e)}))}:function(){if(e.postMessage&&!e.importScripts){var t=!0,n=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=n,t}}()?function(){var t="setImmediate$"+Math.random()+"$",n=function(n){n.source===e&&"string"==typeof n.data&&0===n.data.indexOf(t)&&o(+n.data.slice(t.length))};e.addEventListener?e.addEventListener("message",n,!1):e.attachEvent("onmessage",n),r=function(n){e.postMessage(t+n,"*")}}():e.MessageChannel?function(){var e=new MessageChannel;e.port1.onmessage=function(e){o(e.data)},r=function(t){e.port2.postMessage(t)}}():h&&"onreadystatechange"in h.createElement("script")?function(){var e=h.documentElement;r=function(t){var n=h.createElement("script");n.onreadystatechange=function(){o(t),n.onreadystatechange=null,e.removeChild(n),n=null},e.appendChild(n)}}():r=function(e){setTimeout(o,0,e)},d.setImmediate=i,d.clearImmediate=s}}("undefined"==typeof self?void 0===e?this:e:self)}).call(t,n(7),n(20))},function(e,t){function n(){throw new Error("setTimeout has not been defined")}function i(){throw new Error("clearTimeout has not been defined")}function s(e){if(p===setTimeout)return setTimeout(e,0);if((p===n||!p)&&setTimeout)return p=setTimeout,setTimeout(e,0);try{return p(e,0)}catch(t){try{return p.call(null,e,0)}catch(t){return p.call(this,e,0)}}}function a(e){if(h===clearTimeout)return clearTimeout(e);if((h===i||!h)&&clearTimeout)return h=clearTimeout,clearTimeout(e);try{return h(e)}catch(t){try{return h.call(null,e)}catch(t){return h.call(this,e)}}}function o(){f&&u&&(f=!1,u.length?g=u.concat(g):_=-1,g.length&&r())}function r(){if(!f){var e=s(o);f=!0;for(var t=g.length;t;){for(u=g,g=[];++_<t;)u&&u[_].run();_=-1,t=g.length}u=null,f=!1,a(e)}}function l(e,t){this.fun=e,this.array=t}function c(){}var p,h,d=e.exports={};!function(){try{p="function"==typeof setTimeout?setTimeout:n}catch(e){p=n}try{h="function"==typeof clearTimeout?clearTimeout:i}catch(e){h=i}}();var u,g=[],f=!1,_=-1;d.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];g.push(new l(e,t)),1!==g.length||f||s(r)},l.prototype.run=function(){this.fun.apply(null,this.array)},d.title="browser",d.browser=!0,d.env={},d.argv=[],d.version="",d.versions={},d.on=c,d.addListener=c,d.once=c,d.off=c,d.removeListener=c,d.removeAllListeners=c,d.emit=c,d.prependListener=c,d.prependOnceListener=c,d.listeners=function(e){return[]},d.binding=function(e){throw new Error("process.binding is not supported")},d.cwd=function(){return"/"},d.chdir=function(e){throw new Error("process.chdir is not supported")},d.umask=function(){return 0}},function(e,t,n){n(22).polyfill()},function(e,t,n){function i(e,t){if(null==e)throw new TypeError("Cannot convert first argument to object");for(var n=Object(e),i=1;i<arguments.length;i++){var s=arguments[i];if(null!=s)for(var a=Object.keys(Object(s)),o=0,r=a.length;o<r;o++){var l=a[o],c=Object.getOwnPropertyDescriptor(s,l);void 0!==c&&c.enumerable&&(n[l]=s[l])}}return n}function s(){Object.assign||Object.defineProperty(Object,"assign",{enumerable:!1,configurable:!0,writable:!0,value:i})}e.exports={assign:i,polyfill:s}},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var i=n(24),s=n(6),a=n(5),o=n(36),r=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if("undefined"!=typeof window){var n=o.getOpts.apply(void 0,e);return new Promise((function(e,t){a.default.promise={resolve:e,reject:t},i.default(n),setTimeout((function(){s.openModal()}))}))}};r.close=s.onAction,r.getState=s.getState,r.setActionValue=a.setActionValue,r.stopLoading=s.stopLoading,r.setDefaults=o.setDefaults,t.default=r},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var i=n(1),s=n(0).default.MODAL,a=n(4),o=n(34),r=n(35),l=n(1);t.init=function(e){i.getNode(s)||(document.body||l.throwErr("You can only use SweetAlert AFTER the DOM has loaded!"),o.default(),a.default()),a.initModalContent(e),r.default(e)},t.default=t.init},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var i=n(0).default.MODAL;t.modalMarkup='\n  <div class="'+i+'" role="dialog" aria-modal="true"></div>',t.default=t.modalMarkup},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var i='<div \n    class="'+n(0).default.OVERLAY+'"\n    tabIndex="-1">\n  </div>';t.default=i},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var i=n(0).default.ICON;t.errorIconMarkup=function(){var e=i+"--error",t=e+"__line";return'\n    <div class="'+e+'__x-mark">\n      <span class="'+t+" "+t+'--left"></span>\n      <span class="'+t+" "+t+'--right"></span>\n    </div>\n  '},t.warningIconMarkup=function(){var e=i+"--warning";return'\n    <span class="'+e+'__body">\n      <span class="'+e+'__dot"></span>\n    </span>\n  '},t.successIconMarkup=function(){var e=i+"--success";return'\n    <span class="'+e+"__line "+e+'__line--long"></span>\n    <span class="'+e+"__line "+e+'__line--tip"></span>\n\n    <div class="'+e+'__ring"></div>\n    <div class="'+e+'__hide-corners"></div>\n  '}},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var i=n(0).default.CONTENT;t.contentMarkup='\n  <div class="'+i+'">\n\n  </div>\n'},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var i=n(0),s=i.default.BUTTON_CONTAINER,a=i.default.BUTTON,o=i.default.BUTTON_LOADER;t.buttonMarkup='\n  <div class="'+s+'">\n\n    <button\n      class="'+a+'"\n    ></button>\n\n    <div class="'+o+'">\n      <div></div>\n      <div></div>\n      <div></div>\n    </div>\n\n  </div>\n'},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var i=n(4),s=n(2),a=n(0),o=a.default.ICON,r=a.default.ICON_CUSTOM,l=["error","warning","success","info"],c={error:s.errorIconMarkup(),warning:s.warningIconMarkup(),success:s.successIconMarkup()},p=function(e,t){var n=o+"--"+e;t.classList.add(n);var i=c[e];i&&(t.innerHTML=i)},h=function(e,t){t.classList.add(r);var n=document.createElement("img");n.src=e,t.appendChild(n)},d=function(e){if(e){var t=i.injectElIntoModal(s.iconMarkup);l.includes(e)?p(e,t):h(e,t)}};t.default=d},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var i=n(2),s=n(4),a=function(e){navigator.userAgent.includes("AppleWebKit")&&(e.style.display="none",e.offsetHeight,e.style.display="")};t.initTitle=function(e){if(e){var t=s.injectElIntoModal(i.titleMarkup);t.textContent=e,a(t)}},t.initText=function(e){if(e){var t=document.createDocumentFragment();e.split("\n").forEach((function(e,n,i){t.appendChild(document.createTextNode(e)),n<i.length-1&&t.appendChild(document.createElement("br"))}));var n=s.injectElIntoModal(i.textMarkup);n.appendChild(t),a(n)}}},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var i=n(1),s=n(4),a=n(0),o=a.default.BUTTON,r=a.default.DANGER_BUTTON,l=n(3),c=n(2),p=n(6),h=n(5),d=function(e,t,n){var s=t.text,a=t.value,d=t.className,u=t.closeModal,g=i.stringToNode(c.buttonMarkup),f=g.querySelector("."+o),_=o+"--"+e;f.classList.add(_),d&&(Array.isArray(d)?d:d.split(" ")).filter((function(e){return e.length>0})).forEach((function(e){f.classList.add(e)})),n&&e===l.CONFIRM_KEY&&f.classList.add(r),f.textContent=s;var m={};return m[e]=a,h.setActionValue(m),h.setActionOptionsFor(e,{closeModal:u}),f.addEventListener("click",(function(){return p.onAction(e)})),g},u=function(e,t){var n=s.injectElIntoModal(c.footerMarkup);for(var i in e){var a=e[i],o=d(i,a,t);a.visible&&n.appendChild(o)}0===n.children.length&&n.remove()};t.default=u},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var i=n(3),s=n(4),a=n(2),o=n(5),r=n(6),l=n(0).default.CONTENT,c=function(e){e.addEventListener("input",(function(e){var t=e.target.value;o.setActionValue(t)})),e.addEventListener("keyup",(function(e){if("Enter"===e.key)return r.onAction(i.CONFIRM_KEY)})),setTimeout((function(){e.focus(),o.setActionValue("")}),0)},p=function(e,t,n){var i=document.createElement(t),s=l+"__"+t;for(var a in i.classList.add(s),n){var o=n[a];i[a]=o}"input"===t&&c(i),e.appendChild(i)},h=function(e){if(e){var t=s.injectElIntoModal(a.contentMarkup),n=e.element,i=e.attributes;"string"==typeof n?p(t,n,i):t.appendChild(n)}};t.default=h},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var i=n(1),s=n(2),a=function(){var e=i.stringToNode(s.overlayMarkup);document.body.appendChild(e)};t.default=a},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var i=n(5),s=n(6),a=n(1),o=n(3),r=n(0),l=r.default.MODAL,c=r.default.BUTTON,p=r.default.OVERLAY,h=function(e){e.preventDefault(),_()},d=function(e){e.preventDefault(),m()},u=function(e){if(i.default.isOpen&&"Escape"===e.key)return s.onAction(o.CANCEL_KEY)},g=function(e){if(i.default.isOpen&&"Tab"===e.key)return h(e)},f=function(e){if(i.default.isOpen)return"Tab"===e.key&&e.shiftKey?d(e):void 0},_=function(){var e=a.getNode(c);e&&(e.tabIndex=0,e.focus())},m=function(){var e=a.getNode(l).querySelectorAll("."+c),t=e[e.length-1];t&&t.focus()},v=function(e){e[e.length-1].addEventListener("keydown",g)},y=function(e){e[0].addEventListener("keydown",f)},b=function(){var e=a.getNode(l).querySelectorAll("."+c);e.length&&(v(e),y(e))},w=function(e){if(a.getNode(p)===e.target)return s.onAction(o.CANCEL_KEY)},k=function(e){var t=a.getNode(p);t.removeEventListener("click",w),e&&t.addEventListener("click",w)},L=function(e){i.default.timer&&clearTimeout(i.default.timer),e&&(i.default.timer=window.setTimeout((function(){return s.onAction(o.CANCEL_KEY)}),e))},A=function(e){e.closeOnEsc?document.addEventListener("keyup",u):document.removeEventListener("keyup",u),e.dangerMode?_():m(),b(),k(e.closeOnClickOutside),L(e.timer)};t.default=A},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var i=n(1),s=n(3),a=n(37),o=n(38),r={title:null,text:null,icon:null,buttons:s.defaultButtonList,content:null,className:null,closeOnClickOutside:!0,closeOnEsc:!0,dangerMode:!1,timer:null},l=Object.assign({},r);t.setDefaults=function(e){l=Object.assign({},r,e)};var c=function(e){var t=e&&e.button,n=e&&e.buttons;return void 0!==t&&void 0!==n&&i.throwErr("Cannot set both 'button' and 'buttons' options!"),void 0!==t?{confirm:t}:n},p=function(e){return i.ordinalSuffixOf(e+1)},h=function(e,t){i.throwErr(p(t)+" argument ('"+e+"') is invalid")},d=function(e,t){var n=e+1,s=t[n];i.isPlainObject(s)||void 0===s||i.throwErr("Expected "+p(n)+" argument ('"+s+"') to be a plain object")},u=function(e,t){var n=e+1,s=t[n];void 0!==s&&i.throwErr("Unexpected "+p(n)+" argument ("+s+")")},g=function(e,t,n,s){var a=t instanceof Element;if("string"==typeof t){if(0===n)return{text:t};if(1===n)return{text:t,title:s[0]};if(2===n)return d(n,s),{icon:t};h(t,n)}else{if(a&&0===n)return d(n,s),{content:t};if(i.isPlainObject(t))return u(n,s),t;h(t,n)}};t.getOpts=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n={};e.forEach((function(t,i){var s=g(0,t,i,e);Object.assign(n,s)}));var i=c(n);n.buttons=s.getButtonListOpts(i),delete n.button,n.content=a.getContentOpts(n.content);var p=Object.assign({},r,l,n);return Object.keys(p).forEach((function(e){o.DEPRECATED_OPTS[e]&&o.logDeprecation(e)})),p}},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var i=n(1),s={element:"input",attributes:{placeholder:""}};t.getContentOpts=function(e){var t={};return i.isPlainObject(e)?Object.assign(t,e):e instanceof Element?{element:e}:"input"===e?s:null}},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.logDeprecation=function(e){var n=t.DEPRECATED_OPTS[e];n.onlyRename,n.replacement,n.subOption,n.link},t.DEPRECATED_OPTS={type:{replacement:"icon",link:"/docs/#icon"},imageUrl:{replacement:"icon",link:"/docs/#icon"},customClass:{replacement:"className",onlyRename:!0,link:"/docs/#classname"},imageSize:{},showCancelButton:{replacement:"buttons",link:"/docs/#buttons"},showConfirmButton:{replacement:"button",link:"/docs/#button"},confirmButtonText:{replacement:"button",link:"/docs/#button"},confirmButtonColor:{},cancelButtonText:{replacement:"buttons",link:"/docs/#buttons"},closeOnConfirm:{replacement:"button",subOption:"closeModal",link:"/docs/#button"},closeOnCancel:{replacement:"buttons",subOption:"closeModal",link:"/docs/#buttons"},showLoaderOnConfirm:{replacement:"buttons"},animation:{},inputType:{replacement:"content",link:"/docs/#content"},inputValue:{replacement:"content",link:"/docs/#content"},inputPlaceholder:{replacement:"content",link:"/docs/#content"},html:{replacement:"content",link:"/docs/#content"},allowEscapeKey:{replacement:"closeOnEsc",onlyRename:!0,link:"/docs/#closeonesc"},allowClickOutside:{replacement:"closeOnClickOutside",onlyRename:!0,link:"/docs/#closeonclickoutside"}}}])})),swal=getDefaultExportFromCjs(sweetalert_min);class confirmDialog{async alert(e,t){let n=e;t&&(n=n+"\n"+t),await swal("Server error",n)}}const subscriber_queue=[];function writable(e,t=noop){let n;const i=new Set;function s(t){if(safe_not_equal(e,t)&&(e=t,n)){const t=!subscriber_queue.length;for(const t of i)t[1](),subscriber_queue.push(t,e);if(t){for(let e=0;e<subscriber_queue.length;e+=2)subscriber_queue[e][0](subscriber_queue[e+1]);subscriber_queue.length=0}}}return{set:s,update:function(t){s(t(e))},subscribe:function(a,o=noop){const r=[a,o];return i.add(r),1===i.size&&(n=t(s)||noop),a(e),()=>{i.delete(r),0===i.size&&n&&(n(),n=null)}}}}let transferStore=writable();const tasksStore=writable([]);let readyToLoadStore=writable();class Gyre{getWeightsArray(e){let t=[],n=e.split(/(\([^)]+\))/);for(let e=0;e<n.length;e++){let i=n[e].trim();if(i){let e={prompt:i};t.push(e)}}for(let e=0;e<t.length;e++){let n=t[e],i=n.prompt;if(i.search(/\([^)]+\)/))i=i.replace(/\)/g,""),n.prompt=i,n.weight=1;else{let e,t=i.split("(").length;t>2&&(e=(t-1)/10),i=i.replace(/\(/g,""),i=i.replace(/\)/g,"");let s=i.split(":");e||(e=s[1]),e||(e=1),n.weight=parseFloat(e),n.prompt=s[0]}}return t}strip(e,t){for(;e.length>0&&-1!=t.indexOf(e.charAt(0));)e=e.substr(1);for(;e.length>0&&-1!=t.indexOf(e.charAt(e.length-1));)e=e.substr(0,e.length-1);return e}constructor(){window.onlyonegrpclocal=!1}getStatus(){return this.status}async runSD(e,t){e.url=new URL(e.url).origin,e.url.endsWith("/")?e.url.slice(0,-1):e.url,this.status="waiting";let n=await this.checkNewServer(e);if(window.onlyonegrpclocal=!n,window.onlyonegrpclocal&&window.requestlocalgrpcprocessing&&1==window.requestlocalgrpcprocessing)return;let i=[];t.seedList=[];let s=0;e.model||(e.model="stable-diffusion-v1-5"),"stable-diffusion-v1-5-standard"===e.model&&(e.model="stable-diffusion-v1-5");let a=await this.getModels(e);if(!a)return void(this.status="error");let o=!1;for(let t=0;t<a.length;t++){a[t].id===e.model&&(o=!0)}if(!o&&"removeBackground"!==t.mode)return await(new confirmDialog).alert("Model "+e.model+" not found. Please select model in configuration."),void(this.status="error");this.requestTemplate.engineId=e.model,this.requestTemplate.requestId=Math.floor(1e12*Math.random())+"";let r=[],l=this.getWeightsArray(t.prompt);for(let e=0;e<l.length;e++){let t=l[e];t.prompt&&r.push({text:t.prompt,parameters:{weight:t.weight}})}t.negativePrompt&&r.push({text:t.negativePrompt,parameters:{weight:-1}});let c=Math.random().toString(),p={};if(t.specialLayersImageInfo)for(let e of t.specialLayersImageInfo)e.type;if(t.image64&&(p={parameters:{init:!0}},p.artifact={uuid:c,type:"ARTIFACT_IMAGE",binary:t.image64},"img2img"!==t.mode&&"inpainting"!==t.mode&&"upscale"!==t.mode||r.push(p)),"removeBackground"===t.mode&&(this.requestTemplate.engineId="noop",p.artifact.adjustments=[{background_removal:{}}],r=[p]),"autoMatte"===t.mode){this.requestTemplate.engineId="noop";let e=[],n=0;t.erode&&(n=t.erode),t.rectangleList&&e.push({loi:{rectangles:t.rectangleList}}),t.pointList&&e.push({loi:{points:t.pointList}}),p.artifact.adjustments=[{mask_predict:{behaviour:0,mode:0,prompt:e,erode:n}}],r=[p]}if("upscale"===t.mode&&(this.requestTemplate.engineId=t.upscaleEngine,"upscale"===t.prompt&&(r=[p])),"inpainting"==t.mode||"inpainting_original"==t.mode)if(t.maskImage64){let e={artifact:{type:"ARTIFACT_MASK"}};e.artifact.adjustments=[{levels:{inputLow:0,inputHigh:.01,outputLow:0,outputHigh:1}}],e.artifact.adjustments.push({blur:{sigma:32,direction:"DIRECTION_UP"}}),e.artifact.binary=t.maskImage64,r.push(e)}else{let e={artifact:{type:"ARTIFACT_MASK"}};e.artifact.adjustments=[{channels:{r:"CHANNEL_A",a:"CHANNEL_ONE"}}],e.artifact.adjustments.push({invert:{}}),e.artifact.adjustments.push({blur:{sigma:32,direction:"DIRECTION_UP"}}),e.artifact.binary=t.image64,r.push(e)}if(t.specialLayersImageInfo)for(let e of t.specialLayersImageInfo){let t={type:"ARTIFACT_HINT_IMAGE",mime:"image/png"};"skribble"===e.type&&(t.hint_image_type="sketch"),e.parameters&&e.parameters.method&&"T2I Adapter"===e.parameters.method&&(t.hint_image_type="coadapter/sketch"),"segmentation"===e.type&&(t.hint_image_type="segmentation/ade20k"),"posenet"===e.type&&(t.hint_image_type="openpose"),"depth"===e.type&&(t.hint_image_type="depth"),"inpaint"===e.type&&(t.hint_image_type="inpaint"),"image"===e.type&&"canny_edge"===e.preprocessorType&&(t.hint_image_type="controlnet/canny",e.parameters&&e.parameters.method&&"T2I Adapter"===e.parameters.method&&(t.hint_image_type="coadapter/canny"),t.adjustments=[{canny_edge:{low_threshold:parseFloat(e.parameters.low_threshold),high_threshold:parseFloat(e.parameters.high_threshold)}}]),"image"===e.type&&"depth"===e.preprocessorType&&(t.hint_image_type="depth",t.adjustments=[{depth:{}}],e.parameters&&e.parameters.method&&"T2I Adapter"===e.parameters.method&&(t.hint_image_type="coadapter/depth")),"image"===e.type&&"hed"===e.preprocessorType&&(t.hint_image_type="hed",t.adjustments=[{edge_detection:{}}]),"image"===e.type&&"lineart"===e.preprocessorType&&(t.hint_image_type="lineart",t.adjustments=[{edge_detection:{},engine_id:"hinters-lineart-anime"}]),"image"===e.type&&"pix2pix"===e.preprocessorType&&(t.hint_image_type="pix2pix"),"image"===e.type&&"shuffle"===e.preprocessorType&&(t.hint_image_type="shuffle",t.adjustments=[{shuffle:{}}]),"image"===e.type&&"normal"===e.preprocessorType&&(t.hint_image_type="normal",t.adjustments=[{normal:{background_threshold:-1,preblur:0,postblur:5,smoothing:.8}}]),"image"===e.type&&"segmentation"===e.preprocessorType&&(t.hint_image_type="segmentation/ade20k",t.adjustments=[{segmentation:{}}]),"image"===e.type&&"posenet"===e.preprocessorType&&(t.hint_image_type="openpose",t.adjustments=[{openpose:{}}]),e.parameters&&e.parameters.preprocessor&&"normal"!==e.parameters.preprocessor&&("skip"===e.parameters.preprocessor&&(t.adjustments=[]),"only"===e.parameters.preprocessor&&(t.type="ARTIFACT_IMAGE",this.requestTemplate.engineId="noop",t.adjustments.push({invert:{}}))),"image"===e.type&&"style"===e.preprocessorType&&(t.hint_image_type="style",e.parameters&&e.parameters.method&&"T2I Adapter"===e.parameters.method&&(t.hint_image_type="coadapter/style")),t.binary=e.base64;let n=1,i=0;if(e.parameters&&e.parameters.weight&&(n=e.parameters.weight),e.parameters&&e.parameters.control_mode)switch(e.parameters.control_mode){case"Balanced":i=0;break;case"My prompt is more important":i=1;break;case"ControlNet is more important":i=2}"inpaint"===e.type&&(i=2);let s={artifact:t,parameters:{weight:n,hint_priority:i}};r.push(s)}if(t.loraList&&"upscale"!==t.mode&&"autoMatte"!==t.mode&&"removeBackground"!==t.mode&&"inpainting"!==t.mode)for(let e of t.loraList){let t={artifact:{type:"ARTIFACT_LORA",url:e.url},parameters:{weight:e.weight}};r.push(t)}this.requestTemplate.prompt=r;let h=parseInt(e.width),d=parseInt(e.height),u={};"upscale"!==t.mode&&(u.width=h,u.height=d,t.targetWidth&&t.targetHeight&&(u.width=parseInt(t.targetWidth),u.height=parseInt(t.targetHeight))),t.seed&&(u.seed=[t.seed]),u.steps=parseInt(t.steps),u.samples=parseInt(t.num),u.hires={enable:!1},(u.width>512||u.height>512)&&(u.hires={enable:!0}),t.tiling&&(u.tiling=!0),u.transform={diffusion:{DDIM:"SAMPLER_DDIM",PLMS:"SAMPLER_DDPM",Euler:"SAMPLER_K_EULER","Euler a":"SAMPLER_K_EULER_ANCESTRAL",Heun:"SAMPLER_K_HEUN",DPM2:"SAMPLER_K_DPM_2","DPM2 a":"SAMPLER_K_DPM_2_ANCESTRAL",LMS:"SAMPLER_K_LMS","DPMSolver++ 1 Order":"SAMPLER_DPMSOLVERPP_1ORDER","DPMSolver++ 2 Order":"SAMPLER_DPMSOLVERPP_2ORDER","DPMSolver++ 3 Order":"SAMPLER_DPMSOLVERPP_3ORDER","DPM Fast":"SAMPLER_DPM_FAST","DPM Adaptive":"SAMPLER_DPM_ADAPTIVE","DPMSolver++ 2S a":"SAMPLER_DPMSOLVERPP_2S_ANCESTRAL","DPMSolver++ SDE":"SAMPLER_DPMSOLVERPP_SDE","DPMSolver++ 2M":"SAMPLER_DPMSOLVERPP_2M","DPMSolver++ 2M (Fast)":"SAMPLER_DPMSOLVERPP_2M"}[t.sampling_method]};let g,f,_={scaledStep:0,sampler:{cfgScale:parseFloat(t.cfg_value)}};if("DPMSolver++ 2M (Fast)"===t.sampling_method&&(_.sampler.sigma={sigmaMin:.1072,karrasRho:9}),t.image64||t.maskImage64){let e={};t.strength||(t.strength=.5),t.maskImage64?e.start=1:e.start=parseFloat(t.strength),t.inpainting_original&&(e.start=parseFloat(t.strength)),_.schedule=e}try{t.clip&&(_.guidance={guidancePreset:"GUIDANCE_PRESET_NONE"},_.guidance.instances=[{guidanceStrength:.25}])}catch(e){}u.parameters=[_],this.requestTemplate.image=u,f=await this.postRest(e,"asyncGenerate",this.requestTemplate),f.requestId=this.requestTemplate.requestId,window.asyncHandleobjList||(window.asyncHandleobjList=[]),window.asyncHandleobjList.push({...f,taskid:t.taskid});let m=!1;for(;!m;){if(window.asyncHandleobjList.find((e=>e.requestId==f.requestId&&e.canceled)))break;try{g=await this.postRest(e,"asyncResult",f)}catch(e){throw g={error:!0,complete:!0},e}g&&g.answer&&g.answer.length&&(m=!0),m||await new Promise((e=>setTimeout(e,1e3)))}return g.complete||(window.postMessageAdapter||t.aistudio?this.getAllOtherImagesStudio(e,t,f):this.getAllOtherImages(e,t,f)),g.answer&&(g=g.answer),window.onlyonegrpclocal&&(window.requestlocalgrpcprocessing=!1,readyToLoadStore.set({ready:!0})),Array.isArray(g)||(g=[g]),g.forEach((e=>{e.artifacts&&(e.artifacts.forEach((({type:e,binary:n,seed:a})=>{if("ARTIFACT_IMAGE"===e){a||(a=s),t.seedList[s]=a;let e={base64:n};e.seed=t.seedList[s],i.push(e),s++}})),this.status="ready")})),i}getAllOtherImagesStudio(e,t,n){let i=this,s=t.taskid;!async function(){let t=!1;for(;!t;){await new Promise((e=>setTimeout(e,1e3)));let a=window.asyncHandleobjList.find((e=>e.requestId==n.requestId&&e.canceled));if(a)break;let o=await i.postRest(e,"asyncResult",n);a=window.asyncHandleobjList.find((e=>e.requestId==n.requestId&&e.canceled));let r=!!a;if(o){if(o.answer){let e={taskid:s,answers:o};r&&(e.canceledrequest=!0),transferStore.set(e)}o.complete&&(t=!0)}}}()}async cancelRequest(e,t){if(!window.asyncHandleobjList||!window.asyncHandleobjList.length)return;let n,i=window.asyncHandleobjList.find((e=>e.taskid==t));i.canceled=!0;try{n=await this.postRest(e,"asyncCancel",{requestId:i.requestId,asyncHandle:i.asyncHandle})}catch(e){await(new confirmDialog).alert(e.toString())}}getAllOtherImages(e,t,n){let i=this,s=t.taskid;!async function(){let t,a,o=!1;for(;!o;){if(await new Promise((e=>setTimeout(e,1e3))),window.asyncHandleobjList.find((e=>e.requestId==n.requestId&&e.canceled)))break;try{t=await i.postRest(e,"asyncResult",n)}catch(e){await(new confirmDialog).alert(e.toString()),o=!0}if(!t.answer)continue;a=get_store_value(tasksStore);let r=0,l=a.find(((e,t)=>(r=t,e.p.taskid==s)));if(!l)continue;let c=t.answer.map((e=>{let t=e.artifacts[0];return{base64:"data:image/png;base64,"+t.binary,seed:t.seed}}));l.imagelist=[...l.imagelist,...c],t.complete&&(o=!0,l.complete=!0),a[r]=l,tasksStore.set(a)}}()}getSpecialFeatures(e,t){let n=["canny","style","skribble","depth","normal","hed","posenet","segmentation","shuffle","pix2pix","normal","T2I_ControlNet_canny_switch","pix2pix","backgroundRemoval","text","control_mode"],i=[];if(!e.acceptedHintTypes)return t?n:i;for(let t of e.acceptedHintTypes)for(let e of n){let n=e;"skribble"===e&&(n="scribble"),"posenet"===e&&(n="openpose"),t.type===n&&(i.push(e),"canny"===n&&i.push("T2I_ControlNet_canny_switch"),"scribble"===n&&i.push("text"))}return i&&(i.push("backgroundRemoval"),i.push("control_mode")),i}async getServerFeatures(e){try{let t,n=await this.getModels(e);if(!n)return!1;t=await this.postRest(e,"engines",{task_group:"UPSCALE"},!0);let i={},s=!1;for(let a=0;a<n.length;a++){let o=n[a];o.id===e.model&&(i={artifacts:o.acceptedPromptArtifacts,models:n,model:o.id,upscalers:t,features:this.getSpecialFeatures(o,t)},s=!0)}if(s)return i;let a=n[0];return!!a&&(i={artifacts:a.acceptedPromptArtifacts,models:n,model:a.id,upscalers:t,features:this.getSpecialFeatures(a,t)},i)}catch(e){return!1}}async postRest(e,t,n,i=!1){e.url=new URL(e.url).origin,e.url.endsWith("/")?e.url.slice(0,-1):e.url;let s="";e.token&&(s="/"+e.token);let a,o,r,l=e.url+s+"/grpcgateway/"+t;e.token&&(s=e.token);try{r=await fetch(l,{headers:{"Content-Type":"application/json",Accept:"application/json","Bypass-Tunnel-Reminder":"true"},method:"POST",body:JSON.stringify(n)}),o=await r.text();try{a=JSON.parse(o)}catch(e){throw SyntaxError(e)}if(r.status>400)throw o=a.name+" "+a.messsage,SyntaxError();return a||!1}catch(e){if(i)return;if(e instanceof SyntaxError){let t;throw o&&(t=o.replace(/<[^>]+>/g,"")),!t&&r.statusText&&(t="Server error: "+r.statusText),t||(t=e.toString()),await(new confirmDialog).alert(t),e}throw await(new confirmDialog).alert(e.toString()),this.status="error",e}}async getModels(e){let t;e.url=new URL(e.url).origin,e.url.endsWith("/")?e.url.slice(0,-1):e.url;let n="";e.token&&(n="/"+e.token);let i,s,a=e.url+n+"/grpcgateway/engines";try{s=await fetch(a,{headers:{"Content-Type":"application/json",Accept:"application/json","Bypass-Tunnel-Reminder":"true"},method:"get"}),t=await s.text();try{i=JSON.parse(t)}catch(e){throw SyntaxError(e)}if(i.engine){let e=[];for(let t=0;t<i.engine.length;t++){let n=i.engine[t];"PICTURE"===n.type&&e.push(n)}return e}return!1}catch(e){if(!(e instanceof SyntaxError))throw await(new confirmDialog).alert(e.toString()),this.status="error",e;{let n;t&&(n=t.replace(/<[^>]+>/g,"")),!n&&s.statusText&&(n="Server error: "+s.statusText),n||(n=e.toString()),await(new confirmDialog).alert(n)}}}async checkNewServer(e){return await this.getModels(e)}requestTemplate={}}class gyreDocument{constructor(){this.prompt="",this.modifiers="",this.presetName="",this.layers=[],this.width=this.height=1024,this.id=1}setPrompt(e){this.prompt=e}setModifiers(e,t){this.modifiers=e,this.presetName=t}setDefaultModifier(){this.modifiers="rawphoto of a...\n#-text\n-b&amp;w\n-bad art\n-poorly drawn\n-naked\n-close up\n-blurry\n-disfigured\n-bad anatomy\n-deformed\n-extra limbs\n-ugly\n-nude\nbeautiful\nhighly detailed\ncinematic\n#fujifilm\n#lora:https://civitai.com/api/download/models/16576:1\n#fuji",this.presetName="Cinematic"}layerImageEmpty(){return this.layerImage(1024,1024,"Background Image","data:image/webp;base64,UklGRqQJAABXRUJQVlA4WAoAAAAwAAAA/wMA/wMASUNDUMgBAAAAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADZBTFBIPAAAAAEHEBEREAgk+5tPUET/M/7zn//85z//+c9//vOf//znP//5z3/+85///Oc///nPf/7zn//85z//+c//DVZQOCByBwAAkN8AnQEqAAQABD5tNplJpCMioSAIAIANiWlu4XdhG0AJ7APfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99qwAP7/6wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==")}layer(e,t,n=0,i=0){return n&&(this.width=n,this.height=i),{id:this.id++,name:t,type:e,width:this.width,height:this.height,x:0,y:0,visible:!0}}layerImage(e,t,n,i){let s=this.layer("image",n,e,t);return s.url=i,s}async layerText(e=1024,t=1024,n="Text",i,s,a,o,r=0){let l=this.layer("text",n,e,t);return l.background_type="transparent",i&&(l.data=await i.getScene()),l.font_size=s,l.string=a,l.letter_spacing=r,l.font=o,l}async layer3D(e=1024,t=1024,n="3D Scene",i){let s=this.layer("3d",n,e,t);return s.background_type="transparent",i&&(s.data=await i.getScene()),s}async layerPose(e=1024,t=1024,n="Pose",i){let s=this.layer("posenet",n,e,t);return s.background_type="transparent",s.show_character="human",i&&(s.data=await i.getScene()),s}setToolsLayers(e=0,t=0,n=1024,i=1024){i>this.height&&(i=this.height),n>this.width&&(n=this.width),this.toolsLayers=[{id:"inpaintingBrush",type:"inpaintingBrush"},{id:"aiWindow",type:"generationWindow",x:e,y:t,width:n,height:i,dragRestriction:!0,resizeRestriction:{width:1024,height:1024}},{id:"aiSelection",type:"aiSelection",x:0,y:0,width:512,height:512}]}extendImage(e){let t=this.width,n=this.height;"right"===e&&(this.width+=t/2,this.setToolsLayers(t/2,0,t,n)),"bottom"===e&&(this.height+=n/2,this.setToolsLayers(0,n,t,n)),"left"===e&&(this.width+=t/2,this.setToolsLayers(0,0,t,n),this.layers[0].x=t/2),"top"===e&&(this.height+=n/2,this.setToolsLayers(0,0,t,n),this.layers[0].y=n/2)}setMode(e){this.mode=e}make(){let e={prompt:this.prompt,modifiers:this.modifiers,presetName:this.presetName},t={layers:this.layers.reverse(),document:{width:this.width,height:this.height},toolsLayers:this.toolsLayers,promptInfo:e};return this.mode&&(t.setMode=this.mode),t}async fromWizard(e){return e.image.base64?this.layers.push(this.layerImage(e.image.width,e.image.height,e.image.name,e.image.base64)):this.layers.push(this.layerImageEmpty()),e.background.base64&&(this.layers.push(this.layerImage(e.image.width,e.image.height,e.image.name,e.background.base64)),this.layers[0].visible=!1,this.layers[1].subType="background",this.setMode("generationWindow")),e.prompt&&this.setPrompt(e.prompt.text),e.modifierInfo&&this.setModifiers(e.modifierInfo.modifiers,e.modifierInfo.presetName),e.scene3d.component&&this.layers.push(await this.layer3D(e.scene3d.width,e.scene3d.height,"3D Scene",e.scene3d.component)),e.pose.component&&this.layers.push(await this.layerPose(e.pose.width,e.pose.height,"Pose",e.pose.component)),"text"===e.type&&e.text.component&&(this.layers.push(await this.layerText(1024,1024,"Text",e.text.component,e.text.font_size,e.text.string,e.text.font)),this.setMode("generationWindow")),"txt2img"!==e.type?this.setDefaultModifier():this.setMode("generationWindow"),this.layers[this.layers.length-1].selected=!0,this.setToolsLayers(),"outpainting"===e.type&&e.outpainting.direction&&(this.extendImage(e.outpainting.direction),this.setMode("generationWindow")),this.make()}}let wizards={"3d":{description:"Add an 3D object to the scene as guide for the AI",steps:[{text:"Image",type:"selectImage"},{text:"Object",type:"select3D"},{text:"Prompt",type:"prompt",promptTitle:"Describe object"}]},pose:{description:"Add a character to the scene as guide for the AI",steps:[{text:"Image",type:"selectImage"},{text:"Pose",type:"selectPose"},{text:"Prompt",type:"prompt",promptTitle:"Describe character (e.g. fashion model, construction worker, robot)"}]},text:{description:"AI generated text",steps:[{text:"Text",type:"text"},{text:"Font",type:"font"},{text:"Prompt",type:"prompt",promptTitle:"Describe text"}]},txt2img:{description:"Text to image",steps:[{text:"Prompt",type:"prompt",promptTitle:"Describe what you want to see"},{text:"Style",type:"selectModifier"}]},outpainting:{description:"Generative extend image via Outpainting",steps:[{text:"Image",type:"selectImage"},{text:"Direction",type:"outpainting"},{text:"Prompt",type:"prompt",promptTitle:"Optional: Describe new part"}]},background:{description:"Generative extend image via Outpainting",steps:[{text:"Image",type:"selectImage"},{text:"Removing background",type:"removeBackground"},{text:"Prompt",type:"prompt",promptTitle:"Describe new background"}]}};function get_each_context$1(e,t,n){const i=e.slice();return i[99]=t[n],i}function get_each_context_1(e,t,n){const i=e.slice();return i[102]=t[n],i}function get_each_context_2(e,t,n){const i=e.slice();return i[105]=t[n],i}function create_if_block$1(e){let t,n,i,s,a,o,r,l,c,p,h,d,u,g,f,_,m,v,y,b,w,k,L,A,x,C,T,G,O,E,N,S,I,D,M,P,R,H,F,B,j,z="wizard"===e[32]&&e[22]&&e[24]&&!e[33]&&create_if_block_18(e),$="newDocument"===e[32]&&create_if_block_17(e),U=e[33]&&create_if_block_8(e),q=create_if_block_2$1(e),W=e[16]&&create_if_block_1$1(e);return{c(){t=element("div"),n=element("div"),i=element("div"),i.innerHTML='<img src="appdata/logo4.png" class="logo" alt="Gyre AI Logo"/> Gyre AI',s=space(),a=element("div"),o=element("div"),r=element("span"),r.textContent="Profile",l=space(),c=element("div"),c.textContent="Community",p=space(),h=element("div"),h.textContent="Quick Start",d=space(),u=element("div"),u.textContent="Tutorials",g=space(),f=element("div"),_=element("label"),_.textContent="Import",m=space(),v=element("input"),y=space(),b=element("div"),b.textContent="My files",w=space(),k=element("div"),k.textContent="+",L=space(),A=element("div"),z&&z.c(),x=space(),$&&$.c(),C=space(),U&&U.c(),T=space(),G=element("fds-image-editor-dialog"),q&&q.c(),E=space(),N=element("fds-posenet-select"),I=space(),D=element("fds-search-models-3d"),P=space(),R=element("fds-search-models-3d"),F=space(),W&&W.c(),attr(i,"class","topLogo"),toggle_class(r,"red",!e[8]),toggle_class(o,"active","profile"===e[32]),attr(c,"href","https://discord.gg/FjSA36bR"),attr(c,"class","link"),toggle_class(h,"active","quickStart"===e[32]),toggle_class(u,"active","tutorials"===e[32]),attr(_,"for","file-selector"),attr(_,"class","bw_button menuItem"),attr(v,"type","file"),attr(v,"id","file-selector"),attr(v,"accept","*"),set_style(v,"width","0.1px"),set_style(v,"height","0.1px"),set_style(v,"opacity","0"),set_style(v,"overflow","hidden"),set_style(v,"position","absolute"),set_style(v,"z-index","-1"),toggle_class(b,"active","myFiles"===e[32]),attr(k,"class","new"),toggle_class(k,"active","newDocument"===e[32]),attr(a,"class","rightMenu"),toggle_class(a,"fadeOut",fadeOut),attr(n,"class","topMenu"),attr(A,"class","content"),toggle_class(A,"contentDark",fadeOut),set_custom_element_data(G,"showclose","false"),set_custom_element_data(G,"width","600px"),set_custom_element_data(G,"open",e[3]),set_custom_element_data(G,"onclosed",O=e[92]),set_custom_element_data(N,"posedowloaded",e[40]),set_custom_element_data(N,"onclosed",S=e[93]),set_custom_element_data(N,"open",e[13]),set_custom_element_data(D,"glbbinarydowloaded",e[41]),set_custom_element_data(D,"onclosed",M=e[94]),set_custom_element_data(D,"open",e[14]),set_custom_element_data(R,"glbbinarydowloaded",e[41]),set_custom_element_data(R,"type","primitives"),set_custom_element_data(R,"onclosed",H=e[95]),set_custom_element_data(R,"open",e[15]),attr(t,"class","layers colorScheme startScreen")},m(O,S){insert(O,t,S),append(t,n),append(n,i),append(n,s),append(n,a),append(a,o),append(o,r),append(a,l),append(a,c),append(a,p),append(a,h),append(a,d),append(a,u),append(a,g),append(a,f),append(f,_),append(f,m),append(f,v),append(a,y),append(a,b),append(a,w),append(a,k),append(t,L),append(t,A),z&&z.m(A,null),append(A,x),$&&$.m(A,null),append(A,C),U&&U.m(A,null),append(t,T),append(t,G),q&&q.m(G,null),append(t,E),append(t,N),append(t,I),append(t,D),append(t,P),append(t,R),append(t,F),W&&W.m(t,null),B||(j=[listen(o,"click",e[47]),listen(h,"click",e[50]),listen(u,"click",e[49]),listen(v,"change",e[53]),listen(b,"click",e[48]),listen(k,"click",e[51])],B=!0)},p(e,n){256&n[0]&&toggle_class(r,"red",!e[8]),2&n[1]&&toggle_class(o,"active","profile"===e[32]),2&n[1]&&toggle_class(h,"active","quickStart"===e[32]),2&n[1]&&toggle_class(u,"active","tutorials"===e[32]),2&n[1]&&toggle_class(b,"active","myFiles"===e[32]),2&n[1]&&toggle_class(k,"active","newDocument"===e[32]),"wizard"===e[32]&&e[22]&&e[24]&&!e[33]?z?z.p(e,n):(z=create_if_block_18(e),z.c(),z.m(A,x)):z&&(z.d(1),z=null),"newDocument"===e[32]?$?$.p(e,n):($=create_if_block_17(e),$.c(),$.m(A,C)):$&&($.d(1),$=null),e[33]?U?U.p(e,n):(U=create_if_block_8(e),U.c(),U.m(A,null)):U&&(U.d(1),U=null),q.p(e,n),8&n[0]&&set_custom_element_data(G,"open",e[3]),8&n[0]&&O!==(O=e[92])&&set_custom_element_data(G,"onclosed",O),8192&n[0]&&S!==(S=e[93])&&set_custom_element_data(N,"onclosed",S),8192&n[0]&&set_custom_element_data(N,"open",e[13]),16384&n[0]&&M!==(M=e[94])&&set_custom_element_data(D,"onclosed",M),16384&n[0]&&set_custom_element_data(D,"open",e[14]),32768&n[0]&&H!==(H=e[95])&&set_custom_element_data(R,"onclosed",H),32768&n[0]&&set_custom_element_data(R,"open",e[15]),e[16]?W?W.p(e,n):(W=create_if_block_1$1(e),W.c(),W.m(t,null)):W&&(W.d(1),W=null)},d(e){e&&detach(t),z&&z.d(),$&&$.d(),U&&U.d(),q&&q.d(),W&&W.d(),B=!1,run_all(j)}}}function create_if_block_18(e){let t,n,i,s,a,o,r,l,c,p,h,d,u,g,f,_,m,v,y,b,w,k,L,A,x,C,T,G,O,E,N,S,I,D,M,P,R,H=e[24].description+"",F="selectImage"===e[25].type&&create_if_block_32(e),B="select3D"===e[25].type&&create_if_block_31(e),j="selectPose"===e[25].type&&create_if_block_30(e),z="text"===e[25].type&&create_if_block_29(e),$="font"===e[25].type&&create_if_block_28(e),U="prompt"===e[25].type&&create_if_block_27(e),q="selectModifier"===e[25].type&&create_if_block_25(e),W="outpainting"===e[25].type&&create_if_block_23(e),V="removeBackground"===e[25].type&&create_if_block_20(e);function J(e,t){return e[23]===e[24].steps.length-1?create_if_block_19:create_else_block_5}let Y=J(e),X=Y(e);return{c(){t=element("div"),n=element("div"),i=element("div"),s=element("div"),a=text(H),o=space(),r=element("div"),l=element("fds-wizard-steps"),p=space(),h=element("div"),F&&F.c(),d=space(),B&&B.c(),u=space(),j&&j.c(),g=space(),z&&z.c(),f=space(),$&&$.c(),_=space(),U&&U.c(),m=space(),q&&q.c(),v=space(),W&&W.c(),y=space(),V&&V.c(),b=space(),w=element("div"),k=element("fds-layer-stack-3d"),L=space(),A=element("div"),x=element("fds-image-editor-button"),x.textContent=" Back ",C=space(),T=element("fds-image-editor-button"),G=text("\n                    "),X.c(),O=text("\n                     "),E=space(),N=element("fds-image-editor-text"),S=space(),I=element("fds-3d-scene"),D=space(),M=element("fds-pose-editor"),attr(s,"class","wizardDescription"),toggle_class(s,"fadeOut",fadeOut),set_custom_element_data(l,"steps",c=e[24].steps),set_custom_element_data(l,"current",e[23]),attr(r,"class","wizardSteps"),toggle_class(r,"fadeOut",fadeOut),attr(h,"class","wizardStepContent"),toggle_class(h,"fadeOut",fadeOut),attr(i,"class","left"),set_custom_element_data(k,"layers",e[18]),set_custom_element_data(k,"class","stack"),set_custom_element_data(k,"state","3d"),toggle_class(k,"stackTop",stackTop),toggle_class(k,"stackTopFadeOut",stackTopFadeOut),attr(w,"class","right"),set_style(w,"--fromX",e[20]),set_style(w,"--fromY",e[21]),set_style(w,"--toY",e[19]),attr(n,"class","wizardColumns"),set_custom_element_data(x,"type","button"),toggle_class(x,"firstStep",0===e[23]),set_custom_element_data(T,"type","button"),set_custom_element_data(T,"state","active"),attr(A,"class","navigate"),toggle_class(A,"fadeOut",fadeOut),attr(t,"class","wizard"),set_custom_element_data(N,"text",""),set_style(N,"width","1px"),set_style(N,"height","1px"),set_style(N,"visibility","hidden"),set_custom_element_data(N,"background","transparent"),set_custom_element_data(N,"font","Chewy"),set_custom_element_data(I,"background_type","grey"),set_custom_element_data(I,"camera_behaviour",""),set_custom_element_data(I,"width","1024"),set_custom_element_data(I,"height","1024"),set_style(I,"width","1px"),set_style(I,"height","1px"),set_style(I,"visibility","hidden"),set_custom_element_data(M,"show_character","human"),set_custom_element_data(M,"camera_behaviour",""),set_custom_element_data(M,"width","1024"),set_custom_element_data(M,"height","1024"),set_style(M,"width","1px"),set_style(M,"height","1px"),set_style(M,"visibility","hidden")},m(c,H){insert(c,t,H),append(t,n),append(n,i),append(i,s),append(s,a),append(i,o),append(i,r),append(r,l),append(i,p),append(i,h),F&&F.m(h,null),append(h,d),B&&B.m(h,null),append(h,u),j&&j.m(h,null),append(h,g),z&&z.m(h,null),append(h,f),$&&$.m(h,null),append(h,_),U&&U.m(h,null),append(h,m),q&&q.m(h,null),append(h,v),W&&W.m(h,null),append(h,y),V&&V.m(h,null),append(n,b),append(n,w),append(w,k),append(t,L),append(t,A),append(A,x),append(A,C),append(A,T),append(T,G),X.m(T,null),append(T,O),insert(c,E,H),insert(c,N,H),e[77](N),insert(c,S,H),insert(c,I,H),e[78](I),insert(c,D,H),insert(c,M,H),e[79](M),P||(R=[listen(x,"click",e[75]),listen(T,"click",e[76])],P=!0)},p(e,t){16777216&t[0]&&H!==(H=e[24].description+"")&&set_data(a,H),16777216&t[0]&&c!==(c=e[24].steps)&&set_custom_element_data(l,"steps",c),8388608&t[0]&&set_custom_element_data(l,"current",e[23]),"selectImage"===e[25].type?F?F.p(e,t):(F=create_if_block_32(e),F.c(),F.m(h,d)):F&&(F.d(1),F=null),"select3D"===e[25].type?B?B.p(e,t):(B=create_if_block_31(e),B.c(),B.m(h,u)):B&&(B.d(1),B=null),"selectPose"===e[25].type?j?j.p(e,t):(j=create_if_block_30(e),j.c(),j.m(h,g)):j&&(j.d(1),j=null),"text"===e[25].type?z?z.p(e,t):(z=create_if_block_29(e),z.c(),z.m(h,f)):z&&(z.d(1),z=null),"font"===e[25].type?$?$.p(e,t):($=create_if_block_28(e),$.c(),$.m(h,_)):$&&($.d(1),$=null),"prompt"===e[25].type?U?U.p(e,t):(U=create_if_block_27(e),U.c(),U.m(h,m)):U&&(U.d(1),U=null),"selectModifier"===e[25].type?q?q.p(e,t):(q=create_if_block_25(e),q.c(),q.m(h,v)):q&&(q.d(1),q=null),"outpainting"===e[25].type?W?W.p(e,t):(W=create_if_block_23(e),W.c(),W.m(h,y)):W&&(W.d(1),W=null),"removeBackground"===e[25].type?V?V.p(e,t):(V=create_if_block_20(e),V.c(),V.m(h,null)):V&&(V.d(1),V=null),262144&t[0]&&set_custom_element_data(k,"layers",e[18]),1048576&t[0]&&set_style(w,"--fromX",e[20]),2097152&t[0]&&set_style(w,"--fromY",e[21]),524288&t[0]&&set_style(w,"--toY",e[19]),8388608&t[0]&&toggle_class(x,"firstStep",0===e[23]),Y!==(Y=J(e))&&(X.d(1),X=Y(e),X&&(X.c(),X.m(T,O)))},d(n){n&&detach(t),F&&F.d(),B&&B.d(),j&&j.d(),z&&z.d(),$&&$.d(),U&&U.d(),q&&q.d(),W&&W.d(),V&&V.d(),X.d(),n&&detach(E),n&&detach(N),e[77](null),n&&detach(S),n&&detach(I),e[78](null),n&&detach(D),n&&detach(M),e[79](null),P=!1,run_all(R)}}}function create_if_block_32(e){let t,n,i,s,a;return{c(){t=element("label"),t.innerHTML='<fds-image-editor-button state="active" class="centerButton" type="button"> Import Image </fds-image-editor-button>',n=space(),i=element("input"),attr(t,"for","file-selector-wizard"),attr(i,"type","file"),attr(i,"id","file-selector-wizard"),attr(i,"accept","*"),set_style(i,"width","0.1px"),set_style(i,"height","0.1px"),set_style(i,"opacity","0"),set_style(i,"overflow","hidden"),set_style(i,"position","absolute"),set_style(i,"z-index","-1")},m(o,r){insert(o,t,r),insert(o,n,r),insert(o,i,r),s||(a=listen(i,"change",e[42]),s=!0)},p:noop,d(e){e&&detach(t),e&&detach(n),e&&detach(i),s=!1,a()}}}function create_if_block_31(e){let t,n,i;return{c(){t=element("fds-image-editor-button"),t.textContent="  Select 3D Object ",set_custom_element_data(t,"type","button"),set_custom_element_data(t,"state","active"),set_custom_element_data(t,"class","centerButton")},m(s,a){insert(s,t,a),n||(i=listen(t,"click",e[64]),n=!0)},p:noop,d(e){e&&detach(t),n=!1,i()}}}function create_if_block_30(e){let t,n,i;return{c(){t=element("fds-image-editor-button"),t.textContent="  Select Pose ",set_custom_element_data(t,"type","button"),set_custom_element_data(t,"state","active"),set_custom_element_data(t,"class","centerButton")},m(s,a){insert(s,t,a),n||(i=listen(t,"click",e[65]),n=!0)},p:noop,d(e){e&&detach(t),n=!1,i()}}}function create_if_block_29(e){let t,n,i,s,a,o;return{c(){t=element("div"),t.textContent="Input 1-3 words",n=space(),i=element("textarea"),set_style(t,"margin-bottom","10px"),attr(i,"class","centerButton textInput"),i.value=s=e[11].string},m(s,r){insert(s,t,r),insert(s,n,r),insert(s,i,r),a||(o=listen(i,"change",e[43]),a=!0)},p(e,t){2048&t[0]&&s!==(s=e[11].string)&&(i.value=s)},d(e){e&&detach(t),e&&detach(n),e&&detach(i),a=!1,o()}}}function create_if_block_28(e){let t,n,i,s,a,o,r,l,c,p,h,d,u,g,f,_,m=e[11].string+"",v=e[11].string+"",y=e[11].string+"",b=e[11].string+"";return{c(){t=element("div"),t.textContent="Select Font",n=space(),i=element("div"),s=element("div"),a=text(m),o=space(),r=element("div"),l=text(v),c=space(),p=element("div"),h=text(y),d=space(),u=element("div"),g=text(b),set_style(t,"margin-bottom","10px"),set_style(s,"font-family","Chewy"),set_style(r,"font-family","Righteous"),set_style(p,"font-family","Bangers"),set_style(u,"font-family","Sigmar One"),attr(i,"class","fontSelect")},m(m,v){insert(m,t,v),insert(m,n,v),insert(m,i,v),append(i,s),append(s,a),append(i,o),append(i,r),append(r,l),append(i,c),append(i,p),append(p,h),append(i,d),append(i,u),append(u,g),f||(_=[listen(s,"click",e[66]),listen(r,"click",e[67]),listen(p,"click",e[68]),listen(u,"click",e[69])],f=!0)},p(e,t){2048&t[0]&&m!==(m=e[11].string+"")&&set_data(a,m),2048&t[0]&&v!==(v=e[11].string+"")&&set_data(l,v),2048&t[0]&&y!==(y=e[11].string+"")&&set_data(h,y),2048&t[0]&&b!==(b=e[11].string+"")&&set_data(g,b)},d(e){e&&detach(t),e&&detach(n),e&&detach(i),f=!1,run_all(_)}}}function create_if_block_27(e){let t,n,i,s,a,o,r,l=e[25].promptTitle+"";return{c(){t=element("div"),n=text(l),i=space(),s=element("input"),set_style(t,"margin-bottom","10px"),attr(s,"type","text"),attr(s,"class","centerButton promptInput"),attr(s,"placeholder","Enter prompt"),s.value=a=e[31].text},m(a,l){insert(a,t,l),append(t,n),insert(a,i,l),insert(a,s,l),o||(r=listen(s,"change",e[45]),o=!0)},p(e,t){33554432&t[0]&&l!==(l=e[25].promptTitle+"")&&set_data(n,l),1&t[1]&&a!==(a=e[31].text)&&s.value!==a&&(s.value=a)},d(e){e&&detach(t),e&&detach(i),e&&detach(s),o=!1,r()}}}function create_if_block_25(e){let t,n,i,s,a;function o(e,t){return e[27].name?create_if_block_26:create_else_block_9}let r=o(e),l=r(e);return{c(){t=element("fds-image-editor-button"),n=text("  \n                            "),l.c(),i=text(" "),set_custom_element_data(t,"type","button"),set_custom_element_data(t,"state","active"),set_custom_element_data(t,"class","centerButton")},m(o,r){insert(o,t,r),append(t,n),l.m(t,null),append(t,i),s||(a=listen(t,"click",e[70]),s=!0)},p(e,n){r===(r=o(e))&&l?l.p(e,n):(l.d(1),l=r(e),l&&(l.c(),l.m(t,i)))},d(e){e&&detach(t),l.d(),s=!1,a()}}}function create_else_block_9(e){let t;return{c(){t=text("Select Style/Modifier")},m(e,n){insert(e,t,n)},p:noop,d(e){e&&detach(t)}}}function create_if_block_26(e){let t,n=e[27].name+"";return{c(){t=text(n)},m(e,n){insert(e,t,n)},p(e,i){134217728&i[0]&&n!==(n=e[27].name+"")&&set_data(t,n)},d(e){e&&detach(t)}}}function create_if_block_23(e){let t;function n(e,t){return e[10].base64?create_if_block_24:create_else_block_8}let i=n(e),s=i(e);return{c(){s.c(),t=empty()},m(e,n){s.m(e,n),insert(e,t,n)},p(e,a){i===(i=n(e))&&s?s.p(e,a):(s.d(1),s=i(e),s&&(s.c(),s.m(t.parentNode,t)))},d(e){s.d(e),e&&detach(t)}}}function create_else_block_8(e){let t;return{c(){t=text("Please import an image.")},m(e,n){insert(e,t,n)},p:noop,d(e){e&&detach(t)}}}function create_if_block_24(e){let t,n,i,s,a,o,r,l,c,p,h,d,u;return{c(){t=element("div"),n=element("div"),n.textContent="",i=space(),s=element("div"),s.textContent="",a=space(),o=element("img"),l=space(),c=element("div"),c.textContent="",p=space(),h=element("div"),h.textContent="",attr(n,"class","arrow top"),toggle_class(n,"selected","top"===e[26].direction),attr(s,"class","arrow left"),toggle_class(s,"selected","left"===e[26].direction),src_url_equal(o.src,r=e[10].base64)||attr(o,"src",r),attr(o,"class","center-image"),attr(c,"class","arrow rightArrow"),toggle_class(c,"selected","right"===e[26].direction),attr(h,"class","arrow bottom"),toggle_class(h,"selected","bottom"===e[26].direction),attr(t,"class","containerOutpainting")},m(r,g){insert(r,t,g),append(t,n),append(t,i),append(t,s),append(t,a),append(t,o),append(t,l),append(t,c),append(t,p),append(t,h),d||(u=[listen(n,"click",e[71]),listen(s,"click",e[72]),listen(c,"click",e[73]),listen(h,"click",e[74])],d=!0)},p(e,t){67108864&t[0]&&toggle_class(n,"selected","top"===e[26].direction),67108864&t[0]&&toggle_class(s,"selected","left"===e[26].direction),1024&t[0]&&!src_url_equal(o.src,r=e[10].base64)&&attr(o,"src",r),67108864&t[0]&&toggle_class(c,"selected","right"===e[26].direction),67108864&t[0]&&toggle_class(h,"selected","bottom"===e[26].direction)},d(e){e&&detach(t),d=!1,run_all(u)}}}function create_if_block_20(e){let t;function n(e,t){return e[10].base64?create_if_block_21:create_else_block_7}let i=n(e),s=i(e);return{c(){s.c(),t=empty()},m(e,n){s.m(e,n),insert(e,t,n)},p(e,a){i===(i=n(e))&&s?s.p(e,a):(s.d(1),s=i(e),s&&(s.c(),s.m(t.parentNode,t)))},d(e){s.d(e),e&&detach(t)}}}function create_else_block_7(e){let t;return{c(){t=text("Please import an image.")},m(e,n){insert(e,t,n)},p:noop,d(e){e&&detach(t)}}}function create_if_block_21(e){let t;function n(e,t){return e[9].base64?create_else_block_6:create_if_block_22}let i=n(e),s=i(e);return{c(){s.c(),t=empty()},m(e,n){s.m(e,n),insert(e,t,n)},p(e,a){i===(i=n(e))&&s?s.p(e,a):(s.d(1),s=i(e),s&&(s.c(),s.m(t.parentNode,t)))},d(e){s.d(e),e&&detach(t)}}}function create_else_block_6(e){let t,n;return{c(){t=element("img"),src_url_equal(t.src,n=e[9].base64)||attr(t,"src",n),attr(t,"width","200")},m(e,n){insert(e,t,n)},p(e,i){512&i[0]&&!src_url_equal(t.src,n=e[9].base64)&&attr(t,"src",n)},d(e){e&&detach(t)}}}function create_if_block_22(e){let t;return{c(){t=text("Removing background - please wait...")},m(e,n){insert(e,t,n)},p:noop,d(e){e&&detach(t)}}}function create_else_block_5(e){let t;return{c(){t=text("Next")},m(e,n){insert(e,t,n)},d(e){e&&detach(t)}}}function create_if_block_19(e){let t;return{c(){t=text("Finish")},m(e,n){insert(e,t,n)},d(e){e&&detach(t)}}}function create_if_block_17(e){let t,n,i,s,a,o,r,l,c,p,h,d,u,g,f,_,m,v;return{c(){t=element("div"),t.textContent="New empty document",n=space(),i=element("div"),s=element("div"),a=element("label"),a.textContent="Width",o=space(),r=element("input"),l=space(),c=element("div"),p=element("label"),p.textContent="Height",h=space(),d=element("input"),u=space(),g=element("fds-image-editor-button"),g.textContent=" Create ",f=space(),_=element("hr"),set_style(t,"margin-bottom","20px"),set_style(a,"margin","0"),set_style(a,"line-height","40px"),attr(a,"for","width"),attr(r,"lang","en"),attr(r,"type","text"),attr(r,"id","width"),attr(r,"placeholder","1024"),attr(r,"class","formInput"),set_style(r,"margin-bottom","0"),set_style(s,"initwidth","50%"),set_style(s,"display","flex"),set_style(s,"line-height","30px"),set_style(s,"vertical-align","middle"),set_style(s,"padding-right","10px"),set_style(p,"margin","0"),set_style(p,"line-height","40px"),attr(p,"for","height"),attr(d,"lang","en"),attr(d,"type","text"),attr(d,"id","height"),attr(d,"placeholder","1024"),attr(d,"class","formInput"),set_style(d,"margin-bottom","0"),set_custom_element_data(g,"type","button"),set_style(g,"margin-left","10px"),set_custom_element_data(g,"state","active"),set_style(c,"width","50%"),set_style(c,"display","flex"),set_style(c,"line-height","30px"),set_style(c,"vertical-align","middle"),attr(i,"class","formLine"),set_style(i,"display","flex"),set_style(i,"line-height","25px"),set_style(i,"margin-bottom","20px"),attr(_,"size","1"),set_style(_,"margin-bottom","20px")},m(y,b){insert(y,t,b),insert(y,n,b),insert(y,i,b),append(i,s),append(s,a),append(s,o),append(s,r),set_input_value(r,e[5]),append(i,l),append(i,c),append(c,p),append(c,h),append(c,d),set_input_value(d,e[6]),append(c,u),append(c,g),insert(y,f,b),insert(y,_,b),m||(v=[listen(r,"input",e[80]),listen(d,"input",e[81]),listen(g,"click",e[46])],m=!0)},p(e,t){32&t[0]&&r.value!==e[5]&&set_input_value(r,e[5]),64&t[0]&&d.value!==e[6]&&set_input_value(d,e[6])},d(e){e&&detach(t),e&&detach(n),e&&detach(i),e&&detach(f),e&&detach(_),m=!1,run_all(v)}}}function create_if_block_8(e){let t,n=e[33],i=[];for(let t=0;t<n.length;t+=1)i[t]=create_each_block_1(get_each_context_1(e,n,t));return{c(){for(let e=0;e<i.length;e+=1)i[e].c();t=empty()},m(e,n){for(let t=0;t<i.length;t+=1)i[t]&&i[t].m(e,n);insert(e,t,n)},p(e,s){if(2097188&s[1]){let a;for(n=e[33],a=0;a<n.length;a+=1){const o=get_each_context_1(e,n,a);i[a]?i[a].p(o,s):(i[a]=create_each_block_1(o),i[a].c(),i[a].m(t.parentNode,t))}for(;a<i.length;a+=1)i[a].d(1);i.length=n.length}},d(e){destroy_each(i,e),e&&detach(t)}}}function create_else_block_4(e){let t,n=e[102].intro+"";return{c(){t=text(n)},m(e,n){insert(e,t,n)},p(e,i){4&i[1]&&n!==(n=e[102].intro+"")&&set_data(t,n)},d(e){e&&detach(t)}}}function create_if_block_16(e){let t,n,i=e[102].intro+"";return{c(){t=element("div"),n=text(i),attr(t,"class","intro")},m(e,i){insert(e,t,i),append(t,n)},p(e,t){4&t[1]&&i!==(i=e[102].intro+"")&&set_data(n,i)},d(e){e&&detach(t)}}}function create_if_block_13(e){let t,n,i,s,a,o,r,l,c,p,h,d=e[105].title+"",u=e[105].imageHover&&create_if_block_15(e),g=e[105].play&&create_if_block_14();return{c(){t=element("div"),n=element("div"),i=element("div"),s=element("img"),o=space(),u&&u.c(),r=space(),g&&g.c(),c=space(),p=element("div"),h=text(d),attr(s,"class","imageelins"),attr(s,"alt","Source"),src_url_equal(s.src,a=e[105].image)||attr(s,"src",a),attr(i,"class","imageel link"),attr(i,"href",l=e[105].url),attr(n,"class","flexrow"),toggle_class(n,"square",e[105].square),attr(p,"class","name"),set_style(p,"height","45px"),attr(t,"class","repeater-item")},m(e,a){insert(e,t,a),append(t,n),append(n,i),append(i,s),append(i,o),u&&u.m(i,null),append(i,r),g&&g.m(i,null),append(t,c),append(t,p),append(p,h)},p(e,t){4&t[1]&&!src_url_equal(s.src,a=e[105].image)&&attr(s,"src",a),e[105].imageHover?u?u.p(e,t):(u=create_if_block_15(e),u.c(),u.m(i,r)):u&&(u.d(1),u=null),e[105].play?g||(g=create_if_block_14(),g.c(),g.m(i,null)):g&&(g.d(1),g=null),4&t[1]&&l!==(l=e[105].url)&&attr(i,"href",l),4&t[1]&&toggle_class(n,"square",e[105].square),4&t[1]&&d!==(d=e[105].title+"")&&set_data(h,d)},d(e){e&&detach(t),u&&u.d(),g&&g.d()}}}function create_if_block_15(e){let t,n;return{c(){t=element("img"),attr(t,"class","imageelins result"),attr(t,"alt","Result"),src_url_equal(t.src,n=e[105].imageHover)||attr(t,"src",n)},m(e,n){insert(e,t,n)},p(e,i){4&i[1]&&!src_url_equal(t.src,n=e[105].imageHover)&&attr(t,"src",n)},d(e){e&&detach(t)}}}function create_if_block_14(e){let t;return{c(){t=element("div"),attr(t,"class","play")},m(e,n){insert(e,t,n)},d(e){e&&detach(t)}}}function create_if_block_11(e){let t,n,i,s,a,o,r,l,c,p,h,d=e[105].title+"",u=e[105].imageHover&&create_if_block_12(e);function g(){return e[82](e[105])}return{c(){t=element("div"),n=element("div"),i=element("div"),s=element("img"),o=space(),u&&u.c(),r=space(),l=element("div"),c=text(d),attr(s,"class","imageelins"),attr(s,"alt","Source"),src_url_equal(s.src,a=e[105].image)||attr(s,"src",a),attr(i,"class","imageel"),attr(n,"class","flexrow"),set_style(n,"height","150px"),toggle_class(n,"square",e[105].square),attr(l,"class","name"),set_style(l,"height","45px"),attr(t,"class","repeater-item")},m(e,a){insert(e,t,a),append(t,n),append(n,i),append(i,s),append(i,o),u&&u.m(i,null),append(t,r),append(t,l),append(l,c),p||(h=listen(i,"click",g),p=!0)},p(t,o){e=t,4&o[1]&&!src_url_equal(s.src,a=e[105].image)&&attr(s,"src",a),e[105].imageHover?u?u.p(e,o):(u=create_if_block_12(e),u.c(),u.m(i,null)):u&&(u.d(1),u=null),4&o[1]&&toggle_class(n,"square",e[105].square),4&o[1]&&d!==(d=e[105].title+"")&&set_data(c,d)},d(e){e&&detach(t),u&&u.d(),p=!1,h()}}}function create_if_block_12(e){let t,n;return{c(){t=element("img"),attr(t,"class","imageelins result"),attr(t,"alt","Result"),src_url_equal(t.src,n=e[105].imageHover)||attr(t,"src",n)},m(e,n){insert(e,t,n)},p(e,i){4&i[1]&&!src_url_equal(t.src,n=e[105].imageHover)&&attr(t,"src",n)},d(e){e&&detach(t)}}}function create_if_block_10(e){let t,n,i,s,a,o,r,l,c,p,h,d=e[105].title+"";function u(){return e[83](e[105])}return{c(){t=element("div"),n=element("div"),i=element("div"),s=element("img"),r=space(),l=element("div"),c=text(d),attr(s,"class","imageelins"),set_style(s,"width","207px"),attr(s,"alt",a=e[105].name),src_url_equal(s.src,o=e[105].image)||attr(s,"src",o),attr(i,"class","imageel"),attr(n,"class","flexrow"),set_style(n,"width","207px"),set_style(n,"height","150px"),attr(l,"class","name"),set_style(l,"height","45px"),attr(t,"class","repeater-item")},m(e,a){insert(e,t,a),append(t,n),append(n,i),append(i,s),append(t,r),append(t,l),append(l,c),p||(h=listen(s,"click",u),p=!0)},p(t,n){e=t,4&n[1]&&a!==(a=e[105].name)&&attr(s,"alt",a),4&n[1]&&!src_url_equal(s.src,o=e[105].image)&&attr(s,"src",o),4&n[1]&&d!==(d=e[105].title+"")&&set_data(c,d)},d(e){e&&detach(t),p=!1,h()}}}function create_if_block_9(e){let t,n,i,s,a,o,r,l,c,p=e[105].title+"";function h(){return e[84](e[105])}return{c(){t=element("div"),n=element("div"),i=element("fds-image-editor-button"),o=space(),r=element("div"),set_custom_element_data(i,"size","50"),set_custom_element_data(i,"icon",s=e[105].icon),set_custom_element_data(i,"title",a=e[105].title),attr(n,"class","flexrow"),set_style(n,"width","70px"),set_style(n,"height","70px"),set_style(n,"padding","0"),set_style(n,"margin","0"),attr(r,"class","name"),set_style(r,"height","45px"),attr(t,"class","repeater-item"),set_style(t,"margin","0"),set_style(t,"margin-top","20px")},m(e,s){insert(e,t,s),append(t,n),append(n,i),append(t,o),append(t,r),r.innerHTML=p,l||(c=listen(i,"click",h),l=!0)},p(t,n){e=t,4&n[1]&&s!==(s=e[105].icon)&&set_custom_element_data(i,"icon",s),4&n[1]&&a!==(a=e[105].title)&&set_custom_element_data(i,"title",a),4&n[1]&&p!==(p=e[105].title+"")&&(r.innerHTML=p)},d(e){e&&detach(t),l=!1,c()}}}function create_each_block_2(e){let t,n,i,s,a=e[105].url&&create_if_block_13(e),o=e[105].wizard&&create_if_block_11(e),r=e[105].file&&create_if_block_10(e),l=e[105].icon&&create_if_block_9(e);return{c(){a&&a.c(),t=space(),o&&o.c(),n=space(),r&&r.c(),i=space(),l&&l.c(),s=empty()},m(e,c){a&&a.m(e,c),insert(e,t,c),o&&o.m(e,c),insert(e,n,c),r&&r.m(e,c),insert(e,i,c),l&&l.m(e,c),insert(e,s,c)},p(e,c){e[105].url?a?a.p(e,c):(a=create_if_block_13(e),a.c(),a.m(t.parentNode,t)):a&&(a.d(1),a=null),e[105].wizard?o?o.p(e,c):(o=create_if_block_11(e),o.c(),o.m(n.parentNode,n)):o&&(o.d(1),o=null),e[105].file?r?r.p(e,c):(r=create_if_block_10(e),r.c(),r.m(i.parentNode,i)):r&&(r.d(1),r=null),e[105].icon?l?l.p(e,c):(l=create_if_block_9(e),l.c(),l.m(s.parentNode,s)):l&&(l.d(1),l=null)},d(e){a&&a.d(e),e&&detach(t),o&&o.d(e),e&&detach(n),r&&r.d(e),e&&detach(i),l&&l.d(e),e&&detach(s)}}}function create_each_block_1(e){let t,n,i;function s(e,t){return"new"!==e[102].id&&"new_social"!==e[102].id?create_if_block_16:create_else_block_4}let a=s(e),o=a(e),r=e[102].entries,l=[];for(let t=0;t<r.length;t+=1)l[t]=create_each_block_2(get_each_context_2(e,r,t));return{c(){o.c(),t=space(),n=element("div");for(let e=0;e<l.length;e+=1)l[e].c();i=space(),attr(n,"class","repeater"),set_style(n,"margin-bottom","20px")},m(e,s){o.m(e,s),insert(e,t,s),insert(e,n,s);for(let e=0;e<l.length;e+=1)l[e]&&l[e].m(n,null);append(n,i)},p(e,c){if(a===(a=s(e))&&o?o.p(e,c):(o.d(1),o=a(e),o&&(o.c(),o.m(t.parentNode,t))),2097188&c[1]){let t;for(r=e[102].entries,t=0;t<r.length;t+=1){const s=get_each_context_2(e,r,t);l[t]?l[t].p(s,c):(l[t]=create_each_block_2(s),l[t].c(),l[t].m(n,i))}for(;t<l.length;t+=1)l[t].d(1);l.length=r.length}},d(e){o.d(e),e&&detach(t),e&&detach(n),destroy_each(l,e)}}}function create_if_block_2$1(e){let t,n;function i(e,t){return e[12]?create_if_block_3:create_else_block_2}let s=i(e),a=s(e);return{c(){t=element("span"),n=element("div"),a.c(),attr(n,"class","form"),attr(t,"slot","modalcontent")},m(e,i){insert(e,t,i),append(t,n),a.m(n,null)},p(e,t){s===(s=i(e))&&a?a.p(e,t):(a.d(1),a=s(e),a&&(a.c(),a.m(n,null)))},d(e){e&&detach(t),a.d()}}}function create_else_block_2(e){let t,n,i,s,a,o,r,l,c,p,h;function d(e,t){return e[8]?create_if_block_7:create_else_block_3}let u=d(e),g=u(e);return{c(){t=element("div"),n=element("label"),n.textContent="Gyre Cloud Token",i=space(),s=element("div"),a=element("input"),o=space(),r=element("fds-image-editor-button"),r.textContent="On Premise",l=space(),c=element("div"),g.c(),attr(n,"for","token"),attr(a,"lang","en"),attr(a,"type","password"),attr(a,"placeholder","Token"),attr(a,"id","token"),attr(a,"class","formInput"),set_style(a,"flex-grow","1"),set_custom_element_data(r,"type","button"),set_custom_element_data(r,"style",""),set_style(c,"display","flex"),set_style(c,"width","100%"),set_style(s,"display","flex"),set_style(s,"flex-flow","wrap"),set_style(s,"gap","10px"),attr(t,"class","formLine")},m(d,u){insert(d,t,u),append(t,n),append(t,i),append(t,s),append(s,a),set_input_value(a,e[1]),append(s,o),append(s,r),append(s,l),append(s,c),g.m(c,null),p||(h=[listen(a,"input",e[90]),listen(r,"click",e[91])],p=!0)},p(e,t){2&t[0]&&a.value!==e[1]&&set_input_value(a,e[1]),u===(u=d(e))&&g?g.p(e,t):(g.d(1),g=u(e),g&&(g.c(),g.m(c,null)))},d(e){e&&detach(t),g.d(),p=!1,run_all(h)}}}function create_if_block_3(e){let t,n,i,s,a,o,r,l,c,p,h,d,u,g,f,_,m,v,y=["Gyre","COMFY"],b=[];for(let t=0;t<2;t+=1)b[t]=create_each_block$1(get_each_context$1(e,y,t));function w(e,t){return"Gyre"==e[2]?create_if_block_5:create_else_block_1}let k=w(e),L=k(e);function A(e,t){return e[8]?create_if_block_4:create_else_block}let x=A(e),C=x(e);return{c(){t=element("div"),n=element("select");for(let e=0;e<2;e+=1)b[e].c();i=space(),s=element("div"),L.c(),a=space(),o=element("div"),r=element("input"),l=space(),c=element("fds-image-editor-button"),c.textContent="Gyre Cloud",p=space(),h=element("div"),d=element("label"),d.textContent="Token (optional)",u=space(),g=element("input"),f=space(),_=element("div"),C.c(),attr(n,"class","formInput samplerInput"),set_style(n,"width","140px"),set_style(n,"display","inline-block"),attr(t,"class","select-dropdown"),set_style(t,"width","140px"),set_style(t,"margin-bottom","0"),attr(r,"lang","en"),attr(r,"type","text"),attr(r,"id","serverURL"),attr(r,"placeholder","Server URL"),attr(r,"class","formInput"),set_style(r,"flex-grow","1"),set_custom_element_data(c,"type","button"),set_style(o,"display","flex"),set_style(o,"flex-flow","wrap"),set_style(o,"gap","10px"),attr(s,"class","formLine"),attr(d,"for","token"),attr(g,"lang","en"),attr(g,"id","token"),attr(g,"type","password"),attr(g,"placeholder","Token"),attr(g,"class","formInput"),set_style(g,"width","100%"),attr(h,"class","formLine")},m(y,w){insert(y,t,w),append(t,n);for(let e=0;e<2;e+=1)b[e]&&b[e].m(n,null);insert(y,i,w),insert(y,s,w),L.m(s,null),append(s,a),append(s,o),append(o,r),set_input_value(r,e[0]),append(o,l),append(o,c),insert(y,p,w),insert(y,h,w),append(h,d),append(h,u),append(h,g),set_input_value(g,e[1]),append(h,f),insert(y,_,w),C.m(_,null),m||(v=[listen(n,"change",e[85]),listen(r,"input",e[86]),listen(r,"change",e[87]),listen(c,"click",e[88]),listen(g,"input",e[89])],m=!0)},p(e,t){if(4&t[0]){let i;for(y=["Gyre","COMFY"],i=0;i<2;i+=1){const s=get_each_context$1(e,y,i);b[i]?b[i].p(s,t):(b[i]=create_each_block$1(s),b[i].c(),b[i].m(n,null))}for(;i<2;i+=1)b[i].d(1)}k!==(k=w(e))&&(L.d(1),L=k(e),L&&(L.c(),L.m(s,a))),1&t[0]&&r.value!==e[0]&&set_input_value(r,e[0]),2&t[0]&&g.value!==e[1]&&set_input_value(g,e[1]),x===(x=A(e))&&C?C.p(e,t):(C.d(1),C=x(e),C&&(C.c(),C.m(_,null)))},d(e){e&&detach(t),destroy_each(b,e),e&&detach(i),e&&detach(s),L.d(),e&&detach(p),e&&detach(h),e&&detach(_),C.d(),m=!1,run_all(v)}}}function create_else_block_3(e){let t;return{c(){t=text("Input a valid token for access")},m(e,n){insert(e,t,n)},p:noop,d(e){e&&detach(t)}}}function create_if_block_7(e){let t,n,i;return{c(){t=element("fds-image-editor-button"),t.innerHTML='<div style="width:100px;text-align:center">Ok</div>',set_custom_element_data(t,"type","button"),set_custom_element_data(t,"state","active")},m(s,a){insert(s,t,a),n||(i=listen(t,"click",e[34]),n=!0)},p:noop,d(e){e&&detach(t),n=!1,i()}}}function create_if_block_6(e){let t,n,i;return{c(){t=element("option"),n=text(e[99]),t.selected=i=e[99]===e[2]?"selected":void 0,t.__value=e[99],t.value=t.__value},m(e,i){insert(e,t,i),append(t,n)},p(e,n){4&n[0]&&i!==(i=e[99]===e[2]?"selected":void 0)&&(t.selected=i)},d(e){e&&detach(t)}}}function create_each_block$1(e){let t,n=e[99]&&create_if_block_6(e);return{c(){n&&n.c(),t=empty()},m(e,i){n&&n.m(e,i),insert(e,t,i)},p(e,t){e[99]&&n.p(e,t)},d(e){n&&n.d(e),e&&detach(t)}}}function create_else_block_1(e){let t;return{c(){t=element("label"),t.textContent="URL Comfy Server",attr(t,"for","serverURL")},m(e,n){insert(e,t,n)},d(e){e&&detach(t)}}}function create_if_block_5(e){let t;return{c(){t=element("label"),t.textContent="URL Gyre Server",attr(t,"for","serverURL")},m(e,n){insert(e,t,n)},d(e){e&&detach(t)}}}function create_else_block(e){let t;return{c(){t=text("Server not available")},m(e,n){insert(e,t,n)},p:noop,d(e){e&&detach(t)}}}function create_if_block_4(e){let t,n,i;return{c(){t=element("fds-image-editor-button"),t.innerHTML='<div style="width:100px;text-align:center">Ok</div>',set_custom_element_data(t,"type","button")},m(s,a){insert(s,t,a),n||(i=listen(t,"click",e[34]),n=!0)},p:noop,d(e){e&&detach(t),n=!1,i()}}}function create_if_block_1$1(e){let t,n,i;return{c(){t=element("fds-presets-dialog"),set_custom_element_data(t,"onlyexternalmodifiers","true"),set_custom_element_data(t,"reopendialogevent",e[17])},m(s,a){insert(s,t,a),n||(i=listen(t,"select",e[39]),n=!0)},p(e,n){131072&n[0]&&set_custom_element_data(t,"reopendialogevent",e[17])},d(e){e&&detach(t),n=!1,i()}}}function create_fragment$3(e){let t,n,i=e[4]&&create_if_block$1(e);return{c(){t=space(),i&&i.c(),n=empty(),this.c=noop},m(e,s){insert(e,t,s),i&&i.m(e,s),insert(e,n,s)},p(e,t){e[4]?i?i.p(e,t):(i=create_if_block$1(e),i.c(),i.m(n.parentNode,n)):i&&(i.d(1),i=null)},i:noop,o:noop,d(e){e&&detach(t),i&&i.d(e),e&&detach(n)}}}let fadeOut=!1,stackTop=!1,stackTopFadeOut=!1;function openLink(e){window.open(e,"_blank")}async function convertToPNG(e){return new Promise((t=>{if(e.includes("data:image/png"))return void t(e);const n=new Image;n.onload=()=>{const e=document.createElement("canvas"),i=e.getContext("2d");e.width=n.width,e.height=n.height,i.drawImage(n,0,0);const s=e.toDataURL("image/png");t(s)},n.src=e}))}function instance$3(e,t,n){let i,s=get_current_component(),{contentelement:a}=t,{openProfile:o=!1}=t,{finishedInit:r=!1}=t,{initwidth:l=1024}=t,{initheight:c=1024}=t,{serverurl:p=""}=t,{bearer:h=""}=t,{servertype:d=""}=t,{SDConfig:u}=t,{file_base64:g}=t,{file_blob:f}=t,{file_type:_}=t,{file_name:m}=t,{file_uncompressed:v}=t,{onclosed:y=(()=>{})}=t,{serverIsAvailable:b=!1}=t,w=!1,k=!1,L=!1,A=!1,x=!1,C=[],T="100px";onMount((()=>{ee()}));afterUpdate((()=>{let e=s.shadowRoot,t=e.querySelectorAll(".link");for(let e of t){let t=e.getAttribute("href");e.addEventListener("click",(()=>{E("link"),openLink(t)}))}let i=e.querySelector(".stack");if(!i)return;if(i.classList.contains("stackPos"))return;let a=i.getBoundingClientRect();n(20,G=window.innerWidth-a.right+"px"),n(21,O=`${a.top}px`),i.classList.add("stackPos")}));let G=0,O=0;function E(e){e||n(16,A=!0),e&&n(16,A=!1),n(17,x=!0),setTimeout((()=>{n(17,x=!1)}),"200")}let N="",S=0,I={};function D(e){n(32,Q="wizard"),n(22,N=e),n(24,I=wizards[e]),n(33,K=null),n(63,q={}),n(10,V={}),n(62,$={}),n(11,J={string:""}),n(31,X={text:""}),n(27,j={}),n(26,F={}),n(9,P={}),n(18,C=[]),H(0)}let M={},P={};async function R(){return await H(S+1)}async function H(e){if(e<0&&(e=0),e>=I.steps.length){let e={type:N,image:V,prompt:X,modifierInfo:j,scene3d:q,pose:$,text:J,outpainting:F,background:P},t=new gyreDocument,i=await t.fromWizard(e);return n(58,v=i),n(56,_="gyre"),n(5,l=t.width),n(6,c=t.height),n(57,m="From Wizard"),V.name&&n(57,m=V.name),void Z()}if(n(23,S=e),n(25,M=I.steps[e]),1===e&&"background"===N&&V.base64&&!P.base64){let e=V.base64;e=await convertToPNG(e);let t={mode:"removeBackground",image64:e.split(",")[1],taskid:(Math.random()+1).toString(36).substring(3),prompt:""};(new Gyre).runSD(u.generalConfig,t).then((e=>{if(!e||!e[0]||!e[0].base64)return void n(10,V={});let t="data:image/png;base64,"+e[0].base64;n(9,P={base64:t}),R()}))}}let F={};function B(e){n(26,F.direction=e,F),F.wizard_outpainting,R()}let j={};let z,$={};let U,q={};let W,V={};let J={string:""};async function Y(e){n(30,W.font=e,W),n(11,J.font=e,J),await W.autoSize(),n(30,W.background="white",W);let t=await W.renderForAI();n(30,W.background="transparent",W),n(11,J.thumb=t,J),n(11,J.font_size=W.font_size,J)}let X={text:""};async function Z(){b?n(4,r=!1):await(new confirmDialog).alert("Please set up server configuration in 'Profile' menu!")}let Q="";let K=[];function ee(){n(32,Q="quickStart"),n(33,K=quickStartData)}async function te(e){if("file"!==e.type)n(5,l=e.width),n(6,c=e.height);else if("external"===e.from){let t=await fetch(e.file);const i=await t.arrayBuffer();return n(55,f=new Blob([i],{type:"application/octet-stream"})),n(57,m=e.title),n(56,_="gyre"),void Z()}}let ne=!1;return e.$$set=e=>{"contentelement"in e&&n(59,a=e.contentelement),"openProfile"in e&&n(3,o=e.openProfile),"finishedInit"in e&&n(4,r=e.finishedInit),"initwidth"in e&&n(5,l=e.initwidth),"initheight"in e&&n(6,c=e.initheight),"serverurl"in e&&n(0,p=e.serverurl),"bearer"in e&&n(1,h=e.bearer),"servertype"in e&&n(2,d=e.servertype),"SDConfig"in e&&n(7,u=e.SDConfig),"file_base64"in e&&n(54,g=e.file_base64),"file_blob"in e&&n(55,f=e.file_blob),"file_type"in e&&n(56,_=e.file_type),"file_name"in e&&n(57,m=e.file_name),"file_uncompressed"in e&&n(58,v=e.file_uncompressed),"onclosed"in e&&n(60,y=e.onclosed),"serverIsAvailable"in e&&n(8,b=e.serverIsAvailable)},e.$$.update=()=>{7687&e.$$.dirty[0]|1073741824&e.$$.dirty[1]|3&e.$$.dirty[2]&&(!ne&&h&&(n(2,d="Gyre"),n(0,p="https://cloud.gyre.ai"),n(61,i=p+"/"+h+"/status")),(p||h&&d)&&(p.includes("status")?n(61,i=p):h?(n(61,i=p.replace(/\/$/,"")+"/"+h+"/status"),"COMFY"==d&&n(61,i=p.replace(/\/$/,"")+"/"+h+"/settings")):(n(61,i=p.replace(/\/$/,"")+"/status"),"COMFY"==d&&n(61,i=p.replace(/\/$/,"")+"/settings")),d&&setTimeout((async()=>{let e;try{e=await fetch(i)}catch(e){n(8,b=!1)}n(8,b=!!e?.ok)}),0)),n(19,T="100px"),q.thumb&&(V.base64?(n(18,C[0]=V.base64,C),n(18,C[1]=q.thumb,C),n(19,T="300px")):(n(18,C[0]=q.thumb,C),n(19,T="100px"))),P.base64&&(n(18,C[0]=V.base64,C),n(18,C[1]=P.base64,C),n(19,T="300px")),J.thumb&&(n(18,C[0]=J.thumb,C),n(19,T="100px")),$.thumb&&(V.base64?(n(18,C[0]=V.base64,C),n(18,C[1]=$.thumb,C),n(19,T="300px")):(n(18,C[0]=$.thumb,C),n(19,T="100px"))),V.base64&&n(18,C[0]=V.base64,C))},[p,h,d,o,r,l,c,u,b,P,V,J,ne,w,k,L,A,x,C,T,G,O,N,S,I,M,F,j,z,U,W,X,Q,K,()=>{n(3,o=!1),ne||(n(2,d="Gyre"),n(0,p="https://cloud.gyre.ai"))},E,D,H,B,function(e){n(27,j.name=e.detail.key,j),n(27,j.modifiers=e.detail.modifiers.replace(/<br\/>/g,"\n"),j),R()},async function(e){n(62,$.thumb=e.thumb,$),V.width?n(62,$.width=V.width,$):n(62,$.width=1024,$),V.height?n(62,$.height=V.height,$):n(62,$.height=1024,$),n(28,z.width=$.width,z),n(28,z.height=$.height,z),z.setScene(e),await new Promise((e=>setTimeout(e,510))),n(62,$.component=z,$),R()},async function(e,t,i){n(31,X.text=i,X),n(63,q.thumb=t,q),n(63,q);let s={meshes:[]};BABYLON&&(s.camera={},s.camera.position=new BABYLON.Vector3(0,1,3),s.camera.rotation=new BABYLON.Vector3(0,0,0)),await U.setScene(s),V.width?n(63,q.width=V.width,q):n(63,q.width=1024,q),V.height?n(63,q.height=V.height,q):n(63,q.height=1024,q),n(29,U.width=q.width,U),n(29,U.height=q.height,U),n(29,U.binary=e,U),n(63,q.component=U,q),R()},async function(e){const t=e.target.files[0];if(t.type&&!t.type.startsWith("image/"))return void alert("File is not an image.",t.type,t);n(10,V.name=t.name,V),n(9,P={});const i=new FileReader;i.addEventListener("load",(async e=>{n(10,V.base64=e.target.result,V);let t=new Image;t.src=V.base64,await t.decode(),n(10,V.width=t.width,V),n(10,V.height=t.height,V),R()})),i.readAsDataURL(t)},async function(e){n(31,X.text=e.target.value,X),n(31,X.text=X.text.replace(/\n/g," "),X);let t=e.target.value.toUpperCase();n(30,W.width=1024,W),n(30,W.height=1024,W),n(30,W.text=t,W),await W.autoSize(),n(30,W.background="white",W);let i=await W.renderForAI();n(30,W.background="transparent",W),n(11,J.string=t,J),n(11,J.font_size=W.font_size,J),n(11,J.thumb=i,J),J.font||n(11,J.font="Chewy",J),n(11,J.component=W,J),n(11,J)},Y,async function(e){n(31,X.text=e.target.value,X)},function(){Z()},function(){n(32,Q="profile"),n(3,o=!0)},function(){n(32,Q="myFiles"),n(33,K=[{id:"myFiles",title:"My files",intro:"Not available yet.",entries:[]}])},function(){n(32,Q="tutorials"),n(33,K=tutorialsData)},ee,function(){n(32,Q="newDocument"),n(33,K=newDocumentData)},te,async function(e){const t=e.target.files[0];if(t.type&&!t.type.startsWith("image/")&&!t.name.endsWith(".fdsai")&&!t.name.endsWith(".gyre"))return void alert("File is not an image.",t.type,t);n(57,m=t.name);const i=new FileReader;i.addEventListener("load",(async e=>{if(t.name.endsWith(".fdsai")&&!t.name.endsWith(".gyre"))n(54,g=e.target.result),n(56,_="gyre");else{n(54,g=e.target.result),n(56,_="image");let t=new Image;t.src=g,await t.decode(),n(5,l=t.width),n(6,c=t.height)}Z()})),i.readAsDataURL(t)},g,f,_,m,v,a,y,i,$,q,()=>{n(14,k=!0)},()=>{n(13,w=!0)},()=>{Y("Chewy")},()=>{Y("Righteous")},()=>{Y("Bangers")},()=>{Y("Sigmar One")},()=>{E()},()=>{B("top")},()=>{B("left")},()=>{B("right")},()=>{B("bottom")},()=>{H(S-1)},()=>{H(S+1)},function(e){binding_callbacks[e?"unshift":"push"]((()=>{W=e,n(30,W)}))},function(e){binding_callbacks[e?"unshift":"push"]((()=>{U=e,n(29,U)}))},function(e){binding_callbacks[e?"unshift":"push"]((()=>{z=e,n(28,z)}))},function(){l=this.value,n(5,l)},function(){c=this.value,n(6,c)},e=>{D(e.wizard)},e=>{te(e)},e=>{te(e)},e=>{"COMFY"==d&&n(7,u.configList[1].generalConfig.url=p,u),"Gyre"==d&&n(7,u.configList[0].generalConfig.url=p,u),n(2,d=e.target.value),"COMFY"==d&&n(0,p=u.configList[1].generalConfig.url),"Gyre"==d&&n(0,p=u.configList[0].generalConfig.url)},function(){p=this.value,n(0,p),n(12,ne),n(1,h),n(2,d),n(61,i),n(63,q),n(10,V),n(9,P),n(11,J),n(62,$)},()=>{n(0,p=p.replace(/\/$/,""))},()=>{n(12,ne=!1)},function(){h=this.value,n(1,h)},function(){h=this.value,n(1,h)},()=>{n(12,ne=!0)},()=>{n(3,o=!1)},()=>{n(13,w=!1)},()=>{n(14,k=!1)},()=>{n(15,L=!1)}]}class FirstConfig extends SvelteElement{constructor(e){super();const t=document.createElement("style");t.textContent=".startScreen{touch-action:none}label{display:block;margin-bottom:10px}@media only screen and (max-height: 800px){}.formLine{margin-bottom:10px}.form{margin-bottom:20px;font-size:14px}*{box-sizing:border-box}.logo{height:40px;vertical-align:middle}.topLogo{line-height:40px;font-size:18px;;}.formInput{width:100px;outline:0;border:0;border-bottom:2px solid rgba(255, 255, 255, 0.2);font-size:14px;padding:5px;font-weight:normal;border-radius:3px;color:rgba(255, 255, 255, 0.9);margin-bottom:10px;display:block;box-sizing:border-box}.formInput::placeholder{font-weight:normal;opacity:0.5;color:rgba(255, 255, 255, 0.7)}.topMenu{font-size:16px;background-color:var(--stage-color);width:100vw;height:50px;display:flex;justify-content:space-between;position:fixed;top:0px;left:0;padding:0 15px 0 10px;background-color:rgba(.29,.29,.29,0.5);backdrop-filter:blur(10px)}.rightMenu{line-height:50px;display:flex;width:540px;gap:20px}.rightMenu div{cursor:pointer}.rightMenu div:hover{color:var(--btn-selected-bgcolor)}.rightMenu .active{color:var(--btn-selected2-bgcolor)}.rightMenu .new{line-height:45px;font-size:35px}.content{padding-left:40px;padding-right:40px;padding-top:100px;height:100vh;background:url(appdata/gyreback.png);background-size:cover}.contentDark{transition:all ease 0.3s;background-color:#1d1d1d}.red{color:red}.flexrow{gap:10px;display:flex;flex-direction:row;justify-content:center;align-items:stretch;text-align:center;cursor:pointer;padding-top:5px;padding-bottom:5px;height:100px;margin-bottom:10px}.square{height:150px}.imageel{position:relative}.imageel .result{opacity:0;position:absolute;left:0;top:0}.imageel:hover .result{transition:all ease 0.6s;opacity:1}.repeater{display:flex;flex-direction:row;flex-wrap:wrap;margin-left:auto;margin-right:auto}.repeater-item{display:flex;flex-direction:column;margin:20px;cursor:pointer}.name{overflow:hidden;margin-bottom:5px;width:150px;display:flex;font-size:14px}.imageelins{width:150px}.play{position:absolute;left:55px;bottom:5px;font-size:40px;color:black}.imageel .play::after{font-family:'Inter', sans-serif;content:''}.imageel:hover .play::after{font-family:'Inter', sans-serif;content:''}.intro{text-align:left;padding-left:20px}.wizard{width:fit-content;min-width:800px;background-color:#1d1d1d;padding:20px;border-radius:10px;background-color:rgba(.29,.29,.29,0.5);backdrop-filter:blur(10px);position:fixed;left:50%;transform:translate(-50%)}.wizardDescription{margin-top:10px;margin-bottom:50px;text-align:center;font-size:16px}.wizardSteps{margin-bottom:10px;;}.wizardStepContent{margin-top:10px;margin-left:auto;margin-right:auto;height:200px;display:grid;place-items:center;align-content:center}.wizardColumns{display:flex}.wizard .left{flex:1}.wizard .right{width:200px;padding:10px;margin-top:250px}.wizard .centerButton{width:fit-content}.wizard .navigate{text-align:right}.wizard .firstStep{opacity:0.2}.wizard .textInput{width:200px;height:80px;text-transform:uppercase;text-align:center;font-size:20px;resize:none;border-radius:5px;padding:5px}.wizard .promptInput{width:350px;font-size:16px;padding:5px;border-radius:5px;border:1px solid grey}.wizard .fontSelect{background-color:white;font-size:30px;padding:10px;color:black;cursor:pointer;border-radius:5px}.wizard .fontSelect div:hover{color:white;background-color:black}.containerOutpainting{position:relative;margin-top:20px}.containerOutpainting .arrow{position:absolute;display:flex;justify-content:center;align-items:center;width:50px;height:50px;border-radius:50%;font-size:50px;cursor:pointer}.containerOutpainting .selected{color:var(--theme-btn-selected2-bgcolor)}.containerOutpainting .arrow:hover{color:var(--theme-btn-selected-bgcolor)}.containerOutpainting .center-image{max-width:150px;max-height:150px;display:block;width:auto;height:auto}.containerOutpainting .top{top:-50px;left:50%;transform:translateX(-50%)}.containerOutpainting .bottom{bottom:-50px;left:50%;transform:translateX(-50%)}.containerOutpainting .left{left:-50px;top:50%;transform:translateY(-50%)}.containerOutpainting .rightArrow{right:-50px;top:50%;transform:translateY(-50%)}.fadeOut{transition:all ease 0.3s;opacity:0.0}.stack{transition:all ease 0.8s}.stackPos{right:var(--fromX);top:var(--fromY)}.stackTop{transition:all ease 0.8s;right:50px;top:var(--toY);zoom:0.6}.stackTopFadeOut{transition:all ease 0.8s;opacity:0.0\n}",this.shadowRoot.appendChild(t),init(this,{target:this.shadowRoot,props:attribute_to_object(this.attributes),customElement:!0},instance$3,create_fragment$3,safe_not_equal,{contentelement:59,openProfile:3,finishedInit:4,initwidth:5,initheight:6,serverurl:0,bearer:1,servertype:2,SDConfig:7,file_base64:54,file_blob:55,file_type:56,file_name:57,file_uncompressed:58,onclosed:60,serverIsAvailable:8},null,[-1,-1,-1,-1]),e&&(e.target&&insert(e.target,this,e.anchor),e.props&&(this.$set(e.props),flush()))}static get observedAttributes(){return["contentelement","openProfile","finishedInit","initwidth","initheight","serverurl","bearer","servertype","SDConfig","file_base64","file_blob","file_type","file_name","file_uncompressed","onclosed","serverIsAvailable"]}get contentelement(){return this.$$.ctx[59]}set contentelement(e){this.$$set({contentelement:e}),flush()}get openProfile(){return this.$$.ctx[3]}set openProfile(e){this.$$set({openProfile:e}),flush()}get finishedInit(){return this.$$.ctx[4]}set finishedInit(e){this.$$set({finishedInit:e}),flush()}get initwidth(){return this.$$.ctx[5]}set initwidth(e){this.$$set({initwidth:e}),flush()}get initheight(){return this.$$.ctx[6]}set initheight(e){this.$$set({initheight:e}),flush()}get serverurl(){return this.$$.ctx[0]}set serverurl(e){this.$$set({serverurl:e}),flush()}get bearer(){return this.$$.ctx[1]}set bearer(e){this.$$set({bearer:e}),flush()}get servertype(){return this.$$.ctx[2]}set servertype(e){this.$$set({servertype:e}),flush()}get SDConfig(){return this.$$.ctx[7]}set SDConfig(e){this.$$set({SDConfig:e}),flush()}get file_base64(){return this.$$.ctx[54]}set file_base64(e){this.$$set({file_base64:e}),flush()}get file_blob(){return this.$$.ctx[55]}set file_blob(e){this.$$set({file_blob:e}),flush()}get file_type(){return this.$$.ctx[56]}set file_type(e){this.$$set({file_type:e}),flush()}get file_name(){return this.$$.ctx[57]}set file_name(e){this.$$set({file_name:e}),flush()}get file_uncompressed(){return this.$$.ctx[58]}set file_uncompressed(e){this.$$set({file_uncompressed:e}),flush()}get onclosed(){return this.$$.ctx[60]}set onclosed(e){this.$$set({onclosed:e}),flush()}get serverIsAvailable(){return this.$$.ctx[8]}set serverIsAvailable(e){this.$$set({serverIsAvailable:e}),flush()}}function get_each_context(e,t,n){const i=e.slice();return i[3]=t[n],i[5]=n,i}function create_each_block(e){let t,n,i=e[3].text+"";return{c(){t=element("li"),n=text(i),set_style(t,"width",e[2]),toggle_class(t,"current",e[1]===e[5])},m(e,i){insert(e,t,i),append(t,n)},p(e,s){1&s&&i!==(i=e[3].text+"")&&set_data(n,i),4&s&&set_style(t,"width",e[2]),2&s&&toggle_class(t,"current",e[1]===e[5])},d(e){e&&detach(t)}}}function create_fragment$2(e){let t,n=e[0],i=[];for(let t=0;t<n.length;t+=1)i[t]=create_each_block(get_each_context(e,n,t));return{c(){t=element("ol");for(let e=0;e<i.length;e+=1)i[e].c();this.c=noop},m(e,n){insert(e,t,n);for(let e=0;e<i.length;e+=1)i[e]&&i[e].m(t,null)},p(e,[s]){if(7&s){let a;for(n=e[0],a=0;a<n.length;a+=1){const o=get_each_context(e,n,a);i[a]?i[a].p(o,s):(i[a]=create_each_block(o),i[a].c(),i[a].m(t,null))}for(;a<i.length;a+=1)i[a].d(1);i.length=n.length}},i:noop,o:noop,d(e){e&&detach(t),destroy_each(i,e)}}}function instance$2(e,t,n){let{steps:i=[]}=t,{current:s=0}=t,a="25%";return e.$$set=e=>{"steps"in e&&n(0,i=e.steps),"current"in e&&n(1,s=e.current)},e.$$.update=()=>{1&e.$$.dirty&&i&&n(2,a=100/i.length+"%")},[i,s,a]}customElements.define("fds-first-config",FirstConfig);class WizardSteps extends SvelteElement{constructor(e){super();const t=document.createElement("style");t.textContent="*{box-sizing:border-box}ol{position:relative;overflow:hidden;counter-reset:wizard;list-style-type:none}li{position:relative;float:left;text-align:center;color:#ddb74f}.current~li{color:#ebebeb}li::marker{content:''}li:before{counter-increment:wizard;content:counter(wizard);display:block;color:black;background-color:#ddb74f;border:2px solid #ddb74f;text-align:center;width:2em;height:2em;line-height:2em;border-radius:2em;position:relative;left:50%;margin-bottom:1em;margin-left:-1em;z-index:1;transition:all ease 0.6s}.current~li:before{background-color:#323232;color:#ebebeb;border-color:#555}li+li:after{content:\"\";display:block;width:100%;background-color:#ddb74f;height:2px;position:absolute;left:-50%;top:1em;z-index:0;transition:all ease 0.6s}.current~li:after{background-color:#555}",this.shadowRoot.appendChild(t),init(this,{target:this.shadowRoot,props:attribute_to_object(this.attributes),customElement:!0},instance$2,create_fragment$2,safe_not_equal,{steps:0,current:1},null),e&&(e.target&&insert(e.target,this,e.anchor),e.props&&(this.$set(e.props),flush()))}static get observedAttributes(){return["steps","current"]}get steps(){return this.$$.ctx[0]}set steps(e){this.$$set({steps:e}),flush()}get current(){return this.$$.ctx[1]}set current(e){this.$$set({current:e}),flush()}}function create_if_block_2(e){let t;return{c(){t=element("div"),attr(t,"class","layer bottom-layer "),set_style(t,"background","url(/appdata/checker_thumb.png)"),toggle_class(t,"bottom-layer-flat","flat"===e[1])},m(e,n){insert(e,t,n)},p(e,n){2&n&&toggle_class(t,"bottom-layer-flat","flat"===e[1])},d(e){e&&detach(t)}}}function create_if_block_1(e){let t;return{c(){t=element("div"),attr(t,"class","layer bottom-layer "),set_style(t,"background-image","url("+e[0][0]+")"),toggle_class(t,"bottom-layer-flat","flat"===e[1])},m(e,n){insert(e,t,n)},p(e,n){1&n&&set_style(t,"background-image","url("+e[0][0]+")"),2&n&&toggle_class(t,"bottom-layer-flat","flat"===e[1])},d(e){e&&detach(t)}}}function create_if_block(e){let t,n,i;return{c(){t=element("div"),n=space(),i=element("div"),attr(t,"class","layer mid-layer "),set_style(t,"background-image","url("+e[0][1]+")"),toggle_class(t,"mid-layer-flat","flat"===e[1]),attr(i,"class","layer bottom-layer "),set_style(i,"background-image","url("+e[0][0]+")"),toggle_class(i,"bottom-layer-flat","flat"===e[1])},m(e,s){insert(e,t,s),insert(e,n,s),insert(e,i,s)},p(e,n){1&n&&set_style(t,"background-image","url("+e[0][1]+")"),2&n&&toggle_class(t,"mid-layer-flat","flat"===e[1]),1&n&&set_style(i,"background-image","url("+e[0][0]+")"),2&n&&toggle_class(i,"bottom-layer-flat","flat"===e[1])},d(e){e&&detach(t),e&&detach(n),e&&detach(i)}}}function create_fragment$1(e){let t,n,i,s=0===e[0].length&&create_if_block_2(e),a=1===e[0].length&&create_if_block_1(e),o=2===e[0].length&&create_if_block(e);return{c(){t=element("div"),s&&s.c(),n=space(),a&&a.c(),i=space(),o&&o.c(),this.c=noop,attr(t,"class","layer-container stacked-top")},m(e,r){insert(e,t,r),s&&s.m(t,null),append(t,n),a&&a.m(t,null),append(t,i),o&&o.m(t,null)},p(e,[r]){0===e[0].length?s?s.p(e,r):(s=create_if_block_2(e),s.c(),s.m(t,n)):s&&(s.d(1),s=null),1===e[0].length?a?a.p(e,r):(a=create_if_block_1(e),a.c(),a.m(t,i)):a&&(a.d(1),a=null),2===e[0].length?o?o.p(e,r):(o=create_if_block(e),o.c(),o.m(t,null)):o&&(o.d(1),o=null)},i:noop,o:noop,d(e){e&&detach(t),s&&s.d(),a&&a.d(),o&&o.d()}}}function instance$1(e,t,n){let{layers:i=[]}=t,{state:s="3d"}=t;return e.$$set=e=>{"layers"in e&&n(0,i=e.layers),"state"in e&&n(1,s=e.state)},[i,s]}customElements.define("fds-wizard-steps",WizardSteps);class LayerStack3D extends SvelteElement{constructor(e){super();const t=document.createElement("style");t.textContent="*{box-sizing:border-box}.layer-container{width:100px;height:100px;top:50%;left:50%;perspective:1350px;transform-style:preserve-3d}.layer{background-size:cover;background-position:center;width:100px;height:100px;position:absolute;transition:all 0.6s ease-in-out;cursor:pointer;z-index:1;border-radius:10px;box-shadow:1px 1px 0 1px #f9f9fb,\n    -1px 0 28px 0 rgba(34, 33, 81, 0.01),\n    28px 28px 28px 0 rgba(34, 33, 81, 0.85)}.bottom-layer{transform:rotateX(45deg) rotateZ(45deg) translateZ(50px)}.bottom-layer:hover,.bottom-layer-flat{transform:translate3d(0px, 50px, 50px)}.mid-layer{transform:rotateX(45deg) rotateZ(45deg) translateZ(100px)}.mid-layer:hover,.mid-layer-flat{transform:translate3d(0px, -100px, 50px)}",this.shadowRoot.appendChild(t),init(this,{target:this.shadowRoot,props:attribute_to_object(this.attributes),customElement:!0},instance$1,create_fragment$1,safe_not_equal,{layers:0,state:1},null),e&&(e.target&&insert(e.target,this,e.anchor),e.props&&(this.$set(e.props),flush()))}static get observedAttributes(){return["layers","state"]}get layers(){return this.$$.ctx[0]}set layers(e){this.$$set({layers:e}),flush()}get state(){return this.$$.ctx[1]}set state(e){this.$$set({state:e}),flush()}}customElements.define("fds-layer-stack-3d",LayerStack3D);var name="@fds-components/fds-ai-image-editor",version="1.1.91";class Config{parameters={prompt:"",steps:0,seed:0,num:0,sampling_method:"LMS",seedList:["","","",""],imageDialog:null,regenerate:!1,image64:"",maskImage64:"",inpaint_mask_blur:"4",inpaint_mask_content:"latent noise",mode:"txt2img",strength:"1"};generalConfig={url:"",tokenid:"",token:"",name:"local",type:"Colab",inpaint_mask_blur:"4",inpaint_mask_content:"latent noise",width:"1024",height:"1024",m1fix:!1,allVisible:!0,dlgData:{mode:"txt2img",prompt:"",seed:"",steps:"15",steps_update:"50",num:"2",modifiers:"highly detailed",cfg_value:"7.5",strength:".75",sampling_method:"LMS",previewMode:""}};globalData={prompt:"",modifiers:"",appRegisteredhash:"",dateRegistered:"",fingerprint:""};ModifierData={list:[],tags:[]};configList=[];currentConfigNum=0;getDefault(e){let t,n;return"SDGRPC"===e?(t={inpainting_original:!0,url:"",tokenid:"",token:"",name:"Gyre",type:"SDGRPC",width:"1024",height:"1024",m1fix:!1,allVisible:!0,dlgData:{mode:"txt2img",prompt:"",seed:"",steps:"15",steps_update:"20",num:"2",modifiers:"highly detailed",cfg_value:"7.5",strength:".75",sampling_method:"DPMSolver++ 2M (Fast)"}},n={prompt:"",steps:0,seed:0,num:0,sampling_method:"LMS",seedList:["","","",""],imageDialog:null,regenerate:!1,image64:"",maskImage64:"",inpaint_mask_blur:"4",inpaint_mask_content:"latent noise",mode:"txt2img",strength:"1"},{generalConfig:t,parameters:n}):"COMFY"===e?(t={inpainting_original:!1,url:"",tokenid:"",token:"",name:"COMFY",type:"COMFY",width:"1024",height:"1024",m1fix:!1,allVisible:!0,dlgData:{mode:"txt2img",prompt:"",seed:"",steps:"15",steps_update:"20",num:"1",modifiers:"highly detailed",cfg_value:"7.5",strength:".75",sampling_method:"DPMSolver++ 2M (Fast)"}},n={prompt:"",steps:0,seed:0,num:0,sampling_method:"LMS",seedList:["","","",""],imageDialog:null,regenerate:!1,image64:"",maskImage64:"",inpaint_mask_blur:"4",inpaint_mask_content:"latent noise",mode:"txt2img",strength:"1"},{generalConfig:t,parameters:n}):void 0}constructor(){}async saveToken(e,t){t||(t=""),window.localStorage.setItem(e,t)}async loadToken(e){if(!e)return;return window.localStorage.getItem(e)||""}async updateGlobalData(e){await this.load(),this.globalData=e,await this.save()}async save(){let e={configList:JSON.parse(JSON.stringify(this.configList)),currentConfigNum:this.currentConfigNum,ModifierData:this.ModifierData,globalData:this.globalData},t=JSON.stringify(e);await window.localStorage.setItem("config",t)}async load(){let e=await localStorage.getItem("config");if(e){let t=JSON.parse(e);this.configList=t.configList,t.ModifierData&&(this.ModifierData=t.ModifierData),t.globalData&&(this.globalData=t.globalData),this.currentConfigNum=t.currentConfigNum,await this.get()}return null}async add(e){let t=this.getDefault(e);this.configList.push(t),this.currentConfigNum=this.configList.length-1,await this.get(),await this.save()}async switch(e){return await this.load(),this.currentConfigNum=e,await this.save(),await this.get(),this}async set(){let e=JSON.parse(JSON.stringify({generalConfig:this.generalConfig,parameters:this.parameters}));if(e.generalConfig.tokenid||(this.generalConfig.tokenid=e.generalConfig.tokenid=(Math.random()+1).toString(36).substring(2)),this.generalConfig.tokenid&&this.generalConfig.tokenid.length)try{await this.saveToken(this.generalConfig.tokenid,this.generalConfig.token)}catch(e){}this.configList[this.currentConfigNum]=e,this.generalConfig.dlgData&&(this.globalData.prompt=this.generalConfig.dlgData.prompt,this.globalData.modifiers=this.generalConfig.dlgData.modifiers),await this.save()}async get(){let e=this.configList[this.currentConfigNum];if(e){if(this.generalConfig=e.generalConfig,this.generalConfig.tokenid&&this.generalConfig.tokenid.length)try{this.generalConfig.token=await this.loadToken(this.generalConfig.tokenid)}catch(e){}this.generalConfig.dlgData&&this.globalData&&this.globalData.prompt&&(this.generalConfig.dlgData.prompt=this.globalData.prompt,this.generalConfig.dlgData.modifiers=this.globalData.modifiers),this.parameters=e.parameters}}async delete(){this.configList.splice(this.currentConfigNum,1),this.currentConfigNum=0,await this.get(),await this.save()}}class mappingsHelper{getDefaultFields(){return[{name:"mergedImage",type:"image",notInRuleEditor:!0},{name:"mask",type:"image",notInRuleEditor:!0},{name:"hasMask",type:"boolean"},{name:"hasInitImage",type:"boolean"},{name:"prompt"},{name:"negativePrompt"},{name:"document_width",type:"number"},{name:"document_height",type:"number"},{name:"controlnet[].type"},{name:"controlnet[].image",type:"image",notInRuleEditor:!0},{name:"controlnet[].strength"},{name:"controlnet[].start_percent"},{name:"controlnet[].end_percent"},{name:"controlnet[].model"}]}getMappingFields(e){let t=[];e.forms&&e.forms.default&&e.forms.default.elements&&(t=e.forms.default.elements);let n=this.getDefaultFields(),i={fields:JSON.parse(JSON.stringify(t)),defaultFields:n,outputFields:[{name:"resultImage"}]};for(let e=0;e<t.length;e++){let n=t[e];if(n.split_value_num&&n.split_value_type)for(let e=0;e<n.split_value_num;e++){let t={name:n.name+"_"+e,type:n.split_value_type,originalName:n.name,index:e};i.fields.push(t)}if("drop_layers"===n.type){if(1===n.num_layers)continue;for(let e=0;e<n.num_layers;e++){let t={name:n.name+"_"+e,type:n.type,originalName:n.name,index:e};i.fields.push(t)}}}return i}}class rulesExecution{constructor(){this.defaultFields=(new mappingsHelper).getDefaultFields()}getField(e,t){if(t){for(let n=0;n<t.length;n++){let i=t[n];if(i.name===e)return i}for(let t=0;t<this.defaultFields.length;t++){let n=this.defaultFields[t];if(n.name===e)return n}}}checkArray(e){return e.includes("[]")}getArrayName(e){if(this.checkArray(e))return e.split("[")[0]}convertValue(e,t){if(!t)return"";if("checkbox"===t.type||"boolean"===t.type){if("true"===e)return!0;if("false"===e)return!1}return"slider"===t.type||"number"===t.type?this.isFloat(t.step)?parseFloat(e):parseInt(e):e}getValue(e,t,n,i){let s=this.getField(t,n);if(!this.checkArray(t)){let n=e[t];return this.convertValue(n,s)}let a=t.split("[")[0],o=t.split(".")[1],r=i[a];if(!e[a])throw"array_not_found "+a;if(!e[a][r])throw"index_in_array_not_found "+a+" "+r;let l=e[a][r][o];return this.convertValue(l,s)}setValue(e,t,n,i,s){let a=this.getField(n,i);if(!this.checkArray(n))return void(e[n]=this.convertValue(t,a));let o=n.split("[")[0],r=n.split(".")[1],l=s[o];t=this.convertValue(t,a),e[o][l][r]=t}isFloat(e){return"number"==typeof e&&!isNaN(e)&&e%1!=0}execute(e,t,n,i={},s=""){if(n||(n=[]),!e)return{data:e,hiddenFields:{}};let a=[],o=[];for(let r=0;r<n.length;r++){let l,c=n[r],p=this.getField(c.fieldName,t);if("__ignore_arrays"===s&&this.checkArray(p.name))continue;try{l=this.getValue(e,c.fieldName,t,i)}catch(e){continue}let h=c.rightValue;if(!p)continue;if(s&&"__ignore_arrays"!==s&&!this.checkArray(p.name))continue;if(s&&"__ignore_arrays"!==s&&this.getArrayName(p.name)!==s)continue;h=this.convertValue(h,p),l=this.convertValue(l,p);let d,u,g=!1;switch(c.condition){case"===":case"==":l===h&&(g=!0);break;case"!=":case"!==":l!==h&&(g=!0);break;case">":l>h&&(g=!0);break;case"<=":l<=h&&(g=!0);break;case">=":l>=h&&(g=!0);break;case"<":l<h&&(g=!0)}if(g&&(!c.targetField||(d=c.targetField,u=this.getField(d,t),u))){if("setValue"===c.actionType){let n=c.actionValue;this.setValue(e,n,d,t,i)}if("hideField"===c.actionType&&(a.push(c.targetField),u.hideIt=!0,u.showIt=!1),"showField"===c.actionType&&(o.push(c.targetField),u.showIt=!0,u.hideIt=!1),"copyValue"===c.actionType){let n=c.actionValue;if(!this.getField(c.actionValue,t))continue;let s=this.getValue(e,n,t,i);this.setValue(e,s,d,t,i)}if("copyParameter"===c.actionType){let n=c.actionValue;if(!this.getField(c.actionValue,t))continue;let s=this.getValue(e,n,t,i),a=this.getField(d,t);a._force_render=!0,a[c.targetParameter]=s}}}return{data:e,hiddenFields:a}}}class loopPreparser{constructor(e){this.workflow=e,this.nodeMapping={}}getGroup(e,t){return t.find((t=>{const[n,i,s,a]=t.bounding,[o,r]=e.pos;return o>=n&&o<=n+s&&r>=i&&r<=i+a}))}getNodeById(e){return this.workflow.nodes.find((t=>t.id===e))}getGroupByName(e){return this.workflow.groups.find((t=>t.title===e))}isNodeInGroup(e,t){const n=this.workflow.nodes.find((t=>t.id===e));if(!n)return!1;const i=this.workflow.groups.find((e=>e.title===t&&e.bounding));if(!i)return!1;const[s,a,o,r]=i.bounding,[l,c]=n.pos;return l>=s&&l<=s+o&&c>=a&&c<=a+r}updateNodeLinks(){this.workflow.nodes.forEach((e=>{e.inputs&&e.inputs.forEach((e=>{e.link=null})),e.outputs&&e.outputs.forEach((e=>{e.links=[]}))})),this.workflow.links.forEach((e=>{const[t,n,i,s,a,o]=e,r=this.workflow.nodes.find((e=>e.id===n)),l=this.workflow.nodes.find((e=>e.id===s));r&&r.outputs&&r.outputs[i]&&(r.outputs[i].links||(r.outputs[i].links=[]),r.outputs[i].links.push(t)),l&&l.inputs&&l.inputs[a]&&(l.inputs[a].link=t)}))}removeGyreNodesAndLinkDirectly(){for(let e=this.workflow.nodes.length-1;e>=0;e--){const t=this.workflow.nodes[e];if("GyreLoopStart"===t.type||"GyreLoopEnd"===t.type){const n=this.workflow.links.find((e=>e[1]===t.id)),i=this.workflow.links.find((e=>e[3]===t.id));if(n&&i){const t=[this.workflow.last_link_id+1,i[1],i[2],n[3],n[4],n[5]];this.workflow.last_link_id++,this.workflow.links.push(t),this.workflow.links=this.workflow.links.filter((e=>e[0]!==n[0]&&e[0]!==i[0])),this.workflow.nodes.splice(e,1)}}}}splitLinkWithGyreStartNode(e){const t=this.workflow.links.findIndex((t=>t[0]===e));if(-1===t)return;const n=this.workflow.links[t],[i,s,a,o,r,l]=n,c=++this.workflow.last_node_id,p=++this.workflow.last_link_id,h=++this.workflow.last_link_id,d={id:c,type:"GyreLoopStart",pos:[0,0],inputs:[{name:"ANY",type:"*",link:16}]};this.workflow.nodes.push(d);const u=[p,s,a,c,0,l],g=[h,c,0,o,r,l];this.workflow.links.push(u,g),this.workflow.links.splice(t,1)}adjustLinksForSpecialNodes(e){const t=this.workflow.nodes.filter((e=>"GyreLoopEnd"===e.type)).map((e=>e.id)),n=[];let i=[];const s=[];this.workflow.links.forEach((a=>{const[o,r,l,c,p,h]=a;if(t.includes(c)&&this.isNodeInGroup(r,e)){n.push(o),i.push([...a]);const e=[this.workflow.last_link_id+1,this.nodeMapping[r],l,c,p,h];s.push(e),this.workflow.last_link_id++}})),this.workflow.links=this.workflow.links.filter((e=>!n.includes(e[0]))),this.workflow.links.push(...s),i.forEach((t=>{const[n,i,s,a,o,r]=t;let l;if(this.workflow.links.forEach((t=>{const[n,i,a,o,r,c]=t;"GyreLoopStart"===this.getNodeById(i).type&&this.isNodeInGroup(o,e)&&s===r&&(l=t)})),l){const e=this.nodeMapping[l[3]];if(e){const t=++this.workflow.last_link_id,n=[t,i,s,e,s,r];this.workflow.links.push(n),this.splitLinkWithGyreStartNode(t)}}}))}duplicateGroupWithNodesAndLinks(e,t){const n=this.getGroupByName(e);if(!n)return;let i=this.workflow.last_node_id,s=this.workflow.last_link_id;const a=JSON.parse(JSON.stringify(n));a.title=t,a.bounding[0]+=n.bounding[2]+70,this.workflow.groups.push(a),this.nodeMapping={},this.workflow.nodes.forEach((t=>{if(this.isNodeInGroup(t.id,e)){const e=JSON.parse(JSON.stringify(t));e.id=++i,e.pos[0]+=n.bounding[2]+70,this.nodeMapping[t.id]=e.id,this.workflow.nodes.push(e)}})),this.workflow.links.forEach((e=>{const[t,n,i,a,o,r]=e;if(this.nodeMapping[n]&&this.nodeMapping[a]){const e=[++s,this.nodeMapping[n],i,this.nodeMapping[a],o,r];this.workflow.links.push(e)}})),this.workflow.links.forEach((t=>{const[n,i,a,o,r,l]=t,c=this.workflow.nodes.find((e=>e.id===i));if(this.workflow.nodes.find((e=>e.id===o)),this.isNodeInGroup(o,e)&&!this.isNodeInGroup(i,e)&&"GyreLoopStart"!==c.type&&"GyreLoopEnd"!==c.type){const e=[++s,i,a,this.nodeMapping[o],r,l];this.workflow.links.push(e)}})),this.workflow.last_link_id=s,this.workflow.last_node_id=i,this.adjustLinksForSpecialNodes(e),this.cloneMappings(e)}cloneMappings(e){let t=this.workflow.extra.gyre.mappings;if(t){for(let n=this.workflow.nodes.length-1;n>=0;n--){const i=this.workflow.nodes[n];if(this.isNodeInGroup(i.id,e)){let e=t[i.id];if(e){let n=this.nodeMapping[i.id];n&&(t[n]=JSON.parse(JSON.stringify(e)))}}}this.workflow.extra.gyre.mappings=t}}deactivateGroup(e){for(let t=this.workflow.nodes.length-1;t>=0;t--){const n=this.workflow.nodes[t];this.isNodeInGroup(n.id,e)&&(n.mode=4)}}generateLoop(e,t){let n=this.getGroupByName(e+"[]");if(n){if(n.title=e+"[0]",0===t)return this.deactivateGroup(e+"[0]"),this.removeGyreNodesAndLinkDirectly(),void this.updateNodeLinks();if(t>1)for(let n=0;n<t-1;n++)this.duplicateGroupWithNodesAndLinks(e+"["+n+"]",e+"["+(n+1)+"]");this.removeGyreNodesAndLinkDirectly(),this.updateNodeLinks()}}}class valuePreparser{constructor(e){this.workflow=e,this.loopParser=new loopPreparser(e),this.rules=new rulesExecution,e.extra.gyre&&(this.metadata=e.extra.gyre,this.fieldList=[],this.metadata.forms&&this.metadata.forms.default&&(this.fieldList=(new mappingsHelper).getMappingFields(this.metadata).fields))}getWidgetIndex(e,t){let n=this.workflow.extra.gyre.nodeWidgets;for(let i in n)if(parseInt(i)===e){let e=n[i];for(let n=0;n<e.length;n++){if(e[n].name===t)return n}}return-1}getLinkById(e){return this.workflow.links.find((t=>t[0]===e))}getNodeById(e){return this.workflow.nodes.find((t=>t.id===e))}async getImage(e,t="",n=0){if(window.postMessageAdapter){let i=window.postMessageAdapter.getWorkflowImageRequestServerInstance();return await i.getSingleImage(e,t,n)}return null}async getLayerImage(e,t){if(window.postMessageAdapter){let n=window.postMessageAdapter.getWorkflowImageRequestServerInstance();return await n.getLayerImage(e,t)}return null}async getFile(e){if(window.postMessageAdapter){let t=window.postMessageAdapter.getWorkflowImageRequestServerInstance();return await t.getFile(e)}return null}async convertValue(e,t,n="",i=0){if("image"===t.type){if(n){let e=t.name.split(".")[1];return await this.getImage(e,n,i)}return await this.getImage(t.name)}if("layer_image"===t.type)return await this.getLayerImage(t.name);if("file"===t.type)return await this.getFile(t.name);if("drop_layers"===t.type){let n=0;t.originalName&&(n=t.index);let i=e.split(",")[n];return await this.getLayerImage(null,i)}return"number"==t.type&&!t.step&&e&&(t.step=e),this.rules.convertValue(e,t)}async setNodesValue(e,t,n){for(let i in this.metadata.mappings){let s=this.metadata.mappings[i];if(!s||!s.length)continue;let a=parseInt(i),o=this.loopParser.getNodeById(a);if(!o)continue;let r="",l=-1,c=null;if(o.outputs&&o.outputs.length&&o.outputs[0].widget){r=o.outputs[0].widget.name;let e=o.outputs[0].links[0],t=this.getLinkById(e)[3];l=this.getWidgetIndex(t,r),l>=0&&(c=this.getNodeById(t))}if(o)for(let i=0;i<s.length;i++){let a=s[i];a&&a.fromField===t&&(n=await this.convertValue(n,e),o.widgets_values[parseInt(a.toIndex)]=n,c&&(c.widgets_values[l]=n))}}}async setNodesValueGroup(e,t,n,i,s,a){for(let o=0;o<this.workflow.nodes.length;o++){let r=this.workflow.nodes[o];if(this.loopParser.isNodeInGroup(r.id,n)){let n=this.metadata.mappings[r.id];if(n&&n.length)for(let o=0;o<n.length;o++){let l=n[o];l&&l.fromField===t&&(i=await this.convertValue(i,e,s,a),r.widgets_values[parseInt(l.toIndex)]=i)}}}}removeVirtualNodes(){for(let e=this.workflow.nodes.length-1;e>=0;e--){const t=this.workflow.nodes[e];let n=!1;if(this.workflow.extra.gyre.virtualNodes&&this.workflow.extra.gyre.virtualNodes.length&&(n=this.workflow.extra.gyre.virtualNodes.includes(t.type)),n||"PrimitiveNode"===t.type){const n=this.workflow.links.find((e=>e[1]===t.id));n&&(this.workflow.links=this.workflow.links.filter((e=>e[0]!==n[0]))),this.workflow.nodes.splice(e,1)}}}async setValues(e){if(this.metadata&&this.metadata.mappings)for(let t in e){let n=e[t];if(Array.isArray(n)){let n=t;for(let t=0;t<e[n].length;t++){let i=e[n][t];for(let e in i){let s=n+"[]."+e,a=n+"["+t+"]."+e,o=i[e],r=this.rules.getField(s,this.fieldList);await this.setNodesValue(r,a,o);let l=n+"["+t+"]";await this.setNodesValueGroup(r,s,l,o,n,t)}}}else{let e=this.rules.getField(t,this.fieldList);e&&await this.setNodesValue(e,e.name,n)}}}splitCustomValues(e){for(let t in e){let n=e[t],i=this.rules.getField(t,this.fieldList);if(i&&i.split_value_num&&i.split_value_type){let s=n.split(";");for(let n=0;n<i.split_value_num;n++){let a=s[n],o={name:t+"_"+n,type:i.split_value_type,step:parseFloat(a)};a=this.rules.convertValue(a,o),e[t+"_"+n]=a}}}}}class ComfyUIPreparser{constructor(e){this.workflow=e,e.extra.gyre&&(this.metadata=e.extra.gyre,this.fieldList=[],this.metadata.forms&&this.metadata.forms.default&&(this.fieldList=(new mappingsHelper).getMappingFields(this.metadata).fields))}generateLoops(e){let t=new loopPreparser(this.workflow);for(let n in e){let i=e[n];Array.isArray(i)&&t.generateLoop(n,e[n].length)}}executeAllRules(e){let t=new rulesExecution;if(this.metadata.rules){t.execute(e,this.fieldList,this.metadata.rules,{},"__ignore_arrays");for(let n in e){let i=e[n];if(Array.isArray(i))for(let i=0;i<e[n].length;i++){t=new rulesExecution;let s={};s[n]=i,t.execute(e,this.fieldList,this.metadata.rules,s,n)}}}}async setValues(e){let t=new valuePreparser(this.workflow);await t.setValues(e)}splitCustomValues(e){new valuePreparser(this.workflow).splitCustomValues(e)}async execute(e){this.generateLoops(e),this.executeAllRules(e),this.splitCustomValues(e),await this.setValues(e)}getTestData(){return{prompt:"fashion dog",negativePrompt:"ugly",hasMask:!1,controlnet:[{type:"pose",image:"empty"},{type:"depth",image:"empty"},{type:"scribble",image:"empty"}],seed:123,steps:20}}}let gyre;(function(global){var LiteGraph=global.LiteGraph={VERSION:.4,CANVAS_GRID_SIZE:10,NODE_TITLE_HEIGHT:30,NODE_TITLE_TEXT_Y:20,NODE_SLOT_HEIGHT:20,NODE_WIDGET_HEIGHT:20,NODE_WIDTH:140,NODE_MIN_WIDTH:50,NODE_COLLAPSED_RADIUS:10,NODE_COLLAPSED_WIDTH:80,NODE_TITLE_COLOR:"#999",NODE_SELECTED_TITLE_COLOR:"#FFF",NODE_TEXT_SIZE:14,NODE_TEXT_COLOR:"#AAA",NODE_SUBTEXT_SIZE:12,NODE_DEFAULT_COLOR:"#333",NODE_DEFAULT_BGCOLOR:"#353535",NODE_DEFAULT_BOXCOLOR:"#666",NODE_DEFAULT_SHAPE:"box",NODE_BOX_OUTLINE_COLOR:"#FFF",DEFAULT_SHADOW_COLOR:"rgba(0,0,0,0.5)",DEFAULT_GROUP_FONT:24,WIDGET_BGCOLOR:"#222",WIDGET_OUTLINE_COLOR:"#666",WIDGET_TEXT_COLOR:"#DDD",WIDGET_SECONDARY_TEXT_COLOR:"#999",LINK_COLOR:"#9A9",EVENT_LINK_COLOR:"#A86",CONNECTING_LINK_COLOR:"#AFA",MAX_NUMBER_OF_NODES:1e4,DEFAULT_POSITION:[100,100],VALID_SHAPES:["default","box","round","card"],BOX_SHAPE:1,ROUND_SHAPE:2,CIRCLE_SHAPE:3,CARD_SHAPE:4,ARROW_SHAPE:5,GRID_SHAPE:6,INPUT:1,OUTPUT:2,EVENT:-1,ACTION:-1,NODE_MODES:["Always","On Event","Never","On Trigger"],NODE_MODES_COLORS:["#666","#422","#333","#224","#626"],ALWAYS:0,ON_EVENT:1,NEVER:2,ON_TRIGGER:3,UP:1,DOWN:2,LEFT:3,RIGHT:4,CENTER:5,LINK_RENDER_MODES:["Straight","Linear","Spline"],STRAIGHT_LINK:0,LINEAR_LINK:1,SPLINE_LINK:2,NORMAL_TITLE:0,NO_TITLE:1,TRANSPARENT_TITLE:2,AUTOHIDE_TITLE:3,VERTICAL_LAYOUT:"vertical",proxy:null,node_images_path:"",debug:!1,catch_exceptions:!0,throw_errors:!0,allow_scripts:!1,registered_node_types:{},node_types_by_file_extension:{},Nodes:{},Globals:{},searchbox_extras:{},auto_sort_node_types:!1,node_box_coloured_when_on:!1,node_box_coloured_by_mode:!1,dialog_close_on_mouse_leave:!1,dialog_close_on_mouse_leave_delay:500,shift_click_do_break_link_from:!1,click_do_break_link_to:!1,search_hide_on_mouse_leave:!0,search_filter_enabled:!1,search_show_all_on_open:!0,auto_load_slot_types:!1,registered_slot_in_types:{},registered_slot_out_types:{},slot_types_in:[],slot_types_out:[],slot_types_default_in:[],slot_types_default_out:[],alt_drag_do_clone_nodes:!1,do_add_triggers_slots:!1,allow_multi_output_for_events:!0,middle_click_slot_add_default_node:!1,release_link_on_empty_shows_menu:!1,pointerevents_method:"pointer",ctrl_shift_v_paste_connect_unselected_outputs:!0,use_uuids:!1,registerNodeType:function(e,t){if(!t.prototype)throw"Cannot register a simple object, it must be a class with a prototype";t.type=e,LiteGraph.debug;const n=t.name,i=e.lastIndexOf("/");for(var s in t.category=e.substring(0,i),t.title||(t.title=n),LGraphNode.prototype)t.prototype[s]||(t.prototype[s]=LGraphNode.prototype[s]);const a=this.registered_node_types[e];if(!Object.prototype.hasOwnProperty.call(t.prototype,"shape")&&(Object.defineProperty(t.prototype,"shape",{set:function(e){switch(e){case"default":delete this._shape;break;case"box":this._shape=LiteGraph.BOX_SHAPE;break;case"round":this._shape=LiteGraph.ROUND_SHAPE;break;case"circle":this._shape=LiteGraph.CIRCLE_SHAPE;break;case"card":this._shape=LiteGraph.CARD_SHAPE;break;default:this._shape=e}},get:function(){return this._shape},enumerable:!0,configurable:!0}),t.supported_extensions))for(let e in t.supported_extensions){const n=t.supported_extensions[e];n&&n.constructor===String&&(this.node_types_by_file_extension[n.toLowerCase()]=t)}this.registered_node_types[e]=t,t.constructor.name&&(this.Nodes[n]=t),LiteGraph.onNodeTypeRegistered&&LiteGraph.onNodeTypeRegistered(e,t),a&&LiteGraph.onNodeTypeReplaced&&LiteGraph.onNodeTypeReplaced(e,t,a),t.prototype.onPropertyChange,this.auto_load_slot_types&&new t(t.title||"tmpnode")},unregisterNodeType:function(e){const t=e.constructor===String?this.registered_node_types[e]:e;if(!t)throw"node type not found: "+e;delete this.registered_node_types[t.type],t.constructor.name&&delete this.Nodes[t.constructor.name]},registerNodeAndSlotType:function(e,t,n){n=n||!1;const i=(e.constructor===String&&"anonymous"!==this.registered_node_types[e]?this.registered_node_types[e]:e).constructor.type;let s=[];s="string"==typeof t?t.split(","):t==this.EVENT||t==this.ACTION?["_event_"]:["*"];for(let e=0;e<s.length;++e){let t=s[e];""===t&&(t="*");const a=n?"registered_slot_out_types":"registered_slot_in_types";void 0===this[a][t]&&(this[a][t]={nodes:[]}),this[a][t].nodes.includes(i)||this[a][t].nodes.push(i),n?this.slot_types_out.includes(t.toLowerCase())||(this.slot_types_out.push(t.toLowerCase()),this.slot_types_out.sort()):this.slot_types_in.includes(t.toLowerCase())||(this.slot_types_in.push(t.toLowerCase()),this.slot_types_in.sort())}},wrapFunctionAsNode:function(e,t,n,i,s){for(var a=Array(t.length),o="",r=LiteGraph.getParameterNames(t),l=0;l<r.length;++l)o+="this.addInput('"+r[l]+"',"+(n&&n[l]?"'"+n[l]+"'":"0")+");\n";o+="this.addOutput('out',"+(i?"'"+i+"'":0)+");\n",s&&(o+="this.properties = "+JSON.stringify(s)+";\n");var c=Function(o);c.title=e.split("/").pop(),c.desc="Generated from "+t.name,c.prototype.onExecute=function(){for(var e=0;e<a.length;++e)a[e]=this.getInputData(e);var n=t.apply(this,a);this.setOutputData(0,n)},this.registerNodeType(e,c)},clearRegisteredTypes:function(){this.registered_node_types={},this.node_types_by_file_extension={},this.Nodes={},this.searchbox_extras={}},addNodeMethod:function(e,t){for(var n in LGraphNode.prototype[e]=t,this.registered_node_types){var i=this.registered_node_types[n];i.prototype[e]&&(i.prototype["_"+e]=i.prototype[e]),i.prototype[e]=t}},createNode:function(e,t,n){var i=this.registered_node_types[e];if(!i)return LiteGraph.debug,null;i.prototype,t=t||i.title||e;var s=null;if(LiteGraph.catch_exceptions)try{s=new i(t)}catch(e){return null}else s=new i(t);if(s.type=e,!s.title&&t&&(s.title=t),s.properties||(s.properties={}),s.properties_info||(s.properties_info=[]),s.flags||(s.flags={}),s.size||(s.size=s.computeSize()),s.pos||(s.pos=LiteGraph.DEFAULT_POSITION.concat()),s.mode||(s.mode=LiteGraph.ALWAYS),n)for(var a in n)s[a]=n[a];return s.onNodeCreated&&s.onNodeCreated(),s},getNodeType:function(e){return this.registered_node_types[e]},getNodeTypesInCategory:function(e,t){var n=[];for(var i in this.registered_node_types){var s=this.registered_node_types[i];s.filter==t&&(""==e?null==s.category&&n.push(s):s.category==e&&n.push(s))}return this.auto_sort_node_types&&n.sort((function(e,t){return e.title.localeCompare(t.title)})),n},getNodeTypesCategories:function(e){var t={"":1};for(var n in this.registered_node_types){var i=this.registered_node_types[n];if(i.category&&!i.skip_list){if(i.filter!=e)continue;t[i.category]=1}}var s=[];for(var n in t)s.push(n);return this.auto_sort_node_types?s.sort():s},reloadNodes:function(e){for(var t=document.getElementsByTagName("script"),n=[],i=0;i<t.length;i++)n.push(t[i]);var s=document.getElementsByTagName("head")[0];e=document.location.href+e;for(i=0;i<n.length;i++){var a=n[i].src;if(a&&a.substr(0,e.length)==e)try{LiteGraph.debug;var o=document.createElement("script");o.type="text/javascript",o.src=a,s.appendChild(o),s.removeChild(n[i])}catch(e){if(LiteGraph.throw_errors)throw e;LiteGraph.debug}}LiteGraph.debug},cloneObject:function(e,t){if(null==e)return null;var n=JSON.parse(JSON.stringify(e));if(!t)return n;for(var i in n)t[i]=n[i];return t},uuidv4:function(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(e=>(e^16*Math.random()>>e/4).toString(16)))},isValidConnection:function(e,t){if(""!=e&&"*"!==e||(e=0),""!=t&&"*"!==t||(t=0),!e||!t||e==t||e==LiteGraph.EVENT&&t==LiteGraph.ACTION)return!0;if(e=String(e),t=String(t),e=e.toLowerCase(),t=t.toLowerCase(),-1==e.indexOf(",")&&-1==t.indexOf(","))return e==t;for(var n=e.split(","),i=t.split(","),s=0;s<n.length;++s)for(var a=0;a<i.length;++a)if(this.isValidConnection(n[s],i[a]))return!0;return!1},registerSearchboxExtra:function(e,t,n){this.searchbox_extras[t.toLowerCase()]={type:e,desc:t,data:n}},fetchFile:function(e,t,n,i){if(!e)return null;if(t=t||"text",e.constructor===String)return"http"==e.substr(0,4)&&LiteGraph.proxy&&(e=LiteGraph.proxy+e.substr(e.indexOf(":")+3)),fetch(e).then((function(e){if(!e.ok)throw new Error("File not found");return"arraybuffer"==t?e.arrayBuffer():"text"==t||"string"==t?e.text():"json"==t?e.json():"blob"==t?e.blob():void 0})).then((function(e){n&&n(e)})).catch((function(e){i&&i(e)}));if(e.constructor===File||e.constructor===Blob){var s=new FileReader;if(s.onload=function(e){var i=e.target.result;"json"==t&&(i=JSON.parse(i)),n&&n(i)},"arraybuffer"==t)return s.readAsArrayBuffer(e);if("text"==t||"json"==t)return s.readAsText(e);if("blob"==t)return s.readAsBinaryString(e)}return null}};function LGraph(e){LiteGraph.debug,this.list_of_graphcanvas=null,this.clear(),e&&this.configure(e)}function LLink(e,t,n,i,s,a){this.id=e,this.type=t,this.origin_id=n,this.origin_slot=i,this.target_id=s,this.target_slot=a,this._data=null,this._pos=new Float32Array(2)}function LGraphNode(e){this._ctor(e)}function LGraphGroup(e){this._ctor(e)}function DragAndScale(e,t){this.offset=new Float32Array([0,0]),this.scale=1,this.max_scale=10,this.min_scale=.1,this.onredraw=null,this.enabled=!0,this.last_mouse=[0,0],this.element=null,this.visible_area=new Float32Array(4),e&&(this.element=e,t||this.bindEvents(e))}function LGraphCanvas(e,t,n){this.options=n=n||{},this.background_image=LGraphCanvas.DEFAULT_BACKGROUND_IMAGE,e&&e.constructor===String&&(e=document.querySelector(e)),this.ds=new DragAndScale,this.zoom_modify_alpha=!0,this.title_text_font=LiteGraph.NODE_TEXT_SIZE+"px Arial",this.inner_text_font="normal "+LiteGraph.NODE_SUBTEXT_SIZE+"px Arial",this.node_title_color=LiteGraph.NODE_TITLE_COLOR,this.default_link_color=LiteGraph.LINK_COLOR,this.default_connection_color={input_off:"#778",input_on:"#7F7",output_off:"#778",output_on:"#7F7"},this.default_connection_color_byType={},this.default_connection_color_byTypeOff={},this.highquality_render=!0,this.use_gradients=!1,this.editor_alpha=1,this.pause_rendering=!1,this.clear_background=!0,this.clear_background_color="#222",this.read_only=!1,this.render_only_selected=!0,this.live_mode=!1,this.show_info=!0,this.allow_dragcanvas=!0,this.allow_dragnodes=!0,this.allow_interaction=!0,this.multi_select=!1,this.allow_searchbox=!0,this.allow_reconnect_links=!0,this.align_to_grid=!1,this.drag_mode=!1,this.dragging_rectangle=null,this.filter=null,this.set_canvas_dirty_on_mouse_event=!0,this.always_render_background=!1,this.render_shadows=!0,this.render_canvas_border=!0,this.render_connections_shadows=!1,this.render_connections_border=!0,this.render_curved_connections=!1,this.render_connection_arrows=!1,this.render_collapsed_slots=!0,this.render_execution_order=!1,this.render_title_colored=!0,this.render_link_tooltip=!0,this.links_render_mode=LiteGraph.SPLINE_LINK,this.mouse=[0,0],this.graph_mouse=[0,0],this.canvas_mouse=this.graph_mouse,this.onSearchBox=null,this.onSearchBoxSelection=null,this.onMouse=null,this.onDrawBackground=null,this.onDrawForeground=null,this.onDrawOverlay=null,this.onDrawLinkTooltip=null,this.onNodeMoved=null,this.onSelectionChange=null,this.onConnectingChange=null,this.onBeforeChange=null,this.onAfterChange=null,this.connections_width=3,this.round_radius=8,this.current_node=null,this.node_widget=null,this.over_link_center=null,this.last_mouse_position=[0,0],this.visible_area=this.ds.visible_area,this.visible_links=[],this.viewport=n.viewport||null,t&&t.attachCanvas(this),this.setCanvas(e,n.skip_events),this.clear(),n.skip_render||this.startRendering(),this.autoresize=n.autoresize}"undefined"!=typeof performance?LiteGraph.getTime=performance.now.bind(performance):"undefined"!=typeof Date&&Date.now?LiteGraph.getTime=Date.now.bind(Date):"undefined"!=typeof process?LiteGraph.getTime=function(){var e=process.hrtime();return.001*e[0]+1e-6*e[1]}:LiteGraph.getTime=function(){return(new Date).getTime()},global.LGraph=LiteGraph.LGraph=LGraph,LGraph.supported_types=["number","string","boolean"],LGraph.prototype.getSupportedTypes=function(){return this.supported_types||LGraph.supported_types},LGraph.STATUS_STOPPED=1,LGraph.STATUS_RUNNING=2,LGraph.prototype.clear=function(){if(this.stop(),this.status=LGraph.STATUS_STOPPED,this.last_node_id=0,this.last_link_id=0,this._version=-1,this._nodes)for(var e=0;e<this._nodes.length;++e){var t=this._nodes[e];t.onRemoved&&t.onRemoved()}this._nodes=[],this._nodes_by_id={},this._nodes_in_order=[],this._nodes_executable=null,this._groups=[],this.links={},this.iteration=0,this.config={},this.vars={},this.extra={},this.globaltime=0,this.runningtime=0,this.fixedtime=0,this.fixedtime_lapse=.01,this.elapsed_time=.01,this.last_update_time=0,this.starttime=0,this.catch_errors=!0,this.nodes_executing=[],this.nodes_actioning=[],this.nodes_executedAction=[],this.inputs={},this.outputs={},this.change(),this.sendActionToCanvas("clear")},LGraph.prototype.attachCanvas=function(e){if(e.constructor!=LGraphCanvas)throw"attachCanvas expects a LGraphCanvas instance";e.graph&&e.graph!=this&&e.graph.detachCanvas(e),e.graph=this,this.list_of_graphcanvas||(this.list_of_graphcanvas=[]),this.list_of_graphcanvas.push(e)},LGraph.prototype.detachCanvas=function(e){if(this.list_of_graphcanvas){var t=this.list_of_graphcanvas.indexOf(e);-1!=t&&(e.graph=null,this.list_of_graphcanvas.splice(t,1))}},LGraph.prototype.start=function(e){if(this.status!=LGraph.STATUS_RUNNING){this.status=LGraph.STATUS_RUNNING,this.onPlayEvent&&this.onPlayEvent(),this.sendEventToAllNodes("onStart"),this.starttime=LiteGraph.getTime(),this.last_update_time=this.starttime;var t=this;if(0==(e=e||0)&&"undefined"!=typeof window&&window.requestAnimationFrame){function n(){-1==t.execution_timer_id&&(window.requestAnimationFrame(n),t.onBeforeStep&&t.onBeforeStep(),t.runStep(1,!t.catch_errors),t.onAfterStep&&t.onAfterStep())}this.execution_timer_id=-1,n()}else this.execution_timer_id=setInterval((function(){t.onBeforeStep&&t.onBeforeStep(),t.runStep(1,!t.catch_errors),t.onAfterStep&&t.onAfterStep()}),e)}},LGraph.prototype.stop=function(){this.status!=LGraph.STATUS_STOPPED&&(this.status=LGraph.STATUS_STOPPED,this.onStopEvent&&this.onStopEvent(),null!=this.execution_timer_id&&(-1!=this.execution_timer_id&&clearInterval(this.execution_timer_id),this.execution_timer_id=null),this.sendEventToAllNodes("onStop"))},LGraph.prototype.runStep=function(e,t,n){e=e||1;var i=LiteGraph.getTime();this.globaltime=.001*(i-this.starttime);var s=this._nodes_executable?this._nodes_executable:this._nodes;if(s){if(n=n||s.length,t){for(var a=0;a<e;a++){for(var o=0;o<n;++o){(r=s[o]).mode==LiteGraph.ALWAYS&&r.onExecute&&r.doExecute()}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute()}else try{for(a=0;a<e;a++){for(o=0;o<n;++o){var r;(r=s[o]).mode==LiteGraph.ALWAYS&&r.onExecute&&r.onExecute()}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute(),this.errors_in_execution=!1}catch(e){if(this.errors_in_execution=!0,LiteGraph.throw_errors)throw e;LiteGraph.debug,this.stop()}var l=LiteGraph.getTime(),c=l-i;0==c&&(c=1),this.execution_time=.001*c,this.globaltime+=.001*c,this.iteration+=1,this.elapsed_time=.001*(l-this.last_update_time),this.last_update_time=l,this.nodes_executing=[],this.nodes_actioning=[],this.nodes_executedAction=[]}},LGraph.prototype.updateExecutionOrder=function(){this._nodes_in_order=this.computeExecutionOrder(!1),this._nodes_executable=[];for(var e=0;e<this._nodes_in_order.length;++e)this._nodes_in_order[e].onExecute&&this._nodes_executable.push(this._nodes_in_order[e])},LGraph.prototype.computeExecutionOrder=function(e,t){for(var n=[],i=[],s={},a={},o={},r=0,l=this._nodes.length;r<l;++r){var c=this._nodes[r];if(!e||c.onExecute){s[c.id]=c;var p=0;if(c.inputs)for(var h=0,d=c.inputs.length;h<d;h++)c.inputs[h]&&null!=c.inputs[h].link&&(p+=1);0==p?(i.push(c),t&&(c._level=1)):(t&&(c._level=0),o[c.id]=p)}}for(;0!=i.length;){c=i.shift();if(n.push(c),delete s[c.id],c.outputs)for(r=0;r<c.outputs.length;r++){var u=c.outputs[r];if(null!=u&&null!=u.links&&0!=u.links.length)for(h=0;h<u.links.length;h++){var g=u.links[h],f=this.links[g];if(f&&!a[f.id]){var _=this.getNodeById(f.target_id);null!=_?(t&&(!_._level||_._level<=c._level)&&(_._level=c._level+1),a[f.id]=!0,o[_.id]-=1,0==o[_.id]&&i.push(_)):a[f.id]=!0}}}}for(var r in s)n.push(s[r]);n.length!=this._nodes.length&&LiteGraph.debug;for(l=n.length,r=0;r<l;++r)n[r].order=r;n=n.sort((function(e,t){var n=e.constructor.priority||e.priority||0,i=t.constructor.priority||t.priority||0;return n==i?e.order-t.order:n-i}));for(r=0;r<l;++r)n[r].order=r;return n},LGraph.prototype.getAncestors=function(e){for(var t=[],n=[e],i={};n.length;){var s=n.shift();if(s.inputs){i[s.id]||s==e||(i[s.id]=!0,t.push(s));for(var a=0;a<s.inputs.length;++a){var o=s.getInputNode(a);o&&-1==t.indexOf(o)&&n.push(o)}}}return t.sort((function(e,t){return e.order-t.order})),t},LGraph.prototype.arrange=function(e,t){e=e||100;const n=this.computeExecutionOrder(!1,!0),i=[];for(let e=0;e<n.length;++e){const t=n[e],s=t._level||1;i[s]||(i[s]=[]),i[s].push(t)}let s=e;for(let n=0;n<i.length;++n){const a=i[n];if(!a)continue;let o=100,r=e+LiteGraph.NODE_TITLE_HEIGHT;for(let n=0;n<a.length;++n){const i=a[n];i.pos[0]=t==LiteGraph.VERTICAL_LAYOUT?r:s,i.pos[1]=t==LiteGraph.VERTICAL_LAYOUT?s:r;const l=t==LiteGraph.VERTICAL_LAYOUT?1:0;i.size[l]>o&&(o=i.size[l]);const c=t==LiteGraph.VERTICAL_LAYOUT?0:1;r+=i.size[c]+e+LiteGraph.NODE_TITLE_HEIGHT}s+=o+e}this.setDirtyCanvas(!0,!0)},LGraph.prototype.getTime=function(){return this.globaltime},LGraph.prototype.getFixedTime=function(){return this.fixedtime},LGraph.prototype.getElapsedTime=function(){return this.elapsed_time},LGraph.prototype.sendEventToAllNodes=function(e,t,n){n=n||LiteGraph.ALWAYS;var i=this._nodes_in_order?this._nodes_in_order:this._nodes;if(i)for(var s=0,a=i.length;s<a;++s){var o=i[s];o.constructor!==LiteGraph.Subgraph||"onExecute"==e?o[e]&&o.mode==n&&(void 0===t?o[e]():t&&t.constructor===Array?o[e].apply(o,t):o[e](t)):o.mode==n&&o.sendEventToAllNodes(e,t,n)}},LGraph.prototype.sendActionToCanvas=function(e,t){if(this.list_of_graphcanvas)for(var n=0;n<this.list_of_graphcanvas.length;++n){var i=this.list_of_graphcanvas[n];i[e]&&i[e].apply(i,t)}},LGraph.prototype.add=function(e,t){if(e){if(e.constructor===LGraphGroup)return this._groups.push(e),this.setDirtyCanvas(!0),this.change(),e.graph=this,void this._version++;if(-1!=e.id&&null!=this._nodes_by_id[e.id]&&(LiteGraph.use_uuids?e.id=LiteGraph.uuidv4():e.id=++this.last_node_id),this._nodes.length>=LiteGraph.MAX_NUMBER_OF_NODES)throw"LiteGraph: max number of nodes in a graph reached";return LiteGraph.use_uuids?null!=e.id&&-1!=e.id||(e.id=LiteGraph.uuidv4()):null==e.id||-1==e.id?e.id=++this.last_node_id:this.last_node_id<e.id&&(this.last_node_id=e.id),e.graph=this,this._version++,this._nodes.push(e),this._nodes_by_id[e.id]=e,e.onAdded&&e.onAdded(this),this.config.align_to_grid&&e.alignToGrid(),t||this.updateExecutionOrder(),this.onNodeAdded&&this.onNodeAdded(e),this.setDirtyCanvas(!0),this.change(),e}},LGraph.prototype.remove=function(e){if(e.constructor===LiteGraph.LGraphGroup){var t=this._groups.indexOf(e);return-1!=t&&this._groups.splice(t,1),e.graph=null,this._version++,this.setDirtyCanvas(!0,!0),void this.change()}if(null!=this._nodes_by_id[e.id]&&!e.ignore_remove){if(this.beforeChange(),e.inputs)for(var n=0;n<e.inputs.length;n++){null!=(i=e.inputs[n]).link&&e.disconnectInput(n)}if(e.outputs)for(n=0;n<e.outputs.length;n++){var i;null!=(i=e.outputs[n]).links&&i.links.length&&e.disconnectOutput(n)}if(e.onRemoved&&e.onRemoved(),e.graph=null,this._version++,this.list_of_graphcanvas)for(n=0;n<this.list_of_graphcanvas.length;++n){var s=this.list_of_graphcanvas[n];s.selected_nodes[e.id]&&delete s.selected_nodes[e.id],s.node_dragged==e&&(s.node_dragged=null)}var a=this._nodes.indexOf(e);-1!=a&&this._nodes.splice(a,1),delete this._nodes_by_id[e.id],this.onNodeRemoved&&this.onNodeRemoved(e),this.sendActionToCanvas("checkPanels"),this.setDirtyCanvas(!0,!0),this.afterChange(),this.change(),this.updateExecutionOrder()}},LGraph.prototype.getNodeById=function(e){return null==e?null:this._nodes_by_id[e]},LGraph.prototype.findNodesByClass=function(e,t){(t=t||[]).length=0;for(var n=0,i=this._nodes.length;n<i;++n)this._nodes[n].constructor===e&&t.push(this._nodes[n]);return t},LGraph.prototype.findNodesByType=function(e,t){e=e.toLowerCase();(t=t||[]).length=0;for(var n=0,i=this._nodes.length;n<i;++n)this._nodes[n].type.toLowerCase()==e&&t.push(this._nodes[n]);return t},LGraph.prototype.findNodeByTitle=function(e){for(var t=0,n=this._nodes.length;t<n;++t)if(this._nodes[t].title==e)return this._nodes[t];return null},LGraph.prototype.findNodesByTitle=function(e){for(var t=[],n=0,i=this._nodes.length;n<i;++n)this._nodes[n].title==e&&t.push(this._nodes[n]);return t},LGraph.prototype.getNodeOnPos=function(e,t,n,i){for(var s=(n=n||this._nodes).length-1;s>=0;s--){var a=n[s],o=a.constructor.title_mode==LiteGraph.NO_TITLE;if(a.isPointInside(e,t,i,o))return a}return null},LGraph.prototype.getGroupOnPos=function(e,t){for(var n=this._groups.length-1;n>=0;n--){var i=this._groups[n];if(i.isPointInside(e,t,2,!0))return i}return null},LGraph.prototype.checkNodeTypes=function(){for(var e=0;e<this._nodes.length;e++){var t=this._nodes[e],n=LiteGraph.registered_node_types[t.type];if(t.constructor!=n){var i=LiteGraph.createNode(t.type);this._nodes[e]=i,i.configure(t.serialize()),i.graph=this,this._nodes_by_id[i.id]=i,t.inputs&&(i.inputs=t.inputs.concat()),t.outputs&&(i.outputs=t.outputs.concat())}}this.updateExecutionOrder()},LGraph.prototype.onAction=function(e,t,n){this._input_nodes=this.findNodesByClass(LiteGraph.GraphInput,this._input_nodes);for(var i=0;i<this._input_nodes.length;++i){var s=this._input_nodes[i];if(s.properties.name==e){s.actionDo(e,t,n);break}}},LGraph.prototype.trigger=function(e,t){this.onTrigger&&this.onTrigger(e,t)},LGraph.prototype.addInput=function(e,t,n){this.inputs[e]||(this.beforeChange(),this.inputs[e]={name:e,type:t,value:n},this._version++,this.afterChange(),this.onInputAdded&&this.onInputAdded(e,t),this.onInputsOutputsChange&&this.onInputsOutputsChange())},LGraph.prototype.setInputData=function(e,t){var n=this.inputs[e];n&&(n.value=t)},LGraph.prototype.getInputData=function(e){var t=this.inputs[e];return t?t.value:null},LGraph.prototype.renameInput=function(e,t){if(t!=e){if(!this.inputs[e])return!1;if(this.inputs[t])return!1;this.inputs[t]=this.inputs[e],delete this.inputs[e],this._version++,this.onInputRenamed&&this.onInputRenamed(e,t),this.onInputsOutputsChange&&this.onInputsOutputsChange()}},LGraph.prototype.changeInputType=function(e,t){if(!this.inputs[e])return!1;this.inputs[e].type&&String(this.inputs[e].type).toLowerCase()==String(t).toLowerCase()||(this.inputs[e].type=t,this._version++,this.onInputTypeChanged&&this.onInputTypeChanged(e,t))},LGraph.prototype.removeInput=function(e){return!!this.inputs[e]&&(delete this.inputs[e],this._version++,this.onInputRemoved&&this.onInputRemoved(e),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0)},LGraph.prototype.addOutput=function(e,t,n){this.outputs[e]={name:e,type:t,value:n},this._version++,this.onOutputAdded&&this.onOutputAdded(e,t),this.onInputsOutputsChange&&this.onInputsOutputsChange()},LGraph.prototype.setOutputData=function(e,t){var n=this.outputs[e];n&&(n.value=t)},LGraph.prototype.getOutputData=function(e){var t=this.outputs[e];return t?t.value:null},LGraph.prototype.renameOutput=function(e,t){return!!this.outputs[e]&&(!this.outputs[t]&&(this.outputs[t]=this.outputs[e],delete this.outputs[e],this._version++,this.onOutputRenamed&&this.onOutputRenamed(e,t),void(this.onInputsOutputsChange&&this.onInputsOutputsChange())))},LGraph.prototype.changeOutputType=function(e,t){if(!this.outputs[e])return!1;this.outputs[e].type&&String(this.outputs[e].type).toLowerCase()==String(t).toLowerCase()||(this.outputs[e].type=t,this._version++,this.onOutputTypeChanged&&this.onOutputTypeChanged(e,t))},LGraph.prototype.removeOutput=function(e){return!!this.outputs[e]&&(delete this.outputs[e],this._version++,this.onOutputRemoved&&this.onOutputRemoved(e),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0)},LGraph.prototype.triggerInput=function(e,t){for(var n=this.findNodesByTitle(e),i=0;i<n.length;++i)n[i].onTrigger(t)},LGraph.prototype.setCallback=function(e,t){for(var n=this.findNodesByTitle(e),i=0;i<n.length;++i)n[i].setTrigger(t)},LGraph.prototype.beforeChange=function(e){this.onBeforeChange&&this.onBeforeChange(this,e),this.sendActionToCanvas("onBeforeChange",this)},LGraph.prototype.afterChange=function(e){this.onAfterChange&&this.onAfterChange(this,e),this.sendActionToCanvas("onAfterChange",this)},LGraph.prototype.connectionChange=function(e,t){this.updateExecutionOrder(),this.onConnectionChange&&this.onConnectionChange(e),this._version++,this.sendActionToCanvas("onConnectionChange")},LGraph.prototype.isLive=function(){if(!this.list_of_graphcanvas)return!1;for(var e=0;e<this.list_of_graphcanvas.length;++e){if(this.list_of_graphcanvas[e].live_mode)return!0}return!1},LGraph.prototype.clearTriggeredSlots=function(){for(var e in this.links){var t=this.links[e];t&&(t._last_time&&(t._last_time=0))}},LGraph.prototype.change=function(){LiteGraph.debug,this.sendActionToCanvas("setDirty",[!0,!0]),this.on_change&&this.on_change(this)},LGraph.prototype.setDirtyCanvas=function(e,t){this.sendActionToCanvas("setDirty",[e,t])},LGraph.prototype.removeLink=function(e){var t=this.links[e];if(t){var n=this.getNodeById(t.target_id);n&&n.disconnectInput(t.target_slot)}},LGraph.prototype.serialize=function(){for(var e=[],t=0,n=this._nodes.length;t<n;++t)e.push(this._nodes[t].serialize());var i=[];for(var t in this.links){var s=this.links[t];if(!s.serialize){var a=new LLink;for(var o in s)a[o]=s[o];this.links[t]=a,s=a}i.push(s.serialize())}var r=[];for(t=0;t<this._groups.length;++t)r.push(this._groups[t].serialize());var l={last_node_id:this.last_node_id,last_link_id:this.last_link_id,nodes:e,links:i,groups:r,config:this.config,extra:this.extra,version:LiteGraph.VERSION};return this.onSerialize&&this.onSerialize(l),l},LGraph.prototype.configure=function(e,t){if(e){t||this.clear();var n=e.nodes;if(e.links&&e.links.constructor===Array){for(var i=[],s=0;s<e.links.length;++s){var a=e.links[s];if(a){var o=new LLink;o.configure(a),i[o.id]=o}}e.links=i}for(var s in e)"nodes"!=s&&"groups"!=s&&(this[s]=e[s]);var r=!1;if(this._nodes=[],n){s=0;for(var l=n.length;s<l;++s){var c=n[s];(p=LiteGraph.createNode(c.type,c.title))||(LiteGraph.debug,(p=new LGraphNode).last_serialization=c,p.has_errors=!0,r=!0),p.id=c.id,this.add(p,!0)}for(s=0,l=n.length;s<l;++s){var p;c=n[s];(p=this.getNodeById(c.id))&&p.configure(c)}}if(this._groups.length=0,e.groups)for(s=0;s<e.groups.length;++s){var h=new LiteGraph.LGraphGroup;h.configure(e.groups[s]),this.add(h)}return this.updateExecutionOrder(),this.extra=e.extra||{},this.onConfigure&&this.onConfigure(e),this._version++,this.setDirtyCanvas(!0,!0),r}},LGraph.prototype.load=function(e,t){var n=this;if(e.constructor===File||e.constructor===Blob){var i=new FileReader;return i.addEventListener("load",(function(e){var i=JSON.parse(e.target.result);n.configure(i),t&&t()})),void i.readAsText(e)}var s=new XMLHttpRequest;s.open("GET",e,!0),s.send(null),s.onload=function(e){if(200===s.status){var i=JSON.parse(s.response);n.configure(i),t&&t()}},s.onerror=function(e){}},LGraph.prototype.onNodeTrace=function(e,t,n){},LLink.prototype.configure=function(e){e.constructor===Array?(this.id=e[0],this.origin_id=e[1],this.origin_slot=e[2],this.target_id=e[3],this.target_slot=e[4],this.type=e[5]):(this.id=e.id,this.type=e.type,this.origin_id=e.origin_id,this.origin_slot=e.origin_slot,this.target_id=e.target_id,this.target_slot=e.target_slot)},LLink.prototype.serialize=function(){return[this.id,this.origin_id,this.origin_slot,this.target_id,this.target_slot,this.type]},LiteGraph.LLink=LLink,global.LGraphNode=LiteGraph.LGraphNode=LGraphNode,LGraphNode.prototype._ctor=function(e){this.title=e||"Unnamed",this.size=[LiteGraph.NODE_WIDTH,60],this.graph=null,this._pos=new Float32Array(10,10),Object.defineProperty(this,"pos",{set:function(e){!e||e.length<2||(this._pos[0]=e[0],this._pos[1]=e[1])},get:function(){return this._pos},enumerable:!0}),LiteGraph.use_uuids?this.id=LiteGraph.uuidv4():this.id=-1,this.type=null,this.inputs=[],this.outputs=[],this.connections=[],this.properties={},this.properties_info=[],this.flags={}},LGraphNode.prototype.configure=function(e){for(var t in this.graph&&this.graph._version++,e)if("properties"!=t)null!=e[t]&&("object"==typeof e[t]?this[t]&&this[t].configure?this[t].configure(e[t]):this[t]=LiteGraph.cloneObject(e[t],this[t]):this[t]=e[t]);else for(var n in e.properties)this.properties[n]=e.properties[n],this.onPropertyChanged&&this.onPropertyChanged(n,e.properties[n]);if(e.title||(this.title=this.constructor.title),this.inputs)for(var i=0;i<this.inputs.length;++i){var s=this.inputs[i],a=this.graph?this.graph.links[s.link]:null;this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.INPUT,i,!0,a,s),this.onInputAdded&&this.onInputAdded(s)}if(this.outputs)for(i=0;i<this.outputs.length;++i){var o=this.outputs[i];if(o.links){for(t=0;t<o.links.length;++t){a=this.graph?this.graph.links[o.links[t]]:null;this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,i,!0,a,o)}this.onOutputAdded&&this.onOutputAdded(o)}}if(this.widgets){for(i=0;i<this.widgets.length;++i){var r=this.widgets[i];r&&(r.options&&r.options.property&&null!=this.properties[r.options.property]&&(r.value=JSON.parse(JSON.stringify(this.properties[r.options.property]))))}if(e.widgets_values)for(i=0;i<e.widgets_values.length;++i)this.widgets[i]&&(this.widgets[i].value=e.widgets_values[i])}this.onConfigure&&this.onConfigure(e)},LGraphNode.prototype.serialize=function(){var e={id:this.id,type:this.type,pos:this.pos,size:this.size,flags:LiteGraph.cloneObject(this.flags),order:this.order,mode:this.mode};if(this.constructor===LGraphNode&&this.last_serialization)return this.last_serialization;if(this.inputs&&(e.inputs=this.inputs),this.outputs){for(var t=0;t<this.outputs.length;t++)delete this.outputs[t]._data;e.outputs=this.outputs}if(this.title&&this.title!=this.constructor.title&&(e.title=this.title),this.properties&&(e.properties=LiteGraph.cloneObject(this.properties)),this.widgets&&this.serialize_widgets){e.widgets_values=[];for(t=0;t<this.widgets.length;++t)this.widgets[t]?e.widgets_values[t]=this.widgets[t].value:e.widgets_values[t]=null}return e.type||(e.type=this.constructor.type),this.color&&(e.color=this.color),this.bgcolor&&(e.bgcolor=this.bgcolor),this.boxcolor&&(e.boxcolor=this.boxcolor),this.shape&&(e.shape=this.shape),this.onSerialize&&this.onSerialize(e),e},LGraphNode.prototype.clone=function(){var e=LiteGraph.createNode(this.type);if(!e)return null;var t=LiteGraph.cloneObject(this.serialize());if(t.inputs)for(var n=0;n<t.inputs.length;++n)t.inputs[n].link=null;if(t.outputs)for(n=0;n<t.outputs.length;++n)t.outputs[n].links&&(t.outputs[n].links.length=0);return delete t.id,LiteGraph.use_uuids&&(t.id=LiteGraph.uuidv4()),e.configure(t),e},LGraphNode.prototype.toString=function(){return JSON.stringify(this.serialize())},LGraphNode.prototype.getTitle=function(){return this.title||this.constructor.title},LGraphNode.prototype.setProperty=function(e,t){if(this.properties||(this.properties={}),t!==this.properties[e]){var n=this.properties[e];if(this.properties[e]=t,this.onPropertyChanged&&!1===this.onPropertyChanged(e,t,n)&&(this.properties[e]=n),this.widgets)for(var i=0;i<this.widgets.length;++i){var s=this.widgets[i];if(s&&s.options.property==e){s.value=t;break}}}},LGraphNode.prototype.setOutputData=function(e,t){if(this.outputs&&!(-1==e||e>=this.outputs.length)){var n=this.outputs[e];if(n&&(n._data=t,this.outputs[e].links))for(var i=0;i<this.outputs[e].links.length;i++){var s=this.outputs[e].links[i],a=this.graph.links[s];a&&(a.data=t)}}},LGraphNode.prototype.setOutputDataType=function(e,t){if(this.outputs&&!(-1==e||e>=this.outputs.length)){var n=this.outputs[e];if(n&&(n.type=t,this.outputs[e].links))for(var i=0;i<this.outputs[e].links.length;i++){var s=this.outputs[e].links[i];this.graph.links[s].type=t}}},LGraphNode.prototype.getInputData=function(e,t){if(this.inputs&&!(e>=this.inputs.length||null==this.inputs[e].link)){var n=this.inputs[e].link,i=this.graph.links[n];if(!i)return null;if(!t)return i.data;var s=this.graph.getNodeById(i.origin_id);return s?(s.updateOutputData?s.updateOutputData(i.origin_slot):s.onExecute&&s.onExecute(),i.data):i.data}},LGraphNode.prototype.getInputDataType=function(e){if(!this.inputs)return null;if(e>=this.inputs.length||null==this.inputs[e].link)return null;var t=this.inputs[e].link,n=this.graph.links[t];if(!n)return null;var i=this.graph.getNodeById(n.origin_id);if(!i)return n.type;var s=i.outputs[n.origin_slot];return s?s.type:null},LGraphNode.prototype.getInputDataByName=function(e,t){var n=this.findInputSlot(e);return-1==n?null:this.getInputData(n,t)},LGraphNode.prototype.isInputConnected=function(e){return!!this.inputs&&(e<this.inputs.length&&null!=this.inputs[e].link)},LGraphNode.prototype.getInputInfo=function(e){return this.inputs&&e<this.inputs.length?this.inputs[e]:null},LGraphNode.prototype.getInputLink=function(e){if(!this.inputs)return null;if(e<this.inputs.length){var t=this.inputs[e];return this.graph.links[t.link]}return null},LGraphNode.prototype.getInputNode=function(e){if(!this.inputs)return null;if(e>=this.inputs.length)return null;var t=this.inputs[e];if(!t||null===t.link)return null;var n=this.graph.links[t.link];return n?this.graph.getNodeById(n.origin_id):null},LGraphNode.prototype.getInputOrProperty=function(e){if(!this.inputs||!this.inputs.length)return this.properties?this.properties[e]:null;for(var t=0,n=this.inputs.length;t<n;++t){var i=this.inputs[t];if(e==i.name&&null!=i.link){var s=this.graph.links[i.link];if(s)return s.data}}return this.properties[e]},LGraphNode.prototype.getOutputData=function(e){return this.outputs?e>=this.outputs.length?null:this.outputs[e]._data:null},LGraphNode.prototype.getOutputInfo=function(e){return this.outputs&&e<this.outputs.length?this.outputs[e]:null},LGraphNode.prototype.isOutputConnected=function(e){return!!this.outputs&&(e<this.outputs.length&&this.outputs[e].links&&this.outputs[e].links.length)},LGraphNode.prototype.isAnyOutputConnected=function(){if(!this.outputs)return!1;for(var e=0;e<this.outputs.length;++e)if(this.outputs[e].links&&this.outputs[e].links.length)return!0;return!1},LGraphNode.prototype.getOutputNodes=function(e){if(!this.outputs||0==this.outputs.length)return null;if(e>=this.outputs.length)return null;var t=this.outputs[e];if(!t.links||0==t.links.length)return null;for(var n=[],i=0;i<t.links.length;i++){var s=t.links[i],a=this.graph.links[s];if(a){var o=this.graph.getNodeById(a.target_id);o&&n.push(o)}}return n},LGraphNode.prototype.addOnTriggerInput=function(){var e=this.findInputSlot("onTrigger");return-1==e?(this.addInput("onTrigger",LiteGraph.EVENT,{optional:!0,nameLocked:!0}),this.findInputSlot("onTrigger")):e},LGraphNode.prototype.addOnExecutedOutput=function(){var e=this.findOutputSlot("onExecuted");return-1==e?(this.addOutput("onExecuted",LiteGraph.ACTION,{optional:!0,nameLocked:!0}),this.findOutputSlot("onExecuted")):e},LGraphNode.prototype.onAfterExecuteNode=function(e,t){var n=this.findOutputSlot("onExecuted");-1!=n&&this.triggerSlot(n,e,null,t)},LGraphNode.prototype.changeMode=function(e){switch(e){case LiteGraph.ON_EVENT:break;case LiteGraph.ON_TRIGGER:this.addOnTriggerInput(),this.addOnExecutedOutput();break;case LiteGraph.NEVER:case LiteGraph.ALWAYS:case LiteGraph.ON_REQUEST:break;default:return!1}return this.mode=e,!0},LGraphNode.prototype.doExecute=function(e,t){t=t||{},this.onExecute&&(t.action_call||(t.action_call=this.id+"_exec_"+Math.floor(9999*Math.random())),this.graph.nodes_executing[this.id]=!0,this.onExecute(e,t),this.graph.nodes_executing[this.id]=!1,this.exec_version=this.graph.iteration,t&&t.action_call&&(this.action_call=t.action_call,this.graph.nodes_executedAction[this.id]=t.action_call)),this.execute_triggered=2,this.onAfterExecuteNode&&this.onAfterExecuteNode(e,t)},LGraphNode.prototype.actionDo=function(e,t,n){n=n||{},this.onAction&&(n.action_call||(n.action_call=this.id+"_"+(e||"action")+"_"+Math.floor(9999*Math.random())),this.graph.nodes_actioning[this.id]=e||"actioning",this.onAction(e,t,n),this.graph.nodes_actioning[this.id]=!1,n&&n.action_call&&(this.action_call=n.action_call,this.graph.nodes_executedAction[this.id]=n.action_call)),this.action_triggered=2,this.onAfterExecuteNode&&this.onAfterExecuteNode(t,n)},LGraphNode.prototype.trigger=function(e,t,n){if(this.outputs&&this.outputs.length){this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime());for(var i=0;i<this.outputs.length;++i){var s=this.outputs[i];!s||s.type!==LiteGraph.EVENT||e&&s.name!=e||this.triggerSlot(i,t,null,n)}}},LGraphNode.prototype.triggerSlot=function(e,t,n,i){if(i=i||{},this.outputs&&null!=e){e.constructor;var s=this.outputs[e];if(s){var a=s.links;if(a&&a.length){this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime());for(var o=0;o<a.length;++o){var r=a[o];if(null==n||n==r){var l=this.graph.links[a[o]];if(l){l._last_time=LiteGraph.getTime();var c=this.graph.getNodeById(l.target_id);if(c){var p=c.inputs[l.target_slot];if(c.mode===LiteGraph.ON_TRIGGER)i.action_call||(i.action_call=this.id+"_trigg_"+Math.floor(9999*Math.random())),c.onExecute&&c.doExecute(t,i);else if(c.onAction){i.action_call||(i.action_call=this.id+"_act_"+Math.floor(9999*Math.random()));p=c.inputs[l.target_slot];c.actionDo(p.name,t,i)}}}}}}}}},LGraphNode.prototype.clearTriggeredSlot=function(e,t){if(this.outputs){var n=this.outputs[e];if(n){var i=n.links;if(i&&i.length)for(var s=0;s<i.length;++s){var a=i[s];if(null==t||t==a){var o=this.graph.links[i[s]];o&&(o._last_time=0)}}}}},LGraphNode.prototype.setSize=function(e){this.size=e,this.onResize&&this.onResize(this.size)},LGraphNode.prototype.addProperty=function(e,t,n,i){var s={name:e,type:n,default_value:t};if(i)for(var a in i)s[a]=i[a];return this.properties_info||(this.properties_info=[]),this.properties_info.push(s),this.properties||(this.properties={}),this.properties[e]=t,s},LGraphNode.prototype.addOutput=function(e,t,n){var i={name:e,type:t,links:null};if(n)for(var s in n)i[s]=n[s];return this.outputs||(this.outputs=[]),this.outputs.push(i),this.onOutputAdded&&this.onOutputAdded(i),LiteGraph.auto_load_slot_types&&LiteGraph.registerNodeAndSlotType(this,t,!0),this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0),i},LGraphNode.prototype.addOutputs=function(e){for(var t=0;t<e.length;++t){var n=e[t],i={name:n[0],type:n[1],link:null};if(e[2])for(var s in n[2])i[s]=n[2][s];this.outputs||(this.outputs=[]),this.outputs.push(i),this.onOutputAdded&&this.onOutputAdded(i),LiteGraph.auto_load_slot_types&&LiteGraph.registerNodeAndSlotType(this,n[1],!0)}this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.removeOutput=function(e){this.disconnectOutput(e),this.outputs.splice(e,1);for(var t=e;t<this.outputs.length;++t)if(this.outputs[t]&&this.outputs[t].links)for(var n=this.outputs[t].links,i=0;i<n.length;++i){var s=this.graph.links[n[i]];s&&(s.origin_slot-=1)}this.setSize(this.computeSize()),this.onOutputRemoved&&this.onOutputRemoved(e),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.addInput=function(e,t,n){var i={name:e,type:t=t||0,link:null};if(n)for(var s in n)i[s]=n[s];return this.inputs||(this.inputs=[]),this.inputs.push(i),this.setSize(this.computeSize()),this.onInputAdded&&this.onInputAdded(i),LiteGraph.registerNodeAndSlotType(this,t),this.setDirtyCanvas(!0,!0),i},LGraphNode.prototype.addInputs=function(e){for(var t=0;t<e.length;++t){var n=e[t],i={name:n[0],type:n[1],link:null};if(e[2])for(var s in n[2])i[s]=n[2][s];this.inputs||(this.inputs=[]),this.inputs.push(i),this.onInputAdded&&this.onInputAdded(i),LiteGraph.registerNodeAndSlotType(this,n[1])}this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.removeInput=function(e){this.disconnectInput(e);for(var t=this.inputs.splice(e,1),n=e;n<this.inputs.length;++n)if(this.inputs[n]){var i=this.graph.links[this.inputs[n].link];i&&(i.target_slot-=1)}this.setSize(this.computeSize()),this.onInputRemoved&&this.onInputRemoved(e,t[0]),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.addConnection=function(e,t,n,i){var s={name:e,type:t,pos:n,direction:i,links:null};return this.connections.push(s),s},LGraphNode.prototype.computeSize=function(e){if(this.constructor.size)return this.constructor.size.concat();var t=Math.max(this.inputs?this.inputs.length:1,this.outputs?this.outputs.length:1),n=e||new Float32Array([0,0]);t=Math.max(t,1);var i=LiteGraph.NODE_TEXT_SIZE,s=u(this.title),a=0,o=0;if(this.inputs)for(var r=0,l=this.inputs.length;r<l;++r){var c=this.inputs[r];a<(p=u(c.label||c.name||""))&&(a=p)}if(this.outputs)for(r=0,l=this.outputs.length;r<l;++r){var p,h=this.outputs[r];o<(p=u(h.label||h.name||""))&&(o=p)}n[0]=Math.max(a+o+10,s),n[0]=Math.max(n[0],LiteGraph.NODE_WIDTH),this.widgets&&this.widgets.length&&(n[0]=Math.max(n[0],1.5*LiteGraph.NODE_WIDTH)),n[1]=(this.constructor.slot_start_y||0)+t*LiteGraph.NODE_SLOT_HEIGHT;var d=0;if(this.widgets&&this.widgets.length){for(r=0,l=this.widgets.length;r<l;++r)this.widgets[r].computeSize?d+=this.widgets[r].computeSize(n[0])[1]+4:d+=LiteGraph.NODE_WIDGET_HEIGHT+4;d+=8}function u(e){return e?i*e.length*.6:0}return this.widgets_up?n[1]=Math.max(n[1],d):null!=this.widgets_start_y?n[1]=Math.max(n[1],d+this.widgets_start_y):n[1]+=d,this.constructor.min_height&&n[1]<this.constructor.min_height&&(n[1]=this.constructor.min_height),n[1]+=6,n},LGraphNode.prototype.inResizeCorner=function(e,t){var n=this.outputs?this.outputs.length:1,i=(this.constructor.slot_start_y||0)+n*LiteGraph.NODE_SLOT_HEIGHT;return isInsideRectangle(e,t,this.pos[0]+this.size[0]-15,this.pos[1]+Math.max(this.size[1]-15,i),20,20)},LGraphNode.prototype.getPropertyInfo=function(e){var t=null;if(this.properties_info)for(var n=0;n<this.properties_info.length;++n)if(this.properties_info[n].name==e){t=this.properties_info[n];break}return this.constructor["@"+e]&&(t=this.constructor["@"+e]),this.constructor.widgets_info&&this.constructor.widgets_info[e]&&(t=this.constructor.widgets_info[e]),!t&&this.onGetPropertyInfo&&(t=this.onGetPropertyInfo(e)),t||(t={}),t.type||(t.type=typeof this.properties[e]),"combo"==t.widget&&(t.type="enum"),t},LGraphNode.prototype.addWidget=function(e,t,n,i,s){this.widgets||(this.widgets=[]),!s&&i&&i.constructor===Object&&(s=i,i=null),s&&s.constructor===String&&(s={property:s}),i&&i.constructor===String&&(s||(s={}),s.property=i,i=null),i&&i.constructor!==Function&&(i=null);var a={type:e.toLowerCase(),name:t,value:n,callback:i,options:s||{}};if(void 0!==a.options.y&&(a.y=a.options.y),!i&&!a.options.callback&&a.options.property,"combo"==e&&!a.options.values)throw"LiteGraph addWidget('combo',...) requires to pass values in options: { values:['red','blue'] }";return this.widgets.push(a),this.setSize(this.computeSize()),a},LGraphNode.prototype.addCustomWidget=function(e){return this.widgets||(this.widgets=[]),this.widgets.push(e),e},LGraphNode.prototype.getBounding=function(e,t){e=e||new Float32Array(4);const n=this.pos,i=this.flags.collapsed,s=this.size;let a=0,o=1,r=0,l=0;return t&&(a=4,o=6+a,r=4,l=5+r),e[0]=n[0]-a,e[1]=n[1]-LiteGraph.NODE_TITLE_HEIGHT-r,e[2]=i?(this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH)+o:s[0]+o,e[3]=i?LiteGraph.NODE_TITLE_HEIGHT+l:s[1]+LiteGraph.NODE_TITLE_HEIGHT+l,this.onBounding&&this.onBounding(e),e},LGraphNode.prototype.isPointInside=function(e,t,n,i){n=n||0;var s=this.graph&&this.graph.isLive()?0:LiteGraph.NODE_TITLE_HEIGHT;if(i&&(s=0),this.flags&&this.flags.collapsed){if(isInsideRectangle(e,t,this.pos[0]-n,this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT-n,(this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH)+2*n,LiteGraph.NODE_TITLE_HEIGHT+2*n))return!0}else if(this.pos[0]-4-n<e&&this.pos[0]+this.size[0]+4+n>e&&this.pos[1]-s-n<t&&this.pos[1]+this.size[1]+n>t)return!0;return!1},LGraphNode.prototype.getSlotInPosition=function(e,t){var n=new Float32Array(2);if(this.inputs)for(var i=0,s=this.inputs.length;i<s;++i){var a=this.inputs[i];if(this.getConnectionPos(!0,i,n),isInsideRectangle(e,t,n[0]-10,n[1]-5,20,10))return{input:a,slot:i,link_pos:n}}if(this.outputs)for(i=0,s=this.outputs.length;i<s;++i){var o=this.outputs[i];if(this.getConnectionPos(!1,i,n),isInsideRectangle(e,t,n[0]-10,n[1]-5,20,10))return{output:o,slot:i,link_pos:n}}return null},LGraphNode.prototype.findInputSlot=function(e,t){if(!this.inputs)return-1;for(var n=0,i=this.inputs.length;n<i;++n)if(e==this.inputs[n].name)return t?this.inputs[n]:n;return-1},LGraphNode.prototype.findOutputSlot=function(e,t){if(t=t||!1,!this.outputs)return-1;for(var n=0,i=this.outputs.length;n<i;++n)if(e==this.outputs[n].name)return t?this.outputs[n]:n;return-1},LGraphNode.prototype.findInputSlotFree=function(e){e=e||{};var t=Object.assign({returnObj:!1,typesNotAccepted:[]},e);if(!this.inputs)return-1;for(var n=0,i=this.inputs.length;n<i;++n)if(!(this.inputs[n].link&&null!=this.inputs[n].link||t.typesNotAccepted&&t.typesNotAccepted.includes&&t.typesNotAccepted.includes(this.inputs[n].type)))return t.returnObj?this.inputs[n]:n;return-1},LGraphNode.prototype.findOutputSlotFree=function(e){e=e||{};var t=Object.assign({returnObj:!1,typesNotAccepted:[]},e);if(!this.outputs)return-1;for(var n=0,i=this.outputs.length;n<i;++n)if(!(this.outputs[n].links&&null!=this.outputs[n].links||t.typesNotAccepted&&t.typesNotAccepted.includes&&t.typesNotAccepted.includes(this.outputs[n].type)))return t.returnObj?this.outputs[n]:n;return-1},LGraphNode.prototype.findInputSlotByType=function(e,t,n,i){return this.findSlotByType(!0,e,t,n,i)},LGraphNode.prototype.findOutputSlotByType=function(e,t,n,i){return this.findSlotByType(!1,e,t,n,i)},LGraphNode.prototype.findSlotByType=function(e,t,n,i,s){n=n||!1,i=i||!1,s=s||!1;var a=(e=e||!1)?this.inputs:this.outputs;if(!a)return-1;""!=t&&"*"!=t||(t=0);for(var o=0,r=a.length;o<r;++o){var l=(t+"").toLowerCase().split(",");h=((h="0"==a[o].type||"*"==a[o].type?"0":a[o].type)+"").toLowerCase().split(",");for(var c=0;c<l.length;c++)for(var p=0;p<h.length;p++)if("_event_"==l[c]&&(l[c]=LiteGraph.EVENT),"_event_"==h[c]&&(h[c]=LiteGraph.EVENT),"*"==l[c]&&(l[c]=0),"*"==h[c]&&(h[c]=0),l[c]==h[p]){if(i&&a[o].links&&null!==a[o].links)continue;return n?a[o]:o}}if(i&&!s)for(o=0,r=a.length;o<r;++o){var h;l=(t+"").toLowerCase().split(",");h=((h="0"==a[o].type||"*"==a[o].type?"0":a[o].type)+"").toLowerCase().split(",");for(c=0;c<l.length;c++)for(p=0;p<h.length;p++)if("*"==l[c]&&(l[c]=0),"*"==h[c]&&(h[c]=0),l[c]==h[p])return n?a[o]:o}return-1},LGraphNode.prototype.connectByType=function(e,t,n,i){i=i||{};var s,a=Object.assign({createEventInCase:!0,firstFreeIfOutputGeneralInCase:!0,generalTypeInCase:!0},i);return t&&t.constructor===Number&&(t=this.graph.getNodeById(t)),(s=t.findInputSlotByType(n,!1,!0))>=0&&null!==s?this.connect(e,t,s):a.createEventInCase&&n==LiteGraph.EVENT?this.connect(e,t,-1):a.generalTypeInCase&&(s=t.findInputSlotByType(0,!1,!0,!0))>=0||a.firstFreeIfOutputGeneralInCase&&(0==n||"*"==n||""==n)&&(s=t.findInputSlotFree({typesNotAccepted:[LiteGraph.EVENT]}))>=0?this.connect(e,t,s):null},LGraphNode.prototype.connectByTypeOutput=function(e,t,n,i){i=i||{};var s=Object.assign({createEventInCase:!0,firstFreeIfInputGeneralInCase:!0,generalTypeInCase:!0},i);if(t&&t.constructor===Number&&(t=this.graph.getNodeById(t)),(a=t.findOutputSlotByType(n,!1,!0))>=0&&null!==a)return t.connect(a,this,e);if(s.generalTypeInCase&&(a=t.findOutputSlotByType(0,!1,!0,!0))>=0)return t.connect(a,this,e);if(s.createEventInCase&&n==LiteGraph.EVENT&&LiteGraph.do_add_triggers_slots){var a=t.addOnExecutedOutput();return t.connect(a,this,e)}return s.firstFreeIfInputGeneralInCase&&(0==n||"*"==n||""==n)&&(a=t.findOutputSlotFree({typesNotAccepted:[LiteGraph.EVENT]}))>=0?t.connect(a,this,e):null},LGraphNode.prototype.connect=function(e,t,n){if(n=n||0,!this.graph)return null;if(e.constructor===String){if(-1==(e=this.findOutputSlot(e)))return LiteGraph.debug,null}else if(!this.outputs||e>=this.outputs.length)return LiteGraph.debug,null;if(t&&t.constructor===Number&&(t=this.graph.getNodeById(t)),!t)throw"target node is null";if(t==this)return null;if(n.constructor===String){if(-1==(n=t.findInputSlot(n)))return LiteGraph.debug,null}else if(n===LiteGraph.EVENT){if(!LiteGraph.do_add_triggers_slots)return null;t.changeMode(LiteGraph.ON_TRIGGER),n=t.findInputSlot("onTrigger")}else if(!t.inputs||n>=t.inputs.length)return LiteGraph.debug,null;var i=!1,s=t.inputs[n],a=null,o=this.outputs[e];if(!this.outputs[e])return null;if(t.onBeforeConnectInput&&(n=t.onBeforeConnectInput(n)),!1===n||null===n||!LiteGraph.isValidConnection(o.type,s.type))return this.setDirtyCanvas(!1,!0),i&&this.graph.connectionChange(this,a),null;if(t.onConnectInput&&!1===t.onConnectInput(n,o.type,o,this,e))return null;if(this.onConnectOutput&&!1===this.onConnectOutput(e,s.type,s,t,n))return null;if(t.inputs[n]&&null!=t.inputs[n].link&&(this.graph.beforeChange(),t.disconnectInput(n,{doProcessChange:!1}),i=!0),null!==o.links&&o.links.length&&o.type===LiteGraph.EVENT)LiteGraph.allow_multi_output_for_events||(this.graph.beforeChange(),this.disconnectOutput(e,!1,{doProcessChange:!1}),i=!0);return a=new LLink(LiteGraph.use_uuids?LiteGraph.uuidv4():++this.graph.last_link_id,s.type||o.type,this.id,e,t.id,n),this.graph.links[a.id]=a,null==o.links&&(o.links=[]),o.links.push(a.id),t.inputs[n].link=a.id,this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,e,!0,a,o),t.onConnectionsChange&&t.onConnectionsChange(LiteGraph.INPUT,n,!0,a,s),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.INPUT,t,n,this,e),this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,e,t,n)),this.setDirtyCanvas(!1,!0),this.graph.afterChange(),this.graph.connectionChange(this,a),a},LGraphNode.prototype.disconnectOutput=function(e,t){if(e.constructor===String){if(-1==(e=this.findOutputSlot(e)))return LiteGraph.debug,!1}else if(!this.outputs||e>=this.outputs.length)return LiteGraph.debug,!1;var n=this.outputs[e];if(!n||!n.links||0==n.links.length)return!1;if(t){if(t.constructor===Number&&(t=this.graph.getNodeById(t)),!t)throw"Target Node not found";for(var i=0,s=n.links.length;i<s;i++){var a=n.links[i];if((o=this.graph.links[a]).target_id==t.id){n.links.splice(i,1),(r=t.inputs[o.target_slot]).link=null,delete this.graph.links[a],this.graph&&this.graph._version++,t.onConnectionsChange&&t.onConnectionsChange(LiteGraph.INPUT,o.target_slot,!1,o,r),this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,e,!1,o,n),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,e),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,e),this.graph.onNodeConnectionChange(LiteGraph.INPUT,t,o.target_slot));break}}}else{for(i=0,s=n.links.length;i<s;i++){var o;a=n.links[i];if(o=this.graph.links[a]){t=this.graph.getNodeById(o.target_id);var r=null;this.graph&&this.graph._version++,t&&((r=t.inputs[o.target_slot]).link=null,t.onConnectionsChange&&t.onConnectionsChange(LiteGraph.INPUT,o.target_slot,!1,o,r),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(LiteGraph.INPUT,t,o.target_slot)),delete this.graph.links[a],this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,e,!1,o,n),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,e),this.graph.onNodeConnectionChange(LiteGraph.INPUT,t,o.target_slot))}}n.links=null}return this.setDirtyCanvas(!1,!0),this.graph.connectionChange(this),!0},LGraphNode.prototype.disconnectInput=function(e){if(e.constructor===String){if(-1==(e=this.findInputSlot(e)))return LiteGraph.debug,!1}else if(!this.inputs||e>=this.inputs.length)return LiteGraph.debug,!1;var t=this.inputs[e];if(!t)return!1;var n=this.inputs[e].link;if(null!=n){this.inputs[e].link=null;var i=this.graph.links[n];if(i){var s=this.graph.getNodeById(i.origin_id);if(!s)return!1;var a=s.outputs[i.origin_slot];if(!a||!a.links||0==a.links.length)return!1;for(var o=0,r=a.links.length;o<r;o++)if(a.links[o]==n){a.links.splice(o,1);break}delete this.graph.links[n],this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.INPUT,e,!1,i,t),s.onConnectionsChange&&s.onConnectionsChange(LiteGraph.OUTPUT,o,!1,i,a),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,s,o),this.graph.onNodeConnectionChange(LiteGraph.INPUT,this,e))}}return this.setDirtyCanvas(!1,!0),this.graph&&this.graph.connectionChange(this),!0},LGraphNode.prototype.getConnectionPos=function(e,t,n){n=n||new Float32Array(2);var i=0;e&&this.inputs&&(i=this.inputs.length),!e&&this.outputs&&(i=this.outputs.length);var s=.5*LiteGraph.NODE_SLOT_HEIGHT;if(this.flags.collapsed){var a=this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH;return this.horizontal?(n[0]=this.pos[0]+.5*a,n[1]=e?this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT:this.pos[1]):(n[0]=e?this.pos[0]:this.pos[0]+a,n[1]=this.pos[1]-.5*LiteGraph.NODE_TITLE_HEIGHT),n}return e&&-1==t?(n[0]=this.pos[0]+.5*LiteGraph.NODE_TITLE_HEIGHT,n[1]=this.pos[1]+.5*LiteGraph.NODE_TITLE_HEIGHT,n):e&&i>t&&this.inputs[t].pos?(n[0]=this.pos[0]+this.inputs[t].pos[0],n[1]=this.pos[1]+this.inputs[t].pos[1],n):!e&&i>t&&this.outputs[t].pos?(n[0]=this.pos[0]+this.outputs[t].pos[0],n[1]=this.pos[1]+this.outputs[t].pos[1],n):this.horizontal?(n[0]=this.pos[0]+(t+.5)*(this.size[0]/i),n[1]=e?this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT:this.pos[1]+this.size[1],n):(n[0]=e?this.pos[0]+s:this.pos[0]+this.size[0]+1-s,n[1]=this.pos[1]+(t+.7)*LiteGraph.NODE_SLOT_HEIGHT+(this.constructor.slot_start_y||0),n)},LGraphNode.prototype.alignToGrid=function(){this.pos[0]=LiteGraph.CANVAS_GRID_SIZE*Math.round(this.pos[0]/LiteGraph.CANVAS_GRID_SIZE),this.pos[1]=LiteGraph.CANVAS_GRID_SIZE*Math.round(this.pos[1]/LiteGraph.CANVAS_GRID_SIZE)},LGraphNode.prototype.trace=function(e){this.console||(this.console=[]),this.console.push(e),this.console.length>LGraphNode.MAX_CONSOLE&&this.console.shift(),this.graph.onNodeTrace&&this.graph.onNodeTrace(this,e)},LGraphNode.prototype.setDirtyCanvas=function(e,t){this.graph&&this.graph.sendActionToCanvas("setDirty",[e,t])},LGraphNode.prototype.loadImage=function(e){var t=new Image;t.src=LiteGraph.node_images_path+e,t.ready=!1;var n=this;return t.onload=function(){this.ready=!0,n.setDirtyCanvas(!0)},t},LGraphNode.prototype.captureInput=function(e){if(this.graph&&this.graph.list_of_graphcanvas)for(var t=this.graph.list_of_graphcanvas,n=0;n<t.length;++n){var i=t[n];(e||i.node_capturing_input==this)&&(i.node_capturing_input=e?this:null)}},LGraphNode.prototype.collapse=function(e){this.graph._version++,(!1!==this.constructor.collapsable||e)&&(this.flags.collapsed?this.flags.collapsed=!1:this.flags.collapsed=!0,this.setDirtyCanvas(!0,!0))},LGraphNode.prototype.pin=function(e){this.graph._version++,this.flags.pinned=void 0===e?!this.flags.pinned:e},LGraphNode.prototype.localToScreen=function(e,t,n){return[(e+this.pos[0])*n.scale+n.offset[0],(t+this.pos[1])*n.scale+n.offset[1]]},global.LGraphGroup=LiteGraph.LGraphGroup=LGraphGroup,LGraphGroup.prototype._ctor=function(e){this.title=e||"Group",this.font_size=24,this.color=LGraphCanvas.node_colors.pale_blue?LGraphCanvas.node_colors.pale_blue.groupcolor:"#AAA",this._bounding=new Float32Array([10,10,140,80]),this._pos=this._bounding.subarray(0,2),this._size=this._bounding.subarray(2,4),this._nodes=[],this.graph=null,Object.defineProperty(this,"pos",{set:function(e){!e||e.length<2||(this._pos[0]=e[0],this._pos[1]=e[1])},get:function(){return this._pos},enumerable:!0}),Object.defineProperty(this,"size",{set:function(e){!e||e.length<2||(this._size[0]=Math.max(140,e[0]),this._size[1]=Math.max(80,e[1]))},get:function(){return this._size},enumerable:!0})},LGraphGroup.prototype.configure=function(e){this.title=e.title,this._bounding.set(e.bounding),this.color=e.color,e.font_size&&(this.font_size=e.font_size)},LGraphGroup.prototype.serialize=function(){var e=this._bounding;return{title:this.title,bounding:[Math.round(e[0]),Math.round(e[1]),Math.round(e[2]),Math.round(e[3])],color:this.color,font_size:this.font_size}},LGraphGroup.prototype.move=function(e,t,n){if(this._pos[0]+=e,this._pos[1]+=t,!n)for(var i=0;i<this._nodes.length;++i){var s=this._nodes[i];s.pos[0]+=e,s.pos[1]+=t}},LGraphGroup.prototype.recomputeInsideNodes=function(){this._nodes.length=0;for(var e=this.graph._nodes,t=new Float32Array(4),n=0;n<e.length;++n){var i=e[n];i.getBounding(t),overlapBounding(this._bounding,t)&&this._nodes.push(i)}},LGraphGroup.prototype.isPointInside=LGraphNode.prototype.isPointInside,LGraphGroup.prototype.setDirtyCanvas=LGraphNode.prototype.setDirtyCanvas,LiteGraph.DragAndScale=DragAndScale,DragAndScale.prototype.bindEvents=function(e){this.last_mouse=new Float32Array(2),this._binded_mouse_callback=this.onMouse.bind(this),LiteGraph.pointerListenerAdd(e,"down",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(e,"move",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(e,"up",this._binded_mouse_callback),e.addEventListener("mousewheel",this._binded_mouse_callback,!1),e.addEventListener("wheel",this._binded_mouse_callback,!1)},DragAndScale.prototype.computeVisibleArea=function(e){if(this.element){var t=this.element.width,n=this.element.height,i=-this.offset[0],s=-this.offset[1];e&&(i+=e[0]/this.scale,s+=e[1]/this.scale,t=e[2],n=e[3]);var a=i+t/this.scale,o=s+n/this.scale;this.visible_area[0]=i,this.visible_area[1]=s,this.visible_area[2]=a-i,this.visible_area[3]=o-s}else this.visible_area[0]=this.visible_area[1]=this.visible_area[2]=this.visible_area[3]=0},DragAndScale.prototype.onMouse=function(e){if(this.enabled){var t=this.element,n=t.getBoundingClientRect(),i=e.clientX-n.left,s=e.clientY-n.top;e.canvasx=i,e.canvasy=s,e.dragging=this.dragging;var a=!this.viewport||this.viewport&&i>=this.viewport[0]&&i<this.viewport[0]+this.viewport[2]&&s>=this.viewport[1]&&s<this.viewport[1]+this.viewport[3],o=!1;if(this.onmouse&&(o=this.onmouse(e)),e.type==LiteGraph.pointerevents_method+"down"&&a)this.dragging=!0,LiteGraph.pointerListenerRemove(t,"move",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(document,"move",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(document,"up",this._binded_mouse_callback);else if(e.type==LiteGraph.pointerevents_method+"move"){if(!o){var r=i-this.last_mouse[0],l=s-this.last_mouse[1];this.dragging&&this.mouseDrag(r,l)}}else e.type==LiteGraph.pointerevents_method+"up"?(this.dragging=!1,LiteGraph.pointerListenerRemove(document,"move",this._binded_mouse_callback),LiteGraph.pointerListenerRemove(document,"up",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(t,"move",this._binded_mouse_callback)):!a||"mousewheel"!=e.type&&"wheel"!=e.type&&"DOMMouseScroll"!=e.type||(e.eventType="mousewheel","wheel"==e.type?e.wheel=-e.deltaY:e.wheel=null!=e.wheelDeltaY?e.wheelDeltaY:-60*e.detail,e.delta=e.wheelDelta?e.wheelDelta/40:e.deltaY?-e.deltaY/3:0,this.changeDeltaScale(1+.05*e.delta));return this.last_mouse[0]=i,this.last_mouse[1]=s,a?(e.preventDefault(),e.stopPropagation(),!1):void 0}},DragAndScale.prototype.toCanvasContext=function(e){e.scale(this.scale,this.scale),e.translate(this.offset[0],this.offset[1])},DragAndScale.prototype.convertOffsetToCanvas=function(e){return[(e[0]+this.offset[0])*this.scale,(e[1]+this.offset[1])*this.scale]},DragAndScale.prototype.convertCanvasToOffset=function(e,t){return(t=t||[0,0])[0]=e[0]/this.scale-this.offset[0],t[1]=e[1]/this.scale-this.offset[1],t},DragAndScale.prototype.mouseDrag=function(e,t){this.offset[0]+=e/this.scale,this.offset[1]+=t/this.scale,this.onredraw&&this.onredraw(this)},DragAndScale.prototype.changeScale=function(e,t){if(e<this.min_scale?e=this.min_scale:e>this.max_scale&&(e=this.max_scale),e!=this.scale&&this.element){var n=this.element.getBoundingClientRect();if(n){t=t||[.5*n.width,.5*n.height];var i=this.convertCanvasToOffset(t);this.scale=e,Math.abs(this.scale-1)<.01&&(this.scale=1);var s=this.convertCanvasToOffset(t),a=[s[0]-i[0],s[1]-i[1]];this.offset[0]+=a[0],this.offset[1]+=a[1],this.onredraw&&this.onredraw(this)}}},DragAndScale.prototype.changeDeltaScale=function(e,t){this.changeScale(this.scale*e,t)},DragAndScale.prototype.reset=function(){this.scale=1,this.offset[0]=0,this.offset[1]=0},global.LGraphCanvas=LiteGraph.LGraphCanvas=LGraphCanvas,LGraphCanvas.DEFAULT_BACKGROUND_IMAGE="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAIAAAD/gAIDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQBJREFUeNrs1rEKwjAUhlETUkj3vP9rdmr1Ysammk2w5wdxuLgcMHyptfawuZX4pJSWZTnfnu/lnIe/jNNxHHGNn//HNbbv+4dr6V+11uF527arU7+u63qfa/bnmh8sWLBgwYJlqRf8MEptXPBXJXa37BSl3ixYsGDBMliwFLyCV/DeLIMFCxYsWLBMwSt4Be/NggXLYMGCBUvBK3iNruC9WbBgwYJlsGApeAWv4L1ZBgsWLFiwYJmCV/AK3psFC5bBggULloJX8BpdwXuzYMGCBctgwVLwCl7Be7MMFixYsGDBsu8FH1FaSmExVfAxBa/gvVmwYMGCZbBg/W4vAQYA5tRF9QYlv/QAAAAASUVORK5CYII=",LGraphCanvas.link_type_colors={"-1":LiteGraph.EVENT_LINK_COLOR,number:"#AAA",node:"#DCA"},LGraphCanvas.gradients={},LGraphCanvas.prototype.clear=function(){this.frame=0,this.last_draw_time=0,this.render_time=0,this.fps=0,this.dragging_rectangle=null,this.selected_nodes={},this.selected_group=null,this.visible_nodes=[],this.node_dragged=null,this.node_over=null,this.node_capturing_input=null,this.connecting_node=null,this.highlighted_links={},this.dragging_canvas=!1,this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.dirty_area=null,this.node_in_panel=null,this.node_widget=null,this.last_mouse=[0,0],this.last_mouseclick=0,this.pointer_is_down=!1,this.pointer_is_double=!1,this.visible_area.set([0,0,0,0]),this.onClear&&this.onClear()},LGraphCanvas.prototype.setGraph=function(e,t){this.graph!=e&&(t||this.clear(),e||!this.graph?(e.attachCanvas(this),this._graph_stack&&(this._graph_stack=null),this.setDirty(!0,!0)):this.graph.detachCanvas(this))},LGraphCanvas.prototype.getTopGraph=function(){return this._graph_stack.length?this._graph_stack[0]:this.graph},LGraphCanvas.prototype.openSubgraph=function(e){if(!e)throw"graph cannot be null";if(this.graph==e)throw"graph cannot be the same";this.clear(),this.graph&&(this._graph_stack||(this._graph_stack=[]),this._graph_stack.push(this.graph)),e.attachCanvas(this),this.checkPanels(),this.setDirty(!0,!0)},LGraphCanvas.prototype.closeSubgraph=function(){if(this._graph_stack&&0!=this._graph_stack.length){var e=this.graph._subgraph_node,t=this._graph_stack.pop();this.selected_nodes={},this.highlighted_links={},t.attachCanvas(this),this.setDirty(!0,!0),e&&(this.centerOnNode(e),this.selectNodes([e])),this.ds.offset=[0,0],this.ds.scale=1}},LGraphCanvas.prototype.getCurrentGraph=function(){return this.graph},LGraphCanvas.prototype.setCanvas=function(e,t){if(e&&e.constructor===String&&!(e=document.getElementById(e)))throw"Error creating LiteGraph canvas: Canvas not found";if(e!==this.canvas&&(!e&&this.canvas&&(t||this.unbindEvents()),this.canvas=e,this.ds.element=e,e)){if(e.className+=" lgraphcanvas",e.data=this,e.tabindex="1",this.bgcanvas=null,this.bgcanvas||(this.bgcanvas=document.createElement("canvas"),this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height),null==e.getContext){if("canvas"!=e.localName)throw"Element supplied for LGraphCanvas must be a <canvas> element, you passed a "+e.localName;throw"This browser doesn't support Canvas"}null==(this.ctx=e.getContext("2d"))&&(e.webgl_enabled,this.enableWebGL()),t||this.bindEvents()}},LGraphCanvas.prototype._doNothing=function(e){return e.preventDefault(),!1},LGraphCanvas.prototype._doReturnTrue=function(e){return e.preventDefault(),!0},LGraphCanvas.prototype.bindEvents=function(){if(!this._events_binded){var e=this.canvas,t=this.getCanvasWindow().document;this._mousedown_callback=this.processMouseDown.bind(this),this._mousewheel_callback=this.processMouseWheel.bind(this),this._mousemove_callback=this.processMouseMove.bind(this),this._mouseup_callback=this.processMouseUp.bind(this),LiteGraph.pointerListenerAdd(e,"down",this._mousedown_callback,!0),e.addEventListener("mousewheel",this._mousewheel_callback,!1),LiteGraph.pointerListenerAdd(e,"up",this._mouseup_callback,!0),LiteGraph.pointerListenerAdd(e,"move",this._mousemove_callback),e.addEventListener("contextmenu",this._doNothing),e.addEventListener("DOMMouseScroll",this._mousewheel_callback,!1),this._key_callback=this.processKey.bind(this),e.addEventListener("keydown",this._key_callback,!0),t.addEventListener("keyup",this._key_callback,!0),this._ondrop_callback=this.processDrop.bind(this),e.addEventListener("dragover",this._doNothing,!1),e.addEventListener("dragend",this._doNothing,!1),e.addEventListener("drop",this._ondrop_callback,!1),e.addEventListener("dragenter",this._doReturnTrue,!1),this._events_binded=!0}},LGraphCanvas.prototype.unbindEvents=function(){if(this._events_binded){var e=this.getCanvasWindow().document;LiteGraph.pointerListenerRemove(this.canvas,"move",this._mousedown_callback),LiteGraph.pointerListenerRemove(this.canvas,"up",this._mousedown_callback),LiteGraph.pointerListenerRemove(this.canvas,"down",this._mousedown_callback),this.canvas.removeEventListener("mousewheel",this._mousewheel_callback),this.canvas.removeEventListener("DOMMouseScroll",this._mousewheel_callback),this.canvas.removeEventListener("keydown",this._key_callback),e.removeEventListener("keyup",this._key_callback),this.canvas.removeEventListener("contextmenu",this._doNothing),this.canvas.removeEventListener("drop",this._ondrop_callback),this.canvas.removeEventListener("dragenter",this._doReturnTrue),this._mousedown_callback=null,this._mousewheel_callback=null,this._key_callback=null,this._ondrop_callback=null,this._events_binded=!1}},LGraphCanvas.getFileExtension=function(e){var t=e.indexOf("?");-1!=t&&(e=e.substr(0,t));var n=e.lastIndexOf(".");return-1==n?"":e.substr(n+1).toLowerCase()},LGraphCanvas.prototype.enableWebGL=function(){if("undefined"==typeof GL)throw"litegl.js must be included to use a WebGL canvas";if("undefined"==typeof enableWebGLCanvas)throw"webglCanvas.js must be included to use this feature";this.gl=this.ctx=enableWebGLCanvas(this.canvas),this.ctx.webgl=!0,this.bgcanvas=this.canvas,this.bgctx=this.gl,this.canvas.webgl_enabled=!0},LGraphCanvas.prototype.setDirty=function(e,t){e&&(this.dirty_canvas=!0),t&&(this.dirty_bgcanvas=!0)},LGraphCanvas.prototype.getCanvasWindow=function(){if(!this.canvas)return window;var e=this.canvas.ownerDocument;return e.defaultView||e.parentWindow},LGraphCanvas.prototype.startRendering=function(){this.is_rendering||(this.is_rendering=!0,function e(){this.pause_rendering||this.draw();var t=this.getCanvasWindow();this.is_rendering&&t.requestAnimationFrame(e.bind(this))}.call(this))},LGraphCanvas.prototype.stopRendering=function(){this.is_rendering=!1},LGraphCanvas.prototype.blockClick=function(){this.block_click=!0,this.last_mouseclick=0},LGraphCanvas.prototype.processMouseDown=function(e){if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){this.adjustMouseEvent(e);var t=this.getCanvasWindow();t.document,LGraphCanvas.active_canvas=this;var n=this,i=e.clientX,s=e.clientY;this.ds.viewport=this.viewport;var a=!this.viewport||this.viewport&&i>=this.viewport[0]&&i<this.viewport[0]+this.viewport[2]&&s>=this.viewport[1]&&s<this.viewport[1]+this.viewport[3];if(this.options.skip_events||(LiteGraph.pointerListenerRemove(this.canvas,"move",this._mousemove_callback),LiteGraph.pointerListenerAdd(t.document,"move",this._mousemove_callback,!0),LiteGraph.pointerListenerAdd(t.document,"up",this._mouseup_callback,!0)),a){var o=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes,5),r=!1,l=LiteGraph.getTime(),c=void 0===e.isPrimary||!e.isPrimary,p=l-this.last_mouseclick<300;if(this.mouse[0]=e.clientX,this.mouse[1]=e.clientY,this.graph_mouse[0]=e.canvasX,this.graph_mouse[1]=e.canvasY,this.last_click_position=[this.mouse[0],this.mouse[1]],this.pointer_is_down&&c?this.pointer_is_double=!0:this.pointer_is_double=!1,this.pointer_is_down=!0,this.canvas.focus(),LiteGraph.closeAllContextMenus(t),!this.onMouse||1!=this.onMouse(e)){if(1!=e.which||this.pointer_is_double)if(2==e.which){if(LiteGraph.middle_click_slot_add_default_node&&o&&this.allow_interaction&&!r&&!this.read_only&&!this.connecting_node&&!o.flags.collapsed&&!this.live_mode){var h=!1,d=!1,u=!1;if(o.outputs)for(v=0,w=o.outputs.length;v<w;++v){k=o.outputs[v],L=o.getConnectionPos(!1,v);if(isInsideRectangle(e.canvasX,e.canvasY,L[0]-15,L[1]-10,30,20)){h=k,d=v,u=!0;break}}if(o.inputs)for(v=0,w=o.inputs.length;v<w;++v){A=o.inputs[v],L=o.getConnectionPos(!0,v);if(isInsideRectangle(e.canvasX,e.canvasY,L[0]-15,L[1]-10,30,20)){h=A,d=v,u=!1;break}}if(h&&!1!==d){var g=.5-(d+1)/(u?o.outputs.length:o.inputs.length),f=o.getBounding(),_=[u?f[0]+f[2]:f[0],e.canvasY-80];this.createDefaultNodeForSlot({nodeFrom:u?o:null,slotFrom:u?d:null,nodeTo:u?null:o,slotTo:u?null:d,position:_,nodeType:"AUTO",posAdd:[u?30:-30,130*-g],posSizeFix:[u?0:-1,0]}),r=!0}}!r&&this.allow_dragcanvas&&(this.dragging_canvas=!0)}else(3==e.which||this.pointer_is_double)&&(!this.allow_interaction||r||this.read_only||(o&&(Object.keys(this.selected_nodes).length&&(this.selected_nodes[o.id]||e.shiftKey||e.ctrlKey||e.metaKey)?this.selected_nodes[o.id]||this.selectNodes([o],!0):this.selectNodes([o])),this.processContextMenu(o,e)));else{e.ctrlKey&&(this.dragging_rectangle=new Float32Array(4),this.dragging_rectangle[0]=e.canvasX,this.dragging_rectangle[1]=e.canvasY,this.dragging_rectangle[2]=1,this.dragging_rectangle[3]=1,r=!0),LiteGraph.alt_drag_do_clone_nodes&&e.altKey&&o&&this.allow_interaction&&!r&&!this.read_only&&(cloned=o.clone())&&(cloned.pos[0]+=5,cloned.pos[1]+=5,this.graph.add(cloned,!1,{doCalcSize:!1}),o=cloned,r=!0,C||(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=o),this.selected_nodes[o.id]||this.processNodeSelected(o,e)));var m=!1;if(!o||!this.allow_interaction&&!o.flags.allow_interaction||r||this.read_only){if(!r){if(!this.read_only)for(var v=0;v<this.visible_links.length;++v){var y=this.visible_links[v],b=y._pos;if(!(!b||e.canvasX<b[0]-4||e.canvasX>b[0]+4||e.canvasY<b[1]-4||e.canvasY>b[1]+4)){this.showLinkMenu(y,e),this.over_link_center=null;break}}if(this.selected_group=this.graph.getGroupOnPos(e.canvasX,e.canvasY),this.selected_group_resizing=!1,this.selected_group&&!this.read_only)e.ctrlKey&&(this.dragging_rectangle=null),distance([e.canvasX,e.canvasY],[this.selected_group.pos[0]+this.selected_group.size[0],this.selected_group.pos[1]+this.selected_group.size[1]])*this.ds.scale<10?this.selected_group_resizing=!0:this.selected_group.recomputeInsideNodes();p&&!this.read_only&&this.allow_searchbox&&(this.showSearchBox(e),e.preventDefault(),e.stopPropagation()),m=!0}}else{if(this.live_mode||o.flags.pinned||this.bringToFront(o),this.allow_interaction&&!this.connecting_node&&!o.flags.collapsed&&!this.live_mode)if(!r&&!1!==o.resizable&&o.inResizeCorner(e.canvasX,e.canvasY))this.graph.beforeChange(),this.resizing_node=o,this.canvas.style.cursor="se-resize",r=!0;else{if(o.outputs)for(var v=0,w=o.outputs.length;v<w;++v){var k=o.outputs[v],L=o.getConnectionPos(!1,v);if(isInsideRectangle(e.canvasX,e.canvasY,L[0]-15,L[1]-10,30,20)){this.connecting_node=o,this.connecting_output=k,this.connecting_output.slot_index=v,this.connecting_pos=o.getConnectionPos(!1,v),this.connecting_slot=v,LiteGraph.shift_click_do_break_link_from&&e.shiftKey&&o.disconnectOutput(v),p?o.onOutputDblClick&&o.onOutputDblClick(v,e):o.onOutputClick&&o.onOutputClick(v,e),r=!0;break}}if(o.inputs)for(var v=0,w=o.inputs.length;v<w;++v){var A=o.inputs[v],L=o.getConnectionPos(!0,v);if(isInsideRectangle(e.canvasX,e.canvasY,L[0]-15,L[1]-10,30,20)){if(p?o.onInputDblClick&&o.onInputDblClick(v,e):o.onInputClick&&o.onInputClick(v,e),null!==A.link){var x=this.graph.links[A.link];LiteGraph.click_do_break_link_to&&(o.disconnectInput(v),this.dirty_bgcanvas=!0,r=!0),(this.allow_reconnect_links||e.shiftKey)&&(LiteGraph.click_do_break_link_to||o.disconnectInput(v),this.connecting_node=this.graph._nodes_by_id[x.origin_id],this.connecting_slot=x.origin_slot,this.connecting_output=this.connecting_node.outputs[this.connecting_slot],this.connecting_pos=this.connecting_node.getConnectionPos(!1,this.connecting_slot),this.dirty_bgcanvas=!0,r=!0)}r||(this.connecting_node=o,this.connecting_input=A,this.connecting_input.slot_index=v,this.connecting_pos=o.getConnectionPos(!0,v),this.connecting_slot=v,this.dirty_bgcanvas=!0,r=!0)}}}if(!r){var C=!1;o&&o.flags&&o.flags.pinned&&(C=!0);var T=[e.canvasX-o.pos[0],e.canvasY-o.pos[1]],G=this.processNodeWidgets(o,this.graph_mouse,e);if(G&&(C=!0,this.node_widget=[o,G]),this.allow_interaction&&p&&this.selected_nodes[o.id]&&(o.onDblClick&&o.onDblClick(e,T,this),this.processNodeDblClicked(o),C=!0),o.onMouseDown&&o.onMouseDown(e,T,this))C=!0;else{if(o.subgraph&&!o.skip_subgraph_button&&!o.flags.collapsed&&T[0]>o.size[0]-LiteGraph.NODE_TITLE_HEIGHT&&T[1]<0){n=this;setTimeout((function(){n.openSubgraph(o.subgraph)}),10)}this.live_mode&&(m=!0,C=!0)}C?o.is_selected||this.processNodeSelected(o,e):(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=o),this.processNodeSelected(o,e)),this.dirty_canvas=!0}}!r&&m&&this.allow_dragcanvas&&(this.dragging_canvas=!0)}return this.last_mouse[0]=e.clientX,this.last_mouse[1]=e.clientY,this.last_mouseclick=LiteGraph.getTime(),this.last_mouse_dragging=!0,this.graph.change(),(!t.document.activeElement||"input"!=t.document.activeElement.nodeName.toLowerCase()&&"textarea"!=t.document.activeElement.nodeName.toLowerCase())&&e.preventDefault(),e.stopPropagation(),this.onMouseDown&&this.onMouseDown(e),!1}}}},LGraphCanvas.prototype.processMouseMove=function(e){if(this.autoresize&&this.resize(),this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){LGraphCanvas.active_canvas=this,this.adjustMouseEvent(e);var t=[e.clientX,e.clientY];this.mouse[0]=t[0],this.mouse[1]=t[1];var n=[t[0]-this.last_mouse[0],t[1]-this.last_mouse[1]];if(this.last_mouse=t,this.graph_mouse[0]=e.canvasX,this.graph_mouse[1]=e.canvasY,this.block_click)return e.preventDefault(),!1;e.dragging=this.last_mouse_dragging,this.node_widget&&(this.processNodeWidgets(this.node_widget[0],this.graph_mouse,e,this.node_widget[1]),this.dirty_canvas=!0);var i=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes);if(this.dragging_rectangle)this.dragging_rectangle[2]=e.canvasX-this.dragging_rectangle[0],this.dragging_rectangle[3]=e.canvasY-this.dragging_rectangle[1],this.dirty_canvas=!0;else if(this.selected_group&&!this.read_only){if(this.selected_group_resizing)this.selected_group.size=[e.canvasX-this.selected_group.pos[0],e.canvasY-this.selected_group.pos[1]];else{var s=n[0]/this.ds.scale,a=n[1]/this.ds.scale;this.selected_group.move(s,a,e.ctrlKey),this.selected_group._nodes.length&&(this.dirty_canvas=!0)}this.dirty_bgcanvas=!0}else if(this.dragging_canvas)this.ds.offset[0]+=n[0]/this.ds.scale,this.ds.offset[1]+=n[1]/this.ds.scale,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;else if((this.allow_interaction||i&&i.flags.allow_interaction)&&!this.read_only){this.connecting_node&&(this.dirty_canvas=!0);for(var o=0,r=this.graph._nodes.length;o<r;++o)this.graph._nodes[o].mouseOver&&i!=this.graph._nodes[o]&&(this.graph._nodes[o].mouseOver=!1,this.node_over&&this.node_over.onMouseLeave&&this.node_over.onMouseLeave(e),this.node_over=null,this.dirty_canvas=!0);if(i){if(i.redraw_on_mouse&&(this.dirty_canvas=!0),i.mouseOver||(i.mouseOver=!0,this.node_over=i,this.dirty_canvas=!0,i.onMouseEnter&&i.onMouseEnter(e)),i.onMouseMove&&i.onMouseMove(e,[e.canvasX-i.pos[0],e.canvasY-i.pos[1]],this),this.connecting_node)if(this.connecting_output){var l=this._highlight_input||[0,0];if(this.isOverNodeBox(i,e.canvasX,e.canvasY));else if(-1!=(p=this.isOverNodeInput(i,e.canvasX,e.canvasY,l))&&i.inputs[p]){var c=i.inputs[p].type;LiteGraph.isValidConnection(this.connecting_output.type,c)&&(this._highlight_input=l,this._highlight_input_slot=i.inputs[p])}else this._highlight_input=null,this._highlight_input_slot=null}else if(this.connecting_input){var p;l=this._highlight_output||[0,0];if(this.isOverNodeBox(i,e.canvasX,e.canvasY));else if(-1!=(p=this.isOverNodeOutput(i,e.canvasX,e.canvasY,l))&&i.outputs[p]){c=i.outputs[p].type;LiteGraph.isValidConnection(this.connecting_input.type,c)&&(this._highlight_output=l)}else this._highlight_output=null}this.canvas&&(i.inResizeCorner(e.canvasX,e.canvasY)?this.canvas.style.cursor="se-resize":this.canvas.style.cursor="crosshair")}else{var h=null;for(o=0;o<this.visible_links.length;++o){var d=this.visible_links[o],u=d._pos;if(!(!u||e.canvasX<u[0]-4||e.canvasX>u[0]+4||e.canvasY<u[1]-4||e.canvasY>u[1]+4)){h=d;break}}h!=this.over_link_center&&(this.over_link_center=h,this.dirty_canvas=!0),this.canvas&&(this.canvas.style.cursor="")}if(this.node_capturing_input&&this.node_capturing_input!=i&&this.node_capturing_input.onMouseMove&&this.node_capturing_input.onMouseMove(e,[e.canvasX-this.node_capturing_input.pos[0],e.canvasY-this.node_capturing_input.pos[1]],this),this.node_dragged&&!this.live_mode){for(var o in this.selected_nodes){var g=this.selected_nodes[o];g.pos[0]+=n[0]/this.ds.scale,g.pos[1]+=n[1]/this.ds.scale,g.is_selected||this.processNodeSelected(g,e)}this.dirty_canvas=!0,this.dirty_bgcanvas=!0}if(this.resizing_node&&!this.live_mode){var f=[e.canvasX-this.resizing_node.pos[0],e.canvasY-this.resizing_node.pos[1]],_=this.resizing_node.computeSize();f[0]=Math.max(_[0],f[0]),f[1]=Math.max(_[1],f[1]),this.resizing_node.setSize(f),this.canvas.style.cursor="se-resize",this.dirty_canvas=!0,this.dirty_bgcanvas=!0}}return e.preventDefault(),!1}},LGraphCanvas.prototype.processMouseUp=function(e){var t=void 0===e.isPrimary||e.isPrimary;if(!t)return!1;if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){var n=this.getCanvasWindow().document;LGraphCanvas.active_canvas=this,this.options.skip_events||(LiteGraph.pointerListenerRemove(n,"move",this._mousemove_callback,!0),LiteGraph.pointerListenerAdd(this.canvas,"move",this._mousemove_callback,!0),LiteGraph.pointerListenerRemove(n,"up",this._mouseup_callback,!0)),this.adjustMouseEvent(e);var i=LiteGraph.getTime();if(e.click_time=i-this.last_mouseclick,this.last_mouse_dragging=!1,this.last_click_position=null,this.block_click&&(this.block_click=!1),1==e.which){if(this.node_widget&&this.processNodeWidgets(this.node_widget[0],this.graph_mouse,e),this.node_widget=null,this.selected_group){var s=this.selected_group.pos[0]-Math.round(this.selected_group.pos[0]),a=this.selected_group.pos[1]-Math.round(this.selected_group.pos[1]);this.selected_group.move(s,a,e.ctrlKey),this.selected_group.pos[0]=Math.round(this.selected_group.pos[0]),this.selected_group.pos[1]=Math.round(this.selected_group.pos[1]),this.selected_group._nodes.length&&(this.dirty_canvas=!0),this.selected_group=null}this.selected_group_resizing=!1;var o=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes);if(this.dragging_rectangle){if(this.graph){var r=this.graph._nodes,l=new Float32Array(4),c=Math.abs(this.dragging_rectangle[2]),p=Math.abs(this.dragging_rectangle[3]),h=this.dragging_rectangle[2]<0?this.dragging_rectangle[0]-c:this.dragging_rectangle[0],d=this.dragging_rectangle[3]<0?this.dragging_rectangle[1]-p:this.dragging_rectangle[1];if(this.dragging_rectangle[0]=h,this.dragging_rectangle[1]=d,this.dragging_rectangle[2]=c,this.dragging_rectangle[3]=p,!o||c>10&&p>10){for(var u=[],g=0;g<r.length;++g){var f=r[g];f.getBounding(l),overlapBounding(this.dragging_rectangle,l)&&u.push(f)}u.length&&this.selectNodes(u,e.shiftKey)}else this.selectNodes([o],e.shiftKey||e.ctrlKey)}this.dragging_rectangle=null}else if(this.connecting_node){this.dirty_canvas=!0,this.dirty_bgcanvas=!0;var _=(this.connecting_output||this.connecting_input).type;if(o){if(this.connecting_output)-1!=(m=this.isOverNodeInput(o,e.canvasX,e.canvasY))?this.connecting_node.connect(this.connecting_slot,o,m):this.connecting_node.connectByType(this.connecting_slot,o,_);else if(this.connecting_input){var m;-1!=(m=this.isOverNodeOutput(o,e.canvasX,e.canvasY))?o.connect(m,this.connecting_node,this.connecting_slot):this.connecting_node.connectByTypeOutput(this.connecting_slot,o,_)}}else LiteGraph.release_link_on_empty_shows_menu&&(e.shiftKey&&this.allow_searchbox?this.connecting_output?this.showSearchBox(e,{node_from:this.connecting_node,slot_from:this.connecting_output,type_filter_in:this.connecting_output.type}):this.connecting_input&&this.showSearchBox(e,{node_to:this.connecting_node,slot_from:this.connecting_input,type_filter_out:this.connecting_input.type}):this.connecting_output?this.showConnectionMenu({nodeFrom:this.connecting_node,slotFrom:this.connecting_output,e:e}):this.connecting_input&&this.showConnectionMenu({nodeTo:this.connecting_node,slotTo:this.connecting_input,e:e}));this.connecting_output=null,this.connecting_input=null,this.connecting_pos=null,this.connecting_node=null,this.connecting_slot=-1}else if(this.resizing_node)this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.graph.afterChange(this.resizing_node),this.resizing_node=null;else if(this.node_dragged){(o=this.node_dragged)&&e.click_time<300&&isInsideRectangle(e.canvasX,e.canvasY,o.pos[0],o.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT)&&o.collapse(),this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.node_dragged.pos[0]=Math.round(this.node_dragged.pos[0]),this.node_dragged.pos[1]=Math.round(this.node_dragged.pos[1]),(this.graph.config.align_to_grid||this.align_to_grid)&&this.node_dragged.alignToGrid(),this.onNodeMoved&&this.onNodeMoved(this.node_dragged),this.graph.afterChange(this.node_dragged),this.node_dragged=null}else{!(o=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes))&&e.click_time<300&&this.deselectAllNodes(),this.dirty_canvas=!0,this.dragging_canvas=!1,this.node_over&&this.node_over.onMouseUp&&this.node_over.onMouseUp(e,[e.canvasX-this.node_over.pos[0],e.canvasY-this.node_over.pos[1]],this),this.node_capturing_input&&this.node_capturing_input.onMouseUp&&this.node_capturing_input.onMouseUp(e,[e.canvasX-this.node_capturing_input.pos[0],e.canvasY-this.node_capturing_input.pos[1]])}}else(2==e.which||3==e.which)&&(this.dirty_canvas=!0,this.dragging_canvas=!1);return t&&(this.pointer_is_down=!1,this.pointer_is_double=!1),this.graph.change(),e.stopPropagation(),e.preventDefault(),!1}},LGraphCanvas.prototype.processMouseWheel=function(e){if(this.graph&&this.allow_dragcanvas){var t=null!=e.wheelDeltaY?e.wheelDeltaY:-60*e.detail;this.adjustMouseEvent(e);var n=e.clientX,i=e.clientY;if(!this.viewport||this.viewport&&n>=this.viewport[0]&&n<this.viewport[0]+this.viewport[2]&&i>=this.viewport[1]&&i<this.viewport[1]+this.viewport[3]){var s=this.ds.scale;return t>0?s*=1.1:t<0&&(s*=1/1.1),this.ds.changeScale(s,[e.clientX,e.clientY]),this.graph.change(),e.preventDefault(),!1}}},LGraphCanvas.prototype.isOverNodeBox=function(e,t,n){var i=LiteGraph.NODE_TITLE_HEIGHT;return!!isInsideRectangle(t,n,e.pos[0]+2,e.pos[1]+2-i,i-4,i-4)},LGraphCanvas.prototype.isOverNodeInput=function(e,t,n,i){if(e.inputs)for(var s=0,a=e.inputs.length;s<a;++s){e.inputs[s];var o=e.getConnectionPos(!0,s);if(e.horizontal?isInsideRectangle(t,n,o[0]-5,o[1]-10,10,20):isInsideRectangle(t,n,o[0]-10,o[1]-5,40,10))return i&&(i[0]=o[0],i[1]=o[1]),s}return-1},LGraphCanvas.prototype.isOverNodeOutput=function(e,t,n,i){if(e.outputs)for(var s=0,a=e.outputs.length;s<a;++s){e.outputs[s];var o=e.getConnectionPos(!1,s);if(e.horizontal?isInsideRectangle(t,n,o[0]-5,o[1]-10,10,20):isInsideRectangle(t,n,o[0]-10,o[1]-5,40,10))return i&&(i[0]=o[0],i[1]=o[1]),s}return-1},LGraphCanvas.prototype.processKey=function(e){if(this.graph){var t=!1;if("input"!=e.target.localName){if("keydown"==e.type){if(32==e.keyCode&&(this.dragging_canvas=!0,t=!0),27==e.keyCode&&(this.node_panel&&this.node_panel.close(),this.options_panel&&this.options_panel.close(),t=!0),65==e.keyCode&&e.ctrlKey&&(this.selectNodes(),t=!0),67!==e.keyCode||!e.metaKey&&!e.ctrlKey||e.shiftKey||this.selected_nodes&&(this.copyToClipboard(),t=!0),86===e.keyCode&&(e.metaKey||e.ctrlKey)&&this.pasteFromClipboard(e.shiftKey),46!=e.keyCode&&8!=e.keyCode||"input"!=e.target.localName&&"textarea"!=e.target.localName&&(this.deleteSelectedNodes(),t=!0),this.selected_nodes)for(var n in this.selected_nodes)this.selected_nodes[n].onKeyDown&&this.selected_nodes[n].onKeyDown(e)}else if("keyup"==e.type&&(32==e.keyCode&&(this.dragging_canvas=!1),this.selected_nodes))for(var n in this.selected_nodes)this.selected_nodes[n].onKeyUp&&this.selected_nodes[n].onKeyUp(e);return this.graph.change(),t?(e.preventDefault(),e.stopImmediatePropagation(),!1):void 0}}},LGraphCanvas.prototype.copyToClipboard=function(e){var t={nodes:[],links:[]},n=0,i=[];for(var s in e||(e=this.selected_nodes),e){!1!==(a=e[s]).clonable&&(a._relative_id=n,i.push(a),n+=1)}for(s=0;s<i.length;++s){var a,o=(a=i[s]).clone();if(o&&(t.nodes.push(o.serialize()),a.inputs&&a.inputs.length))for(var r=0;r<a.inputs.length;++r){var l=a.inputs[r];if(l&&null!=l.link){var c=this.graph.links[l.link];if(c){var p=this.graph.getNodeById(c.origin_id);p&&t.links.push([p._relative_id,c.origin_slot,a._relative_id,c.target_slot,p.id])}}}}localStorage.setItem("litegrapheditor_clipboard",JSON.stringify(t))},LGraphCanvas.prototype.pasteFromClipboard=function(e=!1){if(LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs||!e){var t=localStorage.getItem("litegrapheditor_clipboard");if(t){this.graph.beforeChange();for(var n=JSON.parse(t),i=!1,s=!1,a=0;a<n.nodes.length;++a)i?(i[0]>n.nodes[a].pos[0]&&(i[0]=n.nodes[a].pos[0],s[0]=a),i[1]>n.nodes[a].pos[1]&&(i[1]=n.nodes[a].pos[1],s[1]=a)):(i=[n.nodes[a].pos[0],n.nodes[a].pos[1]],s=[a,a]);var o=[];for(a=0;a<n.nodes.length;++a){var r=n.nodes[a],l=LiteGraph.createNode(r.type);l&&(l.configure(r),l.pos[0]+=this.graph_mouse[0]-i[0],l.pos[1]+=this.graph_mouse[1]-i[1],this.graph.add(l,{doProcessChange:!1}),o.push(l))}for(a=0;a<n.links.length;++a){var c,p=n.links[a],h=p[0];if(null!=h)c=o[h];else if(LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs&&e){var d=p[4];d&&(c=this.graph.getNodeById(d))}var u=o[p[2]];c&&u&&c.connect(p[1],u,p[3])}this.selectNodes(o),this.graph.afterChange()}}},LGraphCanvas.prototype.processDrop=function(e){e.preventDefault(),this.adjustMouseEvent(e);var t=e.clientX,n=e.clientY;if(!this.viewport||this.viewport&&t>=this.viewport[0]&&t<this.viewport[0]+this.viewport[2]&&n>=this.viewport[1]&&n<this.viewport[1]+this.viewport[3]){var i=[e.canvasX,e.canvasY],s=this.graph?this.graph.getNodeOnPos(i[0],i[1]):null;if(!s){var a=null;return this.onDropItem&&(a=this.onDropItem(event)),void(a||this.checkDropItem(e))}if(s.onDropFile||s.onDropData){var o=e.dataTransfer.files;if(o&&o.length)for(var r=0;r<o.length;r++){var l=e.dataTransfer.files[0],c=l.name;if(LGraphCanvas.getFileExtension(c),s.onDropFile&&s.onDropFile(l),s.onDropData){var p=new FileReader;p.onload=function(e){var t=e.target.result;s.onDropData(t,c,l)};var h=l.type.split("/")[0];"text"==h||""==h?p.readAsText(l):"image"==h?p.readAsDataURL(l):p.readAsArrayBuffer(l)}}}return!(!s.onDropItem||!s.onDropItem(event))||!!this.onDropItem&&this.onDropItem(event)}},LGraphCanvas.prototype.checkDropItem=function(e){if(e.dataTransfer.files.length){var t=e.dataTransfer.files[0],n=LGraphCanvas.getFileExtension(t.name).toLowerCase(),i=LiteGraph.node_types_by_file_extension[n];if(i){this.graph.beforeChange();var s=LiteGraph.createNode(i.type);s.pos=[e.canvasX,e.canvasY],this.graph.add(s),s.onDropFile&&s.onDropFile(t),this.graph.afterChange()}}},LGraphCanvas.prototype.processNodeDblClicked=function(e){this.onShowNodePanel&&this.onShowNodePanel(e),this.onNodeDblClicked&&this.onNodeDblClicked(e),this.setDirty(!0)},LGraphCanvas.prototype.processNodeSelected=function(e,t){this.selectNode(e,t&&(t.shiftKey||t.ctrlKey||this.multi_select)),this.onNodeSelected&&this.onNodeSelected(e)},LGraphCanvas.prototype.selectNode=function(e,t){null==e?this.deselectAllNodes():this.selectNodes([e],t)},LGraphCanvas.prototype.selectNodes=function(e,t){for(var n in t||this.deselectAllNodes(),"string"==typeof(e=e||this.graph._nodes)&&(e=[e]),e){var i=e[n];if(i.is_selected)this.deselectNode(i);else{if(!i.is_selected&&i.onSelected&&i.onSelected(),i.is_selected=!0,this.selected_nodes[i.id]=i,i.inputs)for(var s=0;s<i.inputs.length;++s)this.highlighted_links[i.inputs[s].link]=!0;if(i.outputs)for(s=0;s<i.outputs.length;++s){var a=i.outputs[s];if(a.links)for(var o=0;o<a.links.length;++o)this.highlighted_links[a.links[o]]=!0}}}this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)},LGraphCanvas.prototype.deselectNode=function(e){if(e.is_selected){if(e.onDeselected&&e.onDeselected(),e.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(e),e.inputs)for(var t=0;t<e.inputs.length;++t)delete this.highlighted_links[e.inputs[t].link];if(e.outputs)for(t=0;t<e.outputs.length;++t){var n=e.outputs[t];if(n.links)for(var i=0;i<n.links.length;++i)delete this.highlighted_links[n.links[i]]}}},LGraphCanvas.prototype.deselectAllNodes=function(){if(this.graph){for(var e=this.graph._nodes,t=0,n=e.length;t<n;++t){var i=e[t];i.is_selected&&(i.onDeselected&&i.onDeselected(),i.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(i))}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)}},LGraphCanvas.prototype.deleteSelectedNodes=function(){for(var e in this.graph.beforeChange(),this.selected_nodes){var t=this.selected_nodes[e];if(!t.block_delete){if(t.inputs&&t.inputs.length&&t.outputs&&t.outputs.length&&LiteGraph.isValidConnection(t.inputs[0].type,t.outputs[0].type)&&t.inputs[0].link&&t.outputs[0].links&&t.outputs[0].links.length){var n=t.graph.links[t.inputs[0].link],i=t.graph.links[t.outputs[0].links[0]],s=t.getInputNode(0),a=t.getOutputNodes(0)[0];s&&a&&s.connect(n.origin_slot,a,i.target_slot)}this.graph.remove(t),this.onNodeDeselected&&this.onNodeDeselected(t)}}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.setDirty(!0),this.graph.afterChange()},LGraphCanvas.prototype.centerOnNode=function(e){this.ds.offset[0]=-e.pos[0]-.5*e.size[0]+.5*this.canvas.width/this.ds.scale,this.ds.offset[1]=-e.pos[1]-.5*e.size[1]+.5*this.canvas.height/this.ds.scale,this.setDirty(!0,!0)},LGraphCanvas.prototype.adjustMouseEvent=function(e){var t=0,n=0;if(this.canvas){var i=this.canvas.getBoundingClientRect();t=e.clientX-i.left,n=e.clientY-i.top}else t=e.clientX,n=e.clientY;e.deltaX=t-this.last_mouse_position[0],e.deltaY=n-this.last_mouse_position[1],this.last_mouse_position[0]=t,this.last_mouse_position[1]=n,e.canvasX=t/this.ds.scale-this.ds.offset[0],e.canvasY=n/this.ds.scale-this.ds.offset[1]},LGraphCanvas.prototype.setZoom=function(e,t){this.ds.changeScale(e,t),this.dirty_canvas=!0,this.dirty_bgcanvas=!0},LGraphCanvas.prototype.convertOffsetToCanvas=function(e,t){return this.ds.convertOffsetToCanvas(e,t)},LGraphCanvas.prototype.convertCanvasToOffset=function(e,t){return this.ds.convertCanvasToOffset(e,t)},LGraphCanvas.prototype.convertEventToCanvasOffset=function(e){var t=this.canvas.getBoundingClientRect();return this.convertCanvasToOffset([e.clientX-t.left,e.clientY-t.top])},LGraphCanvas.prototype.bringToFront=function(e){var t=this.graph._nodes.indexOf(e);-1!=t&&(this.graph._nodes.splice(t,1),this.graph._nodes.push(e))},LGraphCanvas.prototype.sendToBack=function(e){var t=this.graph._nodes.indexOf(e);-1!=t&&(this.graph._nodes.splice(t,1),this.graph._nodes.unshift(e))};var temp=new Float32Array(4);LGraphCanvas.prototype.computeVisibleNodes=function(e,t){var n=t||[];n.length=0;for(var i=0,s=(e=e||this.graph._nodes).length;i<s;++i){var a=e[i];(!this.live_mode||a.onDrawBackground||a.onDrawForeground)&&(overlapBounding(this.visible_area,a.getBounding(temp,!0))&&n.push(a))}return n},LGraphCanvas.prototype.draw=function(e,t){if(this.canvas&&0!=this.canvas.width&&0!=this.canvas.height){var n=LiteGraph.getTime();this.render_time=.001*(n-this.last_draw_time),this.last_draw_time=n,this.graph&&this.ds.computeVisibleArea(this.viewport),(this.dirty_bgcanvas||t||this.always_render_background||this.graph&&this.graph._last_trigger_time&&n-this.graph._last_trigger_time<1e3)&&this.drawBackCanvas(),(this.dirty_canvas||e)&&this.drawFrontCanvas(),this.fps=this.render_time?1/this.render_time:0,this.frame+=1}},LGraphCanvas.prototype.drawFrontCanvas=function(){this.dirty_canvas=!1,this.ctx||(this.ctx=this.bgcanvas.getContext("2d"));var e=this.ctx;if(e){var t=this.canvas;e.start2D&&!this.viewport&&(e.start2D(),e.restore(),e.setTransform(1,0,0,1,0,0));var n=this.viewport||this.dirty_area;if(n&&(e.save(),e.beginPath(),e.rect(n[0],n[1],n[2],n[3]),e.clip()),this.clear_background&&(n?e.clearRect(n[0],n[1],n[2],n[3]):e.clearRect(0,0,t.width,t.height)),this.bgcanvas==this.canvas?this.drawBackCanvas():e.drawImage(this.bgcanvas,0,0),this.onRender&&this.onRender(t,e),this.show_info&&this.renderInfo(e,n?n[0]:0,n?n[1]:0),this.graph){e.save(),this.ds.toCanvasContext(e);for(var i=this.computeVisibleNodes(null,this.visible_nodes),s=0;s<i.length;++s){var a=i[s];e.save(),e.translate(a.pos[0],a.pos[1]),this.drawNode(a,e),e.restore()}if(this.render_execution_order&&this.drawExecutionOrder(e),this.graph.config.links_ontop&&(this.live_mode||this.drawConnections(e)),null!=this.connecting_pos){e.lineWidth=this.connections_width;var o=null,r=this.connecting_output||this.connecting_input,l=r.type,c=r.dir;null==c&&(c=this.connecting_output?this.connecting_node.horizontal?LiteGraph.DOWN:LiteGraph.RIGHT:this.connecting_node.horizontal?LiteGraph.UP:LiteGraph.LEFT);var p=r.shape;if(l===LiteGraph.EVENT)o=LiteGraph.EVENT_LINK_COLOR;else o=LiteGraph.CONNECTING_LINK_COLOR;if(this.renderLink(e,this.connecting_pos,[this.graph_mouse[0],this.graph_mouse[1]],null,!1,null,o,c,LiteGraph.CENTER),e.beginPath(),l===LiteGraph.EVENT||p===LiteGraph.BOX_SHAPE?(e.rect(this.connecting_pos[0]-6+.5,this.connecting_pos[1]-5+.5,14,10),e.fill(),e.beginPath(),e.rect(this.graph_mouse[0]-6+.5,this.graph_mouse[1]-5+.5,14,10)):p===LiteGraph.ARROW_SHAPE?(e.moveTo(this.connecting_pos[0]+8,this.connecting_pos[1]+.5),e.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]+6+.5),e.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]-6+.5),e.closePath()):(e.arc(this.connecting_pos[0],this.connecting_pos[1],4,0,2*Math.PI),e.fill(),e.beginPath(),e.arc(this.graph_mouse[0],this.graph_mouse[1],4,0,2*Math.PI)),e.fill(),e.fillStyle="#ffcc00",this._highlight_input){e.beginPath();var h=this._highlight_input_slot.shape;h===LiteGraph.ARROW_SHAPE?(e.moveTo(this._highlight_input[0]+8,this._highlight_input[1]+.5),e.lineTo(this._highlight_input[0]-4,this._highlight_input[1]+6+.5),e.lineTo(this._highlight_input[0]-4,this._highlight_input[1]-6+.5),e.closePath()):e.arc(this._highlight_input[0],this._highlight_input[1],6,0,2*Math.PI),e.fill()}this._highlight_output&&(e.beginPath(),h===LiteGraph.ARROW_SHAPE?(e.moveTo(this._highlight_output[0]+8,this._highlight_output[1]+.5),e.lineTo(this._highlight_output[0]-4,this._highlight_output[1]+6+.5),e.lineTo(this._highlight_output[0]-4,this._highlight_output[1]-6+.5),e.closePath()):e.arc(this._highlight_output[0],this._highlight_output[1],6,0,2*Math.PI),e.fill())}this.dragging_rectangle&&(e.strokeStyle="#FFF",e.strokeRect(this.dragging_rectangle[0],this.dragging_rectangle[1],this.dragging_rectangle[2],this.dragging_rectangle[3])),this.over_link_center&&this.render_link_tooltip?this.drawLinkTooltip(e,this.over_link_center):this.onDrawLinkTooltip&&this.onDrawLinkTooltip(e,null),this.onDrawForeground&&this.onDrawForeground(e,this.visible_rect),e.restore()}this._graph_stack&&this._graph_stack.length&&this.drawSubgraphPanel(e),this.onDrawOverlay&&this.onDrawOverlay(e),n&&e.restore(),e.finish2D&&e.finish2D()}},LGraphCanvas.prototype.drawSubgraphPanel=function(e){var t=this.graph,n=t._subgraph_node;n&&(this.drawSubgraphPanelLeft(t,n,e),this.drawSubgraphPanelRight(t,n,e))},LGraphCanvas.prototype.drawSubgraphPanelLeft=function(e,t,n){var i=t.inputs?t.inputs.length:0,s=200,a=Math.floor(1.6*LiteGraph.NODE_SLOT_HEIGHT);if(n.fillStyle="#111",n.globalAlpha=.8,n.beginPath(),n.roundRect(10,10,s,(i+1)*a+50,[8]),n.fill(),n.globalAlpha=1,n.fillStyle="#888",n.font="14px Arial",n.textAlign="left",n.fillText("Graph Inputs",20,34),this.drawButton(180,20,20,20,"X","#151515"))this.closeSubgraph();else{var o=50;if(n.font="14px Arial",t.inputs)for(var r=0;r<t.inputs.length;++r){var l=t.inputs[r];if(!l.not_subgraph_input){if(this.drawButton(20,o+2,180,a-2)){var c=t.constructor.input_node_type||"graph/input";this.graph.beforeChange();var p=LiteGraph.createNode(c);p&&(e.add(p),this.block_click=!1,this.last_click_position=null,this.selectNodes([p]),this.node_dragged=p,this.dragging_canvas=!1,p.setProperty("name",l.name),p.setProperty("type",l.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange())}n.fillStyle="#9C9",n.beginPath(),n.arc(184,o+.5*a,5,0,2*Math.PI),n.fill(),n.fillStyle="#AAA",n.fillText(l.name,30,o+.75*a),n.fillStyle="#777",n.fillText(l.type,130,o+.75*a),o+=a}}this.drawButton(20,o+2,180,a-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialog(t)}},LGraphCanvas.prototype.drawSubgraphPanelRight=function(e,t,n){var i=t.outputs?t.outputs.length:0,s=this.bgcanvas.width,a=200,o=Math.floor(1.6*LiteGraph.NODE_SLOT_HEIGHT);n.fillStyle="#111",n.globalAlpha=.8,n.beginPath(),n.roundRect(s-a-10,10,a,(i+1)*o+50,[8]),n.fill(),n.globalAlpha=1,n.fillStyle="#888",n.font="14px Arial",n.textAlign="left";var r="Graph Outputs",l=n.measureText(r).width;if(n.fillText(r,s-l-20,34),this.drawButton(s-a,20,20,20,"X","#151515"))this.closeSubgraph();else{var c=50;if(n.font="14px Arial",t.outputs)for(var p=0;p<t.outputs.length;++p){var h=t.outputs[p];if(!h.not_subgraph_input){if(this.drawButton(s-a,c+2,180,o-2)){var d=t.constructor.output_node_type||"graph/output";this.graph.beforeChange();var u=LiteGraph.createNode(d);u&&(e.add(u),this.block_click=!1,this.last_click_position=null,this.selectNodes([u]),this.node_dragged=u,this.dragging_canvas=!1,u.setProperty("name",h.name),u.setProperty("type",h.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange())}n.fillStyle="#9C9",n.beginPath(),n.arc(s-a+16,c+.5*o,5,0,2*Math.PI),n.fill(),n.fillStyle="#AAA",n.fillText(h.name,s-a+30,c+.75*o),n.fillStyle="#777",n.fillText(h.type,s-a+130,c+.75*o),c+=o}}this.drawButton(s-a,c+2,180,o-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialogRight(t)}},LGraphCanvas.prototype.drawButton=function(e,t,n,i,s,a,o,r){var l=this.ctx;a=a||LiteGraph.NODE_DEFAULT_COLOR,o=o||"#555",r=r||LiteGraph.NODE_TEXT_COLOR;var c=this.ds.convertOffsetToCanvas(this.graph_mouse),p=LiteGraph.isInsideRectangle(c[0],c[1],e,t,n,i);if(c=this.last_click_position?[this.last_click_position[0],this.last_click_position[1]]:null){var h=this.canvas.getBoundingClientRect();c[0]-=h.left,c[1]-=h.top}var d=c&&LiteGraph.isInsideRectangle(c[0],c[1],e,t,n,i);l.fillStyle=p?o:a,d&&(l.fillStyle="#AAA"),l.beginPath(),l.roundRect(e,t,n,i,[4]),l.fill(),null!=s&&s.constructor==String&&(l.fillStyle=r,l.textAlign="center",l.font=(.65*i|0)+"px Arial",l.fillText(s,e+.5*n,t+.75*i),l.textAlign="left");var u=d&&!this.block_click;return d&&this.blockClick(),u},LGraphCanvas.prototype.isAreaClicked=function(e,t,n,i,s){var a=this.mouse;LiteGraph.isInsideRectangle(a[0],a[1],e,t,n,i);var o=(a=this.last_click_position)&&LiteGraph.isInsideRectangle(a[0],a[1],e,t,n,i),r=o&&!this.block_click;return o&&s&&this.blockClick(),r},LGraphCanvas.prototype.renderInfo=function(e,t,n){t=t||10,n=n||this.canvas.offsetHeight-80,e.save(),e.translate(t,n),e.font="10px Arial",e.fillStyle="#888",e.textAlign="left",this.graph?(e.fillText("T: "+this.graph.globaltime.toFixed(2)+"s",5,13),e.fillText("I: "+this.graph.iteration,5,26),e.fillText("N: "+this.graph._nodes.length+" ["+this.visible_nodes.length+"]",5,39),e.fillText("V: "+this.graph._version,5,52),e.fillText("FPS:"+this.fps.toFixed(2),5,65)):e.fillText("No graph selected",5,13),e.restore()},LGraphCanvas.prototype.drawBackCanvas=function(){var e=this.bgcanvas;e.width==this.canvas.width&&e.height==this.canvas.height||(e.width=this.canvas.width,e.height=this.canvas.height),this.bgctx||(this.bgctx=this.bgcanvas.getContext("2d"));var t=this.bgctx;t.start&&t.start();var n=this.viewport||[0,0,t.canvas.width,t.canvas.height];if(this.clear_background&&t.clearRect(n[0],n[1],n[2],n[3]),this._graph_stack&&this._graph_stack.length){t.save(),this._graph_stack[this._graph_stack.length-1];var i=this.graph._subgraph_node;t.strokeStyle=i.bgcolor,t.lineWidth=10,t.strokeRect(1,1,e.width-2,e.height-2),t.lineWidth=1,t.font="40px Arial",t.textAlign="center",t.fillStyle=i.bgcolor||"#AAA";for(var s="",a=1;a<this._graph_stack.length;++a)s+=this._graph_stack[a]._subgraph_node.getTitle()+" >> ";t.fillText(s+i.getTitle(),.5*e.width,40),t.restore()}var o=!1;if(this.onRenderBackground&&(o=this.onRenderBackground(e,t)),this.viewport||(t.restore(),t.setTransform(1,0,0,1,0,0)),this.visible_links.length=0,this.graph){if(t.save(),this.ds.toCanvasContext(t),this.ds.scale<1.5&&!o&&this.clear_background_color&&(t.fillStyle=this.clear_background_color,t.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3])),this.background_image&&this.ds.scale>.5&&!o){if(this.zoom_modify_alpha?t.globalAlpha=(1-.5/this.ds.scale)*this.editor_alpha:t.globalAlpha=this.editor_alpha,t.imageSmoothingEnabled=t.imageSmoothingEnabled=!1,!this._bg_img||this._bg_img.name!=this.background_image){this._bg_img=new Image,this._bg_img.name=this.background_image,this._bg_img.src=this.background_image;var r=this;this._bg_img.onload=function(){r.draw(!0,!0)}}var l=null;null==this._pattern&&this._bg_img.width>0?(l=t.createPattern(this._bg_img,"repeat"),this._pattern_img=this._bg_img,this._pattern=l):l=this._pattern,l&&(t.fillStyle=l,t.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3]),t.fillStyle="transparent"),t.globalAlpha=1,t.imageSmoothingEnabled=t.imageSmoothingEnabled=!0}this.graph._groups.length&&!this.live_mode&&this.drawGroups(e,t),this.onDrawBackground&&this.onDrawBackground(t,this.visible_area),this.onBackgroundRender&&(this.onBackgroundRender=null),this.render_canvas_border&&(t.strokeStyle="#235",t.strokeRect(0,0,e.width,e.height)),this.render_connections_shadows?(t.shadowColor="#000",t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=6):t.shadowColor="rgba(0,0,0,0)",this.live_mode||this.drawConnections(t),t.shadowColor="rgba(0,0,0,0)",t.restore()}t.finish&&t.finish(),this.dirty_bgcanvas=!1,this.dirty_canvas=!0};var temp_vec2=new Float32Array(2);LGraphCanvas.prototype.drawNode=function(e,t){this.current_node=e;var n=e.color||e.constructor.color||LiteGraph.NODE_DEFAULT_COLOR,i=e.bgcolor||e.constructor.bgcolor||LiteGraph.NODE_DEFAULT_BGCOLOR;e.mouseOver;var s=this.ds.scale<.6;if(this.live_mode)e.flags.collapsed||(t.shadowColor="transparent",e.onDrawForeground&&e.onDrawForeground(t,this,this.canvas));else{var a=this.editor_alpha;if(t.globalAlpha=a,this.render_shadows&&!s?(t.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR,t.shadowOffsetX=2*this.ds.scale,t.shadowOffsetY=2*this.ds.scale,t.shadowBlur=3*this.ds.scale):t.shadowColor="transparent",!e.flags.collapsed||!e.onDrawCollapsed||1!=e.onDrawCollapsed(t,this)){var o=e._shape||LiteGraph.BOX_SHAPE,r=temp_vec2;temp_vec2.set(e.size);var l=e.horizontal;if(e.flags.collapsed){t.font=this.inner_text_font;var c=e.getTitle?e.getTitle():e.title;null!=c&&(e._collapsed_width=Math.min(e.size[0],t.measureText(c).width+2*LiteGraph.NODE_TITLE_HEIGHT),r[0]=e._collapsed_width,r[1]=0)}e.clip_area&&(t.save(),t.beginPath(),o==LiteGraph.BOX_SHAPE?t.rect(0,0,r[0],r[1]):o==LiteGraph.ROUND_SHAPE?t.roundRect(0,0,r[0],r[1],[10]):o==LiteGraph.CIRCLE_SHAPE&&t.arc(.5*r[0],.5*r[1],.5*r[0],0,2*Math.PI),t.clip()),e.has_errors&&(i="red"),this.drawNodeShape(e,t,r,n,i,e.is_selected,e.mouseOver),t.shadowColor="transparent",e.onDrawForeground&&e.onDrawForeground(t,this,this.canvas),t.textAlign=l?"center":"left",t.font=this.inner_text_font;var p=!s,h=this.connecting_output,d=this.connecting_input;t.lineWidth=1;var u=0,g=new Float32Array(2);if(e.flags.collapsed){if(this.render_collapsed_slots){var f=null,_=null;if(e.inputs)for(y=0;y<e.inputs.length;y++){if(null!=(L=e.inputs[y]).link){f=L;break}}if(e.outputs)for(y=0;y<e.outputs.length;y++){(L=e.outputs[y]).links&&L.links.length&&(_=L)}if(f){var m=0,v=-.5*LiteGraph.NODE_TITLE_HEIGHT;l&&(m=.5*e._collapsed_width,v=-LiteGraph.NODE_TITLE_HEIGHT),t.fillStyle="#686",t.beginPath(),L.type===LiteGraph.EVENT||L.shape===LiteGraph.BOX_SHAPE?t.rect(m-7+.5,v-4,14,8):L.shape===LiteGraph.ARROW_SHAPE?(t.moveTo(m+8,v),t.lineTo(m+-4,v-4),t.lineTo(m+-4,v+4),t.closePath()):t.arc(m,v,4,0,2*Math.PI),t.fill()}if(_){m=e._collapsed_width,v=-.5*LiteGraph.NODE_TITLE_HEIGHT;l&&(m=.5*e._collapsed_width,v=0),t.fillStyle="#686",t.strokeStyle="black",t.beginPath(),L.type===LiteGraph.EVENT||L.shape===LiteGraph.BOX_SHAPE?t.rect(m-7+.5,v-4,14,8):L.shape===LiteGraph.ARROW_SHAPE?(t.moveTo(m+6,v),t.lineTo(m-6,v-4),t.lineTo(m-6,v+4),t.closePath()):t.arc(m,v,4,0,2*Math.PI),t.fill()}}}else{if(e.inputs)for(var y=0;y<e.inputs.length;y++){var b=(L=e.inputs[y]).type,w=L.shape;t.globalAlpha=a,this.connecting_output&&!LiteGraph.isValidConnection(L.type,h.type)&&(t.globalAlpha=.4*a),t.fillStyle=null!=L.link?L.color_on||this.default_connection_color_byType[b]||this.default_connection_color.input_on:L.color_off||this.default_connection_color_byTypeOff[b]||this.default_connection_color_byType[b]||this.default_connection_color.input_off,(A=e.getConnectionPos(!0,y,g))[0]-=e.pos[0],A[1]-=e.pos[1],u<A[1]+.5*LiteGraph.NODE_SLOT_HEIGHT&&(u=A[1]+.5*LiteGraph.NODE_SLOT_HEIGHT),t.beginPath(),"array"==b&&(w=LiteGraph.GRID_SHAPE);var k=!0;if(L.type===LiteGraph.EVENT||L.shape===LiteGraph.BOX_SHAPE?l?t.rect(A[0]-5+.5,A[1]-8+.5,10,14):t.rect(A[0]-6+.5,A[1]-5+.5,14,10):w===LiteGraph.ARROW_SHAPE?(t.moveTo(A[0]+8,A[1]+.5),t.lineTo(A[0]-4,A[1]+6+.5),t.lineTo(A[0]-4,A[1]-6+.5),t.closePath()):w===LiteGraph.GRID_SHAPE?(t.rect(A[0]-4,A[1]-4,2,2),t.rect(A[0]-1,A[1]-4,2,2),t.rect(A[0]+2,A[1]-4,2,2),t.rect(A[0]-4,A[1]-1,2,2),t.rect(A[0]-1,A[1]-1,2,2),t.rect(A[0]+2,A[1]-1,2,2),t.rect(A[0]-4,A[1]+2,2,2),t.rect(A[0]-1,A[1]+2,2,2),t.rect(A[0]+2,A[1]+2,2,2),k=!1):s?t.rect(A[0]-4,A[1]-4,8,8):t.arc(A[0],A[1],4,0,2*Math.PI),t.fill(),p)(x=null!=L.label?L.label:L.name)&&(t.fillStyle=LiteGraph.NODE_TEXT_COLOR,l||L.dir==LiteGraph.UP?t.fillText(x,A[0],A[1]-10):t.fillText(x,A[0]+10,A[1]+5))}if(t.textAlign=l?"center":"right",t.strokeStyle="black",e.outputs)for(var y=0;y<e.outputs.length;y++){var L,A;b=(L=e.outputs[y]).type,w=L.shape;this.connecting_input&&!LiteGraph.isValidConnection(b,d.type)&&(t.globalAlpha=.4*a),(A=e.getConnectionPos(!1,y,g))[0]-=e.pos[0],A[1]-=e.pos[1],u<A[1]+.5*LiteGraph.NODE_SLOT_HEIGHT&&(u=A[1]+.5*LiteGraph.NODE_SLOT_HEIGHT),t.fillStyle=L.links&&L.links.length?L.color_on||this.default_connection_color_byType[b]||this.default_connection_color.output_on:L.color_off||this.default_connection_color_byTypeOff[b]||this.default_connection_color_byType[b]||this.default_connection_color.output_off,t.beginPath(),"array"==b&&(w=LiteGraph.GRID_SHAPE);var x;k=!0;if(b===LiteGraph.EVENT||w===LiteGraph.BOX_SHAPE?l?t.rect(A[0]-5+.5,A[1]-8+.5,10,14):t.rect(A[0]-6+.5,A[1]-5+.5,14,10):w===LiteGraph.ARROW_SHAPE?(t.moveTo(A[0]+8,A[1]+.5),t.lineTo(A[0]-4,A[1]+6+.5),t.lineTo(A[0]-4,A[1]-6+.5),t.closePath()):w===LiteGraph.GRID_SHAPE?(t.rect(A[0]-4,A[1]-4,2,2),t.rect(A[0]-1,A[1]-4,2,2),t.rect(A[0]+2,A[1]-4,2,2),t.rect(A[0]-4,A[1]-1,2,2),t.rect(A[0]-1,A[1]-1,2,2),t.rect(A[0]+2,A[1]-1,2,2),t.rect(A[0]-4,A[1]+2,2,2),t.rect(A[0]-1,A[1]+2,2,2),t.rect(A[0]+2,A[1]+2,2,2),k=!1):s?t.rect(A[0]-4,A[1]-4,8,8):t.arc(A[0],A[1],4,0,2*Math.PI),t.fill(),!s&&k&&t.stroke(),p)(x=null!=L.label?L.label:L.name)&&(t.fillStyle=LiteGraph.NODE_TEXT_COLOR,l||L.dir==LiteGraph.DOWN?t.fillText(x,A[0],A[1]-8):t.fillText(x,A[0]-10,A[1]+5))}if(t.textAlign="left",t.globalAlpha=1,e.widgets){var C=u;(l||e.widgets_up)&&(C=2),null!=e.widgets_start_y&&(C=e.widgets_start_y),this.drawNodeWidgets(e,C,t,this.node_widget&&this.node_widget[0]==e?this.node_widget[1]:null)}}e.clip_area&&t.restore(),t.globalAlpha=1}}},LGraphCanvas.prototype.drawLinkTooltip=function(e,t){var n=t._pos;if(e.fillStyle="black",e.beginPath(),e.arc(n[0],n[1],3,0,2*Math.PI),e.fill(),null!=t.data&&(!this.onDrawLinkTooltip||1!=this.onDrawLinkTooltip(e,t,this))){var i=t.data,s=null;if(null!=(s=i.constructor===Number?i.toFixed(2):i.constructor===String?'"'+i+'"':i.constructor===Boolean?String(i):i.toToolTip?i.toToolTip():"["+i.constructor.name+"]")){s=s.substr(0,30),e.font="14px Courier New";var a=e.measureText(s).width+20;e.shadowColor="black",e.shadowOffsetX=2,e.shadowOffsetY=2,e.shadowBlur=3,e.fillStyle="#454",e.beginPath(),e.roundRect(n[0]-.5*a,n[1]-15-24,a,24,[3]),e.moveTo(n[0]-10,n[1]-15),e.lineTo(n[0]+10,n[1]-15),e.lineTo(n[0],n[1]-5),e.fill(),e.shadowColor="transparent",e.textAlign="center",e.fillStyle="#CEC",e.fillText(s,n[0],n[1]-15-24*.3)}}};var tmp_area=new Float32Array(4);LGraphCanvas.prototype.drawNodeShape=function(e,t,n,i,s,a,o){t.strokeStyle=i,t.fillStyle=s;var r=LiteGraph.NODE_TITLE_HEIGHT,l=this.ds.scale<.5,c=e._shape||e.constructor.shape||LiteGraph.ROUND_SHAPE,p=e.constructor.title_mode,h=!0;p==LiteGraph.TRANSPARENT_TITLE||p==LiteGraph.NO_TITLE?h=!1:p==LiteGraph.AUTOHIDE_TITLE&&o&&(h=!0);var d=tmp_area;d[0]=0,d[1]=h?-r:0,d[2]=n[0]+1,d[3]=h?n[1]+r:n[1];var u=t.globalAlpha;if(t.beginPath(),c==LiteGraph.BOX_SHAPE||l?t.fillRect(d[0],d[1],d[2],d[3]):c==LiteGraph.ROUND_SHAPE||c==LiteGraph.CARD_SHAPE?t.roundRect(d[0],d[1],d[2],d[3],c==LiteGraph.CARD_SHAPE?[this.round_radius,this.round_radius,0,0]:[this.round_radius]):c==LiteGraph.CIRCLE_SHAPE&&t.arc(.5*n[0],.5*n[1],.5*n[0],0,2*Math.PI),t.fill(),!e.flags.collapsed&&h&&(t.shadowColor="transparent",t.fillStyle="rgba(0,0,0,0.2)",t.fillRect(0,-1,d[2],2)),t.shadowColor="transparent",e.onDrawBackground&&e.onDrawBackground(t,this,this.canvas,this.graph_mouse),h||p==LiteGraph.TRANSPARENT_TITLE){if(e.onDrawTitleBar)e.onDrawTitleBar(t,r,n,this.ds.scale,i);else if(p!=LiteGraph.TRANSPARENT_TITLE&&(e.constructor.title_color||this.render_title_colored)){var g=e.constructor.title_color||i;if(e.flags.collapsed&&(t.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR),this.use_gradients){var f=LGraphCanvas.gradients[g];f||((f=LGraphCanvas.gradients[g]=t.createLinearGradient(0,0,400,0)).addColorStop(0,g),f.addColorStop(1,"#000")),t.fillStyle=f}else t.fillStyle=g;t.beginPath(),c==LiteGraph.BOX_SHAPE||l?t.rect(0,-r,n[0]+1,r):c!=LiteGraph.ROUND_SHAPE&&c!=LiteGraph.CARD_SHAPE||t.roundRect(0,-r,n[0]+1,r,e.flags.collapsed?[this.round_radius]:[this.round_radius,this.round_radius,0,0]),t.fill(),t.shadowColor="transparent"}var _=!1;LiteGraph.node_box_coloured_by_mode&&LiteGraph.NODE_MODES_COLORS[e.mode]&&(_=LiteGraph.NODE_MODES_COLORS[e.mode]),LiteGraph.node_box_coloured_when_on&&(_=e.action_triggered?"#FFF":e.execute_triggered?"#AAA":_);var m=10;if(e.onDrawTitleBox?e.onDrawTitleBox(t,r,n,this.ds.scale):c==LiteGraph.ROUND_SHAPE||c==LiteGraph.CIRCLE_SHAPE||c==LiteGraph.CARD_SHAPE?(l&&(t.fillStyle="black",t.beginPath(),t.arc(.5*r,-.5*r,6,0,2*Math.PI),t.fill()),t.fillStyle=e.boxcolor||_||LiteGraph.NODE_DEFAULT_BOXCOLOR,l?t.fillRect(.5*r-5,-.5*r-5,m,m):(t.beginPath(),t.arc(.5*r,-.5*r,5,0,2*Math.PI),t.fill())):(l&&(t.fillStyle="black",t.fillRect(.5*(r-m)-1,-.5*(r+m)-1,12,12)),t.fillStyle=e.boxcolor||_||LiteGraph.NODE_DEFAULT_BOXCOLOR,t.fillRect(.5*(r-m),-.5*(r+m),m,m)),t.globalAlpha=u,e.onDrawTitleText&&e.onDrawTitleText(t,r,n,this.ds.scale,this.title_text_font,a),!l){t.font=this.title_text_font;var v=String(e.getTitle());v&&(t.fillStyle=a?LiteGraph.NODE_SELECTED_TITLE_COLOR:e.constructor.title_text_color||this.node_title_color,e.flags.collapsed?(t.textAlign="left",t.measureText(v),t.fillText(v.substr(0,20),r,LiteGraph.NODE_TITLE_TEXT_Y-r),t.textAlign="left"):(t.textAlign="left",t.fillText(v,r,LiteGraph.NODE_TITLE_TEXT_Y-r)))}if(!e.flags.collapsed&&e.subgraph&&!e.skip_subgraph_button){var y=LiteGraph.NODE_TITLE_HEIGHT,b=e.size[0]-y,w=LiteGraph.isInsideRectangle(this.graph_mouse[0]-e.pos[0],this.graph_mouse[1]-e.pos[1],b+2,2-y,y-4,y-4);t.fillStyle=w?"#888":"#555",c==LiteGraph.BOX_SHAPE||l?t.fillRect(b+2,2-y,y-4,y-4):(t.beginPath(),t.roundRect(b+2,2-y,y-4,y-4,[4]),t.fill()),t.fillStyle="#333",t.beginPath(),t.moveTo(b+.2*y,.6*-y),t.lineTo(b+.8*y,.6*-y),t.lineTo(b+.5*y,.3*-y),t.fill()}e.onDrawTitle&&e.onDrawTitle(t)}a&&(e.onBounding&&e.onBounding(d),p==LiteGraph.TRANSPARENT_TITLE&&(d[1]-=r,d[3]+=r),t.lineWidth=1,t.globalAlpha=.8,t.beginPath(),c==LiteGraph.BOX_SHAPE?t.rect(-6+d[0],-6+d[1],12+d[2],12+d[3]):c==LiteGraph.ROUND_SHAPE||c==LiteGraph.CARD_SHAPE&&e.flags.collapsed?t.roundRect(-6+d[0],-6+d[1],12+d[2],12+d[3],[2*this.round_radius]):c==LiteGraph.CARD_SHAPE?t.roundRect(-6+d[0],-6+d[1],12+d[2],12+d[3],[2*this.round_radius,2,2*this.round_radius,2]):c==LiteGraph.CIRCLE_SHAPE&&t.arc(.5*n[0],.5*n[1],.5*n[0]+6,0,2*Math.PI),t.strokeStyle=LiteGraph.NODE_BOX_OUTLINE_COLOR,t.stroke(),t.strokeStyle=i,t.globalAlpha=1),e.execute_triggered>0&&e.execute_triggered--,e.action_triggered>0&&e.action_triggered--};var margin_area=new Float32Array(4),link_bounding=new Float32Array(4),tempA=new Float32Array(2),tempB=new Float32Array(2);function compareObjects(e,t){for(var n in e)if(e[n]!=t[n])return!1;return!0}function distance(e,t){return Math.sqrt((t[0]-e[0])*(t[0]-e[0])+(t[1]-e[1])*(t[1]-e[1]))}function colorToString(e){return"rgba("+Math.round(255*e[0]).toFixed()+","+Math.round(255*e[1]).toFixed()+","+Math.round(255*e[2]).toFixed()+","+(4==e.length?e[3].toFixed(2):"1.0")+")"}function isInsideRectangle(e,t,n,i,s,a){return n<e&&n+s>e&&i<t&&i+a>t}function growBounding(e,t,n){t<e[0]?e[0]=t:t>e[2]&&(e[2]=t),n<e[1]?e[1]=n:n>e[3]&&(e[3]=n)}function isInsideBounding(e,t){return!(e[0]<t[0][0]||e[1]<t[0][1]||e[0]>t[1][0]||e[1]>t[1][1])}function overlapBounding(e,t){var n=e[0]+e[2],i=e[1]+e[3],s=t[0]+t[2],a=t[1]+t[3];return!(e[0]>s||e[1]>a||n<t[0]||i<t[1])}function hex2num(e){"#"==e.charAt(0)&&(e=e.slice(1)),e=e.toUpperCase();for(var t,n,i="0123456789ABCDEF",s=new Array(3),a=0,o=0;o<6;o+=2)t=i.indexOf(e.charAt(o)),n=i.indexOf(e.charAt(o+1)),s[a]=16*t+n,a++;return s}function num2hex(e){for(var t,n,i="0123456789ABCDEF",s="#",a=0;a<3;a++)t=e[a]/16,n=e[a]%16,s+=i.charAt(t)+i.charAt(n);return s}function ContextMenu(e,t){t=t||{},this.options=t;var n=this;t.parentMenu&&(t.parentMenu.constructor!==this.constructor?t.parentMenu=null:(this.parentMenu=t.parentMenu,this.parentMenu.lock=!0,this.parentMenu.current_submenu=this));var i=null;t.event&&(i=t.event.constructor.name),"MouseEvent"!==i&&"CustomEvent"!==i&&"PointerEvent"!==i&&(t.event=null);var s=document.createElement("div");function a(e){var n=parseInt(s.style.top);return s.style.top=(n+e.deltaY*t.scroll_speed).toFixed()+"px",e.preventDefault(),!0}if(s.className="litegraph litecontextmenu litemenubar-panel",t.className&&(s.className+=" "+t.className),s.style.minWidth=100,s.style.minHeight=100,s.style.pointerEvents="none",setTimeout((function(){s.style.pointerEvents="auto"}),100),LiteGraph.pointerListenerAdd(s,"up",(function(e){return e.preventDefault(),!0}),!0),s.addEventListener("contextmenu",(function(e){return 2!=e.button||e.preventDefault(),!1}),!0),LiteGraph.pointerListenerAdd(s,"down",(function(e){if(2==e.button)return n.close(),e.preventDefault(),!0}),!0),t.scroll_speed||(t.scroll_speed=.1),s.addEventListener("wheel",a,!0),s.addEventListener("mousewheel",a,!0),this.root=s,t.title){var o=document.createElement("div");o.className="litemenu-title",o.innerHTML=t.title,s.appendChild(o)}for(var r=0;r<e.length;r++){var l=e.constructor==Array?e[r]:r;null!=l&&l.constructor!==String&&(l=void 0===l.content?String(l):l.content);var c=e[r];this.addItem(l,c,t)}LiteGraph.pointerListenerAdd(s,"enter",(function(e){s.closing_timer&&clearTimeout(s.closing_timer)}));var p=document;t.event&&(p=t.event.target.ownerDocument),p||(p=document),p.fullscreenElement?p.fullscreenElement.appendChild(s):p.body.appendChild(s);var h=t.left||0,d=t.top||0;if(t.event){if(h=t.event.clientX-10,d=t.event.clientY-10,t.title&&(d-=20),t.parentMenu){var u=t.parentMenu.root.getBoundingClientRect();h=u.left+u.width}var g=document.body.getBoundingClientRect(),f=s.getBoundingClientRect();g.height,g.width&&h>g.width-f.width-10&&(h=g.width-f.width-10),g.height&&d>g.height-f.height-10&&(d=g.height-f.height-10)}s.style.left=h+"px",s.style.top=d+"px",t.scale&&(s.style.transform="scale("+t.scale+")")}function CurveEditor(e){this.points=e,this.selected=-1,this.nearest=-1,this.size=null,this.must_update=!0,this.margin=5}function clamp(e,t,n){return t>e?t:n<e?n:e}LGraphCanvas.prototype.drawConnections=function(e){var t=LiteGraph.getTime(),n=this.visible_area;margin_area[0]=n[0]-20,margin_area[1]=n[1]-20,margin_area[2]=n[2]+40,margin_area[3]=n[3]+40,e.lineWidth=this.connections_width,e.fillStyle="#AAA",e.strokeStyle="#AAA",e.globalAlpha=this.editor_alpha;for(var i=this.graph._nodes,s=0,a=i.length;s<a;++s){var o=i[s];if(o.inputs&&o.inputs.length)for(var r=0;r<o.inputs.length;++r){var l=o.inputs[r];if(l&&null!=l.link){var c=l.link,p=this.graph.links[c];if(p){var h=this.graph.getNodeById(p.origin_id);if(null!=h){var d=p.origin_slot,u=null;u=-1==d?[h.pos[0]+10,h.pos[1]+10]:h.getConnectionPos(!1,d,tempA);var g=o.getConnectionPos(!0,r,tempB);if(link_bounding[0]=u[0],link_bounding[1]=u[1],link_bounding[2]=g[0]-u[0],link_bounding[3]=g[1]-u[1],link_bounding[2]<0&&(link_bounding[0]+=link_bounding[2],link_bounding[2]=Math.abs(link_bounding[2])),link_bounding[3]<0&&(link_bounding[1]+=link_bounding[3],link_bounding[3]=Math.abs(link_bounding[3])),overlapBounding(link_bounding,margin_area)){var f=h.outputs[d],_=o.inputs[r];if(f&&_){var m=f.dir||(h.horizontal?LiteGraph.DOWN:LiteGraph.RIGHT),v=_.dir||(o.horizontal?LiteGraph.UP:LiteGraph.LEFT);if(this.renderLink(e,u,g,p,!1,0,null,m,v),p&&p._last_time&&t-p._last_time<1e3){var y=2-.002*(t-p._last_time),b=e.globalAlpha;e.globalAlpha=b*y,this.renderLink(e,u,g,p,!0,y,"white",m,v),e.globalAlpha=b}}}}}}}}e.globalAlpha=1},LGraphCanvas.prototype.renderLink=function(e,t,n,i,s,a,o,r,l,c){i&&this.visible_links.push(i),!o&&i&&(o=i.color||LGraphCanvas.link_type_colors[i.type]),o||(o=this.default_link_color),null!=i&&this.highlighted_links[i.id]&&(o="#FFF"),r=r||LiteGraph.RIGHT,l=l||LiteGraph.LEFT;var p=distance(t,n);this.render_connections_border&&this.ds.scale>.6&&(e.lineWidth=this.connections_width+4),e.lineJoin="round",(c=c||1)>1&&(e.lineWidth=.5),e.beginPath();for(var h=0;h<c;h+=1){var d=5*(h-.5*(c-1));if(this.links_render_mode==LiteGraph.SPLINE_LINK){e.moveTo(t[0],t[1]+d);var u=0,g=0,f=0,_=0;switch(r){case LiteGraph.LEFT:u=-.25*p;break;case LiteGraph.RIGHT:u=.25*p;break;case LiteGraph.UP:g=-.25*p;break;case LiteGraph.DOWN:g=.25*p}switch(l){case LiteGraph.LEFT:f=-.25*p;break;case LiteGraph.RIGHT:f=.25*p;break;case LiteGraph.UP:_=-.25*p;break;case LiteGraph.DOWN:_=.25*p}e.bezierCurveTo(t[0]+u,t[1]+g+d,n[0]+f,n[1]+_+d,n[0],n[1]+d)}else if(this.links_render_mode==LiteGraph.LINEAR_LINK){e.moveTo(t[0],t[1]+d);u=0,g=0,f=0,_=0;switch(r){case LiteGraph.LEFT:u=-1;break;case LiteGraph.RIGHT:u=1;break;case LiteGraph.UP:g=-1;break;case LiteGraph.DOWN:g=1}switch(l){case LiteGraph.LEFT:f=-1;break;case LiteGraph.RIGHT:f=1;break;case LiteGraph.UP:_=-1;break;case LiteGraph.DOWN:_=1}e.lineTo(t[0]+15*u,t[1]+15*g+d),e.lineTo(n[0]+15*f,n[1]+15*_+d),e.lineTo(n[0],n[1]+d)}else{if(this.links_render_mode!=LiteGraph.STRAIGHT_LINK)return;e.moveTo(t[0],t[1]);var m=t[0],v=t[1],y=n[0],b=n[1];r==LiteGraph.RIGHT?m+=10:v+=10,l==LiteGraph.LEFT?y-=10:b-=10,e.lineTo(m,v),e.lineTo(.5*(m+y),v),e.lineTo(.5*(m+y),b),e.lineTo(y,b),e.lineTo(n[0],n[1])}}this.render_connections_border&&this.ds.scale>.6&&!s&&(e.strokeStyle="rgba(0,0,0,0.5)",e.stroke()),e.lineWidth=this.connections_width,e.fillStyle=e.strokeStyle=o,e.stroke();var w=this.computeConnectionPoint(t,n,.5,r,l);if(i&&i._pos&&(i._pos[0]=w[0],i._pos[1]=w[1]),this.ds.scale>=.6&&this.highquality_render&&l!=LiteGraph.CENTER){if(this.render_connection_arrows){var k=this.computeConnectionPoint(t,n,.25,r,l),L=this.computeConnectionPoint(t,n,.26,r,l),A=this.computeConnectionPoint(t,n,.75,r,l),x=this.computeConnectionPoint(t,n,.76,r,l),C=0,T=0;this.render_curved_connections?(C=-Math.atan2(L[0]-k[0],L[1]-k[1]),T=-Math.atan2(x[0]-A[0],x[1]-A[1])):T=C=n[1]>t[1]?0:Math.PI,e.save(),e.translate(k[0],k[1]),e.rotate(C),e.beginPath(),e.moveTo(-5,-3),e.lineTo(0,7),e.lineTo(5,-3),e.fill(),e.restore(),e.save(),e.translate(A[0],A[1]),e.rotate(T),e.beginPath(),e.moveTo(-5,-3),e.lineTo(0,7),e.lineTo(5,-3),e.fill(),e.restore()}e.beginPath(),e.arc(w[0],w[1],5,0,2*Math.PI),e.fill()}if(a){e.fillStyle=o;for(h=0;h<5;++h){var G=(.001*LiteGraph.getTime()+.2*h)%1;w=this.computeConnectionPoint(t,n,G,r,l);e.beginPath(),e.arc(w[0],w[1],5,0,2*Math.PI),e.fill()}}},LGraphCanvas.prototype.computeConnectionPoint=function(e,t,n,i,s){i=i||LiteGraph.RIGHT,s=s||LiteGraph.LEFT;var a=distance(e,t),o=e,r=[e[0],e[1]],l=[t[0],t[1]],c=t;switch(i){case LiteGraph.LEFT:r[0]+=-.25*a;break;case LiteGraph.RIGHT:r[0]+=.25*a;break;case LiteGraph.UP:r[1]+=-.25*a;break;case LiteGraph.DOWN:r[1]+=.25*a}switch(s){case LiteGraph.LEFT:l[0]+=-.25*a;break;case LiteGraph.RIGHT:l[0]+=.25*a;break;case LiteGraph.UP:l[1]+=-.25*a;break;case LiteGraph.DOWN:l[1]+=.25*a}var p=(1-n)*(1-n)*(1-n),h=(1-n)*(1-n)*3*n,d=3*(1-n)*(n*n),u=n*n*n;return[p*o[0]+h*r[0]+d*l[0]+u*c[0],p*o[1]+h*r[1]+d*l[1]+u*c[1]]},LGraphCanvas.prototype.drawExecutionOrder=function(e){e.shadowColor="transparent",e.globalAlpha=.25,e.textAlign="center",e.strokeStyle="white",e.globalAlpha=.75;for(var t=this.visible_nodes,n=0;n<t.length;++n){var i=t[n];e.fillStyle="black",e.fillRect(i.pos[0]-LiteGraph.NODE_TITLE_HEIGHT,i.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),0==i.order&&e.strokeRect(i.pos[0]-LiteGraph.NODE_TITLE_HEIGHT+.5,i.pos[1]-LiteGraph.NODE_TITLE_HEIGHT+.5,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),e.fillStyle="#FFF",e.fillText(i.order,i.pos[0]+-.5*LiteGraph.NODE_TITLE_HEIGHT,i.pos[1]-6)}e.globalAlpha=1},LGraphCanvas.prototype.drawNodeWidgets=function(e,t,n,i){if(!e.widgets||!e.widgets.length)return 0;var s=e.size[0],a=e.widgets;t+=2;var o=LiteGraph.NODE_WIDGET_HEIGHT,r=this.ds.scale>.5;n.save(),n.globalAlpha=this.editor_alpha;for(var l=LiteGraph.WIDGET_OUTLINE_COLOR,c=LiteGraph.WIDGET_BGCOLOR,p=LiteGraph.WIDGET_TEXT_COLOR,h=LiteGraph.WIDGET_SECONDARY_TEXT_COLOR,d=15,u=0;u<a.length;++u){var g=a[u],f=t;g.y&&(f=g.y),g.last_y=f,n.strokeStyle=l,n.fillStyle="#222",n.textAlign="left",g.disabled&&(n.globalAlpha*=.5);var _=g.width||s;switch(g.type){case"button":n.fillStyle=c,g.clicked&&(n.fillStyle="#AAA",g.clicked=!1,this.dirty_canvas=!0),n.fillRect(d,f,_-30,o),r&&!g.disabled&&n.strokeRect(d,f,_-30,o),r&&(n.textAlign="center",n.fillStyle=p,n.fillText(g.label||g.name,.5*_,f+.7*o));break;case"toggle":if(n.textAlign="left",n.strokeStyle=l,n.fillStyle=c,n.beginPath(),r?n.roundRect(d,f,_-30,o,[.5*o]):n.rect(d,f,_-30,o),n.fill(),r&&!g.disabled&&n.stroke(),n.fillStyle=g.value?"#89A":"#333",n.beginPath(),n.arc(_-30,f+.5*o,.36*o,0,2*Math.PI),n.fill(),r){n.fillStyle=h;const e=g.label||g.name;null!=e&&n.fillText(e,30,f+.7*o),n.fillStyle=g.value?p:h,n.textAlign="right",n.fillText(g.value?g.options.on||"true":g.options.off||"false",_-40,f+.7*o)}break;case"slider":n.fillStyle=c,n.fillRect(d,f,_-30,o);var m=g.options.max-g.options.min,v=(g.value-g.options.min)/m;if(v<0&&(v=0),v>1&&(v=1),n.fillStyle=g.options.hasOwnProperty("slider_color")?g.options.slider_color:i==g?"#89A":"#678",n.fillRect(d,f,v*(_-30),o),r&&!g.disabled&&n.strokeRect(d,f,_-30,o),g.marker){var y=(g.marker-g.options.min)/m;y<0&&(y=0),y>1&&(y=1),n.fillStyle=g.options.hasOwnProperty("marker_color")?g.options.marker_color:"#AA9",n.fillRect(d+y*(_-30),f,2,o)}r&&(n.textAlign="center",n.fillStyle=p,n.fillText(g.label||g.name+"  "+Number(g.value).toFixed(null!=g.options.precision?g.options.precision:3),.5*_,f+.7*o));break;case"number":case"combo":if(n.textAlign="left",n.strokeStyle=l,n.fillStyle=c,n.beginPath(),r?n.roundRect(d,f,_-30,o,[.5*o]):n.rect(d,f,_-30,o),n.fill(),r)if(g.disabled||n.stroke(),n.fillStyle=p,g.disabled||(n.beginPath(),n.moveTo(31,f+5),n.lineTo(21,f+.5*o),n.lineTo(31,f+o-5),n.fill(),n.beginPath(),n.moveTo(_-d-16,f+5),n.lineTo(_-d-6,f+.5*o),n.lineTo(_-d-16,f+o-5),n.fill()),n.fillStyle=h,n.fillText(g.label||g.name,35,f+.7*o),n.fillStyle=p,n.textAlign="right","number"==g.type)n.fillText(Number(g.value).toFixed(void 0!==g.options.precision?g.options.precision:3),_-30-20,f+.7*o);else{var b=g.value;if(g.options.values){var w=g.options.values;w.constructor===Function&&(w=w()),w&&w.constructor!==Array&&(b=w[g.value])}n.fillText(b,_-30-20,f+.7*o)}break;case"string":case"text":if(n.textAlign="left",n.strokeStyle=l,n.fillStyle=c,n.beginPath(),r?n.roundRect(d,f,_-30,o,[.5*o]):n.rect(d,f,_-30,o),n.fill(),r){g.disabled||n.stroke(),n.save(),n.beginPath(),n.rect(d,f,_-30,o),n.clip(),n.fillStyle=h;const e=g.label||g.name;null!=e&&n.fillText(e,30,f+.7*o),n.fillStyle=p,n.textAlign="right",n.fillText(String(g.value).substr(0,30),_-30,f+.7*o),n.restore()}break;default:g.draw&&g.draw(n,e,_,f,o)}t+=(g.computeSize?g.computeSize(_)[1]:o)+4,n.globalAlpha=this.editor_alpha}n.restore(),n.textAlign="left"},LGraphCanvas.prototype.processNodeWidgets=function(node,pos,event,active_widget){if(!node.widgets||!node.widgets.length||!this.allow_interaction&&!node.flags.allow_interaction)return null;for(var x=pos[0]-node.pos[0],y=pos[1]-node.pos[1],width=node.size[0],that=this,ref_window=this.getCanvasWindow(),i=0;i<node.widgets.length;++i){var w=node.widgets[i];if(w&&!w.disabled){var widget_height=w.computeSize?w.computeSize(width)[1]:LiteGraph.NODE_WIDGET_HEIGHT,widget_width=w.width||width;if(w==active_widget||!(x<6||x>widget_width-12||y<w.last_y||y>w.last_y+widget_height||void 0===w.last_y)){var old_value=w.value;switch(w.type){case"button":event.type===LiteGraph.pointerevents_method+"down"&&(w.callback&&setTimeout((function(){w.callback(w,that,node,pos,event)}),20),w.clicked=!0,this.dirty_canvas=!0);break;case"slider":var old_value=w.value,nvalue=clamp((x-15)/(widget_width-30),0,1);if(w.options.read_only)break;w.value=w.options.min+(w.options.max-w.options.min)*nvalue,old_value!=w.value&&setTimeout((function(){inner_value_change(w,w.value)}),20),this.dirty_canvas=!0;break;case"number":case"combo":var old_value=w.value,delta=x<40?-1:x>widget_width-40?1:0,allow_scroll=!0;if(delta&&x>-3&&x<widget_width+3&&(allow_scroll=!1),allow_scroll&&event.type==LiteGraph.pointerevents_method+"move"&&"number"==w.type)event.deltaX&&(w.value+=.1*event.deltaX*(w.options.step||1)),null!=w.options.min&&w.value<w.options.min&&(w.value=w.options.min),null!=w.options.max&&w.value>w.options.max&&(w.value=w.options.max);else if(event.type==LiteGraph.pointerevents_method+"down"){var values=w.options.values;values&&values.constructor===Function&&(values=w.options.values(w,node));var values_list=null;"number"!=w.type&&(values_list=values.constructor===Array?values:Object.keys(values));var delta=x<40?-1:x>widget_width-40?1:0;if("number"==w.type)w.value+=.1*delta*(w.options.step||1),null!=w.options.min&&w.value<w.options.min&&(w.value=w.options.min),null!=w.options.max&&w.value>w.options.max&&(w.value=w.options.max);else if(delta){var index=-1;this.last_mouseclick=0,index=values.constructor===Object?values_list.indexOf(String(w.value))+delta:values_list.indexOf(w.value)+delta,index>=values_list.length&&(index=values_list.length-1),index<0&&(index=0),values.constructor===Array?w.value=values[index]:w.value=index}else{var text_values=values!=values_list?Object.values(values):values;function e(e,t,n){return values!=values_list&&(e=text_values.indexOf(e)),this.value=e,inner_value_change(this,e),that.dirty_canvas=!0,!1}new LiteGraph.ContextMenu(text_values,{scale:Math.max(1,this.ds.scale),event:event,className:"dark",callback:e.bind(w)},ref_window)}}else if(event.type==LiteGraph.pointerevents_method+"up"&&"number"==w.type){var delta=x<40?-1:x>widget_width-40?1:0;event.click_time<200&&0==delta&&this.prompt("Value",w.value,function(v){if(/^[0-9+\-*/()\s]+|\d+\.\d+$/.test(v))try{v=eval(v)}catch(e){}this.value=Number(v),inner_value_change(this,this.value)}.bind(w),event)}old_value!=w.value&&setTimeout(function(){inner_value_change(this,this.value)}.bind(w),20),this.dirty_canvas=!0;break;case"toggle":event.type==LiteGraph.pointerevents_method+"down"&&(w.value=!w.value,setTimeout((function(){inner_value_change(w,w.value)}),20));break;case"string":case"text":event.type==LiteGraph.pointerevents_method+"down"&&this.prompt("Value",w.value,function(e){inner_value_change(this,e)}.bind(w),event,!!w.options&&w.options.multiline);break;default:w.mouse&&(this.dirty_canvas=w.mouse(event,[x,y],node))}return old_value!=w.value&&(node.onWidgetChanged&&node.onWidgetChanged(w.name,w.value,old_value,w),node.graph._version++),w}}}function inner_value_change(e,t){"number"==e.type&&(t=Number(t)),e.value=t,e.options&&e.options.property&&void 0!==node.properties[e.options.property]&&node.setProperty(e.options.property,t),e.callback&&e.callback(e.value,that,node,pos,event)}return null},LGraphCanvas.prototype.drawGroups=function(e,t){if(this.graph){var n=this.graph._groups;t.save(),t.globalAlpha=.5*this.editor_alpha;for(var i=0;i<n.length;++i){var s=n[i];if(overlapBounding(this.visible_area,s._bounding)){t.fillStyle=s.color||"#335",t.strokeStyle=s.color||"#335";var a=s._pos,o=s._size;t.globalAlpha=.25*this.editor_alpha,t.beginPath(),t.rect(a[0]+.5,a[1]+.5,o[0],o[1]),t.fill(),t.globalAlpha=this.editor_alpha,t.stroke(),t.beginPath(),t.moveTo(a[0]+o[0],a[1]+o[1]),t.lineTo(a[0]+o[0]-10,a[1]+o[1]),t.lineTo(a[0]+o[0],a[1]+o[1]-10),t.fill();var r=s.font_size||LiteGraph.DEFAULT_GROUP_FONT_SIZE;t.font=r+"px Arial",t.textAlign="left",t.fillText(s.title,a[0]+4,a[1]+r)}}t.restore()}},LGraphCanvas.prototype.adjustNodesSize=function(){for(var e=this.graph._nodes,t=0;t<e.length;++t)e[t].size=e[t].computeSize();this.setDirty(!0,!0)},LGraphCanvas.prototype.resize=function(e,t){if(!e&&!t){var n=this.canvas.parentNode;e=n.offsetWidth,t=n.offsetHeight}this.canvas.width==e&&this.canvas.height==t||(this.canvas.width=e,this.canvas.height=t,this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,this.setDirty(!0,!0))},LGraphCanvas.prototype.switchLiveMode=function(e){if(!e)return this.live_mode=!this.live_mode,this.dirty_canvas=!0,void(this.dirty_bgcanvas=!0);var t=this,n=this.live_mode?1.1:.9;this.live_mode&&(this.live_mode=!1,this.editor_alpha=.1);var i=setInterval((function(){t.editor_alpha*=n,t.dirty_canvas=!0,t.dirty_bgcanvas=!0,n<1&&t.editor_alpha<.01&&(clearInterval(i),n<1&&(t.live_mode=!0)),n>1&&t.editor_alpha>.99&&(clearInterval(i),t.editor_alpha=1)}),1)},LGraphCanvas.prototype.onNodeSelectionChange=function(e){},LGraphCanvas.onGroupAdd=function(e,t,n){var i=LGraphCanvas.active_canvas;i.getCanvasWindow();var s=new LiteGraph.LGraphGroup;s.pos=i.convertEventToCanvasOffset(n),i.graph.add(s)},LGraphCanvas.getBoundaryNodes=function(e){let t=null,n=null,i=null,s=null;for(const a in e){const o=e[a],[r,l]=o.pos,[c,p]=o.size;(null===t||l<t.pos[1])&&(t=o),(null===n||r+c>n.pos[0]+n.size[0])&&(n=o),(null===i||l+p>i.pos[1]+i.size[1])&&(i=o),(null===s||r<s.pos[0])&&(s=o)}return{top:t,right:n,bottom:i,left:s}},LGraphCanvas.prototype.boundaryNodesForSelection=function(){return LGraphCanvas.getBoundaryNodes(Object.values(this.selected_nodes))},LGraphCanvas.alignNodes=function(e,t,n){if(!e)return;const i=LGraphCanvas.active_canvas;let s=[];s=void 0===n?LGraphCanvas.getBoundaryNodes(e):{top:n,right:n,bottom:n,left:n};for(const[e,n]of Object.entries(i.selected_nodes))switch(t){case"right":n.pos[0]=s.right.pos[0]+s.right.size[0]-n.size[0];break;case"left":n.pos[0]=s.left.pos[0];break;case"top":n.pos[1]=s.top.pos[1];break;case"bottom":n.pos[1]=s.bottom.pos[1]+s.bottom.size[1]-n.size[1]}i.dirty_canvas=!0,i.dirty_bgcanvas=!0},LGraphCanvas.onNodeAlign=function(e,t,n,i,s){new LiteGraph.ContextMenu(["Top","Bottom","Left","Right"],{event:n,callback:function(e){LGraphCanvas.alignNodes(LGraphCanvas.active_canvas.selected_nodes,e.toLowerCase(),s)},parentMenu:i})},LGraphCanvas.onGroupAlign=function(e,t,n,i){new LiteGraph.ContextMenu(["Top","Bottom","Left","Right"],{event:n,callback:function(e){LGraphCanvas.alignNodes(LGraphCanvas.active_canvas.selected_nodes,e.toLowerCase())},parentMenu:i})},LGraphCanvas.onMenuAdd=function(e,t,n,i,s){var a=LGraphCanvas.active_canvas,o=a.getCanvasWindow(),r=a.graph;if(r)return function e(t,i){var l=LiteGraph.getNodeTypesCategories(a.filter||r.filter).filter((function(e){return e.startsWith(t)})),c=[];l.map((function(n){if(n){var i=new RegExp("^("+t+")"),s=n.replace(i,"").split("/")[0],a=""===t?s+"/":t+s+"/",o=s;-1!=o.indexOf("::")&&(o=o.split("::")[1]),-1===c.findIndex((function(e){return e.value===a}))&&c.push({value:a,content:o,has_submenu:!0,callback:function(t,n,i,s){e(t.value,s)}})}})),LiteGraph.getNodeTypesInCategory(t.slice(0,-1),a.filter||r.filter).map((function(e){if(!e.skip_list){var t={value:e.type,content:e.title,has_submenu:!1,callback:function(e,t,n,i){var o=i.getFirstEvent();a.graph.beforeChange();var r=LiteGraph.createNode(e.value);r&&(r.pos=a.convertEventToCanvasOffset(o),a.graph.add(r)),s&&s(r),a.graph.afterChange()}};c.push(t)}})),new LiteGraph.ContextMenu(c,{event:n,parentMenu:i},o)}("",i),!1},LGraphCanvas.onMenuCollapseAll=function(){},LGraphCanvas.onMenuNodeEdit=function(){},LGraphCanvas.showMenuNodeOptionalInputs=function(e,t,n,i,s){if(s){var a=this,o=LGraphCanvas.active_canvas.getCanvasWindow();t=s.optional_inputs;s.onGetInputs&&(t=s.onGetInputs());var r=[];if(t)for(var l=0;l<t.length;l++){var c=t[l];if(c){var p=c[0];c[2]||(c[2]={}),c[2].label&&(p=c[2].label),c[2].removable=!0;var h={content:p,value:c};c[1]==LiteGraph.ACTION&&(h.className="event"),r.push(h)}else r.push(null)}if(s.onMenuNodeInputs){var d=s.onMenuNodeInputs(r);d&&(r=d)}if(r.length)return new LiteGraph.ContextMenu(r,{event:n,callback:function(e,t,n){if(!s)return;e.callback&&e.callback.call(a,s,e,t,n);e.value&&(s.graph.beforeChange(),s.addInput(e.value[0],e.value[1],e.value[2]),s.onNodeInputAdd&&s.onNodeInputAdd(e.value),s.setDirtyCanvas(!0,!0),s.graph.afterChange())},parentMenu:i,node:s},o),!1}},LGraphCanvas.showMenuNodeOptionalOutputs=function(e,t,n,i,s){if(s){var a=this,o=LGraphCanvas.active_canvas.getCanvasWindow();t=s.optional_outputs;s.onGetOutputs&&(t=s.onGetOutputs());var r=[];if(t)for(var l=0;l<t.length;l++){var c=t[l];if(c){if(!s.flags||!s.flags.skip_repeated_outputs||-1==s.findOutputSlot(c[0])){var p=c[0];c[2]||(c[2]={}),c[2].label&&(p=c[2].label),c[2].removable=!0;var h={content:p,value:c};c[1]==LiteGraph.EVENT&&(h.className="event"),r.push(h)}}else r.push(null)}if(this.onMenuNodeOutputs&&(r=this.onMenuNodeOutputs(r)),LiteGraph.do_add_triggers_slots&&-1==s.findOutputSlot("onExecuted")&&r.push({content:"On Executed",value:["onExecuted",LiteGraph.EVENT,{nameLocked:!0}],className:"event"}),s.onMenuNodeOutputs){var d=s.onMenuNodeOutputs(r);d&&(r=d)}if(r.length)return new LiteGraph.ContextMenu(r,{event:n,callback:function e(t,n,o){if(!s)return;t.callback&&t.callback.call(a,s,t,n,o);if(!t.value)return;var r=t.value[1];if(r&&(r.constructor===Object||r.constructor===Array)){var l=[];for(var c in r)l.push({content:c,value:r[c]});return new LiteGraph.ContextMenu(l,{event:n,callback:e,parentMenu:i,node:s}),!1}s.graph.beforeChange(),s.addOutput(t.value[0],t.value[1],t.value[2]),s.onNodeOutputAdd&&s.onNodeOutputAdd(t.value),s.setDirtyCanvas(!0,!0),s.graph.afterChange()},parentMenu:i,node:s},o),!1}},LGraphCanvas.onShowMenuNodeProperties=function(e,t,n,i,s){if(s&&s.properties){var a=LGraphCanvas.active_canvas,o=a.getCanvasWindow(),r=[];for(var l in s.properties){"object"==typeof(e=void 0!==s.properties[l]?s.properties[l]:" ")&&(e=JSON.stringify(e));var c=s.getPropertyInfo(l);"enum"!=c.type&&"combo"!=c.type||(e=LGraphCanvas.getPropertyPrintableValue(e,c.values)),e=LGraphCanvas.decodeHTML(e),r.push({content:"<span class='property_name'>"+(c.label?c.label:l)+"</span><span class='property_value'>"+e+"</span>",value:l})}if(r.length)return new LiteGraph.ContextMenu(r,{event:n,callback:function(e,t,n,i){if(!s)return;var o=this.getBoundingClientRect();a.showEditPropertyValue(s,e.value,{position:[o.left,o.top]})},parentMenu:i,allow_html:!0,node:s},o),!1}},LGraphCanvas.decodeHTML=function(e){var t=document.createElement("div");return t.innerText=e,t.innerHTML},LGraphCanvas.onMenuResizeNode=function(e,t,n,i,s){if(s){var a=function(e){e.size=e.computeSize(),e.onResize&&e.onResize(e.size)},o=LGraphCanvas.active_canvas;if(!o.selected_nodes||Object.keys(o.selected_nodes).length<=1)a(s);else for(var r in o.selected_nodes)a(o.selected_nodes[r]);s.setDirtyCanvas(!0,!0)}},LGraphCanvas.prototype.showLinkMenu=function(e,t){var n=this,i=n.graph.getNodeById(e.origin_id),s=n.graph.getNodeById(e.target_id),a=!1;i&&i.outputs&&i.outputs[e.origin_slot]&&(a=i.outputs[e.origin_slot].type);var o=!1;s&&s.outputs&&s.outputs[e.target_slot]&&(o=s.inputs[e.target_slot].type);var r=new LiteGraph.ContextMenu(["Add Node",null,"Delete",null],{event:t,title:null!=e.data?e.data.constructor.name:null,callback:function(t,l,c){switch(t){case"Add Node":LGraphCanvas.onMenuAdd(null,null,c,r,(function(t){t.inputs&&t.inputs.length&&t.outputs&&t.outputs.length&&i.connectByType(e.origin_slot,t,a)&&(t.connectByType(e.target_slot,s,o),t.pos[0]-=.5*t.size[0])}));break;case"Delete":n.graph.removeLink(e.id)}}});return!1},LGraphCanvas.prototype.createDefaultNodeForSlot=function(e){e=e||{};var t=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,position:[],nodeType:null,posAdd:[0,0],posSizeFix:[0,0]},e),n=t.nodeFrom&&null!==t.slotFrom,i=!n&&t.nodeTo&&null!==t.slotTo;if(!n&&!i)return!1;if(!t.nodeType)return!1;var s=n?t.nodeFrom:t.nodeTo,a=n?t.slotFrom:t.slotTo,o=!1;switch(typeof a){case"string":o=n?s.findOutputSlot(a,!1):s.findInputSlot(a,!1),a=n?s.outputs[a]:s.inputs[a];break;case"object":o=n?s.findOutputSlot(a.name):s.findInputSlot(a.name);break;case"number":o=a,a=n?s.outputs[a]:s.inputs[a];break;default:return!1}var r=a.type==LiteGraph.EVENT?"_event_":a.type,l=n?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(l&&l[r]){if(a.link,nodeNewType=!1,"object"==typeof l[r]||"array"==typeof l[r]){for(var c in l[r])if(t.nodeType==l[r][c]||"AUTO"==t.nodeType){nodeNewType=l[r][c];break}}else t.nodeType!=l[r]&&"AUTO"!=t.nodeType||(nodeNewType=l[r]);if(nodeNewType){var p=!1;"object"==typeof nodeNewType&&nodeNewType.node&&(p=nodeNewType,nodeNewType=nodeNewType.node);var h=LiteGraph.createNode(nodeNewType);if(h){if(p){if(p.properties)for(var d in p.properties)h.addProperty(d,p.properties[d]);if(p.inputs)for(var d in h.inputs=[],p.inputs)h.addOutput(p.inputs[d][0],p.inputs[d][1]);if(p.outputs)for(var d in h.outputs=[],p.outputs)h.addOutput(p.outputs[d][0],p.outputs[d][1]);p.title&&(h.title=p.title),p.json&&h.configure(p.json)}return this.graph.add(h),h.pos=[t.position[0]+t.posAdd[0]+(t.posSizeFix[0]?t.posSizeFix[0]*h.size[0]:0),t.position[1]+t.posAdd[1]+(t.posSizeFix[1]?t.posSizeFix[1]*h.size[1]:0)],n?t.nodeFrom.connectByType(o,h,r):t.nodeTo.connectByTypeOutput(o,h,r),!0}}}return!1},LGraphCanvas.prototype.showConnectionMenu=function(e){e=e||{};var t=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,e:null},e),n=this,i=t.nodeFrom&&t.slotFrom,s=!i&&t.nodeTo&&t.slotTo;if(!i&&!s)return!1;var a=i?t.nodeFrom:t.nodeTo,o=i?t.slotFrom:t.slotTo,r=!1;switch(typeof o){case"string":r=i?a.findOutputSlot(o,!1):a.findInputSlot(o,!1),o=i?a.outputs[o]:a.inputs[o];break;case"object":r=i?a.findOutputSlot(o.name):a.findInputSlot(o.name);break;case"number":r=o,o=i?a.outputs[o]:a.inputs[o];break;default:return!1}var l=["Add Node",null];n.allow_searchbox&&(l.push("Search"),l.push(null));var c=o.type==LiteGraph.EVENT?"_event_":o.type,p=i?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(p&&p[c])if("object"==typeof p[c]||"array"==typeof p[c])for(var h in p[c])l.push(p[c][h]);else l.push(p[c]);var d=new LiteGraph.ContextMenu(l,{event:t.e,title:(o&&""!=o.name?o.name+(c?" | ":""):"")+(o&&c?c:""),callback:function(e,s,a){switch(e){case"Add Node":LGraphCanvas.onMenuAdd(null,null,a,d,(function(e){i?t.nodeFrom.connectByType(r,e,c):t.nodeTo.connectByTypeOutput(r,e,c)}));break;case"Search":i?n.showSearchBox(a,{node_from:t.nodeFrom,slot_from:o,type_filter_in:c}):n.showSearchBox(a,{node_to:t.nodeTo,slot_from:o,type_filter_out:c});break;default:n.createDefaultNodeForSlot(Object.assign(t,{position:[t.e.canvasX,t.e.canvasY],nodeType:e}))}}});return!1},LGraphCanvas.onShowPropertyEditor=function(e,t,n,i,s){var a=e.property||"title",o=s[a],r=document.createElement("div");r.is_modified=!1,r.className="graphdialog",r.innerHTML="<span class='name'></span><input autofocus type='text' class='value'/><button>OK</button>",r.close=function(){r.parentNode&&r.parentNode.removeChild(r)},r.querySelector(".name").innerText=a;var l=r.querySelector(".value");l&&(l.value=o,l.addEventListener("blur",(function(e){this.focus()})),l.addEventListener("keydown",(function(e){if(r.is_modified=!0,27==e.keyCode)r.close();else if(13==e.keyCode)g();else if(13!=e.keyCode&&"textarea"!=e.target.localName)return;e.preventDefault(),e.stopPropagation()})));var c=LGraphCanvas.active_canvas.canvas,p=c.getBoundingClientRect(),h=-20,d=-20;p&&(h-=p.left,d-=p.top),event?(r.style.left=event.clientX+h+"px",r.style.top=event.clientY+d+"px"):(r.style.left=.5*c.width+h+"px",r.style.top=.5*c.height+d+"px"),r.querySelector("button").addEventListener("click",g),c.parentNode.appendChild(r),l&&l.focus();var u=null;function g(){l&&function(t){"Number"==e.type?t=Number(t):"Boolean"==e.type&&(t=Boolean(t));s[a]=t,r.parentNode&&r.parentNode.removeChild(r);s.setDirtyCanvas(!0,!0)}(l.value)}r.addEventListener("mouseleave",(function(e){LiteGraph.dialog_close_on_mouse_leave&&!r.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(u=setTimeout(r.close,LiteGraph.dialog_close_on_mouse_leave_delay))})),r.addEventListener("mouseenter",(function(e){LiteGraph.dialog_close_on_mouse_leave&&u&&clearTimeout(u)}))},LGraphCanvas.prototype.prompt=function(e,t,n,i,s){var a=this;e=e||"";var o=document.createElement("div");o.is_modified=!1,o.className="graphdialog rounded",o.innerHTML=s?"<span class='name'></span> <textarea autofocus class='value'></textarea><button class='rounded'>OK</button>":"<span class='name'></span> <input autofocus type='text' class='value'/><button class='rounded'>OK</button>",o.close=function(){a.prompt_box=null,o.parentNode&&o.parentNode.removeChild(o)};var r=LGraphCanvas.active_canvas.canvas;r.parentNode.appendChild(o),this.ds.scale>1&&(o.style.transform="scale("+this.ds.scale+")");var l=null,c=!1;LiteGraph.pointerListenerAdd(o,"leave",(function(e){c||LiteGraph.dialog_close_on_mouse_leave&&!o.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(l=setTimeout(o.close,LiteGraph.dialog_close_on_mouse_leave_delay))})),LiteGraph.pointerListenerAdd(o,"enter",(function(e){LiteGraph.dialog_close_on_mouse_leave&&l&&clearTimeout(l)}));var p=o.querySelectorAll("select");p&&p.forEach((function(e){e.addEventListener("click",(function(e){c++})),e.addEventListener("blur",(function(e){c=0})),e.addEventListener("change",(function(e){c=-1}))})),a.prompt_box&&a.prompt_box.close(),a.prompt_box=o,o.querySelector(".name").innerText=e;var h=o.querySelector(".value");h.value=t,h.select();var d=h;d.addEventListener("keydown",(function(e){if(o.is_modified=!0,27==e.keyCode)o.close();else{if(13!=e.keyCode||"textarea"==e.target.localName)return;n&&n(this.value),o.close()}e.preventDefault(),e.stopPropagation()})),o.querySelector("button").addEventListener("click",(function(e){n&&n(d.value),a.setDirty(!0),o.close()}));var u=r.getBoundingClientRect(),g=-20,f=-20;return u&&(g-=u.left,f-=u.top),i?(o.style.left=i.clientX+g+"px",o.style.top=i.clientY+f+"px"):(o.style.left=.5*r.width+g+"px",o.style.top=.5*r.height+f+"px"),setTimeout((function(){d.focus()}),10),o},LGraphCanvas.search_limit=-1,LGraphCanvas.prototype.showSearchBox=function(e,t){var n={slot_from:null,node_from:null,node_to:null,do_type_filter:LiteGraph.search_filter_enabled,type_filter_in:!1,type_filter_out:!1,show_general_if_none_on_typefilter:!0,show_general_after_typefiltered:!0,hide_on_mouse_leave:LiteGraph.search_hide_on_mouse_leave,show_all_if_empty:!0,show_all_on_open:LiteGraph.search_show_all_on_open};t=Object.assign(n,t||{});var i=this,s=LGraphCanvas.active_canvas,a=s.canvas,o=a.ownerDocument||document,r=document.createElement("div");if(r.className="litegraph litesearchbox graphdialog rounded",r.innerHTML="<span class='name'>Search</span> <input autofocus type='text' class='value rounded'/>",t.do_type_filter&&(r.innerHTML+="<select class='slot_in_type_filter'><option value=''></option></select>",r.innerHTML+="<select class='slot_out_type_filter'><option value=''></option></select>"),r.innerHTML+="<div class='helper'></div>",o.fullscreenElement?o.fullscreenElement.appendChild(r):(o.body.appendChild(r),o.body.style.overflow="hidden"),t.do_type_filter)var l=r.querySelector(".slot_in_type_filter"),c=r.querySelector(".slot_out_type_filter");if(r.close=function(){i.search_box=null,this.blur(),a.focus(),o.body.style.overflow="",setTimeout((function(){i.canvas.focus()}),20),r.parentNode&&r.parentNode.removeChild(r)},this.ds.scale>1&&(r.style.transform="scale("+this.ds.scale+")"),t.hide_on_mouse_leave){var p=!1,h=null;LiteGraph.pointerListenerAdd(r,"enter",(function(e){h&&(clearTimeout(h),h=null)})),LiteGraph.pointerListenerAdd(r,"leave",(function(e){p||(h=setTimeout((function(){r.close()}),"number"==typeof t.hide_on_mouse_leave?t.hide_on_mouse_leave:500))})),t.do_type_filter&&(l.addEventListener("click",(function(e){p++})),l.addEventListener("blur",(function(e){p=0})),l.addEventListener("change",(function(e){p=-1})),c.addEventListener("click",(function(e){p++})),c.addEventListener("blur",(function(e){p=0})),c.addEventListener("change",(function(e){p=-1})))}i.search_box&&i.search_box.close(),i.search_box=r;var d=r.querySelector(".helper"),u=null,g=null,f=null,_=r.querySelector("input");if(_&&(_.addEventListener("blur",(function(e){this.focus()})),_.addEventListener("keydown",(function(e){if(38==e.keyCode)x(!1);else if(40==e.keyCode)x(!0);else if(27==e.keyCode)r.close();else{if(13!=e.keyCode)return g&&clearInterval(g),void(g=setTimeout(C,10));f?A(unescape(f.dataset.type)):u?A(u):r.close()}return e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),!0}))),t.do_type_filter){if(l){var m=(y=LiteGraph.slot_types_in).length;t.type_filter_in!=LiteGraph.EVENT&&t.type_filter_in!=LiteGraph.ACTION||(t.type_filter_in="_event_");for(var v=0;v<m;v++){(b=document.createElement("option")).value=y[v],b.innerHTML=y[v],l.appendChild(b),!1!==t.type_filter_in&&(t.type_filter_in+"").toLowerCase()==(y[v]+"").toLowerCase()&&(b.selected=!0)}l.addEventListener("change",(function(){C()}))}if(c){var y;m=(y=LiteGraph.slot_types_out).length;t.type_filter_out!=LiteGraph.EVENT&&t.type_filter_out!=LiteGraph.ACTION||(t.type_filter_out="_event_");for(v=0;v<m;v++){var b;(b=document.createElement("option")).value=y[v],b.innerHTML=y[v],c.appendChild(b),!1!==t.type_filter_out&&(t.type_filter_out+"").toLowerCase()==(y[v]+"").toLowerCase()&&(b.selected=!0)}c.addEventListener("change",(function(){C()}))}}var w=a.getBoundingClientRect(),k=(e?e.clientX:w.left+.5*w.width)-80,L=(e?e.clientY:w.top+.5*w.height)-20;function A(n){if(n)if(i.onSearchBoxSelection)i.onSearchBoxSelection(n,e,s);else{var a=LiteGraph.searchbox_extras[n.toLowerCase()];a&&(n=a.type),s.graph.beforeChange();var o=LiteGraph.createNode(n);if(o&&(o.pos=s.convertEventToCanvasOffset(e),s.graph.add(o,!1)),a&&a.data){if(a.data.properties)for(var l in a.data.properties)o.addProperty(l,a.data.properties[l]);if(a.data.inputs)for(var l in o.inputs=[],a.data.inputs)o.addOutput(a.data.inputs[l][0],a.data.inputs[l][1]);if(a.data.outputs)for(var l in o.outputs=[],a.data.outputs)o.addOutput(a.data.outputs[l][0],a.data.outputs[l][1]);a.data.title&&(o.title=a.data.title),a.data.json&&o.configure(a.data.json)}if(t.node_from){var c=!1;switch(typeof t.slot_from){case"string":c=t.node_from.findOutputSlot(t.slot_from);break;case"object":-1==(c=t.slot_from.name?t.node_from.findOutputSlot(t.slot_from.name):-1)&&void 0!==t.slot_from.slot_index&&(c=t.slot_from.slot_index);break;case"number":c=t.slot_from;break;default:c=0}void 0!==t.node_from.outputs[c]&&!1!==c&&c>-1&&t.node_from.connectByType(c,o,t.node_from.outputs[c].type)}if(t.node_to){c=!1;switch(typeof t.slot_from){case"string":c=t.node_to.findInputSlot(t.slot_from);break;case"object":-1==(c=t.slot_from.name?t.node_to.findInputSlot(t.slot_from.name):-1)&&void 0!==t.slot_from.slot_index&&(c=t.slot_from.slot_index);break;case"number":c=t.slot_from;break;default:c=0}void 0!==t.node_to.inputs[c]&&!1!==c&&c>-1&&t.node_to.connectByTypeOutput(c,o,t.node_to.inputs[c].type)}s.graph.afterChange()}r.close()}function x(e){var t=f;f&&f.classList.remove("selected"),f?(f=e?f.nextSibling:f.previousSibling)||(f=t):f=e?d.childNodes[0]:d.childNodes[d.childNodes.length],f&&(f.classList.add("selected"),f.scrollIntoView({block:"end",behavior:"smooth"}))}function C(){g=null;var e=_.value;if(u=null,d.innerHTML="",e||t.show_all_if_empty)if(i.onSearchBox){var n=i.onSearchBox(d,e,s);if(n)for(var a=0;a<n.length;++a)m(n[a])}else{var o=0;e=e.toLowerCase();var r=s.filter||s.graph.filter;if(t.do_type_filter&&i.search_box)var l=i.search_box.querySelector(".slot_in_type_filter"),c=i.search_box.querySelector(".slot_out_type_filter");else l=!1,c=!1;for(var a in LiteGraph.searchbox_extras){var p=LiteGraph.searchbox_extras[a];if(t.show_all_if_empty&&!e||-1!==p.desc.toLowerCase().indexOf(e)){var h=LiteGraph.registered_node_types[p.type];if((!h||h.filter==r)&&v(p.type)&&(m(p.desc,"searchbox_extra"),-1!==LGraphCanvas.search_limit&&o++>LGraphCanvas.search_limit))break}}var f=null;if(Array.prototype.filter)f=Object.keys(LiteGraph.registered_node_types).filter(v);else for(var a in f=[],LiteGraph.registered_node_types)v(a)&&f.push(a);for(a=0;a<f.length&&(m(f[a]),!(-1!==LGraphCanvas.search_limit&&o++>LGraphCanvas.search_limit));a++);if(t.show_general_after_typefiltered&&(l.value||c.value)){for(var a in filtered_extra=[],LiteGraph.registered_node_types)v(a,{inTypeOverride:!(!l||!l.value)&&"*",outTypeOverride:!(!c||!c.value)&&"*"})&&filtered_extra.push(a);for(a=0;a<filtered_extra.length&&(m(filtered_extra[a],"generic_type"),!(-1!==LGraphCanvas.search_limit&&o++>LGraphCanvas.search_limit));a++);}if((l.value||c.value)&&0==d.childNodes.length&&t.show_general_if_none_on_typefilter){for(var a in filtered_extra=[],LiteGraph.registered_node_types)v(a,{skipFilter:!0})&&filtered_extra.push(a);for(a=0;a<filtered_extra.length&&(m(filtered_extra[a],"not_in_filter"),!(-1!==LGraphCanvas.search_limit&&o++>LGraphCanvas.search_limit));a++);}function v(n,i){i=i||{};var s=Object.assign({skipFilter:!1,inTypeOverride:!1,outTypeOverride:!1},i),a=LiteGraph.registered_node_types[n];if(r&&a.filter!=r)return!1;if((!t.show_all_if_empty||e)&&-1===n.toLowerCase().indexOf(e)&&(!a.title||-1===a.title.toLowerCase().indexOf(e)))return!1;if(t.do_type_filter&&!s.skipFilter){var o=n,p=l.value;if(!1!==s.inTypeOverride&&(p=s.inTypeOverride),l&&p)if(LiteGraph.registered_slot_in_types[p]&&LiteGraph.registered_slot_in_types[p].nodes)if(!1===LiteGraph.registered_slot_in_types[p].nodes.includes(o))return!1;p=c.value;if(!1!==s.outTypeOverride&&(p=s.outTypeOverride),c&&p)if(LiteGraph.registered_slot_out_types[p]&&LiteGraph.registered_slot_out_types[p].nodes)if(!1===LiteGraph.registered_slot_out_types[p].nodes.includes(o))return!1}return!0}}function m(e,t){var n=document.createElement("div");u||(u=e);const i=LiteGraph.registered_node_types[e];if(i?.title){n.innerText=i?.title;const t=document.createElement("span");t.className="litegraph lite-search-item-type",t.textContent=e,n.append(t)}else n.innerText=e;n.dataset.type=escape(e),n.className="litegraph lite-search-item",t&&(n.className+=" "+t),n.addEventListener("click",(function(e){A(unescape(this.dataset.type))})),d.appendChild(n)}}return r.style.left=k+"px",r.style.top=L+"px",e.layerY>w.height-200&&(d.style.maxHeight=w.height-e.layerY-20+"px"),_.focus(),t.show_all_on_open&&C(),r},LGraphCanvas.prototype.showEditPropertyValue=function(e,t,n){if(e&&void 0!==e.properties[t]){n=n||{};var i=e.getPropertyInfo(t),s=i.type,a="";if("string"==s||"number"==s||"array"==s||"object"==s)a="<input autofocus type='text' class='value'/>";else if("enum"!=s&&"combo"!=s||!i.values){if("boolean"!=s&&"toggle"!=s)return;a="<input autofocus type='checkbox' class='value' "+(e.properties[t]?"checked":"")+"/>"}else{for(var o in a="<select autofocus type='text' class='value'>",i.values){var r=o;i.values.constructor===Array&&(r=i.values[o]),a+="<option value='"+r+"' "+(r==e.properties[t]?"selected":"")+">"+i.values[o]+"</option>"}a+="</select>"}var l=this.createDialog("<span class='name'>"+(i.label?i.label:t)+"</span>"+a+"<button>OK</button>",n),c=!1;if("enum"!=s&&"combo"!=s||!i.values){if("boolean"==s||"toggle"==s)(c=l.querySelector("input"))&&c.addEventListener("click",(function(e){l.modified(),h(!!c.checked)}));else if(c=l.querySelector("input")){c.addEventListener("blur",(function(e){this.focus()}));r=void 0!==e.properties[t]?e.properties[t]:"";"string"!==s&&(r=JSON.stringify(r)),c.value=r,c.addEventListener("keydown",(function(e){if(27==e.keyCode)l.close();else if(13==e.keyCode)p();else if(13!=e.keyCode)return void l.modified();e.preventDefault(),e.stopPropagation()}))}}else(c=l.querySelector("select")).addEventListener("change",(function(e){l.modified(),h(e.target.value)}));return c&&c.focus(),l.querySelector("button").addEventListener("click",p),l}function p(){h(c.value)}function h(a){i&&i.values&&i.values.constructor===Object&&null!=i.values[a]&&(a=i.values[a]),"number"==typeof e.properties[t]&&(a=Number(a)),"array"!=s&&"object"!=s||(a=JSON.parse(a)),e.properties[t]=a,e.graph&&e.graph._version++,e.onPropertyChanged&&e.onPropertyChanged(t,a),n.onclose&&n.onclose(),l.close(),e.setDirtyCanvas(!0,!0)}},LGraphCanvas.prototype.createDialog=function(e,t){t=Object.assign({checkForInput:!1,closeOnLeave:!0,closeOnLeave_checkModified:!0},t||{});var n=document.createElement("div");n.className="graphdialog",n.innerHTML=e,n.is_modified=!1;var i=this.canvas.getBoundingClientRect(),s=-20,a=-20;if(i&&(s-=i.left,a-=i.top),t.position?(s+=t.position[0],a+=t.position[1]):t.event?(s+=t.event.clientX,a+=t.event.clientY):(s+=.5*this.canvas.width,a+=.5*this.canvas.height),n.style.left=s+"px",n.style.top=a+"px",this.canvas.parentNode.appendChild(n),t.checkForInput){var o=[];(o=n.querySelectorAll("input"))&&o.forEach((function(e){e.addEventListener("keydown",(function(e){if(n.modified(),27==e.keyCode)n.close();else if(13!=e.keyCode)return;e.preventDefault(),e.stopPropagation()})),e.focus()}))}n.modified=function(){n.is_modified=!0},n.close=function(){n.parentNode&&n.parentNode.removeChild(n)};var r=null,l=!1;n.addEventListener("mouseleave",(function(e){l||(t.closeOnLeave||LiteGraph.dialog_close_on_mouse_leave)&&!n.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(r=setTimeout(n.close,LiteGraph.dialog_close_on_mouse_leave_delay))})),n.addEventListener("mouseenter",(function(e){(t.closeOnLeave||LiteGraph.dialog_close_on_mouse_leave)&&r&&clearTimeout(r)}));var c=n.querySelectorAll("select");return c&&c.forEach((function(e){e.addEventListener("click",(function(e){l++})),e.addEventListener("blur",(function(e){l=0})),e.addEventListener("change",(function(e){l=-1}))})),n},LGraphCanvas.prototype.createPanel=function(e,t){var n=(t=t||{}).window||window,i=document.createElement("div");if(i.className="litegraph dialog",i.innerHTML="<div class='dialog-header'><span class='dialog-title'></span></div><div class='dialog-content'></div><div style='display:none;' class='dialog-alt-content'></div><div class='dialog-footer'></div>",i.header=i.querySelector(".dialog-header"),t.width&&(i.style.width=t.width+(t.width.constructor===Number?"px":"")),t.height&&(i.style.height=t.height+(t.height.constructor===Number?"px":"")),t.closable){var s=document.createElement("span");s.innerHTML="&#10005;",s.classList.add("close"),s.addEventListener("click",(function(){i.close()})),i.header.appendChild(s)}return i.title_element=i.querySelector(".dialog-title"),i.title_element.innerText=e,i.content=i.querySelector(".dialog-content"),i.alt_content=i.querySelector(".dialog-alt-content"),i.footer=i.querySelector(".dialog-footer"),i.close=function(){i.onClose&&"function"==typeof i.onClose&&i.onClose(),i.parentNode&&i.parentNode.removeChild(i),this.parentNode&&this.parentNode.removeChild(this)},i.toggleAltContent=function(e){if(void 0!==e)var t=e?"block":"none",n=e?"none":"block";else t="block"!=i.alt_content.style.display?"block":"none",n="block"!=i.alt_content.style.display?"none":"block";i.alt_content.style.display=t,i.content.style.display=n},i.toggleFooterVisibility=function(e){if(void 0!==e)var t=e?"block":"none";else t="block"!=i.footer.style.display?"block":"none";i.footer.style.display=t},i.clear=function(){this.content.innerHTML=""},i.addHTML=function(e,t,n){var s=document.createElement("div");return t&&(s.className=t),s.innerHTML=e,n?i.footer.appendChild(s):i.content.appendChild(s),s},i.addButton=function(e,t,n){var s=document.createElement("button");return s.innerText=e,s.options=n,s.classList.add("btn"),s.addEventListener("click",t),i.footer.appendChild(s),s},i.addSeparator=function(){var e=document.createElement("div");e.className="separator",i.content.appendChild(e)},i.addWidget=function(e,t,s,a,o){a=a||{};var r=String(s);"number"==(e=e.toLowerCase())&&(r=s.toFixed(3));var l=document.createElement("div");l.className="property",l.innerHTML="<span class='property_name'></span><span class='property_value'></span>",l.querySelector(".property_name").innerText=a.label||t;var c=l.querySelector(".property_value");if(c.innerText=r,l.dataset.property=t,l.dataset.type=a.type||e,l.options=a,l.value=s,"code"==e)l.addEventListener("click",(function(e){i.inner_showCodePad(this.dataset.property)}));else if("boolean"==e)l.classList.add("boolean"),s&&l.classList.add("bool-on"),l.addEventListener("click",(function(){var e=this.dataset.property;this.value=!this.value,this.classList.toggle("bool-on"),this.querySelector(".property_value").innerText=this.value?"true":"false",p(e,this.value)}));else if("string"==e||"number"==e)c.setAttribute("contenteditable",!0),c.addEventListener("keydown",(function(t){"Enter"!=t.code||"string"==e&&t.shiftKey||(t.preventDefault(),this.blur())})),c.addEventListener("blur",(function(){var e=this.innerText,t=this.parentNode.dataset.property;"number"==this.parentNode.dataset.type&&(e=Number(e)),p(t,e)}));else if("enum"==e||"combo"==e){r=LGraphCanvas.getPropertyPrintableValue(s,a.values);c.innerText=r,c.addEventListener("click",(function(e){var t=a.values||[],i=this.parentNode.dataset.property,s=this;new LiteGraph.ContextMenu(t,{event:e,className:"dark",callback:function(e,t,n){return s.innerText=e,p(i,e),!1}},n)}))}function p(e,t){a.callback&&a.callback(e,t,a),o&&o(e,t,a)}return i.content.appendChild(l),l},i.onOpen&&"function"==typeof i.onOpen&&i.onOpen(),i},LGraphCanvas.getPropertyPrintableValue=function(e,t){if(!t)return String(e);if(t.constructor===Array)return String(e);if(t.constructor===Object){var n="";for(var i in t)if(t[i]==e){n=i;break}return String(e)+" ("+n+")"}},LGraphCanvas.prototype.closePanels=function(){var e;(e=document.querySelector("#node-panel"))&&e.close(),(e=document.querySelector("#option-panel"))&&e.close()},LGraphCanvas.prototype.showShowGraphOptionsPanel=function(e,t,n,i){if(this.constructor&&"HTMLDivElement"==this.constructor.name){if(!(t&&t.event&&t.event.target&&t.event.target.lgraphcanvas))return;var s=t.event.target.lgraphcanvas}else s=this;s.closePanels();var a=s.getCanvasWindow();panel=s.createPanel("Options",{closable:!0,window:a,onOpen:function(){s.OPTIONPANEL_IS_OPEN=!0},onClose:function(){s.OPTIONPANEL_IS_OPEN=!1,s.options_panel=null}}),s.options_panel=panel,panel.id="option-panel",panel.classList.add("settings"),function(){panel.content.innerHTML="";var e=function(e,t,n){n&&n.key&&(e=n.key),n.values&&(t=Object.values(n.values).indexOf(t)),s[e]=t},t=LiteGraph.availableCanvasOptions;for(var n in t.sort(),t){var i=t[n];panel.addWidget("boolean",i,s[i],{key:i,on:"True",off:"False"},e)}s.links_render_mode,panel.addWidget("combo","Render mode",LiteGraph.LINK_RENDER_MODES[s.links_render_mode],{key:"links_render_mode",values:LiteGraph.LINK_RENDER_MODES},e),panel.addSeparator(),panel.footer.innerHTML=""}(),s.canvas.parentNode.appendChild(panel)},LGraphCanvas.prototype.showShowNodePanel=function(e){this.SELECTED_NODE=e,this.closePanels();var t=this.getCanvasWindow(),n=this,i=this.createPanel(e.title||"",{closable:!0,window:t,onOpen:function(){n.NODEPANEL_IS_OPEN=!0},onClose:function(){n.NODEPANEL_IS_OPEN=!1,n.node_panel=null}});function s(){i.content.innerHTML="",i.addHTML("<span class='node_type'>"+e.type+"</span><span class='node_desc'>"+(e.constructor.desc||"")+"</span><span class='separator'></span>"),i.addHTML("<h3>Properties</h3>");var t=function(t,i){switch(n.graph.beforeChange(e),t){case"Title":e.title=i;break;case"Mode":var s=Object.values(LiteGraph.NODE_MODES).indexOf(i);s>=0&&LiteGraph.NODE_MODES[s]&&e.changeMode(s);break;case"Color":LGraphCanvas.node_colors[i]&&(e.color=LGraphCanvas.node_colors[i].color,e.bgcolor=LGraphCanvas.node_colors[i].bgcolor);break;default:e.setProperty(t,i)}n.graph.afterChange(),n.dirty_canvas=!0};i.addWidget("string","Title",e.title,{},t),i.addWidget("combo","Mode",LiteGraph.NODE_MODES[e.mode],{values:LiteGraph.NODE_MODES},t);var s="";for(var a in void 0!==e.color&&(s=Object.keys(LGraphCanvas.node_colors).filter((function(t){return LGraphCanvas.node_colors[t].color==e.color}))),i.addWidget("combo","Color",s,{values:Object.keys(LGraphCanvas.node_colors)},t),e.properties){var o=e.properties[a],r=e.getPropertyInfo(a);r.type,e.onAddPropertyToPanel&&e.onAddPropertyToPanel(a,i)||i.addWidget(r.widget||r.type,a,o,r,t)}i.addSeparator(),e.onShowCustomPanelInfo&&e.onShowCustomPanelInfo(i),i.footer.innerHTML="",i.addButton("Delete",(function(){e.block_delete||(e.graph.remove(e),i.close())})).classList.add("delete")}n.node_panel=i,i.id="node-panel",i.node=e,i.classList.add("settings"),i.inner_showCodePad=function(t){i.classList.remove("settings"),i.classList.add("centered"),i.alt_content.innerHTML="<textarea class='code'></textarea>";var n=i.alt_content.querySelector("textarea"),a=function(){i.toggleAltContent(!1),i.toggleFooterVisibility(!0),n.parentNode.removeChild(n),i.classList.add("settings"),i.classList.remove("centered"),s()};n.value=e.properties[t],n.addEventListener("keydown",(function(i){"Enter"==i.code&&i.ctrlKey&&(e.setProperty(t,n.value),a())})),i.toggleAltContent(!0),i.toggleFooterVisibility(!1),n.style.height="calc(100% - 40px)";var o=i.addButton("Assign",(function(){e.setProperty(t,n.value),a()}));i.alt_content.appendChild(o);var r=i.addButton("Close",a);r.style.float="right",i.alt_content.appendChild(r)},s(),this.canvas.parentNode.appendChild(i)},LGraphCanvas.prototype.showSubgraphPropertiesDialog=function(e){var t=this.canvas.parentNode.querySelector(".subgraph_dialog");t&&t.close();var n=this.createPanel("Subgraph Inputs",{closable:!0,width:500});function i(){if(n.clear(),e.inputs)for(var t=0;t<e.inputs.length;++t){var s=e.inputs[t];if(!s.not_subgraph_input){var a=n.addHTML("<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>","subgraph_property");a.dataset.name=s.name,a.dataset.slot=t,a.querySelector(".name").innerText=s.name,a.querySelector(".type").innerText=s.type,a.querySelector("button").addEventListener("click",(function(t){e.removeInput(Number(this.parentNode.dataset.slot)),i()}))}}}n.node=e,n.classList.add("subgraph_dialog");return n.addHTML(" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>","subgraph_property extra",!0).querySelector("button").addEventListener("click",(function(t){var n=this.parentNode,s=n.querySelector(".name").value,a=n.querySelector(".type").value;s&&-1==e.findInputSlot(s)&&(e.addInput(s,a),n.querySelector(".name").value="",n.querySelector(".type").value="",i())})),i(),this.canvas.parentNode.appendChild(n),n},LGraphCanvas.prototype.showSubgraphPropertiesDialogRight=function(e){var t=this.canvas.parentNode.querySelector(".subgraph_dialog");t&&t.close();var n=this.createPanel("Subgraph Outputs",{closable:!0,width:500});function i(){if(n.clear(),e.outputs)for(var t=0;t<e.outputs.length;++t){var s=e.outputs[t];if(!s.not_subgraph_output){var a=n.addHTML("<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>","subgraph_property");a.dataset.name=s.name,a.dataset.slot=t,a.querySelector(".name").innerText=s.name,a.querySelector(".type").innerText=s.type,a.querySelector("button").addEventListener("click",(function(t){e.removeOutput(Number(this.parentNode.dataset.slot)),i()}))}}}n.node=e,n.classList.add("subgraph_dialog");var s=n.addHTML(" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>","subgraph_property extra",!0);function a(){var t=this.parentNode,n=t.querySelector(".name").value,s=t.querySelector(".type").value;n&&-1==e.findOutputSlot(n)&&(e.addOutput(n,s),t.querySelector(".name").value="",t.querySelector(".type").value="",i())}return s.querySelector(".name").addEventListener("keydown",(function(e){13==e.keyCode&&a.apply(this)})),s.querySelector("button").addEventListener("click",(function(e){a.apply(this)})),i(),this.canvas.parentNode.appendChild(n),n},LGraphCanvas.prototype.checkPanels=function(){if(this.canvas)for(var e=this.canvas.parentNode.querySelectorAll(".litegraph.dialog"),t=0;t<e.length;++t){var n=e[t];n.node&&(n.node.graph&&n.graph==this.graph||n.close())}},LGraphCanvas.onMenuNodeCollapse=function(e,t,n,i,s){s.graph.beforeChange();var a=function(e){e.collapse()},o=LGraphCanvas.active_canvas;if(!o.selected_nodes||Object.keys(o.selected_nodes).length<=1)a(s);else for(var r in o.selected_nodes)a(o.selected_nodes[r]);s.graph.afterChange()},LGraphCanvas.onMenuNodePin=function(e,t,n,i,s){s.pin()},LGraphCanvas.onMenuNodeMode=function(e,t,n,i,s){return new LiteGraph.ContextMenu(LiteGraph.NODE_MODES,{event:n,callback:function(e){if(!s)return;var t=Object.values(LiteGraph.NODE_MODES).indexOf(e),n=function(e){t>=0&&LiteGraph.NODE_MODES[t]?e.changeMode(t):e.changeMode(LiteGraph.ALWAYS)},i=LGraphCanvas.active_canvas;if(!i.selected_nodes||Object.keys(i.selected_nodes).length<=1)n(s);else for(var a in i.selected_nodes)n(i.selected_nodes[a])},parentMenu:i,node:s}),!1},LGraphCanvas.onMenuNodeColors=function(e,t,n,i,s){if(!s)throw"no node for color";var a=[];for(var o in a.push({value:null,content:"<span style='display: block; padding-left: 4px;'>No color</span>"}),LGraphCanvas.node_colors){var r=LGraphCanvas.node_colors[o];e={value:o,content:"<span style='display: block; color: #999; padding-left: 4px; border-left: 8px solid "+r.color+"; background-color:"+r.bgcolor+"'>"+o+"</span>"};a.push(e)}return new LiteGraph.ContextMenu(a,{event:n,callback:function(e){if(!s)return;var t=e.value?LGraphCanvas.node_colors[e.value]:null,n=function(e){t?e.constructor===LiteGraph.LGraphGroup?e.color=t.groupcolor:(e.color=t.color,e.bgcolor=t.bgcolor):(delete e.color,delete e.bgcolor)},i=LGraphCanvas.active_canvas;if(!i.selected_nodes||Object.keys(i.selected_nodes).length<=1)n(s);else for(var a in i.selected_nodes)n(i.selected_nodes[a]);s.setDirtyCanvas(!0,!0)},parentMenu:i,node:s}),!1},LGraphCanvas.onMenuNodeShapes=function(e,t,n,i,s){if(!s)throw"no node passed";return new LiteGraph.ContextMenu(LiteGraph.VALID_SHAPES,{event:n,callback:function(e){if(!s)return;s.graph.beforeChange();var t=function(t){t.shape=e},n=LGraphCanvas.active_canvas;if(!n.selected_nodes||Object.keys(n.selected_nodes).length<=1)t(s);else for(var i in n.selected_nodes)t(n.selected_nodes[i]);s.graph.afterChange(),s.setDirtyCanvas(!0)},parentMenu:i,node:s}),!1},LGraphCanvas.onMenuNodeRemove=function(e,t,n,i,s){if(!s)throw"no node passed";var a=s.graph;a.beforeChange();var o=function(e){!1!==e.removable&&a.remove(e)},r=LGraphCanvas.active_canvas;if(!r.selected_nodes||Object.keys(r.selected_nodes).length<=1)o(s);else for(var l in r.selected_nodes)o(r.selected_nodes[l]);a.afterChange(),s.setDirtyCanvas(!0,!0)},LGraphCanvas.onMenuNodeToSubgraph=function(e,t,n,i,s){var a=s.graph,o=LGraphCanvas.active_canvas;if(o){var r=Object.values(o.selected_nodes||{});r.length||(r=[s]);var l=LiteGraph.createNode("graph/subgraph");l.pos=s.pos.concat(),a.add(l),l.buildFromNodes(r),o.deselectAllNodes(),s.setDirtyCanvas(!0,!0)}},LGraphCanvas.onMenuNodeClone=function(e,t,n,i,s){s.graph.beforeChange();var a={},o=function(e){if(!1!==e.clonable){var t=e.clone();t&&(t.pos=[e.pos[0]+5,e.pos[1]+5],e.graph.add(t),a[t.id]=t)}},r=LGraphCanvas.active_canvas;if(!r.selected_nodes||Object.keys(r.selected_nodes).length<=1)o(s);else for(var l in r.selected_nodes)o(r.selected_nodes[l]);Object.keys(a).length&&r.selectNodes(a),s.graph.afterChange(),s.setDirtyCanvas(!0,!0)},LGraphCanvas.node_colors={red:{color:"#322",bgcolor:"#533",groupcolor:"#A88"},brown:{color:"#332922",bgcolor:"#593930",groupcolor:"#b06634"},green:{color:"#232",bgcolor:"#353",groupcolor:"#8A8"},blue:{color:"#223",bgcolor:"#335",groupcolor:"#88A"},pale_blue:{color:"#2a363b",bgcolor:"#3f5159",groupcolor:"#3f789e"},cyan:{color:"#233",bgcolor:"#355",groupcolor:"#8AA"},purple:{color:"#323",bgcolor:"#535",groupcolor:"#a1309b"},yellow:{color:"#432",bgcolor:"#653",groupcolor:"#b58b2a"},black:{color:"#222",bgcolor:"#000",groupcolor:"#444"}},LGraphCanvas.prototype.getCanvasMenuOptions=function(){var e=null;if(this.getMenuOptions?e=this.getMenuOptions():(e=[{content:"Add Node",has_submenu:!0,callback:LGraphCanvas.onMenuAdd},{content:"Add Group",callback:LGraphCanvas.onGroupAdd}],Object.keys(this.selected_nodes).length>1&&e.push({content:"Align",has_submenu:!0,callback:LGraphCanvas.onGroupAlign}),this._graph_stack&&this._graph_stack.length>0&&e.push(null,{content:"Close subgraph",callback:this.closeSubgraph.bind(this)})),this.getExtraMenuOptions){var t=this.getExtraMenuOptions(this,e);t&&(e=e.concat(t))}return e},LGraphCanvas.prototype.getNodeMenuOptions=function(e){var t=null;if(e.getMenuOptions?t=e.getMenuOptions(this):(t=[{content:"Inputs",has_submenu:!0,disabled:!0,callback:LGraphCanvas.showMenuNodeOptionalInputs},{content:"Outputs",has_submenu:!0,disabled:!0,callback:LGraphCanvas.showMenuNodeOptionalOutputs},null,{content:"Properties",has_submenu:!0,callback:LGraphCanvas.onShowMenuNodeProperties},{content:"Properties Panel",callback:function(e,t,n,i,s){LGraphCanvas.active_canvas.showShowNodePanel(s)}},null,{content:"Title",callback:LGraphCanvas.onShowPropertyEditor},{content:"Mode",has_submenu:!0,callback:LGraphCanvas.onMenuNodeMode}],!1!==e.resizable&&t.push({content:"Resize",callback:LGraphCanvas.onMenuResizeNode}),t.push({content:"Collapse",callback:LGraphCanvas.onMenuNodeCollapse},{content:"Pin",callback:LGraphCanvas.onMenuNodePin},{content:"Colors",has_submenu:!0,callback:LGraphCanvas.onMenuNodeColors},{content:"Shapes",has_submenu:!0,callback:LGraphCanvas.onMenuNodeShapes},null)),e.onGetInputs){var n=e.onGetInputs();n&&n.length&&(t[0].disabled=!1)}if(e.onGetOutputs){var i=e.onGetOutputs();i&&i.length&&(t[1].disabled=!1)}if(e.getExtraMenuOptions){var s=e.getExtraMenuOptions(this,t);s&&(s.push(null),t=s.concat(t))}return!1!==e.clonable&&t.push({content:"Clone",callback:LGraphCanvas.onMenuNodeClone}),Object.keys(this.selected_nodes).length>1&&t.push({content:"Align Selected To",has_submenu:!0,callback:LGraphCanvas.onNodeAlign}),t.push(null,{content:"Remove",disabled:!(!1!==e.removable&&!e.block_delete),callback:LGraphCanvas.onMenuNodeRemove}),e.graph&&e.graph.onGetNodeMenuOptions&&e.graph.onGetNodeMenuOptions(t,e),t},LGraphCanvas.prototype.getGroupMenuOptions=function(e){return[{content:"Title",callback:LGraphCanvas.onShowPropertyEditor},{content:"Color",has_submenu:!0,callback:LGraphCanvas.onMenuNodeColors},{content:"Font size",property:"font_size",type:"Number",callback:LGraphCanvas.onShowPropertyEditor},null,{content:"Remove",callback:LGraphCanvas.onMenuNodeRemove}]},LGraphCanvas.prototype.processContextMenu=function(e,t){var n=this,i=LGraphCanvas.active_canvas.getCanvasWindow(),s=null,a={event:t,callback:function(t,i,s){if(!t)return;if("Remove Slot"==t.content){var a=t.slot;return e.graph.beforeChange(),a.input?e.removeInput(a.slot):a.output&&e.removeOutput(a.slot),void e.graph.afterChange()}if("Disconnect Links"==t.content){a=t.slot;return e.graph.beforeChange(),a.output?e.disconnectOutput(a.slot):a.input&&e.disconnectInput(a.slot),void e.graph.afterChange()}if("Rename Slot"==t.content){var o=(a=t.slot).input?e.getInputInfo(a.slot):e.getOutputInfo(a.slot),r=n.createDialog("<span class='name'>Name</span><input autofocus type='text'/><button>OK</button>",i),l=r.querySelector("input");l&&o&&(l.value=o.label||"");var c=function(){e.graph.beforeChange(),l.value&&(o&&(o.label=l.value),n.setDirty(!0)),r.close(),e.graph.afterChange()};r.querySelector("button").addEventListener("click",c),l.addEventListener("keydown",(function(e){if(r.is_modified=!0,27==e.keyCode)r.close();else if(13==e.keyCode)c();else if(13!=e.keyCode&&"textarea"!=e.target.localName)return;e.preventDefault(),e.stopPropagation()})),l.focus()}},extra:e};e&&(a.title=e.type);var o=null;if(e&&(o=e.getSlotInPosition(t.canvasX,t.canvasY),LGraphCanvas.active_node=e),o){if(s=[],e.getSlotMenuOptions)s=e.getSlotMenuOptions(o);else{o&&o.output&&o.output.links&&o.output.links.length&&s.push({content:"Disconnect Links",slot:o});var r=o.input||o.output;r.removable&&s.push(r.locked?"Cannot remove":{content:"Remove Slot",slot:o}),r.nameLocked||s.push({content:"Rename Slot",slot:o})}a.title=(o.input?o.input.type:o.output.type)||"*",o.input&&o.input.type==LiteGraph.ACTION&&(a.title="Action"),o.output&&o.output.type==LiteGraph.EVENT&&(a.title="Event")}else if(e)s=this.getNodeMenuOptions(e);else{s=this.getCanvasMenuOptions();var l=this.graph.getGroupOnPos(t.canvasX,t.canvasY);l&&s.push(null,{content:"Edit Group",has_submenu:!0,submenu:{title:"Group",extra:l,options:this.getGroupMenuOptions(l)}})}s&&new LiteGraph.ContextMenu(s,a,i)},"undefined"!=typeof window&&window.CanvasRenderingContext2D&&!window.CanvasRenderingContext2D.prototype.roundRect&&(window.CanvasRenderingContext2D.prototype.roundRect=function(e,t,n,i,s,a){var o=0,r=0,l=0,c=0;if(0!==s){if(void 0===a&&(a=s),null!=s&&s.constructor===Array)if(1==s.length)o=r=l=c=s[0];else if(2==s.length)o=c=s[0],r=l=s[1];else{if(4!=s.length)return;o=s[0],r=s[1],l=s[2],c=s[3]}else o=s||0,r=s||0,l=a||0,c=a||0;this.moveTo(e+o,t),this.lineTo(e+n-r,t),this.quadraticCurveTo(e+n,t,e+n,t+r),this.lineTo(e+n,t+i-c),this.quadraticCurveTo(e+n,t+i,e+n-c,t+i),this.lineTo(e+c,t+i),this.quadraticCurveTo(e,t+i,e,t+i-l),this.lineTo(e,t+l),this.quadraticCurveTo(e,t,e+o,t)}else this.rect(e,t,n,i)}),LiteGraph.compareObjects=compareObjects,LiteGraph.distance=distance,LiteGraph.colorToString=colorToString,LiteGraph.isInsideRectangle=isInsideRectangle,LiteGraph.growBounding=growBounding,LiteGraph.isInsideBounding=isInsideBounding,LiteGraph.overlapBounding=overlapBounding,LiteGraph.hex2num=hex2num,LiteGraph.num2hex=num2hex,ContextMenu.prototype.addItem=function(e,t,n){var i=this;n=n||{};var s=document.createElement("div");s.className="litemenu-entry submenu";var a=!1;function o(e){var t=this.value,s=!0;(i.current_submenu&&i.current_submenu.close(e),n.callback)&&(!0===n.callback.call(this,t,n,e,i,n.node)&&(s=!1));if(t){if(t.callback&&!n.ignore_item_callbacks&&!0!==t.disabled)!0===t.callback.call(this,t,n,e,i,n.extra)&&(s=!1);if(t.submenu){if(!t.submenu.options)throw"ContextMenu submenu needs options";new i.constructor(t.submenu.options,{callback:t.submenu.callback,event:e,parentMenu:i,ignore_item_callbacks:t.submenu.ignore_item_callbacks,title:t.submenu.title,extra:t.submenu.extra,autoopen:n.autoopen}),s=!1}}s&&!i.lock&&i.close()}return null===t?s.classList.add("separator"):(s.innerHTML=t&&t.title?t.title:e,s.value=t,t&&(t.disabled&&(a=!0,s.classList.add("disabled")),(t.submenu||t.has_submenu)&&s.classList.add("has_submenu")),"function"==typeof t?(s.dataset.value=e,s.onclick_callback=t):s.dataset.value=t,t.className&&(s.className+=" "+t.className)),this.root.appendChild(s),a||s.addEventListener("click",o),!a&&n.autoopen&&LiteGraph.pointerListenerAdd(s,"enter",(function(e){var t=this.value;if(!t||!t.has_submenu)return;o.call(this,e)})),s},ContextMenu.prototype.close=function(e,t){this.root.parentNode&&this.root.parentNode.removeChild(this.root),this.parentMenu&&!t&&(this.parentMenu.lock=!1,this.parentMenu.current_submenu=null,void 0===e?this.parentMenu.close():e&&!ContextMenu.isCursorOverElement(e,this.parentMenu.root)&&ContextMenu.trigger(this.parentMenu.root,LiteGraph.pointerevents_method+"leave",e)),this.current_submenu&&this.current_submenu.close(e,!0),this.root.closing_timer&&clearTimeout(this.root.closing_timer)},ContextMenu.trigger=function(e,t,n,i){var s=document.createEvent("CustomEvent");return s.initCustomEvent(t,!0,!0,n),s.srcElement=i,e.dispatchEvent?e.dispatchEvent(s):e.__events&&e.__events.dispatchEvent(s),s},ContextMenu.prototype.getTopMenu=function(){return this.options.parentMenu?this.options.parentMenu.getTopMenu():this},ContextMenu.prototype.getFirstEvent=function(){return this.options.parentMenu?this.options.parentMenu.getFirstEvent():this.options.event},ContextMenu.isCursorOverElement=function(e,t){var n=e.clientX,i=e.clientY,s=t.getBoundingClientRect();return!!s&&(i>s.top&&i<s.top+s.height&&n>s.left&&n<s.left+s.width)},LiteGraph.ContextMenu=ContextMenu,LiteGraph.closeAllContextMenus=function(e){var t=(e=e||window).document.querySelectorAll(".litecontextmenu");if(t.length){for(var n=[],i=0;i<t.length;i++)n.push(t[i]);for(i=0;i<n.length;i++)n[i].close?n[i].close():n[i].parentNode&&n[i].parentNode.removeChild(n[i])}},LiteGraph.extendClass=function(e,t){for(var n in t)e.hasOwnProperty(n)||(e[n]=t[n]);if(t.prototype)for(var n in t.prototype)t.prototype.hasOwnProperty(n)&&(e.prototype.hasOwnProperty(n)||(t.prototype.__lookupGetter__(n)?e.prototype.__defineGetter__(n,t.prototype.__lookupGetter__(n)):e.prototype[n]=t.prototype[n],t.prototype.__lookupSetter__(n)&&e.prototype.__defineSetter__(n,t.prototype.__lookupSetter__(n))))},CurveEditor.sampleCurve=function(e,t){if(t){for(var n=0;n<t.length-1;++n){var i=t[n],s=t[n+1];if(!(s[0]<e)){var a=s[0]-i[0];if(Math.abs(a)<1e-5)return i[1];var o=(e-i[0])/a;return i[1]*(1-o)+s[1]*o}}return 0}},CurveEditor.prototype.draw=function(e,t,n,i,s,a){var o=this.points;if(o){this.size=t;var r=t[0]-2*this.margin,l=t[1]-2*this.margin;s=s||"#666",e.save(),e.translate(this.margin,this.margin),i&&(e.fillStyle="#111",e.fillRect(0,0,r,l),e.fillStyle="#222",e.fillRect(.5*r,0,1,l),e.strokeStyle="#333",e.strokeRect(0,0,r,l)),e.strokeStyle=s,a&&(e.globalAlpha=.5),e.beginPath();for(var c=0;c<o.length;++c){var p=o[c];e.lineTo(p[0]*r,(1-p[1])*l)}if(e.stroke(),e.globalAlpha=1,!a)for(c=0;c<o.length;++c){p=o[c];e.fillStyle=this.selected==c?"#FFF":this.nearest==c?"#DDD":"#AAA",e.beginPath(),e.arc(p[0]*r,(1-p[1])*l,2,0,2*Math.PI),e.fill()}e.restore()}},CurveEditor.prototype.onMouseDown=function(e,t){var n=this.points;if(n&&!(e[1]<0)){var i=this.size[0]-2*this.margin,s=this.size[1]-2*this.margin,a=e[0]-this.margin,o=e[1]-this.margin,r=[a,o],l=30/t.ds.scale;if(this.selected=this.getCloserPoint(r,l),-1==this.selected){var c=[a/i,1-o/s];n.push(c),n.sort((function(e,t){return e[0]-t[0]})),this.selected=n.indexOf(c),this.must_update=!0}return-1!=this.selected||void 0}},CurveEditor.prototype.onMouseMove=function(e,t){var n=this.points;if(n){var i=this.selected;if(!(i<0)){var s=(e[0]-this.margin)/(this.size[0]-2*this.margin),a=(e[1]-this.margin)/(this.size[1]-2*this.margin),o=[e[0]-this.margin,e[1]-this.margin],r=30/t.ds.scale;this._nearest=this.getCloserPoint(o,r);var l=n[i];if(l){var c=0==i||i==n.length-1;if(!c&&(e[0]<-10||e[0]>this.size[0]+10||e[1]<-10||e[1]>this.size[1]+10))return n.splice(i,1),void(this.selected=-1);l[0]=c?0==i?0:1:clamp(s,0,1),l[1]=1-clamp(a,0,1),n.sort((function(e,t){return e[0]-t[0]})),this.selected=n.indexOf(l),this.must_update=!0}}}},CurveEditor.prototype.onMouseUp=function(e,t){return this.selected=-1,!1},CurveEditor.prototype.getCloserPoint=function(e,t){var n=this.points;if(!n)return-1;t=t||30;for(var i=this.size[0]-2*this.margin,s=this.size[1]-2*this.margin,a=n.length,o=[0,0],r=1e6,l=-1,c=0;c<a;++c){var p=n[c];o[0]=p[0]*i,o[1]=(1-p[1])*s,o[0],e[0];var h=vec2.distance(e,o);h>r||h>t||(l=c,r=h)}return l},LiteGraph.CurveEditor=CurveEditor,LiteGraph.getParameterNames=function(e){return(e+"").replace(/[/][/].*$/gm,"").replace(/\s+/g,"").replace(/[/][*][^/*]*[*][/]/g,"").split("){",1)[0].replace(/^[^(]*[(]/,"").replace(/=[^,]+/g,"").split(",").filter(Boolean)},LiteGraph.pointerListenerAdd=function(e,t,n,i=!1){if(e&&e.addEventListener&&t&&"function"==typeof n){var s=LiteGraph.pointerevents_method,a=t;if("pointer"==s&&!window.PointerEvent)switch(a){case"down":s="touch",a="start";break;case"move":case"cancel":s="touch";break;case"up":s="touch",a="end"}switch(a){case"down":case"up":case"move":case"over":case"out":case"enter":e.addEventListener(s+a,n,i);case"leave":case"cancel":case"gotpointercapture":case"lostpointercapture":if("mouse"!=s)return e.addEventListener(s+a,n,i);default:return e.addEventListener(a,n,i)}}},LiteGraph.pointerListenerRemove=function(e,t,n,i=!1){if(e&&e.removeEventListener&&t&&"function"==typeof n)switch(t){case"down":case"up":case"move":case"over":case"out":case"enter":"pointer"!=LiteGraph.pointerevents_method&&"mouse"!=LiteGraph.pointerevents_method||e.removeEventListener(LiteGraph.pointerevents_method+t,n,i);case"leave":case"cancel":case"gotpointercapture":case"lostpointercapture":if("pointer"==LiteGraph.pointerevents_method)return e.removeEventListener(LiteGraph.pointerevents_method+t,n,i);default:return e.removeEventListener(t,n,i)}},global.clamp=clamp,"undefined"==typeof window||window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)})})(window),"undefined"!=typeof exports&&(exports.LiteGraph=(void 0).LiteGraph,exports.LGraph=(void 0).LGraph,exports.LLink=(void 0).LLink,exports.LGraphNode=(void 0).LGraphNode,exports.LGraphGroup=(void 0).LGraphGroup,exports.DragAndScale=(void 0).DragAndScale,exports.LGraphCanvas=(void 0).LGraphCanvas,exports.ContextMenu=(void 0).ContextMenu);let convertToApiJson=async(e,t)=>{e=fixJsonPathsForOs(e,"nt"==t),e=fixDataJson(e);let n=new window.LGraph;return n.start(),n.configure(e),await createApiJson(n)},fixJsonPathsForOs=(e,t)=>{try{return e.nodes.forEach(((n,i)=>{n.widgets_values&&n.widgets_values.forEach(((n,s)=>{t&&n&&!isValidUrl(n)&&null!=n.includes&&n.includes("/")&&(n=n.replaceAll("/","\\"),e.nodes[i].widgets_values[s]=n),!t&&n&&!isValidUrl(n)&&null!=n.includes&&n.includes("\\")&&(n=n.replaceAll("\\","/"),e.nodes[i].widgets_values[s]=n)}))})),e}catch(e){}},isValidUrl=e=>/^(?:https?:\/\/|ftp:\/\/|www\.)[a-z0-9-]+(?:\.[a-z0-9-]+)+[^\s]*$/i.test(e),fixDataJson=e=>(e.nodes=e.nodes.map((t=>{let n=e.extra.gyre.nodeWidgets[t.id];return{...t,widgets:n}})),gyre=e.extra.gyre,e),checkIsVirtualNode=e=>{let t=!1;return gyre.virtualNodes&&gyre.virtualNodes.length&&(t=gyre.virtualNodes.includes(e.type)),t},prepareGraph=async e=>{for(const t of e.computeExecutionOrder(!1)){if(t.widgets)for(const e of t.widgets)e.beforeQueued&&e.beforeQueued();let e=[t];t.getInnerNodes&&(e=t.getInnerNodes());for(let t of e)checkIsVirtualNode(t)&&t.applyToGraph&&t.applyToGraph()}return e},createApiJson=async e=>{e=await prepareGraph(e);const t={};for(const n of e.computeExecutionOrder(!1)){const e=!(2===n.mode||4===n.mode)&&n.getInnerNodes?n.getInnerNodes():[n];for(let n of e){if(checkIsVirtualNode(n))continue;if([2,4].includes(n.mode))continue;let e={},i=n.widgets;if(i)for(let t in i){let s=i[t];s.options&&!1===s.options.serialize||(s.serializeValue?e[s.name]=await s.serializeValue(n,t):e[s.name]=s.value)}for(let t in n.inputs){let i=n.getInputNode(t);if(i){let s=n.getInputLink(t);for(;4===i.mode||checkIsVirtualNode(i);){let e=!1;if(checkIsVirtualNode(i))s=i.getInputLink(s.origin_slot),s&&(i=i.getInputNode(s.target_slot),i&&(e=!0));else if(s&&4===i.mode){let a=[s.origin_slot,...Object.keys(i.inputs)];for(let o of a)if(i.inputs[o]?.type===n.inputs[t].type){s=i.getInputLink(o),s&&(i=i.getInputNode(o)),e=!0;break}}if(!e)break}s&&i?.updateLink&&(s=i.updateLink(s)),s&&(e[n.inputs[t].name]=[String(s.origin_id),parseInt(s.origin_slot)])}}let s=n.type;n.properties&&n.properties["Node name for S&R"]&&(s=n.properties["Node name for S&R"]),t[String(n.id)]={inputs:e,class_type:n.type,_meta:{title:s}}}}for(let e in t)for(const n in t[e].inputs){const i=t[e].inputs[n];Array.isArray(i)&&2===i.length&&!t[i[0]]&&delete t[e].inputs[n]}return t};class Comfy{static getInstance(e){return this.instance||(this.instance=new Comfy(e)),this.instance}async getLayerImage(e,t){return new Promise((n=>{let i=async e=>{let t=e.data;if("sendLayerImage"===t.key){t.error&&(this.stoperror=!0);let e=(Math.random()+1).toString(36).substring(7);await this.uploadImage(t.base64,e),window.removeEventListener("message",i),n(e)}};window.addEventListener("message",i),window.postMessage({key:"getLayerImage",layerName:e,layerID:t})}))}async getSingleImage(e,t="",n){return new Promise((i=>{let s=async e=>{let t=e.data;if("sendWorkflowImage"===t.key){let e=Comfy.getInstance(),n=(Math.random()+1).toString(36).substring(7);await e.uploadImage(t.base64,n),window.removeEventListener("message",s),i(n)}};window.addEventListener("message",s),window.postMessage({key:"getWorkflowImage",propertyName:e,arrayName:t,index:n})}))}async getWorkflowList(){let e;try{e=await fetch(`${this.serverAddress}/gyre/readworkflowdir`)}catch(e){return e.message="Error getting workflowlist. ",e.message+=e.stack,window.postMessage({key:"generateError",errorObject:e}),!1}let t=await e.json();if("error"in t)throw new Error(JSON.stringify(t));let n=t.find((e=>"deactivatedworkflows"==e.name));return n&&(n=JSON.parse(n.json)),t=t.filter((e=>"deactivatedworkflows"!=e.name)),t=t.filter((e=>{let t=JSON.parse(e.json),i=t?.extra?.gyre?.workflowid;return!n.includes(i)})),t}async getGyreComponents(){const e=await fetch(`${this.serverAddress}/gyre/collect_gyre_components`,{method:"POST"}),t=await e.json();if("error"in t)throw new Error(JSON.stringify(t));return t}async initGyreComponents(){globalThis.gyre.serverName=this.serverAddress;var e=document.createElement("script");e.async=!1,e.src=`${this.serverAddress}/gyre/init_components.js`,window.document.head.appendChild(e)}async init(){const e=await fetch(`${this.serverAddress}/gyre/collect_gyre_components`,{method:"POST"}),t=await e.json();if("error"in t)throw new Error(JSON.stringify(t));return t}constructor(e){this.clientId=this.uuidv4(),this.serverAddress=e.url;let t=this.serverAddress.replace(/(^\w+:|^)\/\//,""),n="ws://";0==this.serverAddress.indexOf("https://")&&(n="wss://"),this.wsurl=`${n}${t}/ws?clientId=${this.clientId}`,this.connect()}async connect(){this.ws&&await this.disconnect(),this.ws=new WebSocket(this.wsurl),this.ws.onopen=function(){},this.ws.onmessage=function(e){},this.ws.onclose=function(){},this.ws.onerror=function(){}}async disconnect(){this.ws&&(this.ws.close(),this.ws=void 0)}async getEmbeddings(){const e=await fetch(`${this.serverAddress}/embeddings`),t=await e.json();if("error"in t)throw new Error(JSON.stringify(t));return t}async getExtensions(){const e=await fetch(`${this.serverAddress}/extensions`),t=await e.json();if("error"in t)throw new Error(JSON.stringify(t));return t}async getImages(e){if(!this.ws)throw new Error("WebSocket client is not connected. Please call connect() before interacting.");const t=(await this.queuePrompt(e)).prompt_id;return new Promise(((e,n)=>{const i=[],s=this.onwsmessage=async(s,a)=>{if(!a){window.postMessage({key:"wsmessage",data:s.data,totalNodes:this.totalNodes,nodesNames:this.nodesNames});try{const n=JSON.parse(s.data.toString());if("executing"===n.type){const s=n.data;if(!s.node){s.prompt_id;if(s.prompt_id===t){const n=(await this.getHistory(t))[t];for(const e of Object.keys(n.outputs))if(this.currworkflow.extra.gyre&&this.currworkflow.extra.gyre.mappings&&this.currworkflow.extra.gyre.mappings[e]){const t=n.outputs[e];if(t.images){const n=[];for(const i of t.images){const t=await this.getImage(i.filename,i.subfolder,i.type);n.push({nodeId:e,blob:t,image:i})}i.push(n)}}return this.ws.onmessage=null,e(i)}}}}catch(e){return n(e)}}};this.ws.onmessage=s}))}async getImage(e,t,n){const i=await fetch(`${this.serverAddress}/view?`+new URLSearchParams({filename:e,subfolder:t,type:n}));return await i.blob()}async queuePrompt(e){const t=await fetch(`${this.serverAddress}/prompt`,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({prompt:e,client_id:this.clientId})}),n=await t.json();if("error"in n)throw await this.cancelRequestMethod(),new Error(JSON.stringify(n));return n}async interrupt(){await fetch(`${this.serverAddress}/interrupt`,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"}})}async editHistory(e){const t=await fetch(`${this.serverAddress}/history`,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(e)}),n=await t.json();if("error"in n)throw new Error(JSON.stringify(n))}async getComfySystemStats(){const e=await fetch(`${this.serverAddress}/system_stats`,{method:"GET"}),t=await e.json();if("error"in t)throw new Error(JSON.stringify(t));return t}async uploadLog(e,t,n){try{const i=await fetch(`${this.serverAddress}/gyre/upload_log_json_file`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({file_path:e,json_str:t,debugdir:n})});return await i.text()}catch(e){alert("Error saving workflow .json file: "+e)}}async getHistory(e){const t=await fetch(`${this.serverAddress}/history`+(e?`/${e}`:"")),n=await t.json();if("error"==n[e].status?.status_str)throw await this.cancelRequestMethod(),new Error(JSON.stringify(n[e].status.messages));if("error"in n)throw await this.cancelRequestMethod(),new Error(JSON.stringify(n));return n}async uploadFile(e,t){return this.uploadImage(e,t,!0)}async uploadImage(e,t,n,i){let s;if(n)s=new Blob([e]);else if("string"==typeof e||e instanceof String){let t=await fetch(e);s=await t.blob()}else s=new Blob([e]);const a=new FormData;a.append("image",s,t),void 0!==i&&a.append("overwrite",i.toString());const o=await fetch(`${this.serverAddress}/upload/image`,{method:"POST",body:a}),r=await o.json();return"error"in r?(await(new confirmDialog).alert(JSON.stringify(r)),null):r}async uploadMask(e,t,n,i){const s=new FormData;let a;if("string"==typeof e||e instanceof String){let t=await fetch(e);a=await t.blob()}else a=new Blob([e]);s.append("image",a,t),s.append("original_ref",JSON.stringify(n)),s.append("type","input"),s.append("subfolder",""),void 0!==i&&s.append("overwrite",i.toString());const o=await fetch(`${this.serverAddress}/upload/mask`,{method:"POST",body:s}),r=await o.json();if("error"in r)throw new Error(JSON.stringify(r));return r}getStatus(){return this.status}getFormValues(){let e={};return this.currentWorkflowListValues.forms.default.elements.forEach((t=>{e[t.name]=void 0!==t.elementvalue?t.elementvalue:t.default,"number"==t.type&&(e[t.name]=parseFloat(e[t.name])),"seed"==t.name&&(e[t.name]&&0!==e[t.name]&&"0"!==e[t.name]||(e[t.name]=this.generateSeed()),e[t.name]=parseInt(e[t.name]))})),e}generateSeed(){return Math.floor(4294967292*Math.random())+1}getControlNetData(e){return e.specialLayersImageInfo&&e.specialLayersImageInfo.length?e.specialLayersImageInfo.map((e=>({type:e.type,image:"empty"}))):null}createDataForParser(e){let t={};t.prompt=e.prompt,t.negativePrompt=e.negativePrompt,t.hasMask=!1,t.hasInitImage=!1,t.document_width=e.width||e.config.width,t.document_height=e.height||e.config.height,void 0!==e.image64&&(t.mergedImage="empty"),void 0!==e.maskImage64&&(t.mask="empty"),(e.maskImage64||e.maskURLRef||"inpainting"==e.mode)&&(t.hasMask=!0),"inpainting"!==e.mode&&"img2img"!==e.mode||(t.hasInitImage=!0),t={...t,...this.getFormValues()};let n=this.getControlNetData(e);return t.controlnet=n||[],t}async runSD(e,t){let n;this.currworkflow=JSON.parse(this.workflowList.find((t=>t.name==e.currentworkflowelementname)).json),this.currentWorkflowListValues=e.workflowListValues.find((t=>t.name==e.currentworkflowelementname));let i=new ComfyUIPreparser(this.currworkflow),s=this.createDataForParser(t),a=s.number_images||1,o=[];s.seed&&o.push(s.seed);try{await i.execute(s)}catch(e){e.message=e.stack;let n=t.layergeneration;return void window.postMessage({key:"generateBack",taskid:t.taskid,imagelist:e,generateasync:!window.generatesync,layergeneration:n})}if(this.stoperror)return void(this.stoperror=!1);if(e.debugNextGenerate){var r=new Date;let e=`debug_api_${(r=new Date(r.getTime())).getFullYear().toString()+"-"+(2==(r.getMonth()+1).toString().length?(r.getMonth()+1).toString():"0"+(r.getMonth()+1).toString())+"-"+(2==r.getDate().toString().length?r.getDate().toString():"0"+r.getDate().toString())+" "+(2==r.getHours().toString().length?r.getHours().toString():"0"+r.getHours().toString())+":"+(2==(5*parseInt(r.getMinutes()/5)).toString().length?(5*parseInt(r.getMinutes()/5)).toString():"0"+(5*parseInt(r.getMinutes()/5)).toString())+":00"}.json`;e=e.replace(/\s/g,"_"),e=e.replaceAll("-","_"),e=e.replaceAll(":","_"),await this.uploadLog(e,JSON.stringify(i.workflow),"debug"),await this.uploadLog("formdata_"+e,JSON.stringify(s),"formdata")}this.totalNodes=i.workflow.nodes.length,this.nodesNames=i.workflow.nodes.map((e=>({id:e.id,type:e.type}))),n=await convertToApiJson(i.workflow,this.systemstats?.system?.os);this.morerequests=[];for(let e=0;e<a;e++){let e=JSON.stringify(n);if(o.length){let t=this.generateSeed();e=e.replaceAll(o[0],t),o.push(t)}let t=JSON.parse(e);this.morerequests.push(t)}return await this.generateAllImages(t,o),null}async cancelRequestMethod(){this.cancelrequest=!0,await this.interrupt()}async generateAllImages(e,t){let n=!1,i=0;for(;!n;){if(this.cancelrequest){this.cancelrequest=!1;break}await new Promise((e=>setTimeout(e,500)));let s=this.morerequests.shift(),a=this.generateSeed();t.length&&t[i]&&(a=t[i]);let o=await this.executeRequest(s,a),r=e.layergeneration;window.postMessage({key:"generateBack",taskid:e.taskid,imagelist:o,generateasync:!window.generatesync,resultinnewlayer:!0,idx:i,layergeneration:r}),i++,this.morerequests.length||(n=!0)}}async executeRequest(e,t){let n,i=e=>new Promise(((t,n)=>{const i=new FileReader;i.onloadend=()=>t(i.result),i.readAsDataURL(e)}));try{n=await this.getImages(e)}catch(t){var s=new Date;let n=`error_api_${(s=new Date(s.getTime())).getFullYear().toString()+"-"+(2==(s.getMonth()+1).toString().length?(s.getMonth()+1).toString():"0"+(s.getMonth()+1).toString())+"-"+(2==s.getDate().toString().length?s.getDate().toString():"0"+s.getDate().toString())+" "+(2==s.getHours().toString().length?s.getHours().toString():"0"+s.getHours().toString())+":"+(2==(5*parseInt(s.getMinutes()/5)).toString().length?(5*parseInt(s.getMinutes()/5)).toString():"0"+(5*parseInt(s.getMinutes()/5)).toString())+":00"}.json`;return n=n.replace(/\s/g,"_"),n=n.replaceAll("-","_"),n=n.replaceAll(":","_"),await this.uploadLog(n,JSON.stringify(e)),t}let a=[];for(let e=0;e<n.length;e++){let s=await i(n[e][0].blob),o=s.split(",")[0];s=s.split(",")[1];let r={mime:o,base64:s,seed:t,blob:n[e][0].blob};a.push(r)}return a}async getServerFeatures(e){try{let e={};this.systemstats=await this.getComfySystemStats(),this.workflowList=e.workflowList=await this.getWorkflowList(),this.gyrecomponents=e.gyrecomponents=await this.getGyreComponents(),await this.initGyreComponents(),e.workflow_image_request=!0,e.inpainting_original=!0,e.invert_controlnet_sketch=!0,e.features=["canny","T2I_ControlNet_canny_switch","depth","skribble","text","posenet","hed","control_mode"];let t=await fetch(`${this.serverAddress}/gyre/get_all_models`),n=await t.json();return n&&n.models?e.availableModels=n.models:e.availableModels=[],e}catch(e){return e.message="Error getting server features. ",e.message+=e.stack,window.postMessage({key:"generateError",errorObject:e}),!1}}uuidv4(){return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,(e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)))}}class SDWebservice{constructor(){}strip(e,t){for(;e.length>0&&-1!=t.indexOf(e.charAt(0));)e=e.substr(1);for(;e.length>0&&-1!=t.indexOf(e.charAt(e.length-1));)e=e.substr(0,e.length-1);return e}createSDGrpc(e){return"COMFY"===e.type?Comfy.getInstance(e):new Gyre}async getWorkflowList(e){let t=this.createSDGrpc(e);return await t.getWorkflowList(e)}async getServerFeatures(e){let t=[],n=parseInt(e.width),i=parseInt(e.height),s=this.createSDGrpc(e),a=await s.getServerFeatures(e);t=[{name:"LMS"},{name:"Euler a"},{name:"Euler"},{name:"Heun"},{name:"DPM2"},{name:"DPM2 a"},{name:"DDIM"},{name:"PLMS"},{name:"DPMSolver++ 1 Order"},{name:"DPMSolver++ 2 Order"},{name:"DPMSolver++ 3 Order"},{name:"DPMSolver++ 2S a"},{name:"DPMSolver++ SDE"},{name:"DPMSolver++ 2M"},{name:"DPMSolver++ 2M (Fast)"}];let o={tiling:!0,strength:!0,steps:!0,seed:!0,samplers:t,hr:!0,clip:!0,image_number_max:9};return a&&a.artifacts&&a.artifacts.includes("ARTIFACT_DEPTH")&&(o.depth=!0),a&&a.models&&(o.models=a.models),a&&a.upscalers&&(o.upscalers=a.upscalers.engine),a&&a.model&&(o.model=a.model),n<=512&&i<=512&&(o.hr=!1),o.removeBackground=!0,o.autoMatte=!0,o.features=a.features,o.workflowList=a.workflowList,a.inpainting_original&&(o.inpainting_original=a.inpainting_original),a.workflow_image_request&&(o.workflow_image_request=a.workflow_image_request),a.invert_controlnet_sketch&&(o.invert_controlnet_sketch=a.invert_controlnet_sketch),a.availableModels&&(o.availableModels=a.availableModels),o}async getServerData(e,t,n){let i=n.url;i=this.strip(i,"/"),"txt2img"===e.mode?i+="/sdapi/v1/txt2img":i+="/sdapi/v1/img2img";try{let e=await fetch(i,{headers:{"Content-Type":"application/json",Accept:"application/json"},method:"post",body:t}),n=await e.json();return n.images?n.error?void await(new confirmDialog).alert("Error",n.text):n:void await(new confirmDialog).alert("Error",JSON.stringify(n))}catch(e){await(new confirmDialog).alert("Server error",e.toString()+"\n"+i)}}estimateTime(e,t){return e.timeCalculation?e.timeCalculation*t.num*t.steps:80*t.num*t.steps}getStatus(){return this.gs?this.gs.getStatus():this.d2?this.d2.getStatus():this.status}async estimateTimeQueue(e){return{}}async cancelRequest(e,t){if("SDGRPC"===e.type){this.gs=this.createSDGrpc(e);try{await this.gs.cancelRequest(e,t)}catch(e){}}if("COMFY"===e.type){this.gs=Comfy.getInstance(e);try{await this.gs.cancelRequest(e,t)}catch(e){}}}async runSD(e,t){if(t.config=e,"COMFY"===e.type){let n,i=performance.now();this.gs=Comfy.getInstance(e);try{n=await this.gs.runSD(e,t)}catch(e){}let s=performance.now()-i;return e.timeCalculation=s/t.num/t.steps,n}if("SDGRPC"===e.type){let n,i=performance.now();this.gs=this.createSDGrpc(e);try{n=await this.gs.runSD(e,t)}catch(e){}let s=performance.now()-i;return e.timeCalculation=s/t.num/t.steps,n}let n;this.status="waiting",n=t.seed?parseInt(t.seed):-1;["fill","original","latent noise","latent nothing","g-diffusion"].indexOf(e.inpaint_mask_content);if(!await this.switchModel(e,t))return void(this.status="error");let i={enable_hr:t.enable_hr,denoising_strength:0,firstphase_width:0,firstphase_height:0,prompt:t.prompt,seed:n,subseed:-1,subseed_strength:0,seed_resize_from_h:-1,seed_resize_from_w:-1,batch_size:1,n_iter:parseInt(t.num),steps:parseInt(t.steps),cfg_scale:parseFloat(t.cfg_value),width:parseInt(e.width),height:parseInt(e.height),restore_faces:t.restore_faces,tiling:t.tiling,negative_prompt:t.negative_prompt,eta:0,s_churn:0,s_tmax:0,s_tmin:0,s_noise:1,override_settings:{},sampler_index:t.sampling_method};t.enable_hr&&(i.denoising_strength=.7),"img2img"!==t.mode&&"inpainting"!==t.mode&&"inpainting_original"!==t.mode||(i.init_images=["data:image/png;base64,"+t.image64],i.denoising_strength=t.strength,i.resize_mode=0,i.inpaint_full_res=!1,t.maskImage64&&(i.mask="data:image/png;base64,"+t.maskImage64,i.denoising_strength=1,i.inpainting_fill=2,i.mask_blur=0));let s=JSON.stringify(i),a=performance.now();this.status="processing";let o=await this.getServerData(t,s,e);if(!o)return void(this.status="error");this.status="ready";let r=performance.now()-a;e.timeCalculation=r/t.num/t.steps;let l=[];t.seedList=[];let c,p=o.info,h=JSON.parse(p).all_seeds;for(let e=0;e<t.num;e++){c=o.images[e],t.seedList[e]=h[e]+"";let n={base64:c};n.seed=t.seedList[e],l.push(n)}return l}async getModels(e){let t=e.url;t=this.strip(t,"/"),t+="/sdapi/v1/sd-models";let n,i=[];try{let e=await fetch(t,{headers:{"Content-Type":"application/json",Accept:"application/json"},method:"get"});if(n=await e.json(),n.error)return void await(new confirmDialog).alert("Error",n.text)}catch(e){await(new confirmDialog).alert("Server error",e.toString()+"\n"+t)}for(let e=0;e<n.length;e++){let t=n[e];i.push({id:t.model_name,hash:t.hash})}return i}async switchModel(e,t){let n=await this.getModels(e);if(!n)return!1;let i="";if(i=e.model,"inpainting"===t.mode&&(i=e.inpainting_model,i||(i="sd-v1-5-inpainting")),!i)return await(new confirmDialog).alert("No model selected in config"),!1;let s="";for(let e=0;e<n.length;e++){let t=n[e];t.id===i&&(s=i+".ckpt ["+t.hash+"]")}if(!s)return await(new confirmDialog).alert("Model not found: "+s),!1;let a={sd_model_checkpoint:s},o=JSON.stringify(a),r=e.url;r=this.strip(r,"/"),r+="/sdapi/v1/options";try{let e=await fetch(r,{headers:{"Content-Type":"application/json",Accept:"application/json"},method:"post",body:o});await e.json();return!0}catch(e){return await(new confirmDialog).alert("Server error",e.toString()+"\n"+r),!1}}}class prompt{taskid;constructor(e){this.taskid=e}async getFullPrompt(e){let t="",n=e.modifiers.split(/\n|\r/),i="",s="";try{for(let e=0;e<n.length;e++){let s=n[e];s=s.trim(),s.endsWith("...")?i+=s.replace("..."," "):s&&"#"!=s[0]&&"-"!=s[0]&&!s.startsWith("lora:")&&(-1!=s.search(":")&&(s="("+s+")"),t+=", "+s)}s=e.prompt}catch(e){}return s||(s=""),s=i+s,s+=t,s}getLoraList(e){let t=e.modifiers.split(/\n|\r/),n=[];for(let e=0;e<t.length;e++){let i=t[e];if(i.startsWith("lora:")){let e=i.replace("lora:",""),t=1;if(e=e.replace("://","__MAGIC__"),-1!=e.search(":")){let n=e.split(":");e=n[0],t=parseFloat(n[1])}e=e.replace("__MAGIC__","://"),n.push({url:e,weight:t})}}return n}async getNegativePrompt(e){let t="",n=e.modifiers.split(/\n|\r/);for(let e=0;e<n.length;e++){let i=n[e];"-"===i[0]&&(t+=", "+i.replace("-",""))}return t}async getPromptObject(e,t,n,i,s,a,o){let r=e,l={};if(l.prompt=await this.getFullPrompt(r),l.negativePrompt=await this.getNegativePrompt(r),l.loraList=await this.getLoraList(r),l.prompt)return l.mode=t,"variations"===l.mode&&(l.prompt="variations"),l.steps=r.steps,l.seed=r.seed,l.num=r.num,l.inpainting_original=r.inpainting_original,l.sampling_method=r.sampling_method,l.cfg_value=r.cfg_value,r.clip&&(l.clip=!0),l.tiling=e.tiling,l.enable_hr=e.enable_hr,l.enable_depth=e.enable_depth,l.restore_faces=e.restore_faces,l.strength=.75,"img2img"===t&&(l.strength=r.strength,l.image64=n.base64,l.imageURLRef=n.urlRef,s&&(l.depthImage64=s.base64)),"variations"===t&&(l.image64=n.base64,l.imageURLRef=n.urlRef),"removeBackground"===t&&(l.image64=n.base64,l.imageURLRef=n.urlRef),"autoMatte"===t&&(l.image64=n.base64,l.imageURLRef=n.urlRef,l.pointList=e.pointList,l.rectangleList=e.rectangleList,l.erode=e.erode),"upscale"===t&&(l.image64=n.base64,l.imageURLRef=n.urlRef,l.upscaleEngine=e.upscaleEngine),"inpainting"!==t&&"inpainting_original"!==t||(l.strength=r.strength,l.image64=n.base64,l.imageURLRef=n.urlRef,i&&(l.maskImage64=i.base64,l.maskURLRef=i.urlRef,o&&(l.imageInfoSelectionURLRef=o.urlRef))),l.specialLayersImageInfo=a,this.taskid&&(l.taskid=this.taskid),l.targetWidth=e.targetWidth,l.targetHeight=e.targetHeight,l}}class ComfyStandAlone extends Comfy{static getInstance(e){return this.instance||(this.instance=new ComfyStandAlone(e)),this.instance}constructor(e){super(e)}async getLayerImage(e,t){let n=await this.callBack_files("getLayerImage",e,t);n||(this.stoperror=!0);let i=(Math.random()+1).toString(36).substring(7);return await this.uploadImage(n,i),i}async getSingleImage(e,t="",n){let i=await this.callBack_files("getSingleImage",e,t,n);i||(this.stoperror=!0);let s=(Math.random()+1).toString(36).substring(7);return await this.uploadImage(i,s),s}async getFile(e,t="",n){let i=await this.callBack_files("getFile",e,t,n);i||(this.stoperror=!0);let s=(Math.random()+1).toString(36).substring(7);return await this.uploadFile(i,s),s}async runSD(e,t,n,i,s){let a;this.callBack_files=i,this.callback_finished=t,this.workflowList||(this.workflowList=await this.getWorkflowList()),this.currworkflow=JSON.parse(this.workflowList.find((t=>t.name==e)).json);let o=new ComfyUIPreparser(this.currworkflow),r=n.number_images||1,l=[];n.seed&&l.push(n.seed);try{await o.execute(n)}catch(e){e.message=e.stack;let t=p.layergeneration;return void window.postMessage({key:"generateBack",taskid:p.taskid,imagelist:e,generateasync:!window.generatesync,layergeneration:t})}if(this.stoperror)return void(this.stoperror=!1);this.totalNodes=o.workflow.nodes.length,this.nodesNames=o.workflow.nodes.map((e=>({id:e.id,type:e.type}))),a=await convertToApiJson(o.workflow,this.systemstats?.system?.os);this.morerequests=[];for(let e=0;e<r;e++){let e=JSON.stringify(a);if(l.length){let t=this.generateSeed();e=e.replaceAll(l[0],t),l.push(t)}let t=JSON.parse(e);this.morerequests.push(t)}return await this.generateAllImages(l),null}async generateAllImages(e){let t=!1,n=0;for(;!t;){if(this.cancelrequest){this.cancelrequest=!1;break}await new Promise((e=>setTimeout(e,500)));let i=this.morerequests.shift(),s=this.generateSeed();e.length&&e[n]&&(s=e[n]);let a=await this.executeRequest(i,s);this.callback_finished(a),n++,this.morerequests.length||(t=!0)}}}class PostMessageAdapter{unsubscribe;openProfile=!0;firstconfigelement;server_features;constructor(){}async postMessage(e){let t;if("init"===e.key)try{let e=512,i=512,s="",a="",o=new Config;for(await o.load(),await o.get(),o.configList.length||await o.add("SDGRPC"),o.configList.find((e=>"COMFY"==e.generalConfig.name))||(await o.add("COMFY"),o.currentConfigNum=0),this.firstconfigelement=document.createElement("fds-first-config"),this.firstconfigelement.classList.add("colorScheme"),this.firstconfigelement.serverurl=o.generalConfig.url||window.location.href,this.firstconfigelement.bearer=o.generalConfig.token,this.firstconfigelement.SDConfig=o,this.firstconfigelement.servertype=o.generalConfig.name,document.body.appendChild(this.firstconfigelement),o.configList.length||(this.firstconfigelement.finishedInit=!0),this.firstconfigelement.finishedInit=!0,this.firstconfigelement.serverurl&&("https://cloud.gyre.ai"!==this.firstconfigelement.serverurl||this.firstconfigelement.bearer)||(this.firstconfigelement.openProfile=!0);this.firstconfigelement.finishedInit;)await new Promise((e=>setTimeout(e,100)));s=this.firstconfigelement.serverurl||s,s=s.endsWith("/")?s.slice(0,-1):s,e=this.firstconfigelement.initwidth||e,i=this.firstconfigelement.initheight||i,a=this.firstconfigelement.bearer;let r=0;o.configList.forEach(((e,t)=>{e.generalConfig.name==this.firstconfigelement.servertype&&(r=t)})),o.currentConfigNum!=r&&(o.currentConfigNum=r,await o.get()),o.generalConfig.url=s,o.generalConfig.token=a,await o.set();var n=document.createElement("canvas");n.width=e,n.height=i;let l,c,p,h="png";this.firstconfigelement.file_blob||this.firstconfigelement.file_uncompressed||this.firstconfigelement.file_base64||(l=n.toDataURL()),this.firstconfigelement.file_base64&&"image"===this.firstconfigelement.file_type&&(l=this.firstconfigelement.file_base64,h=l.substring(11,l.indexOf(";base64"))),this.firstconfigelement.file_base64&&"gyre"===this.firstconfigelement.file_type&&(l=this.firstconfigelement.file_base64,h="gyre"),this.firstconfigelement.file_blob&&"gyre"===this.firstconfigelement.file_type&&(c=this.firstconfigelement.file_blob,h="gyre"),this.firstconfigelement.file_uncompressed&&"gyre"===this.firstconfigelement.file_type&&(p=this.firstconfigelement.file_uncompressed,h="gyre");let d=new SDWebservice;this.server_features=await d.getServerFeatures(o.generalConfig),t={data:{base64:l,blob:c,imageType:h,uncompressed:p,key:"init",documentInfo:{width:e,height:i},Config:o,num:o.currentConfigNum,serverFeatures:this.server_features}}}catch(e){return e.message=e.stack,window.postMessage({key:"generateError",errorObject:e}),!1}if("changeModel"===e.key&&(t=await this.changeConfigElement({objkey:"model",value:e.model})),"changeInpaintingModel"===e.key&&(t=await this.changeConfigElement({objkey:"inpainting_model",value:e.model})),"changeGeneralConfig"===e.key&&(t=await this.changeConfigElement({objkey:e.type,value:e.value}),e.skiprefresh&&(t=null)),"changeGlobalData"===e.key){(new Config).updateGlobalData(e.globalData)}if("changeSize"===e.key){let n;"width"===e.type&&(n="width"),"height"===e.type&&(n="height"),t=await this.changeConfigElement({objkey:n,value:e.value})}if("numberImages"===e.key){let t=new Config;await t.load(),await t.get(),t.generalConfig.dlgData.num=parseInt(e.num),t.set()}if("modifierSave"===e.key){let t=new Config;await t.load(),await t.get(),t.ModifierData=JSON.parse(e.modifier.modifierdata),await t.save()}if("changeSampler"===e.key){let t=new Config;await t.load(),await t.get(),t.generalConfig.dlgData.sampling_method=e.sampling_method,t.set()}if("cancelRequest"===e.key){let t=new SDWebservice;await t.cancelRequest(e.Config.generalConfig,e.taskid)}if("getWorkflowsList"===e.key){let n=new SDWebservice;t={data:{key:"workflowsListBack",workflowlist:await n.getWorkflowList(e.Config.generalConfig)}}}if("generate"===e.key){let n=e.layer,i=new prompt(n.taskid),s=await i.getPromptObject(n.generate,n.generate.mode,n.ImageInfo,n.AlphaImageInfo,n.DepthImageInfo,n.specialLayersImageInfo),a=new SDWebservice,o=n.generate.layergeneration;s.layergeneration=o;let r=await a.runSD(e.Config.generalConfig,s);this.unsubscribe||(this.unsubscribe=transferStore.subscribe((async e=>{if(!e)return;if(!e.taskid)return;let t=e.answers.answer.map((t=>{let n=t.artifacts[0],i={base64:n.binary,seed:n.seed};return e.answers.complete&&(i.complete=!0),i}));window.postMessage({key:"generateBack",taskid:e.taskid,imagelist:t,generateasync:!window.generatesync}),transferStore.set()}))),null!=r&&(t={data:{key:"generateBack",taskid:n.taskid,generateasync:!window.generatesync,imagelist:r,layergeneration:o}})}t&&window.postMessage(t.data)}async generate(e,t){let n=new SDWebservice;if("string"==typeof t||t instanceof String){const e=await fetch(t);t=await e.json()}let i=new prompt(t.taskid),s=await i.getPromptObject(t.generate,t.generate.mode,t.ImageInfo,t.AlphaImageInfo,t.DepthImageInfo,t.specialLayersImageInfo,t.ImageInfoSelection),a=await n.runSD(e,s),o={data:{key:"generateBack",generateasync:!window.generatesync,imagelist:a}};if(o)return o.data}async init(e){this.StandAloneSDConfig={url:e}}async executeWorkflow(e,t,n,i,s){this.getWorkflowImageRequestServerInstance("standalone").runSD(e,t,i,n,s)}async changeConfigElement(e){let t=new Config;await t.load(),await t.get(),""==e.objkey?t.generalConfig=e.value:t.generalConfig[e.objkey]=e.value,await t.set();let n=new SDWebservice;return this.server_features||(this.server_features=await n.getServerFeatures(t.generalConfig)),{data:{key:"switchConfig",num:t.currentConfigNum,serverFeatures:this.server_features}}}getWorkflowImageRequestServerInstance(e){let t=this.firstconfigelement?.SDConfig||null;return e||this.standalone?(this.standalone=!0,t=this.StandAloneSDConfig,ComfyStandAlone.getInstance(t)):Comfy.getInstance(t)}}let inst=new PostMessageAdapter;function create_fragment(e){return{c(){this.c=noop},m:noop,p:noop,i:noop,o:noop,d:noop}}function instance(e,t,n){get_current_component(),fdsHelper.get_href();const i=version;return onMount((()=>{})),[async function(e){return"version"===e?new Promise((e=>{e(version)})):await fdsHelper.getInfo(e,name)},i]}window.postMessageAdapter=inst;class App extends SvelteElement{constructor(e){super(),init(this,{target:this.shadowRoot,props:attribute_to_object(this.attributes),customElement:!0},instance,create_fragment,safe_not_equal,{getInfo:0,version:1},null),e&&(e.target&&insert(e.target,this,e.anchor),e.props&&(this.$set(e.props),flush()))}static get observedAttributes(){return["getInfo","version"]}get getInfo(){return this.$$.ctx[0]}get version(){return this.$$.ctx[1]}}return customElements.define("fds-ai-image-editor",App),App}();
//# sourceMappingURL=fds-ai-image-editor.js.map
