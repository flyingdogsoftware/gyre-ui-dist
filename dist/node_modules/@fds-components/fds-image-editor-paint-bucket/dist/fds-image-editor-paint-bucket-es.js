function t(){}function e(t){return t()}function n(){return Object.create(null)}function o(t){t.forEach(e)}function r(t){return"function"==typeof t}function l(t,e){return t!=t?e==e:t!==e||t&&"object"==typeof t||"function"==typeof t}let a,i;function s(t,e){return a||(a=document.createElement("a")),a.href=e,t===a.href}function c(e,...n){if(null==e)return t;const o=e.subscribe(...n);return o.unsubscribe?()=>o.unsubscribe():o}function u(t,e,n){return t.set(n),e}function d(t,e){t.appendChild(e)}function h(t,e,n){t.insertBefore(e,n||null)}function g(t){t.parentNode&&t.parentNode.removeChild(t)}function f(t){return document.createElement(t)}function p(t){return document.createTextNode(t)}function y(){return p(" ")}function m(t,e,n,o){return t.addEventListener(e,n,o),()=>t.removeEventListener(e,n,o)}function b(t,e,n){null==n?t.removeAttribute(e):t.getAttribute(e)!==n&&t.setAttribute(e,n)}function $(t,e,n){e in t?t[e]="boolean"==typeof t[e]&&""===n||n:b(t,e,n)}function x(t,e){e=""+e,t.data!==e&&(t.data=e)}function w(t,e,n,o){null==n?t.style.removeProperty(e):t.style.setProperty(e,n,o?"important":"")}function C(t){const e={};for(const n of t)e[n.name]=n.value;return e}function T(t){i=t}function v(){if(!i)throw new Error("Function called outside component initialization");return i}const _=[],E=[];let I=[];const k=[],L=Promise.resolve();let P=!1;function V(t){I.push(t)}const F=new Set;let A=0;function D(){if(0!==A)return;const t=i;do{try{for(;A<_.length;){const t=_[A];A++,T(t),j(t.$$)}}catch(t){throw _.length=0,A=0,t}for(T(null),_.length=0,A=0;E.length;)E.pop()();for(let t=0;t<I.length;t+=1){const e=I[t];F.has(e)||(F.add(e),e())}I.length=0}while(_.length);for(;k.length;)k.pop()();P=!1,F.clear(),T(t)}function j(t){if(null!==t.fragment){t.update(),o(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(V)}}const M=new Set;function R(t,e){const n=t.$$;null!==n.fragment&&(!function(t){const e=[],n=[];I.forEach((o=>-1===t.indexOf(o)?e.push(o):n.push(o))),n.forEach((t=>t())),I=e}(n.after_update),o(n.on_destroy),n.fragment&&n.fragment.d(e),n.on_destroy=n.fragment=null,n.ctx=[])}function S(t,e){-1===t.$$.dirty[0]&&(_.push(t),P||(P=!0,L.then(D)),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function B(l,a,s,c,u,d,h,f=[-1]){const p=i;T(l);const y=l.$$={fragment:null,ctx:[],props:d,update:t,not_equal:u,bound:n(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(a.context||(p?p.$$.context:[])),callbacks:n(),dirty:f,skip_bound:!1,root:a.target||p.$$.root};h&&h(y.root);let m=!1;if(y.ctx=s?s(l,a.props||{},((t,e,...n)=>{const o=n.length?n[0]:e;return y.ctx&&u(y.ctx[t],y.ctx[t]=o)&&(!y.skip_bound&&y.bound[t]&&y.bound[t](o),m&&S(l,t)),e})):[],y.update(),m=!0,o(y.before_update),y.fragment=!!c&&c(y.ctx),a.target){if(a.hydrate){const t=function(t){return Array.from(t.childNodes)}(a.target);y.fragment&&y.fragment.l(t),t.forEach(g)}else y.fragment&&y.fragment.c();a.intro&&((b=l.$$.fragment)&&b.i&&(M.delete(b),b.i($))),function(t,n,l,a){const{fragment:i,after_update:s}=t.$$;i&&i.m(n,l),a||V((()=>{const n=t.$$.on_mount.map(e).filter(r);t.$$.on_destroy?t.$$.on_destroy.push(...n):o(n),t.$$.on_mount=[]})),s.forEach(V)}(l,a.target,a.anchor,a.customElement),D()}var b,$;T(p)}let O;"function"==typeof HTMLElement&&(O=class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){const{on_mount:t}=this.$$;this.$$.on_disconnect=t.map(e).filter(r);for(const t in this.$$.slotted)this.appendChild(this.$$.slotted[t])}attributeChangedCallback(t,e,n){this[t]=n}disconnectedCallback(){o(this.$$.on_disconnect)}$destroy(){R(this,1),this.$destroy=t}$on(e,n){if(!r(n))return t;const o=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return o.push(n),()=>{const t=o.indexOf(n);-1!==t&&o.splice(t,1)}}$set(t){var e;this.$$set&&(e=t,0!==Object.keys(e).length)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}});const z=[];let H=function(e,n=t){let o;const r=new Set;function a(t){if(l(e,t)&&(e=t,o)){const t=!z.length;for(const t of r)t[1](),z.push(t,e);if(t){for(let t=0;t<z.length;t+=2)z[t][0](z[t+1]);z.length=0}}}return{set:a,update:function(t){a(t(e))},subscribe:function(l,i=t){const s=[l,i];return r.add(s),1===r.size&&(o=n(a)||t),l(e),()=>{r.delete(s),0===r.size&&o&&(o(),o=null)}}}}({});function N(t){let e,n,r,l,a,i,s,c,u,C,T,v,_,E,I,k,L,P,V,F,A=t[3]?"Switch to Color Fill":"Switch to Pattern Fill",D=t[3]&&U(t);return{c(){e=f("div"),n=f("fds-image-editor-button"),r=p(A),l=y(),D&&D.c(),a=y(),i=f("div"),s=f("label"),s.textContent="Tolerance:",c=y(),u=f("span"),C=p(t[4]),T=y(),v=f("fds-image-editor-slider"),_=y(),E=f("div"),I=f("div"),k=f("fds-image-editor-button"),k.textContent="Done",L=y(),P=f("fds-image-editor-button"),P.textContent="Cancel",$(n,"type","button"),b(e,"class","formLine"),w(s,"margin-right","5px"),b(s,"class","more-label"),w(u,"width","24px"),$(v,"class","slider"),$(v,"min","1"),$(v,"max","255"),$(v,"step","1"),$(v,"value",t[4]),b(i,"class","formLine"),w(i,"display","flex"),w(i,"align-self","center"),$(k,"type","button"),$(P,"type","button"),w(I,"display","flex"),w(I,"align-items","center"),b(E,"class","formLine")},m(o,g){h(o,e,g),d(e,n),d(n,r),h(o,l,g),D&&D.m(o,g),h(o,a,g),h(o,i,g),d(i,s),d(i,c),d(i,u),d(u,C),d(i,T),d(i,v),h(o,_,g),h(o,E,g),d(E,I),d(I,k),d(I,L),d(I,P),V||(F=[m(n,"click",t[10]),m(v,"change",t[12]),m(k,"click",t[13]),m(P,"click",t[14])],V=!0)},p(t,e){8&e&&A!==(A=t[3]?"Switch to Color Fill":"Switch to Pattern Fill")&&x(r,A),t[3]?D?D.p(t,e):(D=U(t),D.c(),D.m(a.parentNode,a)):D&&(D.d(1),D=null),16&e&&x(C,t[4]),16&e&&$(v,"value",t[4])},d(t){t&&g(e),t&&g(l),D&&D.d(t),t&&g(a),t&&g(i),t&&g(_),t&&g(E),V=!1,o(F)}}}function U(e){let n,o,r,l,a,i,s;return{c(){n=f("div"),o=f("label"),o.textContent="Please drop a layer:",r=y(),l=f("div"),a=f("fds-layer-stack-3d-new"),w(o,"width","160px"),b(o,"class","more-label"),$(a,"mode","drop"),w(l,"min-width","130px"),w(l,"padding-top","40px"),b(l,"class","drop_layers"),b(n,"class","formLine"),w(n,"display","inline-flex")},m(t,c){h(t,n,c),d(n,o),d(n,r),d(n,l),d(l,a),i||(s=m(a,"dropLayer",e[11]),i=!0)},p:t,d(t){t&&g(n),i=!1,s()}}}function W(e){let n,o,r,l=N(e);return{c(){n=f("div"),o=y(),l&&l.c(),this.c=t,b(n,"class","show"),b(n,"style",r=e[3]?"display: inline-flex;width: 820px; justify-content: space-around;":"display: inline-flex;width: 560px; justify-content: space-around; ")},m(t,e){h(t,n,e),d(n,o),l&&l.m(n,null)},p(t,[e]){l?l.p(t,e):(l=N(t),l.c(),l.m(n,null)),8&e&&r!==(r=t[3]?"display: inline-flex;width: 820px; justify-content: space-around;":"display: inline-flex;width: 560px; justify-content: space-around; ")&&b(n,"style",r)},i:t,o:t,d(t){t&&g(n),l&&l.d()}}}function Y(e,n,o){let r,l,a=t,i=()=>(a(),a=c(l,(t=>o(1,r=t))),l);e.$$.on_destroy.push((()=>a())),globalThis.gyre&&globalThis.gyre.paletteValues.tools&&globalThis.gyre.paletteValues.tools.fdsimageeditorpaintbucket?i(l=globalThis.gyre.paletteValues.tools.fdsimageeditorpaintbucket):i(l=H);let s,d=v().$$.root.host;globalThis.gyre?.paletteValues.foregroundColor;let h=30;function g(t,e){d.dispatchEvent(new CustomEvent("change",{detail:{name:t,value:e}}))}function f(){u(l,r.usePatternFill=!r.usePatternFill,r),o(3,s=r.usePatternFill)}function p(){o(3,s=r.usePatternFill),r.fillColor&&r.fillColor,r.tolerance&&o(4,h=r.tolerance)}function y(t,e){globalThis.gyre&&t.detail&&u(l,r.loadPatternImageId=parseInt(t.detail),r)}let{editcoord:m}=n;return e.$$set=t=>{"editcoord"in t&&o(0,m=t.editcoord)},e.$$.update=()=>{2&e.$$.dirty&&r&&p()},[m,r,l,s,h,g,f,y,p,()=>{o(0,m=!m),g("editcoord",m)},()=>{f()},t=>{y(t)},t=>{o(4,h=u(l,r.tolerance=t.detail.value,r))},()=>{u(l,r.done=!0,r)},()=>{u(l,r.cancel=!0,r)}]}function q(e){let n,o,r,l;return{c(){n=f("img"),this.c=t,w(n,"opacity",e[0]/100),s(n.src,o=e[3])||b(n,"src",o)},m(t,o){h(t,n,o),e[10](n),r||(l=m(n,"mousedown",e[4]),r=!0)},p(t,[e]){1&e&&w(n,"opacity",t[0]/100),8&e&&!s(n.src,o=t[3])&&b(n,"src",o)},i:t,o:t,d(t){t&&g(n),e[10](null),r=!1,l()}}}function X(t,e,n){return Math.abs(t.r-e.r)<=n&&Math.abs(t.g-e.g)<=n&&Math.abs(t.b-e.b)<=n&&Math.abs(t.a-e.a)<=n}function G(t,e,n){const o=document.createElement("canvas");o.width=e,o.height=n;const r=o.getContext("2d"),l=new ImageData(t,e,n);return r.putImageData(l,0,0),o.toDataURL("image/png")}function J(e,n,o){let r,l,a,i,s=t,d=()=>(s(),s=c(l,(t=>o(9,r=t))),l);e.$$.on_destroy.push((()=>s())),globalThis.gyre&&globalThis.gyre.paletteValues.tools&&globalThis.gyre.paletteValues.tools.fdsimageeditorpaintbucket?d(l=globalThis.gyre.paletteValues.tools.fdsimageeditorpaintbucket):d(l=H);let h,g=window.devicePixelRatio;globalThis.gyre&&(h=globalThis.gyre?.canvas.zoom);let f,p,y,m,b,$,{opacity:x}=n;globalThis.gyre&&globalThis.gyre.paletteValues.selectedLayer&&(x=globalThis.gyre.paletteValues.selectedLayer.opacity);let w=v().$$.root.host,{fillColor:C=globalThis.gyre?.paletteValues.foregroundColor||"#ff0000"}=n,{tolerance:T=30}=n,{usePatternFill:_=!0}=n;var I;async function k(t,e){let n=t=parseInt(t),a=e=parseInt(e);const s=p.getImageData(0,0,$.width,$.height),c=s.data,d=4*parseInt(a*f.width+n),h={r:c[d],g:c[d+1],b:c[d+2],a:c[d+3]},g=new Uint8Array(f.width*f.height);_&&b?function(t,e,n,o,a,i,s){const c=[{x:t,y:e}],d=m.width,h=m.height,g=b.data;for(;c.length;){const{x:t,y:e}=c.pop(),r=e*a+t;if(s[r])continue;s[r]=1;const l=4*r;if(X({r:o[l],g:o[l+1],b:o[l+2],a:o[l+3]},n,T)){const n=4*(e%h*d+t%d);o[l]=g[n],o[l+1]=g[n+1],o[l+2]=g[n+2],o[l+3]=g[n+3],t>0&&c.push({x:t-1,y:e}),t<a-1&&c.push({x:t+1,y:e}),e>0&&c.push({x:t,y:e-1}),e<i-1&&c.push({x:t,y:e+1})}}u(l,r.cimgurl=G(o,a,i),r)}(n,a,h,c,f.width,f.height,g):function(t,e,n,o,a,i,s,c){o=globalThis.gyre?.paletteValues.foregroundColor||o;const d=[{x:t,y:e}];let h=function(t){var e;if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(t))return 3==(e=t.substring(1).split("")).length&&(e=[e[0],e[0],e[1],e[1],e[2],e[2]]),{r:(e="0x"+e.join(""))>>16&255,g:e>>8&255,b:255&e,a:255};throw new Error("Bad Hex")}(o);for(;d.length;){const{x:t,y:e}=d.pop(),o=e*i+t;if(c[o])continue;c[o]=1;const r=4*o;X({r:a[r],g:a[r+1],b:a[r+2],a:a[r+3]},n,T)&&(a[r]=h.r,a[r+1]=h.g,a[r+2]=h.b,a[r+3]=h.a,t>0&&d.push({x:t-1,y:e}),t<i-1&&d.push({x:t+1,y:e}),e>0&&d.push({x:t,y:e-1}),e<s-1&&d.push({x:t,y:e+1}))}u(l,r.cimgurl=G(a,i,s),r),globalThis.gyre.log("flood fill resulttt",r.cimgurl)}(n,a,h,C,c,f.width,f.height,g),p.putImageData(s,0,0),o(3,i=r.cimgurl)}function L(){if(globalThis.gyre&&globalThis.gyre.paletteValues.selectedLayer&&o(0,x=globalThis.gyre.paletteValues.selectedLayer.opacity),r.tolerance&&o(6,T=r.tolerance),o(7,_=r.usePatternFill),r.patternData&&(b=r.patternData),r.fillColor&&o(5,C=r.fillColor),r.done){if(u(l,r.done=!1,r),!r.cimgurl)return;!function(){if(!globalThis.gyre)return;let t=r.cimgurl,e=globalThis.gyre.paletteValues.selectedLayer.url;globalThis.gyre.undo_redo_add("paintBucket","imagegenerated",{urlBefore:e,urlAfter:t},((t,e)=>{let n;"undo"===e&&(n=t.data.urlAfter),"redo"===e&&(n=t.data.urlBefore),globalThis.gyre.paletteValues.selectedLayer.url=n,globalThis.gyre.paletteValues.selectedLayer._refreshCallback?globalThis.gyre.paletteValues.selectedLayer._refreshCallback():globalThis.gyre.canvasComponent.refresh()}))}(),w.dispatchEvent(new CustomEvent("change",{detail:{type:"imagegenerated",dataURL:r.cimgurl,coords:$}}))}r.cancel&&(w.dispatchEvent(new CustomEvent("change",{detail:{type:"cancelimagegenerate"}})),u(l,r.cancel=!1,r))}return I=async()=>{globalThis.gyre&&o(3,i=globalThis.gyre.paletteValues.selectedLayer.url),f=document.createElement("canvas"),p=f.getContext("2d"),y=new Image,globalThis.gyre||(y.src="dog.png"),globalThis.gyre&&(y.src=globalThis.gyre.paletteValues.selectedLayer.url),$={x:0,y:0,width:globalThis.gyre.paletteValues.selectedLayer.width,height:globalThis.gyre.paletteValues.selectedLayer.height},y.crossOrigin="Anonymous",y.onload=()=>{$={x:0,y:0,width:y.naturalWidth,height:y.naturalHeight},f.width=$.width,f.height=$.height,p.drawImage(y,$.x,$.y,$.width,$.height)}},v().$$.on_mount.push(I),e.$$set=t=>{"opacity"in t&&o(0,x=t.opacity),"fillColor"in t&&o(5,C=t.fillColor),"tolerance"in t&&o(6,T=t.tolerance),"usePatternFill"in t&&o(7,_=t.usePatternFill)},e.$$.update=()=>{512&e.$$.dirty&&r&&(r.loadPatternImageId&&function(){let t=globalThis.gyre.layerManager.findById(null,parseInt(r.loadPatternImageId)).entry.url;m=new Image,m.src="pattern.png",t&&(m.src=t),m.crossOrigin="Anonymous",m.onload=()=>{const t=document.createElement("canvas");t.width=m.width,t.height=m.height;const e=t.getContext("2d");e.drawImage(m,0,0),b=e.getImageData(0,0,m.width,m.height),u(l,r.loadPatternImageId=null,r)}}(),L())},[x,l,a,i,function({offsetX:t,offsetY:e}){let n=globalThis.gyre?.paletteValues.selectedLayer,o=parseFloat(h)/100/g;t/=o,e/=o;let r=a.naturalWidth,l=a.naturalHeight,i=a.getBoundingClientRect();i={x:0,y:0,width:i.width,height:i.height};let s=r*o,c=l*o,u=t/(i.width/s),d=e/(i.height/c);n.rotation&&i.width==i.height||parseInt(i.width)==parseInt(s)&&parseInt(i.height)==parseInt(c)?k(t,e):k(u,d)},C,T,_,L,r,function(t){E[t?"unshift":"push"]((()=>{a=t,o(2,a)}))}]}customElements.define("fds-image-editor-paint-bucket-dialog",class extends O{constructor(t){super();const e=document.createElement("style");e.textContent="*{box-sizing:border-box}.formLine{displaY:block;margin-bottom:20px}.slider{vertical-align:middle}.formLine{margin-bottom:5px}.show{display:block}",this.shadowRoot.appendChild(e),B(this,{target:this.shadowRoot,props:C(this.attributes),customElement:!0},Y,W,l,{refresh:8,editcoord:0},null),t&&(t.target&&h(t.target,this,t.anchor),t.props&&(this.$set(t.props),D()))}static get observedAttributes(){return["refresh","editcoord"]}get refresh(){return this.$$.ctx[8]}get editcoord(){return this.$$.ctx[0]}set editcoord(t){this.$$set({editcoord:t}),D()}});class K extends O{constructor(t){super();const e=document.createElement("style");e.textContent="img{cursor:crosshair;position:absolute;top:0;left:0;width:100%;height:100%;transform-origin:top left;user-select:none}",this.shadowRoot.appendChild(e),B(this,{target:this.shadowRoot,props:C(this.attributes),customElement:!0},J,q,l,{opacity:0,fillColor:5,tolerance:6,usePatternFill:7,refresh:8},null),t&&(t.target&&h(t.target,this,t.anchor),t.props&&(this.$set(t.props),D()))}static get observedAttributes(){return["opacity","fillColor","tolerance","usePatternFill","refresh"]}get opacity(){return this.$$.ctx[0]}set opacity(t){this.$$set({opacity:t}),D()}get fillColor(){return this.$$.ctx[5]}set fillColor(t){this.$$set({fillColor:t}),D()}get tolerance(){return this.$$.ctx[6]}set tolerance(t){this.$$set({tolerance:t}),D()}get usePatternFill(){return this.$$.ctx[7]}set usePatternFill(t){this.$$set({usePatternFill:t}),D()}get refresh(){return this.$$.ctx[8]}}customElements.define("fds-image-editor-paint-bucket",K);export{K as default};
//# sourceMappingURL=fds-image-editor-paint-bucket-es.js.map
